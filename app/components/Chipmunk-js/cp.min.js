(function(){Object.create=Object.create||function(e){function t(){}return t.prototype=e,new t};var e;typeof exports=="undefined"?(e={},typeof window=="object"&&(window.cp=e)):e=exports;var t=function(e,t){if(!e)throw new Error("Assertion failed: "+t)},n=function(e,t){!e&&console&&console.warn&&(console.warn("ASSERTION FAILED: "+t),console.trace&&console.trace())},r=function(e,t){return e<t?e:t},i=function(e,t){return e>t?e:t},s,o;typeof window=="object"&&window.navigator.userAgent.indexOf("Firefox")>-1?(s=Math.min,o=Math.max):(s=r,o=i);var u=function(e,t){return e<t?e+" "+t:t+" "+e},a=function(e,t){for(var n=0;n<e.length;n++)if(e[n]===t){e[n]=e[e.length-1],e.length--;return}},f=function(e,t,n){var r=k(t,n),i=m(E(r,k(e,n))/j(r));return C(n,A(r,i))},l=function(e,t,n,r,i,s){var o=n-i,u=r-s,a=m(S(o,u,e-i,t-s)/F(o,u));return new b(i+o*a,s+u*a)};e.momentForCircle=function(e,t,n,r){return e*(.5*(t*t+n*n)+j(r))},e.areaForCircle=function(e,t){return Math.PI*Math.abs(e*e-t*t)},e.momentForSegment=function(e,t,n){var r=A(C(t,n),.5);return e*(X(n,t)/12+j(r))},e.areaForSegment=function(e,t,n){return n*(Math.PI*n+2*W(e,t))},e.momentForPoly=function(e,t,n){var r=0,i=0,s=t.length;for(var o=0;o<s;o+=2){var u=t[o]+n.x,a=t[o+1]+n.y,f=t[(o+2)%s]+n.x,l=t[(o+3)%s]+n.y,c=M(f,l,u,a),h=S(u,a,u,a)+S(u,a,f,l)+S(f,l,f,l);r+=c*h,i+=c}return e*r/(6*i)},e.areaForPoly=function(e){var t=0;for(var n=0,r=e.length;n<r;n+=2)t+=O(new b(e[n],e[n+1]),new b(e[(n+2)%r],e[(n+3)%r]));return-t/2},e.centroidForPoly=function(e){var t=0,n=new b(0,0);for(var r=0,i=e.length;r<i;r+=2){var s=new b(e[r],e[r+1]),o=new b(e[(r+2)%i],e[(r+3)%i]),u=O(s,o);t+=u,n=C(n,A(C(s,o),u))}return A(n,1/(3*t))},e.recenterPoly=function(t){var n=e.centroidForPoly(t);for(var r=0;r<t.length;r+=2)t[r]-=n.x,t[r+1]-=n.y},e.momentForBox=function(e,t,n){return e*(t*t+n*n)/12},e.momentForBox2=function(t,n){var r=n.r-n.l,i=n.t-n.b,s=A([n.l+n.r,n.b+n.t],.5);return e.momentForBox(t,r,i)+t*j(s)};var c=e.loopIndexes=function(e){var t=0,n=0,r,i,s,o;r=s=e[0],i=o=e[1];var u=e.length>>1;for(var a=1;a<u;a++){var f=e[a*2],l=e[a*2+1];if(f<r||f==r&&l<i)r=f,i=l,t=a;else if(f>s||f==s&&l>o)s=f,o=l,n=a}return[t,n]},h=function(e,t,n){var r=e[t*2];e[t*2]=e[n*2],e[n*2]=r,r=e[t*2+1],e[t*2+1]=e[n*2+1],e[n*2+1]=r},p=function(e,t,n,r,i,s){if(n===0)return 0;var o=0,u=t,a=k(i,r),f=s*x(a),l=t;for(var c=t+n-1;l<=c;){var p=new b(e[l*2],e[l*2+1]),d=O(a,k(p,r));d>f?(d>o&&(o=d,u=l),l++):(h(e,l,c),c--)}return u!=t&&h(e,t,u),l-t},d=function(e,t,n,r,i,s,o,u){if(r<0)return 0;if(r==0)return t[u*2]=s.x,t[u*2+1]=s.y,1;var a=p(t,n,r,i,s,e),f=new b(t[n*2],t[n*2+1]),l=d(e,t,n+1,a-1,i,f,s,u),c=u+l++;t[c*2]=s.x,t[c*2+1]=s.y;var h=p(t,n+a,r-a,s,o,e),v=new b(t[(n+a)*2],t[(n+a)*2+1]);return l+d(e,t,n+a+1,h-1,s,v,o,u+l)};e.convexHull=function(e,t,r){if(t)for(var i=0;i<e.length;i++)t[i]=e[i];else t=e;var s=c(e),o=s[0],u=s[1];if(o==u)return t.length=2,t;h(t,0,o),h(t,1,u==0?o:u);var a=new b(t[0],t[1]),f=new b(t[2],t[3]),l=e.length>>1,p=d(r,t,2,l-2,a,f,a,1)+1;return t.length=p*2,n(Tt(t),"Internal error: cpConvexHull() and cpPolyValidate() did not agree.Please report this error with as much info as you can."),t};var v=function(e,t,n){return s(o(e,t),n)},m=function(e){return o(0,s(e,1))},g=function(e,t,n){return e*(1-n)+t*n},y=function(e,t,n){return e+v(t-e,-n,n)},b=e.Vect=function(e,t){this.x=e,this.y=t};e.v=function(e,t){return new b(e,t)};var w=e.vzero=new b(0,0),E=e.v.dot=function(e,t){return e.x*t.x+e.y*t.y},S=function(e,t,n,r){return e*n+t*r},x=e.v.len=function(e){return Math.sqrt(E(e,e))},T=e.v.len2=function(e,t){return Math.sqrt(e*e+t*t)},N=e.v.eql=function(e,t){return e.x===t.x&&e.y===t.y},C=e.v.add=function(e,t){return new b(e.x+t.x,e.y+t.y)};b.prototype.add=function(e){return this.x+=e.x,this.y+=e.y,this};var k=e.v.sub=function(e,t){return new b(e.x-t.x,e.y-t.y)};b.prototype.sub=function(e){return this.x-=e.x,this.y-=e.y,this};var L=e.v.neg=function(e){return new b(-e.x,-e.y)};b.prototype.neg=function(){return this.x=-this.x,this.y=-this.y,this};var A=e.v.mult=function(e,t){return new b(e.x*t,e.y*t)};b.prototype.mult=function(e){return this.x*=e,this.y*=e,this};var O=e.v.cross=function(e,t){return e.x*t.y-e.y*t.x},M=function(e,t,n,r){return e*r-t*n},_=e.v.perp=function(e){return new b(-e.y,e.x)},D=e.v.pvrperp=function(e){return new b(e.y,-e.x)},P=e.v.project=function(e,t){return A(t,E(e,t)/j(t))};b.prototype.project=function(e){return this.mult(E(this,e)/j(e)),this};var H=e.v.rotate=function(e,t){return new b(e.x*t.x-e.y*t.y,e.x*t.y+e.y*t.x)};b.prototype.rotate=function(e){return this.x=this.x*e.x-this.y*e.y,this.y=this.x*e.y+this.y*e.x,this};var B=e.v.unrotate=function(e,t){return new b(e.x*t.x+e.y*t.y,e.y*t.x-e.x*t.y)},j=e.v.lengthsq=function(e){return E(e,e)},F=e.v.lengthsq2=function(e,t){return e*e+t*t},I=e.v.lerp=function(e,t,n){return C(A(e,1-n),A(t,n))},q=e.v.normalize=function(e){return A(e,1/x(e))},R=e.v.normalize_safe=function(e){return e.x===0&&e.y===0?w:q(e)},U=e.v.clamp=function(e,t){return E(e,e)>t*t?A(q(e),t):e},z=e.v.lerpconst=function(e,t,n){return C(e,U(k(t,e),n))},W=e.v.dist=function(e,t){return x(k(e,t))},X=e.v.distsq=function(e,t){return j(k(e,t))},V=e.v.near=function(e,t,n){return X(e,t)<n*n},$=e.v.slerp=function(e,t,n){var r=Math.acos(E(e,t));if(r){var i=1/Math.sin(r);return C(A(e,Math.sin((1-n)*r)*i),A(t,Math.sin(n*r)*i))}return e},J=e.v.slerpconst=function(e,t,n){var r=Math.acos(E(e,t));return $(e,t,s(n,r)/r)},K=e.v.forangle=function(e){return new b(Math.cos(e),Math.sin(e))},Q=e.v.toangle=function(e){return Math.atan2(e.y,e.x)},G=e.v.str=function(e){return"("+e.x.toFixed(3)+", "+e.y.toFixed(3)+")"},Y=0,Z=e.BB=function(e,t,n,r){this.l=e,this.b=t,this.r=n,this.t=r,Y++};e.bb=function(e,t,n,r){return new Z(e,t,n,r)};var et=function(e,t){return new Z(e.x-t,e.y-t,e.x+t,e.y+t)},tt=function(e,t){return e.l<=t.r&&t.l<=e.r&&e.b<=t.t&&t.b<=e.t},nt=function(e,t,n,r,i){return e.l<=r&&t<=e.r&&e.b<=i&&n<=e.t},rt=function(e,t){return e.l<=t.l&&e.r>=t.r&&e.b<=t.b&&e.t>=t.t},it=function(e,t){return e.l<=t.x&&e.r>=t.x&&e.b<=t.y&&e.t>=t.y},st=function(e,t,n,r,i){return e<=i.x&&n>=i.x&&t<=i.y&&r>=i.y},ot=function(e,t){return new Z(s(e.l,t.l),s(e.b,t.b),o(e.r,t.r),o(e.t,t.t))},ut=function(e,t){return new Z(s(e.l,t.x),s(e.b,t.y),o(e.r,t.x),o(e.t,t.y))},at=function(e){return(e.r-e.l)*(e.t-e.b)},ft=function(e,t){return(o(e.r,t.r)-s(e.l,t.l))*(o(e.t,t.t)-s(e.b,t.b))},lt=function(e,t,n,r,i){return(o(e.r,r)-s(e.l,t))*(o(e.t,i)-s(e.b,n))},ct=function(e,t,n){return bbSegmentQuery(e,t,n)!=Infinity},ht=function(e,t){var n=s(o(e.l,t.x),e.r),r=s(o(e.b,t.y),e.t);return new b(n,r)},pt=function(e,t){var n=Math.abs(e.r-e.l),r=(t.x-e.l)%n,i=r>0?r:r+n,s=Math.abs(e.t-e.b),o=(t.y-e.b)%s,u=o>0?o:o+s;return new b(i+e.l,u+e.b)},dt=0,vt=e.NO_GROUP=0,mt=e.ALL_LAYERS=-1;e.resetShapeIdCounter=function(){dt=0};var gt=e.Shape=function(e){this.body=e,this.bb_l=this.bb_b=this.bb_r=this.bb_t=0,this.hashid=dt++,this.sensor=!1,this.e=0,this.u=0,this.surface_v=w,this.collision_type=0,this.group=0,this.layers=mt,this.space=null,this.collisionCode=this.collisionCode};gt.prototype.setElasticity=function(e){this.e=e},gt.prototype.setFriction=function(e){this.body.activate(),this.u=e},gt.prototype.setLayers=function(e){this.body.activate(),this.layers=e},gt.prototype.setSensor=function(e){this.body.activate(),this.sensor=e},gt.prototype.setCollisionType=function(e){this.body.activate(),this.collision_type=e},gt.prototype.getBody=function(){return this.body},gt.prototype.active=function(){return this.body&&this.body.shapeList.indexOf(this)!==-1},gt.prototype.setBody=function(e){t(!this.active(),"You cannot change the body on an active shape. You must remove the shape from the space before changing the body."),this.body=e},gt.prototype.cacheBB=function(){return this.update(this.body.p,this.body.rot)},gt.prototype.update=function(e,n){t(!isNaN(n.x),"Rotation is NaN"),t(!isNaN(e.x),"Position is NaN"),this.cacheData(e,n)},gt.prototype.pointQuery=function(e){var t=this.nearestPointQuery(e);if(t.d<0)return t},gt.prototype.getBB=function(){return new Z(this.bb_l,this.bb_b,this.bb_r,this.bb_t)};var yt=function(e){this.shape=e,this.d=Infinity,this.n=w},bt=function(e,t,n){this.shape=e,this.p=t,this.d=n},wt=function(e,t,n){this.shape=e,this.t=t,this.n=n};wt.prototype.hitPoint=function(e,t){return I(e,t,this.t)},wt.prototype.hitDist=function(e,t){return W(e,t)*this.t};var Et=e.CircleShape=function(e,t,n){this.c=this.tc=n,this.r=t,this.type="circle",gt.call(this,e)};Et.prototype=Object.create(gt.prototype),Et.prototype.cacheData=function(e,t){var n=this.tc=H(this.c,t).add(e),r=this.r;this.bb_l=n.x-r,this.bb_b=n.y-r,this.bb_r=n.x+r,this.bb_t=n.y+r},Et.prototype.nearestPointQuery=function(e){var t=e.x-this.tc.x,n=e.y-this.tc.y,r=T(t,n),i=this.r,s=new b(this.tc.x+t*i/r,this.tc.y+n*i/r);return new bt(this,s,r-i)};var St=function(e,t,n,r,i,s){r=k(r,t),i=k(i,t);var o=E(r,r)-2*E(r,i)+E(i,i),u=-2*E(r,r)+2*E(r,i),a=E(r,r)-n*n,f=u*u-4*o*a;if(f>=0){var l=(-u-Math.sqrt(f))/(2*o);if(0<=l&&l<=1)return new wt(e,l,q(I(r,i,l)))}};Et.prototype.segmentQuery=function(e,t){return St(this,this.tc,this.r,e,t)};var xt=e.SegmentShape=function(e,t,n,r){this.a=t,this.b=n,this.n=_(q(k(n,t))),this.ta=this.tb=this.tn=null,this.r=r,this.a_tangent=w,this.b_tangent=w,this.type="segment",gt.call(this,e)};xt.prototype=Object.create(gt.prototype),xt.prototype.cacheData=function(e,t){this.ta=C(e,H(this.a,t)),this.tb=C(e,H(this.b,t)),this.tn=H(this.n,t);var n,r,i,s;this.ta.x<this.tb.x?(n=this.ta.x,r=this.tb.x):(n=this.tb.x,r=this.ta.x),this.ta.y<this.tb.y?(i=this.ta.y,s=this.tb.y):(i=this.tb.y,s=this.ta.y);var o=this.r;this.bb_l=n-o,this.bb_b=i-o,this.bb_r=r+o,this.bb_t=s+o},xt.prototype.nearestPointQuery=function(e){var t=f(e,this.ta,this.tb),n=e.x-t.x,r=e.y-t.y,i=T(n,r),s=this.r,o=i?C(t,A(new b(n,r),s/i)):t;return new bt(this,o,i-s)},xt.prototype.segmentQuery=function(e,t){var n=this.tn,r=E(k(this.ta,e),n),i=this.r,s=r>0?L(n):n,o=k(A(s,i),e),u=C(this.ta,o),a=C(this.tb,o),f=k(t,e);if(O(f,u)*O(f,a)<=0){var l=r+(r>0?-i:i),c=-l,h=E(f,n)-l;if(c*h<0)return new wt(this,c/(c-h),s)}else if(i!==0){var p=St(this,this.ta,this.r,e,t),d=St(this,this.tb,this.r,e,t);return p?d&&d.t<p.t?d:p:d}},xt.prototype.setNeighbors=function(e,t){this.a_tangent=k(e,this.a),this.b_tangent=k(t,this.b)},xt.prototype.setEndpoints=function(e,t){this.a=e,this.b=t,this.n=_(q(k(t,e)))};var Tt=function(e){var t=e.length;for(var n=0;n<t;n+=2){var r=e[n],i=e[n+1],s=e[(n+2)%t],o=e[(n+3)%t],u=e[(n+4)%t],a=e[(n+5)%t];if(M(s-r,o-i,u-s,a-o)>0)return!1}return!0},Nt=e.PolyShape=function(e,t,n){this.setVerts(t,n),this.type="poly",gt.call(this,e)};Nt.prototype=Object.create(gt.prototype);var Ct=function(e,t){this.n=e,this.d=t};Ct.prototype.compare=function(e){return E(this.n,e)-this.d},Nt.prototype.setVerts=function(e,n){t(e.length>=4,"Polygons require some verts"),t(typeof e[0]=="number","Polygon verticies should be specified in a flattened list (eg [x1,y1,x2,y2,x3,y3,...])"),t(Tt(e),"Polygon is concave or has a reversed winding. Consider using cpConvexHull()");var r=e.length,i=r>>1;this.verts=new Array(r),this.tVerts=new Array(r),this.planes=new Array(i),this.tPlanes=new Array(i);for(var s=0;s<r;s+=2){var o=e[s]+n.x,u=e[s+1]+n.y,a=e[(s+2)%r]+n.x,f=e[(s+3)%r]+n.y,l=q(_(new b(a-o,f-u)));this.verts[s]=o,this.verts[s+1]=u,this.planes[s>>1]=new Ct(l,S(l.x,l.y,o,u)),this.tPlanes[s>>1]=new Ct(new b(0,0),0)}};var kt=e.BoxShape=function(e,t,n){var r=t/2,i=n/2;return Lt(e,new Z(-r,-i,r,i))},Lt=e.BoxShape2=function(e,t){var n=[t.l,t.b,t.l,t.t,t.r,t.t,t.r,t.b];return new Nt(e,n,w)};Nt.prototype.transformVerts=function(e,t){var n=this.verts,r=this.tVerts,i=Infinity,u=-Infinity,a=Infinity,f=-Infinity;for(var l=0;l<n.length;l+=2){var c=n[l],h=n[l+1],p=e.x+c*t.x-h*t.y,d=e.y+c*t.y+h*t.x;r[l]=p,r[l+1]=d,i=s(i,p),u=o(u,p),a=s(a,d),f=o(f,d)}this.bb_l=i,this.bb_b=a,this.bb_r=u,this.bb_t=f},Nt.prototype.transformAxes=function(e,t){var n=this.planes,r=this.tPlanes;for(var i=0;i<n.length;i++){var s=H(n[i].n,t);r[i].n=s,r[i].d=E(e,s)+n[i].d}},Nt.prototype.cacheData=function(e,t){this.transformAxes(e,t),this.transformVerts(e,t)},Nt.prototype.nearestPointQuery=function(e){var t=this.tPlanes,n=this.tVerts,r=n[n.length-2],i=n[n.length-1],s=Infinity,o=w,u=!1;for(var a=0;a<t.length;a++){t[a].compare(e)>0&&(u=!0);var f=n[a*2],c=n[a*2+1],h=l(e.x,e.y,r,i,f,c),p=W(e,h);p<s&&(s=p,o=h),r=f,i=c}return new bt(this,o,u?s:-s)},Nt.prototype.segmentQuery=function(e,t){var n=this.tPlanes,r=this.tVerts,i=n.length,s=i*2;for(var o=0;o<i;o++){var u=n[o].n,a=E(e,u);if(n[o].d>a)continue;var f=E(t,u),l=(n[o].d-a)/(f-a);if(l<0||1<l)continue;var c=I(e,t,l),h=-O(u,c),p=-M(u.x,u.y,r[o*2],r[o*2+1]),d=-M(u.x,u.y,r[(o*2+2)%s],r[(o*2+3)%s]);if(p<=h&&h<=d)return new wt(this,l,u)}},Nt.prototype.valueOnAxis=function(e,t){var n=this.tVerts,r=S(e.x,e.y,n[0],n[1]);for(var i=2;i<n.length;i+=2)r=s(r,S(e.x,e.y,n[i],n[i+1]));return r-t},Nt.prototype.containsVert=function(e,t){var n=this.tPlanes;for(var r=0;r<n.length;r++){var i=n[r].n,s=S(i.x,i.y,e,t)-n[r].d;if(s>0)return!1}return!0},Nt.prototype.containsVertPartial=function(e,t,n){var r=this.tPlanes;for(var i=0;i<r.length;i++){var s=r[i].n;if(E(s,n)<0)continue;var o=S(s.x,s.y,e,t)-r[i].d;if(o>0)return!1}return!0},Nt.prototype.getNumVerts=function(){return this.verts.length/2},Nt.prototype.getVert=function(e){return new b(this.verts[e*2],this.verts[e*2+1])};var At=e.Body=function(e,t){this.p=new b(0,0),this.vx=this.vy=0,this.f=new b(0,0),this.w=0,this.t=0,this.v_limit=Infinity,this.w_limit=Infinity,this.v_biasx=this.v_biasy=0,this.w_bias=0,this.space=null,this.shapeList=[],this.arbiterList=null,this.constraintList=null,this.nodeRoot=null,this.nodeNext=null,this.nodeIdleTime=0,this.setMass(e),this.setMoment(t),this.rot=new b(0,0),this.setAngle(0)},Ot=function(){var e=new At(Infinity,Infinity);return e.nodeIdleTime=Infinity,e};if(typeof DEBUG!="undefined"&&DEBUG){var Mt=function(e,n){t(e.x==e.x&&e.y==e.y,n)},_t=function(e,n){t(Math.abs(e.x)!==Infinity&&Math.abs(e.y)!==Infinity,n)},Dt=function(e,t){Mt(e,t),_t(e,t)};At.prototype.sanityCheck=function(){t(this.m===this.m&&this.m_inv===this.m_inv,"Body's mass is invalid."),t(this.i===this.i&&this.i_inv===this.i_inv,"Body's moment is invalid."),Dt(this.p,"Body's position is invalid."),Dt(this.f,"Body's force is invalid."),t(this.vx===this.vx&&Math.abs(this.vx)!==Infinity,"Body's velocity is invalid."),t(this.vy===this.vy&&Math.abs(this.vy)!==Infinity,"Body's velocity is invalid."),t(this.a===this.a&&Math.abs(this.a)!==Infinity,"Body's angle is invalid."),t(this.w===this.w&&Math.abs(this.w)!==Infinity,"Body's angular velocity is invalid."),t(this.t===this.t&&Math.abs(this.t)!==Infinity,"Body's torque is invalid."),Dt(this.rot,"Body's rotation vector is invalid."),t(this.v_limit===this.v_limit,"Body's velocity limit is invalid."),t(this.w_limit===this.w_limit,"Body's angular velocity limit is invalid.")}}else At.prototype.sanityCheck=function(){};At.prototype.getPos=function(){return this.p},At.prototype.getVel=function(){return new b(this.vx,this.vy)},At.prototype.getAngVel=function(){return this.w},At.prototype.isSleeping=function(){return this.nodeRoot!==null},At.prototype.isStatic=function(){return this.nodeIdleTime===Infinity},At.prototype.isRogue=function(){return this.space===null},At.prototype.setMass=function(e){t(e>0,"Mass must be positive and non-zero."),this.activate(),this.m=e,this.m_inv=1/e},At.prototype.setMoment=function(e){t(e>0,"Moment of Inertia must be positive and non-zero."),this.activate(),this.i=e,this.i_inv=1/e},At.prototype.addShape=function(e){this.shapeList.push(e)},At.prototype.removeShape=function(e){a(this.shapeList,e)};var Pt=function(e,t,n){return e===n?e.next(t):(e.a===t?e.next_a=Pt(e.next_a,t,n):e.next_b=Pt(e.next_b,t,n),e)};At.prototype.removeConstraint=function(e){this.constraintList=Pt(this.constraintList,this,e)},At.prototype.setPos=function(t){this.activate(),this.sanityCheck(),t===w&&(t=e.v(0,0)),this.p=t},At.prototype.setVel=function(e){this.activate(),this.vx=e.x,this.vy=e.y},At.prototype.setAngVel=function(e){this.activate(),this.w=e},At.prototype.setAngleInternal=function(e){t(!isNaN(e),"Internal Error: Attempting to set body's angle to NaN"),this.a=e,this.rot.x=Math.cos(e),this.rot.y=Math.sin(e)},At.prototype.setAngle=function(e){this.activate(),this.sanityCheck(),this.setAngleInternal(e)},At.prototype.velocity_func=function(e,t,n){var r=this.vx*t+(e.x+this.f.x*this.m_inv)*n,i=this.vy*t+(e.y+this.f.y*this.m_inv)*n,s=this.v_limit,o=r*r+i*i,u=o>s*s?s/Math.sqrt(o):1;this.vx=r*u,this.vy=i*u;var a=this.w_limit;this.w=v(this.w*t+this.t*this.i_inv*n,-a,a),this.sanityCheck()},At.prototype.position_func=function(e){this.p.x+=(this.vx+this.v_biasx)*e,this.p.y+=(this.vy+this.v_biasy)*e,this.setAngleInternal(this.a+(this.w+this.w_bias)*e),this.v_biasx=this.v_biasy=0,this.w_bias=0,this.sanityCheck()},At.prototype.resetForces=function(){this.activate(),this.f=new b(0,0),this.t=0},At.prototype.applyForce=function(e,t){this.activate(),this.f=C(this.f,e),this.t+=O(t,e)},At.prototype.applyImpulse=function(e,t){this.activate(),Fn(this,e.x,e.y,t)},At.prototype.getVelAtPoint=function(e){return C(new b(this.vx,this.vy),A(_(e),this.w))},At.prototype.getVelAtWorldPoint=function(e){return this.getVelAtPoint(k(e,this.p))},At.prototype.getVelAtLocalPoint=function(e){return this.getVelAtPoint(H(e,this.rot))},At.prototype.eachShape=function(e){for(var t=0,n=this.shapeList.length;t<n;t++)e(this.shapeList[t])},At.prototype.eachConstraint=function(e){var t=this.constraintList;while(t){var n=t.next(this);e(t),t=n}},At.prototype.eachArbiter=function(e){var t=this.arbiterList;while(t){var n=t.next(this);t.swappedColl=this===t.body_b,e(t),t=n}},At.prototype.local2World=function(e){return C(this.p,H(e,this.rot))},At.prototype.world2Local=function(e){return B(k(e,this.p),this.rot)},At.prototype.kineticEnergy=function(){var e=this.vx*this.vx+this.vy*this.vy,t=this.w*this.w;return(e?e*this.m:0)+(t?t*this.i:0)};var Ht=e.SpatialIndex=function(e){this.staticIndex=e;if(e){if(e.dynamicIndex)throw new Error("This static index is already associated with a dynamic index.");e.dynamicIndex=this}};Ht.prototype.collideStatic=function(e,t){if(e.count>0){var n=e.query;this.each(function(e){n(e,new Z(e.bb_l,e.bb_b,e.bb_r,e.bb_t),t)})}};var Bt=e.BBTree=function(e){Ht.call(this,e),this.velocityFunc=null,this.leaves={},this.count=0,this.root=null,this.pooledNodes=null,this.pooledPairs=null,this.stamp=0};Bt.prototype=Object.create(Ht.prototype);var jt=0,Ft=function(e,t,n){this.obj=null,this.bb_l=s(t.bb_l,n.bb_l),this.bb_b=s(t.bb_b,n.bb_b),this.bb_r=o(t.bb_r,n.bb_r),this.bb_t=o(t.bb_t,n.bb_t),this.parent=null,this.setA(t),this.setB(n)};Bt.prototype.makeNode=function(e,t){var n=this.pooledNodes;return n?(this.pooledNodes=n.parent,n.constructor(this,e,t),n):(jt++,new Ft(this,e,t))};var It=0,qt=function(e,t){this.obj=t,e.getBB(t,this),this.parent=null,this.stamp=1,this.pairs=null,It++};Bt.prototype.getBB=function(e,t){var n=this.velocityFunc;if(n){var r=.1,i=(e.bb_r-e.bb_l)*r,u=(e.bb_t-e.bb_b)*r,a=A(n(e),.1);t.bb_l=e.bb_l+s(-i,a.x),t.bb_b=e.bb_b+s(-u,a.y),t.bb_r=e.bb_r+o(i,a.x),t.bb_t=e.bb_t+o(u,a.y)}else t.bb_l=e.bb_l,t.bb_b=e.bb_b,t.bb_r=e.bb_r,t.bb_t=e.bb_t},Bt.prototype.getStamp=function(){var e=this.dynamicIndex;return e&&e.stamp?e.stamp:this.stamp},Bt.prototype.incrementStamp=function(){this.dynamicIndex&&this.dynamicIndex.stamp?this.dynamicIndex.stamp++:this.stamp++};var Rt=0,Ut=function(e,t,n,r){this.prevA=null,this.leafA=e,this.nextA=t,this.prevB=null,this.leafB=n,this.nextB=r};Bt.prototype.makePair=function(e,t,n,r){var i=this.pooledPairs;return i?(this.pooledPairs=i.prevA,i.prevA=null,i.leafA=e,i.nextA=t,i.prevB=null,i.leafB=n,i.nextB=r,i):(Rt++,new Ut(e,t,n,r))},Ut.prototype.recycle=function(e){this.prevA=e.pooledPairs,e.pooledPairs=this};var zt=function(e,t,n){n&&(n.leafA===t?n.prevA=e:n.prevB=e),e?e.leafA===t?e.nextA=n:e.nextB=n:t.pairs=n};qt.prototype.clearPairs=function(e){var t=this.pairs,n;this.pairs=null;while(t)t.leafA===this?(n=t.nextA,zt(t.prevB,t.leafB,t.nextB)):(n=t.nextB,zt(t.prevA,t.leafA,t.nextA)),t.recycle(e),t=n};var Wt=function(e,t,n){var r=e.pairs,i=t.pairs,s=n.makePair(e,r,t,i);e.pairs=t.pairs=s,r&&(r.leafA===e?r.prevA=s:r.prevB=s),i&&(i.leafA===t?i.prevA=s:i.prevB=s)};Ft.prototype.recycle=function(e){this.parent=e.pooledNodes,e.pooledNodes=this},qt.prototype.recycle=function(e){},Ft.prototype.setA=function(e){this.A=e,e.parent=this},Ft.prototype.setB=function(e){this.B=e,e.parent=this},qt.prototype.isLeaf=!0,Ft.prototype.isLeaf=!1,Ft.prototype.otherChild=function(e){return this.A==e?this.B:this.A},Ft.prototype.replaceChild=function(e,t,r){n(e==this.A||e==this.B,"Node is not a child of parent."),this.A==e?(this.A.recycle(r),this.setA(t)):(this.B.recycle(r),this.setB(t));for(var i=this;i;i=i.parent){var u=i.A,a=i.B;i.bb_l=s(u.bb_l,a.bb_l),i.bb_b=s(u.bb_b,a.bb_b),i.bb_r=o(u.bb_r,a.bb_r),i.bb_t=o(u.bb_t,a.bb_t)}},Ft.prototype.bbArea=qt.prototype.bbArea=function(){return(this.bb_r-this.bb_l)*(this.bb_t-this.bb_b)};var Xt=function(e,t){return(o(e.bb_r,t.bb_r)-s(e.bb_l,t.bb_l))*(o(e.bb_t,t.bb_t)-s(e.bb_b,t.bb_b))},Vt=function(e,t){return Math.abs(e.bb_l+e.bb_r-t.bb_l-t.bb_r)+Math.abs(e.bb_b+e.bb_t-t.bb_b-t.bb_t)},$t=function(e,t,n){if(e==null)return t;if(e.isLeaf)return n.makeNode(t,e);var r=e.B.bbArea()+Xt(e.A,t),i=e.A.bbArea()+Xt(e.B,t);return r===i&&(r=Vt(e.A,t),i=Vt(e.B,t)),i<r?e.setB($t(e.B,t,n)):e.setA($t(e.A,t,n)),e.bb_l=s(e.bb_l,t.bb_l),e.bb_b=s(e.bb_b,t.bb_b),e.bb_r=o(e.bb_r,t.bb_r),e.bb_t=o(e.bb_t,t.bb_t),e};Ft.prototype.intersectsBB=qt.prototype.intersectsBB=function(e){return this.bb_l<=e.r&&e.l<=this.bb_r&&this.bb_b<=e.t&&e.b<=this.bb_t};var Jt=function(e,t,n){e.intersectsBB(t)&&(e.isLeaf?n(e.obj):(Jt(e.A,t,n),Jt(e.B,t,n)))},Kt=function(e,t,n){var r=1/(n.x-t.x),i=e.bb_l==t.x?-Infinity:(e.bb_l-t.x)*r,u=e.bb_r==t.x?Infinity:(e.bb_r-t.x)*r,a=s(i,u),f=o(i,u),l=1/(n.y-t.y),c=e.bb_b==t.y?-Infinity:(e.bb_b-t.y)*l,h=e.bb_t==t.y?Infinity:(e.bb_t-t.y)*l,p=s(c,h),d=o(c,h);if(p<=f&&a<=d){var v=o(a,p),m=s(f,d);if(0<=m&&v<=1)return o(v,0)}return Infinity},Qt=function(e,t,n,r,i){if(e.isLeaf)return i(e.obj);var o=Kt(e.A,t,n),u=Kt(e.B,t,n);return o<u?(o<r&&(r=s(r,Qt(e.A,t,n,r,i))),u<r&&(r=s(r,Qt(e.B,t,n,r,i)))):(u<r&&(r=s(r,Qt(e.B,t,n,r,i))),o<r&&(r=s(r,Qt(e.A,t,n,r,i)))),r};Bt.prototype.subtreeRecycle=function(e){e.isLeaf&&(this.subtreeRecycle(e.A),this.subtreeRecycle(e.B),e.recycle(this))};var Gt=function(e,t,n){if(t==e)return null;var r=t.parent;if(r==e){var i=e.otherChild(t);return i.parent=e.parent,e.recycle(n),i}return r.parent.replaceChild(r,r.otherChild(t),n),e},Yt=function(e,t){return e.bb_l<=t.bb_r&&t.bb_l<=e.bb_r&&e.bb_b<=t.bb_t&&t.bb_b<=e.bb_t};qt.prototype.markLeafQuery=function(e,t,n,r){Yt(e,this)&&(t?Wt(e,this,n):(this.stamp<e.stamp&&Wt(this,e,n),r&&r(e.obj,this.obj)))},Ft.prototype.markLeafQuery=function(e,t,n,r){Yt(e,this)&&(this.A.markLeafQuery(e,t,n,r),this.B.markLeafQuery(e,t,n,r))},qt.prototype.markSubtree=function(e,t,n){if(this.stamp==e.getStamp()){t&&t.markLeafQuery(this,!1,e,n);for(var r=this;r.parent;r=r.parent)r==r.parent.A?r.parent.B.markLeafQuery(this,!0,e,n):r.parent.A.markLeafQuery(this,!1,e,n)}else{var i=this.pairs;while(i)this===i.leafB?(n&&n(i.leafA.obj,this.obj),i=i.nextB):i=i.nextA}},Ft.prototype.markSubtree=function(e,t,n){this.A.markSubtree(e,t,n),this.B.markSubtree(e,t,n)},qt.prototype.containsObj=function(e){return this.bb_l<=e.bb_l&&this.bb_r>=e.bb_r&&this.bb_b<=e.bb_b&&this.bb_t>=e.bb_t},qt.prototype.update=function(e){var t=e.root,n=this.obj;return this.containsObj(n)?!1:(e.getBB(this.obj,this),t=Gt(t,this,e),e.root=$t(t,this,e),this.clearPairs(e),this.stamp=e.getStamp(),!0)},qt.prototype.addPairs=function(e){var t=e.dynamicIndex;if(t){var n=t.root;n&&n.markLeafQuery(this,!0,t,null)}else{var r=e.staticIndex.root;this.markSubtree(e,r,null)}},Bt.prototype.insert=function(e,t){var n=new qt(this,e);this.leaves[t]=n,this.root=$t(this.root,n,this),this.count++,n.stamp=this.getStamp(),n.addPairs(this),this.incrementStamp()},Bt.prototype.remove=function(e,t){var n=this.leaves[t];delete this.leaves[t],this.root=Gt(this.root,n,this),this.count--,n.clearPairs(this),n.recycle(this)},Bt.prototype.contains=function(e,t){return this.leaves[t]!=null};var Zt=function(e,t){};Bt.prototype.reindexQuery=function(e){if(!this.root)return;var t,n=this.leaves;for(t in n)n[t].update(this);var r=this.staticIndex,i=r&&r.root;this.root.markSubtree(this,i,e),r&&!i&&this.collideStatic(this,r,e),this.incrementStamp()},Bt.prototype.reindex=function(){this.reindexQuery(Zt)},Bt.prototype.reindexObject=function(e,t){var n=this.leaves[t];n&&(n.update(this)&&n.addPairs(this),this.incrementStamp())},Bt.prototype.pointQuery=function(e,t){this.query(new Z(e.x,e.y,e.x,e.y),t)},Bt.prototype.segmentQuery=function(e,t,n,r){this.root&&Qt(this.root,e,t,n,r)},Bt.prototype.query=function(e,t){this.root&&Jt(this.root,e,t)},Bt.prototype.count=function(){return this.count},Bt.prototype.each=function(e){var t;for(t in this.leaves)e(this.leaves[t].obj)};var en=function(e,t,n,r,i){return(o(e.bb_r,r)-s(e.bb_l,t))*(o(e.bb_t,i)-s(e.bb_b,n))},tn=function(e,t,n,r){if(r==1)return t[n];if(r==2)return e.makeNode(t[n],t[n+1]);var i=t[n],u=i.bb_l,a=i.bb_b,f=i.bb_r,l=i.bb_t,c=n+r;for(var h=n+1;h<c;h++)i=t[h],u=s(u,i.bb_l),a=s(a,i.bb_b),f=o(f,i.bb_r),l=o(l,i.bb_t);var p=f-u>l-a,d=new Array(r*2);if(p)for(var h=n;h<c;h++)d[2*h+0]=t[h].bb_l,d[2*h+1]=t[h].bb_r;else for(var h=n;h<c;h++)d[2*h+0]=t[h].bb_b,d[2*h+1]=t[h].bb_t;d.sort(function(e,t){return e-t});var v=(d[r-1]+d[r])*.5,m=u,g=a,y=f,b=l,w=u,E=a,S=f,x=l;p?y=w=v:b=E=v;var T=c;for(var N=n;N<T;){var i=t[N];en(i,w,E,S,x)<en(i,m,g,y,b)?(T--,t[N]=t[T],t[T]=i):N++}if(T==r){var i=null;for(var h=n;h<c;h++)i=$t(i,t[h],e);return i}return NodeNew(e,tn(e,t,n,T-n),tn(e,t,T,c-T))};Bt.prototype.optimize=function(){var e=new Array(this.count),t=0;for(var n in this.leaves)e[t++]=this.nodes[n];tree.subtreeRecycle(root),this.root=tn(tree,e,e.length)};var nn=function(e,t){!e.isLeaf&&t<=10&&(nn(e.A,t+1),nn(e.B,t+1));var n="";for(var r=0;r<t;r++)n+=" ";console.log(n+e.bb_b+" "+e.bb_t)};Bt.prototype.log=function(){this.root&&nn(this.root,0)};var rn=e.CollisionHandler=function(){this.a=this.b=0};rn.prototype.begin=function(e,t){return!0},rn.prototype.preSolve=function(e,t){return!0},rn.prototype.postSolve=function(e,t){},rn.prototype.separate=function(e,t){};var sn=4,on=function(e,t){this.e=0,this.u=0,this.surface_vr=w,this.a=e,this.body_a=e.body,this.b=t,this.body_b=t.body,this.thread_a_next=this.thread_a_prev=null,this.thread_b_next=this.thread_b_prev=null,this.contacts=null,this.stamp=0,this.handler=null,this.swappedColl=!1,this.state="first coll"};on.prototype.getShapes=function(){return this.swappedColl?[this.b,this.a]:[this.a,this.b]},on.prototype.totalImpulse=function(){var e=this.contacts,t=new b(0,0);for(var n=0,r=e.length;n<r;n++){var i=e[n];t.add(A(i.n,i.jnAcc))}return this.swappedColl?t:t.neg()},on.prototype.totalImpulseWithFriction=function(){var e=this.contacts,t=new b(0,0);for(var n=0,r=e.length;n<r;n++){var i=e[n];t.add((new b(i.jnAcc,i.jtAcc)).rotate(i.n))}return this.swappedColl?t:t.neg()},on.prototype.totalKE=function(){var e=(1-this.e)/(1+this.e),t=0,n=this.contacts;for(var r=0,i=n.length;r<i;r++){var s=n[r],o=s.jnAcc,u=s.jtAcc;t+=e*o*o/s.nMass+u*u/s.tMass}return t},on.prototype.ignore=function(){this.state="ignore"},on.prototype.getA=function(){return this.swappedColl?this.b:this.a},on.prototype.getB=function(){return this.swappedColl?this.a:this.b},on.prototype.isFirstContact=function(){return this.state==="first coll"};var un=function(e,t,n){this.point=e,this.normal=t,this.dist=n};on.prototype.getContactPointSet=function(){var e=new Array(this.contacts.length),t;for(t=0;t<e.length;t++)e[t]=new un(this.contacts[t].p,this.contacts[t].n,this.contacts[t].dist);return e},on.prototype.getNormal=function(e){var t=this.contacts[e].n;return this.swappedColl?L(t):t},on.prototype.getPoint=function(e){return this.contacts[e].p},on.prototype.getDepth=function(e){return this.contacts[e].dist};var an=function(e,t,n,r){n?n.body_a===t?n.thread_a_next=r:n.thread_b_next=r:t.arbiterList=r,r&&(r.body_a===t?r.thread_a_prev=n:r.thread_b_prev=n)};on.prototype.unthread=function(){an(this,this.body_a,this.thread_a_prev,this.thread_a_next),an(this,this.body_b,this.thread_b_prev,this.thread_b_next),this.thread_a_prev=this.thread_a_next=null,this.thread_b_prev=this.thread_b_next=null},on.prototype.update=function(e,t,n,r){if(this.contacts)for(var i=0;i<this.contacts.length;i++){var s=this.contacts[i];for(var o=0;o<e.length;o++){var u=e[o];u.hash===s.hash&&(u.jnAcc=s.jnAcc,u.jtAcc=s.jtAcc)}}this.contacts=e,this.handler=t,this.swappedColl=n.collision_type!==t.a,this.e=n.e*r.e,this.u=n.u*r.u,this.surface_vr=k(n.surface_v,r.surface_v),this.a=n,this.body_a=n.body,this.b=r,this.body_b=r.body,this.state=="cached"&&(this.state="first coll")},on.prototype.preStep=function(e,t,n){var r=this.body_a,i=this.body_b;for(var o=0;o<this.contacts.length;o++){var u=this.contacts[o];u.r1=k(u.p,r.p),u.r2=k(u.p,i.p),u.nMass=1/Un(r,i,u.r1,u.r2,u.n),u.tMass=1/Un(r,i,u.r1,u.r2,_(u.n)),u.bias=-n*s(0,u.dist+t)/e,u.jBias=0,u.bounce=jn(r,i,u.r1,u.r2,u.n)*this.e}},on.prototype.applyCachedImpulse=function(e){if(this.isFirstContact())return;var t=this.body_a,n=this.body_b;for(var r=0;r<this.contacts.length;r++){var i=this.contacts[r],s=i.n.x,o=i.n.y,u=s*i.jnAcc-o*i.jtAcc,a=s*i.jtAcc+o*i.jnAcc;In(t,n,i.r1,i.r2,u*e,a*e)}};var fn=0,ln=0;on.prototype.applyImpulse=function(){fn++;var e=this.body_a,t=this.body_b,n=this.surface_vr,r=this.u;for(var i=0;i<this.contacts.length;i++){ln++;var s=this.contacts[i],u=s.nMass,a=s.n,f=s.r1,l=s.r2,c=t.vx-l.y*t.w-(e.vx-f.y*e.w),h=t.vy+l.x*t.w-(e.vy+f.x*e.w),p=a.x*(t.v_biasx-l.y*t.w_bias-e.v_biasx+f.y*e.w_bias)+a.y*(l.x*t.w_bias+t.v_biasy-f.x*e.w_bias-e.v_biasy),d=S(c,h,a.x,a.y),m=S(c+n.x,h+n.y,-a.y,a.x),g=(s.bias-p)*u,y=s.jBias;s.jBias=o(y+g,0);var b=-(s.bounce+d)*u,w=s.jnAcc;s.jnAcc=o(w+b,0);var E=r*s.jnAcc,x=-m*s.tMass,T=s.jtAcc;s.jtAcc=v(T+x,-E,E);var N=a.x*(s.jBias-y),C=a.y*(s.jBias-y);qn(e,-N,-C,f),qn(t,N,C,l);var k=s.jnAcc-w,L=s.jtAcc-T;In(e,t,f,l,a.x*k-a.y*L,a.x*L+a.y*k)}},on.prototype.callSeparate=function(e){var t=e.lookupHandler(this.a.collision_type,this.b.collision_type);t.separate(this,e)},on.prototype.next=function(e){return this.body_a==e?this.thread_a_next:this.thread_b_next};var cn=0,hn=function(e,t,n,r){this.p=e,this.n=t,this.dist=n,this.r1=this.r2=w,this.nMass=this.tMass=this.bounce=this.bias=0,this.jnAcc=this.jtAcc=this.jBias=0,this.hash=r,cn++},pn=[],dn=function(e,t,n,r){var i=n+r,s=k(t,e),o=j(s);if(o>=i*i)return;var u=Math.sqrt(o);return new hn(C(e,A(s,.5+(n-.5*i)/(u?u:Infinity))),u?A(s,1/u):new b(1,0),u-i,0)},vn=function(e,t){var n=dn(e.tc,t.tc,e.r,t.r);return n?[n]:pn},mn=function(e,t){var n=t.ta,r=t.tb,i=e.tc,s=k(r,n),o=m(E(s,k(i,n))/j(s)),u=C(n,A(s,o)),a=dn(i,u,e.r,t.r);if(a){var f=a.n;return o===0&&E(f,t.a_tangent)<0||o===1&&E(f,t.b_tangent)<0?pn:[a]}return pn},gn=0,yn=function(e,t){var n=0,r=e.valueOnAxis(t[0].n,t[0].d);if(r>0)return-1;for(var i=1;i<t.length;i++){var s=e.valueOnAxis(t[i].n,t[i].d);if(s>0)return-1;s>r&&(r=s,n=i)}return gn=r,n},bn=function(e,t,n,r){var i=[],s=e.tVerts;for(var o=0;o<s.length;o+=2){var a=s[o],f=s[o+1];t.containsVertPartial(a,f,L(n))&&i.push(new hn(new b(a,f),n,r,u(e.hashid,o)))}var l=t.tVerts;for(var o=0;o<l.length;o+=2){var a=l[o],f=l[o+1];e.containsVertPartial(a,f,n)&&i.push(new hn(new b(a,f),n,r,u(t.hashid,o)))}return i},wn=function(e,t,n,r){var i=[],s=e.tVerts;for(var o=0;o<s.length;o+=2){var a=s[o],f=s[o+1];t.containsVert(a,f)&&i.push(new hn(new b(a,f),n,r,u(e.hashid,o>>1)))}var l=t.tVerts;for(var o=0;o<l.length;o+=2){var a=l[o],f=l[o+1];e.containsVert(a,f)&&i.push(new hn(new b(a,f),n,r,u(t.hashid,o>>1)))}return i.length?i:bn(e,t,n,r)},En=function(e,t){var n=yn(t,e.tPlanes);if(n==-1)return pn;var r=gn,i=yn(e,t.tPlanes);if(i==-1)return pn;var s=gn;return r>s?wn(e,t,e.tPlanes[n].n,r):wn(e,t,L(t.tPlanes[i].n),s)},Sn=function(e,t,n){var r=E(t,e.ta)-e.r,i=E(t,e.tb)-e.r;return s(r,i)-n},xn=function(e,t,n,r,i){var s=O(t.tn,t.ta),o=O(t.tn,t.tb),a=A(t.tn,i),f=n.tVerts;for(var l=0;l<f.length;l+=2){var c=f[l],h=f[l+1];if(S(c,h,a.x,a.y)<E(t.tn,t.ta)*i+t.r){var p=M(t.tn.x,t.tn.y,c,h);s>=p&&p>=o&&e.push(new hn(new b(c,h),a,r,u(n.hashid,l)))}}},Tn=function(e,t){var n=[],r=t.tPlanes,i=r.length,s=E(e.tn,e.ta),o=t.valueOnAxis(e.tn,s)-e.r,a=t.valueOnAxis(L(e.tn),-s)-e.r;if(a>0||o>0)return pn;var f=0,l=Sn(e,r[0].n,r[0].d);if(l>0)return pn;for(var c=0;c<i;c++){var h=Sn(e,r[c].n,r[c].d);if(h>0)return pn;h>l&&(l=h,f=c)}var p=L(r[f].n),d=C(e.ta,A(p,e.r)),v=C(e.tb,A(p,e.r));t.containsVert(d.x,d.y)&&n.push(new hn(d,p,l,u(e.hashid,0))),t.containsVert(v.x,v.y)&&n.push(new hn(v,p,l,u(e.hashid,1)));if(o>=l||a>=l)o>a?xn(n,e,t,o,1
):xn(n,e,t,a,-1);if(n.length===0){var m=f*2,g=t.tVerts,y=new b(g[m],g[m+1]),w;if(w=dn(e.ta,y,e.r,0,n))return[w];if(w=dn(e.tb,y,e.r,0,n))return[w];var S=i*2,x=new b(g[(m+2)%S],g[(m+3)%S]);if(w=dn(e.ta,x,e.r,0,n))return[w];if(w=dn(e.tb,x,e.r,0,n))return[w]}return n},Nn=function(e,t){var n=t.tPlanes,r=0,i=E(n[0].n,e.tc)-n[0].d-e.r;for(var s=0;s<n.length;s++){var o=E(n[s].n,e.tc)-n[s].d-e.r;if(o>0)return pn;o>i&&(i=o,r=s)}var u=n[r].n,a=t.tVerts,f=a.length,l=r<<1,c=a[l],h=a[l+1],p=a[(l+2)%f],d=a[(l+3)%f],v=M(u.x,u.y,c,h),m=M(u.x,u.y,p,d),g=O(u,e.tc);if(g<m){var y=dn(e.tc,new b(p,d),e.r,0,y);return y?[y]:pn}if(g<v)return[new hn(k(e.tc,A(u,e.r+i/2)),L(u),i,0)];var y=dn(e.tc,new b(c,h),e.r,0,y);return y?[y]:pn};Et.prototype.collisionCode=0,xt.prototype.collisionCode=1,Nt.prototype.collisionCode=2,Et.prototype.collisionTable=[vn,mn,Nn],xt.prototype.collisionTable=[null,function(e,t){return pn},Tn],Nt.prototype.collisionTable=[null,null,En];var Cn=e.collideShapes=function(e,n){return t(e.collisionCode<=n.collisionCode,"Collided shapes must be sorted by type"),e.collisionTable[n.collisionCode](e,n)},kn=new rn,Ln=e.Space=function(){this.stamp=0,this.curr_dt=0,this.bodies=[],this.rousedBodies=[],this.sleepingComponents=[],this.staticShapes=new Bt(null),this.activeShapes=new Bt(this.staticShapes),this.arbiters=[],this.contactBuffersHead=null,this.cachedArbiters={},this.constraints=[],this.locked=0,this.collisionHandlers={},this.defaultHandler=kn,this.postStepCallbacks=[],this.iterations=10,this.gravity=w,this.damping=1,this.idleSpeedThreshold=0,this.sleepTimeThreshold=Infinity,this.collisionSlop=.1,this.collisionBias=Math.pow(.9,60),this.collisionPersistence=3,this.enableContactGraph=!1,this.staticBody=new At(Infinity,Infinity),this.staticBody.nodeIdleTime=Infinity,this.collideShapes=this.makeCollideShapes()};Ln.prototype.getCurrentTimeStep=function(){return this.curr_dt},Ln.prototype.setIterations=function(e){this.iterations=e},Ln.prototype.isLocked=function(){return this.locked};var An=function(e){t(!e.locked,"This addition/removal cannot be done safely during a call to cpSpaceStep()  or during a query. Put these calls into a post-step callback.")};Ln.prototype.addCollisionHandler=function(e,t,n,r,i,s){An(this),this.removeCollisionHandler(e,t);var o=new rn;o.a=e,o.b=t,n&&(o.begin=n),r&&(o.preSolve=r),i&&(o.postSolve=i),s&&(o.separate=s),this.collisionHandlers[u(e,t)]=o},Ln.prototype.removeCollisionHandler=function(e,t){An(this),delete this.collisionHandlers[u(e,t)]},Ln.prototype.setDefaultCollisionHandler=function(e,t,n,r){An(this);var i=new rn;e&&(i.begin=e),t&&(i.preSolve=t),n&&(i.postSolve=n),r&&(i.separate=r),this.defaultHandler=i},Ln.prototype.lookupHandler=function(e,t){return this.collisionHandlers[u(e,t)]||this.defaultHandler},Ln.prototype.addShape=function(e){var n=e.body;return n.isStatic()?this.addStaticShape(e):(t(!e.space,"This shape is already added to a space and cannot be added to another."),An(this),n.activate(),n.addShape(e),e.update(n.p,n.rot),this.activeShapes.insert(e,e.hashid),e.space=this,e)},Ln.prototype.addStaticShape=function(e){t(!e.space,"This shape is already added to a space and cannot be added to another."),An(this);var n=e.body;return n.addShape(e),e.update(n.p,n.rot),this.staticShapes.insert(e,e.hashid),e.space=this,e},Ln.prototype.addBody=function(e){return t(!e.isStatic(),"Static bodies cannot be added to a space as they are not meant to be simulated."),t(!e.space,"This body is already added to a space and cannot be added to another."),An(this),this.bodies.push(e),e.space=this,e},Ln.prototype.addConstraint=function(e){t(!e.space,"This shape is already added to a space and cannot be added to another."),An(this);var n=e.a,r=e.b;return n.activate(),r.activate(),this.constraints.push(e),e.next_a=n.constraintList,n.constraintList=e,e.next_b=r.constraintList,r.constraintList=e,e.space=this,e},Ln.prototype.filterArbiters=function(e,t){for(var n in this.cachedArbiters){var r=this.cachedArbiters[n];if(e===r.body_a&&(t===r.a||t===null)||e===r.body_b&&(t===r.b||t===null))t&&r.state!=="cached"&&r.callSeparate(this),r.unthread(),a(this.arbiters,r),delete this.cachedArbiters[n]}},Ln.prototype.removeShape=function(e){var n=e.body;n.isStatic()?this.removeStaticShape(e):(t(this.containsShape(e),"Cannot remove a shape that was not added to the space. (Removed twice maybe?)"),An(this),n.activate(),n.removeShape(e),this.filterArbiters(n,e),this.activeShapes.remove(e,e.hashid),e.space=null)},Ln.prototype.removeStaticShape=function(e){t(this.containsShape(e),"Cannot remove a static or sleeping shape that was not added to the space. (Removed twice maybe?)"),An(this);var n=e.body;n.isStatic()&&n.activateStatic(e),n.removeShape(e),this.filterArbiters(n,e),this.staticShapes.remove(e,e.hashid),e.space=null},Ln.prototype.removeBody=function(e){t(this.containsBody(e),"Cannot remove a body that was not added to the space. (Removed twice maybe?)"),An(this),e.activate(),a(this.bodies,e),e.space=null},Ln.prototype.removeConstraint=function(e){t(this.containsConstraint(e),"Cannot remove a constraint that was not added to the space. (Removed twice maybe?)"),An(this),e.a.activate(),e.b.activate(),a(this.constraints,e),e.a.removeConstraint(e),e.b.removeConstraint(e),e.space=null},Ln.prototype.containsShape=function(e){return e.space===this},Ln.prototype.containsBody=function(e){return e.space==this},Ln.prototype.containsConstraint=function(e){return e.space==this},Ln.prototype.uncacheArbiter=function(e){delete this.cachedArbiters[u(e.a.hashid,e.b.hashid)],a(this.arbiters,e)},Ln.prototype.eachBody=function(e){this.lock();var t=this.bodies;for(var n=0;n<t.length;n++)e(t[n]);var r=this.sleepingComponents;for(var n=0;n<r.length;n++){var i=r[n],s=i;while(s){var o=s.nodeNext;e(s),s=o}}this.unlock(!0)},Ln.prototype.eachShape=function(e){this.lock(),this.activeShapes.each(e),this.staticShapes.each(e),this.unlock(!0)},Ln.prototype.eachConstraint=function(e){this.lock();var t=this.constraints;for(var n=0;n<t.length;n++)e(t[n]);this.unlock(!0)},Ln.prototype.reindexStatic=function(){t(!this.locked,"You cannot manually reindex objects while the space is locked. Wait until the current query or step is complete."),this.staticShapes.each(function(e){var t=e.body;e.update(t.p,t.rot)}),this.staticShapes.reindex()},Ln.prototype.reindexShape=function(e){t(!this.locked,"You cannot manually reindex objects while the space is locked. Wait until the current query or step is complete.");var n=e.body;e.update(n.p,n.rot),this.activeShapes.reindexObject(e,e.hashid),this.staticShapes.reindexObject(e,e.hashid)},Ln.prototype.reindexShapesForBody=function(e){for(var t=e.shapeList;t;t=t.next)this.reindexShape(t)},Ln.prototype.useSpatialHash=function(e,t){throw new Error("Spatial Hash not implemented.");var n,r},Ln.prototype.activateBody=function(e){t(!e.isRogue(),"Internal error: Attempting to activate a rogue body.");if(this.locked)this.rousedBodies.indexOf(e)===-1&&this.rousedBodies.push(e);else{this.bodies.push(e);for(var n=0;n<e.shapeList.length;n++){var r=e.shapeList[n];this.staticShapes.remove(r,r.hashid),this.activeShapes.insert(r,r.hashid)}for(var i=e.arbiterList;i;i=i.next(e)){var s=i.body_a;if(e===s||s.isStatic()){var o=i.a,a=i.b;this.cachedArbiters[u(o.hashid,a.hashid)]=i,i.stamp=this.stamp,i.handler=this.lookupHandler(o.collision_type,a.collision_type),this.arbiters.push(i)}}for(var f=e.constraintList;f;f=f.nodeNext){var s=f.a;(e===s||s.isStatic())&&this.constraints.push(f)}}},Ln.prototype.deactivateBody=function(e){t(!e.isRogue(),"Internal error: Attempting to deactivate a rogue body."),a(this.bodies,e);for(var n=0;n<e.shapeList.length;n++){var r=e.shapeList[n];this.activeShapes.remove(r,r.hashid),this.staticShapes.insert(r,r.hashid)}for(var i=e.arbiterList;i;i=i.next(e)){var s=i.body_a;(e===s||s.isStatic())&&this.uncacheArbiter(i)}for(var o=e.constraintList;o;o=o.nodeNext){var s=o.a;(e===s||s.isStatic())&&a(this.constraints,o)}};var On=function(e){return e?e.nodeRoot:null},Mn=function(e){if(!e||!e.isSleeping(e))return;t(!e.isRogue(),"Internal Error: componentActivate() called on a rogue body.");var n=e.space,r=e;while(r){var i=r.nodeNext;r.nodeIdleTime=0,r.nodeRoot=null,r.nodeNext=null,n.activateBody(r),r=i}a(n.sleepingComponents,e)};At.prototype.activate=function(){this.isRogue()||(this.nodeIdleTime=0,Mn(On(this)))},At.prototype.activateStatic=function(e){t(this.isStatic(),"Body.activateStatic() called on a non-static body.");for(var n=this.arbiterList;n;n=n.next(this))(!e||e==n.a||e==n.b)&&(n.body_a==this?n.body_b:n.body_a).activate()},At.prototype.pushArbiter=function(e){n((e.body_a===this?e.thread_a_next:e.thread_b_next)===null,"Internal Error: Dangling contact graph pointers detected. (A)"),n((e.body_a===this?e.thread_a_prev:e.thread_b_prev)===null,"Internal Error: Dangling contact graph pointers detected. (B)");var t=this.arbiterList;n(t===null||(t.body_a===this?t.thread_a_prev:t.thread_b_prev)===null,"Internal Error: Dangling contact graph pointers detected. (C)"),e.body_a===this?e.thread_a_next=t:e.thread_b_next=t,t&&(t.body_a===this?t.thread_a_prev=e:t.thread_b_prev=e),this.arbiterList=e};var _n=function(e,t){t.nodeRoot=e,t!==e&&(t.nodeNext=e.nodeNext,e.nodeNext=t)},Dn=function(e,t){if(!t.isRogue()){var r=On(t);if(r==null){_n(e,t);for(var i=t.arbiterList;i;i=i.next(t))Dn(e,t==i.body_a?i.body_b:i.body_a);for(var s=t.constraintList;s;s=s.next(t))Dn(e,t==s.a?s.b:s.a)}else n(r===e,"Internal Error: Inconsistency detected in the contact graph.")}},Pn=function(e,t){for(var n=e;n;n=n.nodeNext)if(n.nodeIdleTime<t)return!0;return!1};Ln.prototype.processComponents=function(e){var t=this.sleepTimeThreshold!==Infinity,r=this.bodies;for(var i=0;i<r.length;i++){var s=r[i];n(s.nodeNext===null,"Internal Error: Dangling next pointer detected in contact graph."),n(s.nodeRoot===null,"Internal Error: Dangling root pointer detected in contact graph.")}if(t){var o=this.idleSpeedThreshold,u=o?o*o:j(this.gravity)*e*e;for(var i=0;i<r.length;i++){var s=r[i],a=u?s.m*u:0;s.nodeIdleTime=s.kineticEnergy()>a?0:s.nodeIdleTime+e}}var f=this.arbiters;for(var i=0,l=f.length;i<l;i++){var c=f[i],h=c.body_a,p=c.body_b;t&&((p.isRogue()&&!p.isStatic()||h.isSleeping())&&h.activate(),(h.isRogue()&&!h.isStatic()||p.isSleeping())&&p.activate()),h.pushArbiter(c),p.pushArbiter(c)}if(t){var d=this.constraints;for(var i=0;i<d.length;i++){var v=d[i],h=v.a,p=v.b;p.isRogue()&&!p.isStatic()&&h.activate(),h.isRogue()&&!h.isStatic()&&p.activate()}for(var i=0;i<r.length;){var s=r[i];if(On(s)===null){Dn(s,s);if(!Pn(s,this.sleepTimeThreshold)){this.sleepingComponents.push(s);for(var m=s;m;m=m.nodeNext)this.deactivateBody(m);continue}}i++,s.nodeRoot=null,s.nodeNext=null}}},At.prototype.sleep=function(){this.sleepWithGroup(null)},At.prototype.sleepWithGroup=function(e){t(!this.isStatic()&&!this.isRogue(),"Rogue and static bodies cannot be put to sleep.");var n=this.space;t(n,"Cannot put a rogue body to sleep."),t(!n.locked,"Bodies cannot be put to sleep during a query or a call to cpSpaceStep(). Put these calls into a post-step callback."),t(e===null||e.isSleeping(),"Cannot use a non-sleeping body as a group identifier.");if(this.isSleeping()){t(On(this)===On(e),"The body is already sleeping and it's group cannot be reassigned.");return}for(var r=0;r<this.shapeList.length;r++)this.shapeList[r].update(this.p,this.rot);n.deactivateBody(this);if(e){var i=On(e);this.nodeRoot=i,this.nodeNext=i.nodeNext,this.nodeIdleTime=0,i.nodeNext=this}else this.nodeRoot=this,this.nodeNext=null,this.nodeIdleTime=0,n.sleepingComponents.push(this);a(n.bodies,this)},Ln.prototype.activateShapesTouchingShape=function(e){this.sleepTimeThreshold!==Infinity&&this.shapeQuery(e,function(e,t){e.body.activate()})},Ln.prototype.pointQuery=function(e,t,n,r){var i=function(i){(!i.group||n!==i.group)&&t&i.layers&&i.pointQuery(e)&&r(i)},s=new Z(e.x,e.y,e.x,e.y);this.lock(),this.activeShapes.query(s,i),this.staticShapes.query(s,i),this.unlock(!0)},Ln.prototype.pointQueryFirst=function(e,t,n){var r=null;return this.pointQuery(e,t,n,function(e){e.sensor||(r=e)}),r},Ln.prototype.nearestPointQuery=function(e,t,n,r,i){var s=function(s){if((!s.group||r!==s.group)&&n&s.layers){var o=s.nearestPointQuery(e);o.d<t&&i(s,o.d,o.p)}},o=et(e,t);this.lock(),this.activeShapes.query(o,s),this.staticShapes.query(o,s),this.unlock(!0)},Ln.prototype.nearestPointQueryNearest=function(e,t,n,r){var i,s=function(s){if((!s.group||r!==s.group)&&n&s.layers&&!s.sensor){var o=s.nearestPointQuery(e);o.d<t&&(!i||o.d<i.d)&&(i=o)}},o=et(e,t);return this.activeShapes.query(o,s),this.staticShapes.query(o,s),i},Ln.prototype.segmentQuery=function(e,t,n,r,i){var s=function(s){var o;return(!s.group||r!==s.group)&&n&s.layers&&(o=s.segmentQuery(e,t))&&i(s,o.t,o.n),1};this.lock(),this.staticShapes.segmentQuery(e,t,1,s),this.activeShapes.segmentQuery(e,t,1,s),this.unlock(!0)},Ln.prototype.segmentQueryFirst=function(e,t,n,r){var i=null,s=function(s){var o;return(!s.group||r!==s.group)&&n&s.layers&&!s.sensor&&(o=s.segmentQuery(e,t))&&(i===null||o.t<i.t)&&(i=o),i?i.t:1};return this.staticShapes.segmentQuery(e,t,1,s),this.activeShapes.segmentQuery(e,t,i?i.t:1,s),i},Ln.prototype.bbQuery=function(e,t,n,r){var i=function(i){(!i.group||n!==i.group)&&t&i.layers&&nt(e,i.bb_l,i.bb_b,i.bb_r,i.bb_t)&&r(i)};this.lock(),this.activeShapes.query(e,i),this.staticShapes.query(e,i),this.unlock(!0)},Ln.prototype.shapeQuery=function(e,t){var n=e.body;n&&e.update(n.p,n.rot);var r=new Z(e.bb_l,e.bb_b,e.bb_r,e.bb_t),i=!1,s=function(n){var r=e;if(r.group&&r.group===n.group||!(r.layers&n.layers)||r===n)return;var s;if(r.collisionCode<=n.collisionCode)s=Cn(r,n);else{s=Cn(n,r);for(var o=0;o<s.length;o++)s[o].n=L(s[o].n)}if(s.length){i=!r.sensor&&!n.sensor;if(t){var u=new Array(s.length);for(var o=0;o<s.length;o++)u[o]=new un(s[o].p,s[o].n,s[o].dist);t(n,u)}}};return this.lock(),this.activeShapes.query(r,s),this.staticShapes.query(r,s),this.unlock(!0),i},Ln.prototype.addPostStepCallback=function(e){n(this.locked,"Adding a post-step callback when the space is not locked is unnecessary. Post-step callbacks will not called until the end of the next call to cpSpaceStep() or the next query."),this.postStepCallbacks.push(e)},Ln.prototype.runPostStepCallbacks=function(){for(var e=0;e<this.postStepCallbacks.length;e++)this.postStepCallbacks[e]();this.postStepCallbacks=[]},Ln.prototype.lock=function(){this.locked++},Ln.prototype.unlock=function(e){this.locked--,t(this.locked>=0,"Internal Error: Space lock underflow.");if(this.locked===0&&e){var n=this.rousedBodies;for(var r=0;r<n.length;r++)this.activateBody(n[r]);n.length=0,this.runPostStepCallbacks()}},Ln.prototype.makeCollideShapes=function(){var e=this;return function(t,n){var r=e;if(!(t.bb_l<=n.bb_r&&n.bb_l<=t.bb_r&&t.bb_b<=n.bb_t&&n.bb_b<=t.bb_t)||t.body===n.body||t.group&&t.group===n.group||!(t.layers&n.layers))return;var i=r.lookupHandler(t.collision_type,n.collision_type),s=t.sensor||n.sensor;if(s&&i===kn)return;if(t.collisionCode>n.collisionCode){var o=t;t=n,n=o}var a=Cn(t,n);if(a.length===0)return;var f=u(t.hashid,n.hashid),l=r.cachedArbiters[f];l||(l=r.cachedArbiters[f]=new on(t,n)),l.update(a,i,t,n),l.state=="first coll"&&!i.begin(l,r)&&l.ignore(),l.state!=="ignore"&&i.preSolve(l,r)&&!s?r.arbiters.push(l):(l.contacts=null,l.state!=="ignore"&&(l.state="normal")),l.stamp=r.stamp}},Ln.prototype.arbiterSetFilter=function(e){var t=this.stamp-e.stamp,n=e.body_a,r=e.body_b;return(n.isStatic()||n.isSleeping())&&(r.isStatic()||r.isSleeping())?!0:(t>=1&&e.state!="cached"&&(e.callSeparate(this),e.state="cached"),t>=this.collisionPersistence?(e.contacts=null,!1):!0)};var Hn=function(e){var t=e.body;e.update(t.p,t.rot)};Ln.prototype.step=function(e){if(e===0)return;t(w.x===0&&w.y===0,"vzero is invalid"),this.stamp++;var n=this.curr_dt;this.curr_dt=e;var r,i,s,o=this.bodies,u=this.constraints,a=this.arbiters;for(r=0;r<a.length;r++){var f=a[r];f.state="normal",!f.body_a.isSleeping()&&!f.body_b.isSleeping()&&f.unthread()}a.length=0,this.lock();for(r=0;r<o.length;r++)o[r].position_func(e);this.activeShapes.each(Hn),this.activeShapes.reindexQuery(this.collideShapes),this.unlock(!1),this.processComponents(e),this.lock();for(s in this.cachedArbiters)this.arbiterSetFilter(this.cachedArbiters[s])||delete this.cachedArbiters[s];var l=this.collisionSlop,c=1-Math.pow(this.collisionBias,e);for(r=0;r<a.length;r++)a[r].preStep(e,l,c);for(r=0;r<u.length;r++){var h=u[r];h.preSolve(this),h.preStep(e)}var p=Math.pow(this.damping,e),d=this.gravity;for(r=0;r<o.length;r++)o[r].velocity_func(d,p,e);var v=n===0?0:e/n;for(r=0;r<a.length;r++)a[r].applyCachedImpulse(v);for(r=0;r<u.length;r++)u[r].applyCachedImpulse(v);for(r=0;r<this.iterations;r++){for(i=0;i<a.length;i++)a[i].applyImpulse();for(i=0;i<u.length;i++)u[i].applyImpulse()}for(r=0;r<u.length;r++)u[r].postSolve(this);for(r=0;r<a.length;r++)a[r].handler.postSolve(a[r],this);this.unlock(!0)};var Bn=function(e,t,n,r){var i=e.vx+ -n.y*e.w,s=e.vy+n.x*e.w,o=t.vx+ -r.y*t.w,u=t.vy+r.x*t.w;return new b(o-i,u-s)},jn=function(e,t,n,r,i){var s=e.vx+ -n.y*e.w,o=e.vy+n.x*e.w,u=t.vx+ -r.y*t.w,a=t.vy+r.x*t.w;return S(u-s,a-o,i.x,i.y)},Fn=function(e,t,n,r){e.vx+=t*e.m_inv,e.vy+=n*e.m_inv,e.w+=e.i_inv*(r.x*n-r.y*t)},In=function(e,t,n,r,i,s){Fn(e,-i,-s,n),Fn(t,i,s,r)},qn=function(e,t,n,r){e.v_biasx+=t*e.m_inv,e.v_biasy+=n*e.m_inv,e.w_bias+=e.i_inv*M(r.x,r.y,t,n)},Rn=function(e,t,n){var r=O(t,n);return e.m_inv+e.i_inv*r*r},Un=function(e,t,r,i,s){var o=Rn(e,r,s)+Rn(t,i,s);return n(o!==0,"Unsolvable collision or constraint."),o},zn=function(e,t,r,i,s,o){var u,a,f,l,c=e.m_inv+t.m_inv;u=c,a=0,f=0,l=c;var h=e.i_inv,p=r.x*r.x*h,d=r.y*r.y*h,v=-r.x*r.y*h;u+=d,a+=v,f+=v,l+=p;var m=t.i_inv,g=i.x*i.x*m,y=i.y*i.y*m,b=-i.x*i.y*m;u+=y,a+=b,f+=b,l+=g;var w=u*l-a*f;n(w!==0,"Unsolvable constraint.");var E=1/w;s.x=l*E,s.y=-a*E,o.x=-f*E,o.y=u*E},Wn=function(e,t,n){return new b(E(e,t),E(e,n))},Xn=function(e,t){return 1-Math.pow(e,t)},Vn=e.Constraint=function(e,t){this.a=e,this.b=t,this.space=null,this.next_a=null,this.next_b=null,this.maxForce=Infinity,this.errorBias=Math.pow(.9,60),this.maxBias=Infinity};Vn.prototype.activateBodies=function(){this.a&&this.a.activate(),this.b&&this.b.activate()},Vn.prototype.preStep=function(e){},Vn.prototype.applyCachedImpulse=function(e){},Vn.prototype.applyImpulse=function(){},Vn.prototype.getImpulse=function(){return 0},Vn.prototype.preSolve=function(e){},Vn.prototype.postSolve=function(e){},Vn.prototype.next=function(e){return this.a===e?this.next_a:this.next_b};var $n=e.PinJoint=function(e,t,r,i){Vn.call(this,e,t),this.anchr1=r,this.anchr2=i;var s=e?C(e.p,H(r,e.rot)):r,o=t?C(t.p,H(i,t.rot)):i;this.dist=x(k(o,s)),n(this.dist>0,"You created a 0 length pin joint. A pivot joint will be much more stable."),this.r1=this.r2=null,this.n=null,this.nMass=0,this.jnAcc=this.jnMax=0,this.bias=0};$n.prototype=Object.create(Vn.prototype),$n.prototype.preStep=function(e){var t=this.a,n=this.b;this.r1=H(this.anchr1,t.rot),this.r2=H(this.anchr2,n.rot);var r=k(C(n.p,this.r2),C(t.p,this.r1)),i=x(r);this.n=A(r,1/(i?i:Infinity)),this.nMass=1/Un(t,n,this.r1,this.r2,this.n);var s=this.maxBias;this.bias=v(-Xn(this.errorBias,e)*(i-this.dist)/e,-s,s),this.jnMax=this.maxForce*e},$n.prototype.applyCachedImpulse=function(e){var t=A(this.n,this.jnAcc*e);In(this.a,this.b,this.r1,this.r2,t.x,t.y)},$n.prototype.applyImpulse=function(){var e=this.a,t=this.b,n=this.n,r=jn(e,t,this.r1,this.r2,n),i=(this.bias-r)*this.nMass,s=this.jnAcc;this.jnAcc=v(s+i,-this.jnMax,this.jnMax),i=this.jnAcc-s,In(e,t,this.r1,this.r2,n.x*i,n.y*i)},$n.prototype.getImpulse=function(){return Math.abs(this.jnAcc)};var Jn=e.SlideJoint=function(e,t,n,r,i,s){Vn.call(this,e,t),this.anchr1=n,this.anchr2=r,this.min=i,this.max=s,this.r1=this.r2=this.n=null,this.nMass=0,this.jnAcc=this.jnMax=0,this.bias=0};Jn.prototype=Object.create(Vn.prototype),Jn.prototype.preStep=function(e){var t=this.a,n=this.b;this.r1=H(this.anchr1,t.rot),this.r2=H(this.anchr2,n.rot);var r=k(C(n.p,this.r2),C(t.p,this.r1)),i=x(r),s=0;i>this.max?(s=i-this.max,this.n=R(r)):i<this.min?(s=this.min-i,this.n=L(R(r))):(this.n=w,this.jnAcc=0),this.nMass=1/Un(t,n,this.r1,this.r2,this.n);var o=this.maxBias;this.bias=v(-Xn(this.errorBias,e)*s/e,-o,o),this.jnMax=this.maxForce*e},Jn.prototype.applyCachedImpulse=function(e){var t=this.jnAcc*e;In(this.a,this.b,this.r1,this.r2,this.n.x*t,this.n.y*t)},Jn.prototype.applyImpulse=function(){if(this.n.x===0&&this.n.y===0)return;var e=this.a,t=this.b,n=this.n,r=this.r1,i=this.r2,s=Bn(e,t,r,i),o=E(s,n),u=(this.bias-o)*this.nMass,a=this.jnAcc;this.jnAcc=v(a+u,-this.jnMax,0),u=this.jnAcc-a,In(e,t,this.r1,this.r2,n.x*u,n.y*u)},Jn.prototype.getImpulse=function(){return Math.abs(this.jnAcc)};var Kn=e.PivotJoint=function(e,t,n,r){Vn.call(this,e,t);if(typeof r=="undefined"){var i=n;n=e?e.world2Local(i):i,r=t?t.world2Local(i):i}this.anchr1=n,this.anchr2=r,this.r1=this.r2=w,this.k1=new b(0,0),this.k2=new b(0,0),this.jAcc=w,this.jMaxLen=0,this.bias=w};Kn.prototype=Object.create(Vn.prototype),Kn.prototype.preStep=function(e){var t=this.a,n=this.b;this.r1=H(this.anchr1,t.rot),this.r2=H(this.anchr2,n.rot),zn(t,n,this.r1,this.r2,this.k1,this.k2),this.jMaxLen=this.maxForce*e;var r=k(C(n.p,this.r2),C(t.p,this.r1));this.bias=U(A(r,-Xn(this.errorBias,e)/e),this.maxBias)},Kn.prototype.applyCachedImpulse=function(e){In(this.a,this.b,this.r1,this.r2,this.jAcc.x*e,this.jAcc.y*e)},Kn.prototype.applyImpulse=function(){var e=this.a,t=this.b,n=this.r1,r=this.r2,i=Bn(e,t,n,r),s=Wn(k(this.bias,i),this.k1,this.k2),o=this.jAcc;this.jAcc=U(C(this.jAcc,s),this.jMaxLen),In(e,t,this.r1,this.r2,this.jAcc.x-o.x,this.jAcc.y-o.y)},Kn.prototype.getImpulse=function(){return x(this.jAcc)};var Qn=e.GrooveJoint=function(e,t,n,r,i){Vn.call(this,e,t),this.grv_a=n,this.grv_b=r,this.grv_n=_(q(k(r,n))),this.anchr2=i,this.grv_tn=null,this.clamp=0,this.r1=this.r2=null,this.k1=new b(0,0),this.k2=new b(0,0),this.jAcc=w,this.jMaxLen=0,this.bias=null};Qn.prototype=Object.create(Vn.prototype),Qn.prototype.preStep=function(e){var t=this.a,n=this.b,r=t.local2World(this.grv_a),i=t.local2World(this.grv_b),s=H(this.grv_n,t.rot),o=E(r,s);this.grv_tn=s,this.r2=H(this.anchr2,n.rot);var u=O(C(n.p,this.r2),s);u<=O(r,s)?(this.clamp=1,this.r1=k(r,t.p)):u>=O(i,s)?(this.clamp=-1,this.r1=k(i,t.p)):(this.clamp=0,this.r1=k(C(A(_(s),-u),A(s,o)),t.p)),zn(t,n,this.r1,this.r2,this.k1,this.k2),this.jMaxLen=this.maxForce*e;var a=k(C(n.p,this.r2),C(t.p,this.r1));this.bias=U(A(a,-Xn(this.errorBias,e)/e),this.maxBias)},Qn.prototype.applyCachedImpulse=function(e){In(this.a,this.b,this.r1,this.r2,this.jAcc.x*e,this.jAcc.y*e)},Qn.prototype.grooveConstrain=function(e){var t=this.grv_tn,n=this.clamp*O(e,t)>0?e:P(e,t);return U(n,this.jMaxLen)},Qn.prototype.applyImpulse=function(){var e=this.a,t=this.b,n=this.r1,r=this.r2,i=Bn(e,t,n,r),s=Wn(k(this.bias,i),this.k1,this.k2),o=this.jAcc;this.jAcc=this.grooveConstrain(C(o,s)),In(e,t,this.r1,this.r2,this.jAcc.x-o.x,this.jAcc.y-o.y)},Qn.prototype.getImpulse=function(){return x(this.jAcc)},Qn.prototype.setGrooveA=function(e){this.grv_a=e,this.grv_n=_(q(k(this.grv_b,e))),this.activateBodies()},Qn.prototype.setGrooveB=function(e){this.grv_b=e,this.grv_n=_(q(k(e,this.grv_a))),this.activateBodies()};var Gn=function(e,t){return(e.restLength-t)*e.stiffness},Yn=e.DampedSpring=function(e,t,n,r,i,s,o){Vn.call(this,e,t),this.anchr1=n,this.anchr2=r,this.restLength=i,this.stiffness=s,this.damping=o,this.springForceFunc=Gn,this.target_vrn=this.v_coef=0,this.r1=this.r2=null,this.nMass=0,this.n=null};Yn.prototype=Object.create(Vn.prototype),Yn.prototype.preStep=function(e){var t=this.a,r=this.b;this.r1=H(this.anchr1,t.rot),this.r2=H(this.anchr2,r.rot);var i=k(C(r.p,this.r2),C(t.p,this.r1)),s=x(i);this.n=A(i,1/(s?s:Infinity));var o=Un(t,r,this.r1,this.r2,this.n);n(o!==0,"Unsolvable this."),this.nMass=1/o,this.target_vrn=0,this.v_coef=1-Math.exp(-this.damping*e*o);var u=this.springForceFunc(this,s);In(t,r,this.r1,this.r2,this.n.x*u*e,this.n.y*u*e)},Yn.prototype.applyCachedImpulse=function(e){},Yn.prototype.applyImpulse=function(){var e=this.a,t=this.b,n=this.n,r=this.r1,i=this.r2,s=jn(e,t,r,i,n),o=(this.target_vrn-s)*this.v_coef;this.target_vrn=s+o,o*=this.nMass,In(e,t,this.r1,this.r2,this.n.x*o,this.n.y*o)},Yn.prototype.getImpulse=function(){return 0};var Zn=function(e,t){return(t-e.restAngle)*e.stiffness},er=e.DampedRotarySpring=function(e,t,n,r,i){Vn.call(this,e,t),this.restAngle=n,this.stiffness=r,this.damping=i,this.springTorqueFunc=Zn,this.target_wrn=0,this.w_coef=0,this.iSum=0};er.prototype=Object.create(Vn.prototype),er.prototype.preStep=function(e){var t=this.a,r=this.b,i=t.i_inv+r.i_inv;n(i!==0,"Unsolvable spring."),this.iSum=1/i,this.w_coef=1-Math.exp(-this.damping*e*i),this.target_wrn=0;var s=this.springTorqueFunc(this,t.a-r.a)*e;t.w-=s*t.i_inv,r.w+=s*r.i_inv},er.prototype.applyImpulse=function(){var e=this.a,t=this.b,n=e.w-t.w,r=(this.target_wrn-n)*this.w_coef;this.target_wrn=n+r;var i=r*this.iSum;e.w+=i*e.i_inv,t.w-=i*t.i_inv};var tr=e.RotaryLimitJoint=function(e,t,n,r){Vn.call(this,e,t),this.min=n,this.max=r,this.jAcc=0,this.iSum=this.bias=this.jMax=0};tr.prototype=Object.create(Vn.prototype),tr.prototype.preStep=function(e){var t=this.a,n=this.b,r=n.a-t.a,i=0;r>this.max?i=this.max-r:r<this.min&&(i=this.min-r),this.iSum=1/(1/t.i+1/n.i);var s=this.maxBias;this.bias=v(-Xn(this.errorBias,e)*i/e,-s,s),this.jMax=this.maxForce*e,this.bias||(this.jAcc=0)},tr.prototype.applyCachedImpulse=function(e){var t=this.a,n=this.b,r=this.jAcc*e;t.w-=r*t.i_inv,n.w+=r*n.i_inv},tr.prototype.applyImpulse=function(){if(!this.bias)return;var e=this.a,t=this.b,n=t.w-e.w,r=-(this.bias+n)*this.iSum,i=this.jAcc;this.bias<0?this.jAcc=v(i+r,0,this.jMax):this.jAcc=v(i+r,-this.jMax,0),r=this.jAcc-i,e.w-=r*e.i_inv,t.w+=r*t.i_inv},tr.prototype.getImpulse=function(){return Math.abs(joint.jAcc)};var nr=e.RatchetJoint=function(e,t,n,r){Vn.call(this,e,t),this.angle=0,this.phase=n,this.ratchet=r,this.angle=(t?t.a:0)-(e?e.a:0),this.iSum=this.bias=this.jAcc=this.jMax=0};nr.prototype=Object.create(Vn.prototype),nr.prototype.preStep=function(e){var t=this.a,n=this.b,r=this.angle,i=this.phase,s=this.ratchet,o=n.a-t.a,u=r-o,a=0;u*s>0?a=u:this.angle=Math.floor((o-i)/s)*s+i,this.iSum=1/(t.i_inv+n.i_inv);var f=this.maxBias;this.bias=v(-Xn(this.errorBias,e)*a/e,-f,f),this.jMax=this.maxForce*e,this.bias||(this.jAcc=0)},nr.prototype.applyCachedImpulse=function(e){var t=this.a,n=this.b,r=this.jAcc*e;t.w-=r*t.i_inv,n.w+=r*n.i_inv},nr.prototype.applyImpulse=function(){if(!this.bias)return;var e=this.a,t=this.b,n=t.w-e.w,r=this.ratchet,i=-(this.bias+n)*this.iSum,s=this.jAcc;this.jAcc=v((s+i)*r,0,this.jMax*Math.abs(r))/r,i=this.jAcc-s,e.w-=i*e.i_inv,t.w+=i*t.i_inv},nr.prototype.getImpulse=function(e){return Math.abs(e.jAcc)};var rr=e.GearJoint=function(e,t,n,r){Vn.call(this,e,t),this.phase=n,this.ratio=r,this.ratio_inv=1/r,this.jAcc=0,this.iSum=this.bias=this.jMax=0};rr.prototype=Object.create(Vn.prototype),rr.prototype.preStep=function(e){var t=this.a,n=this.b;this.iSum=1/(t.i_inv*this.ratio_inv+this.ratio*n.i_inv);var r=this.maxBias;this.bias=v(-Xn(this.errorBias,e)*(n.a*this.ratio-t.a-this.phase)/e,-r,r),this.jMax=this.maxForce*e},rr.prototype.applyCachedImpulse=function(e){var t=this.a,n=this.b,r=this.jAcc*e;t.w-=r*t.i_inv*this.ratio_inv,n.w+=r*n.i_inv},rr.prototype.applyImpulse=function(){var e=this.a,t=this.b,n=t.w*this.ratio-e.w,r=(this.bias-n)*this.iSum,i=this.jAcc;this.jAcc=v(i+r,-this.jMax,this.jMax),r=this.jAcc-i,e.w-=r*e.i_inv*this.ratio_inv,t.w+=r*t.i_inv},rr.prototype.getImpulse=function(){return Math.abs(this.jAcc)},rr.prototype.setRatio=function(e){this.ratio=e,this.ratio_inv=1/e,this.activateBodies()};var ir=e.SimpleMotor=function(e,t,n){Vn.call(this,e,t),this.rate=n,this.jAcc=0,this.iSum=this.jMax=0};ir.prototype=Object.create(Vn.prototype),ir.prototype.preStep=function(e){this.iSum=1/(this.a.i_inv+this.b.i_inv),this.jMax=this.maxForce*e},ir.prototype.applyCachedImpulse=function(e){var t=this.a,n=this.b,r=this.jAcc*e;t.w-=r*t.i_inv,n.w+=r*n.i_inv},ir.prototype.applyImpulse=function(){var e=this.a,t=this.b,n=t.w-e.w+this.rate,r=-n*this.iSum,i=this.jAcc;this.jAcc=v(i+r,-this.jMax,this.jMax),r=this.jAcc-i,e.w-=r*e.i_inv,t.w+=r*t.i_inv},ir.prototype.getImpulse=function(){return Math.abs(this.jAcc)}})();