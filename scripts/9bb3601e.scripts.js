(function(){Object.create=Object.create||function(a){function b(){}return b.prototype=a,new b};var a;typeof exports=="undefined"?(a={},typeof window=="object"&&(window.cp=a)):a=exports;var b=function(a,b){if(!a)throw new Error("Assertion failed: "+b)},c=function(a,b){!a&&console&&console.warn&&(console.warn("ASSERTION FAILED: "+b),console.trace&&console.trace())},d=function(a,b){return a<b?a:b},e=function(a,b){return a>b?a:b},f,g;typeof window=="object"&&window.navigator.userAgent.indexOf("Firefox")>-1?(f=Math.min,g=Math.max):(f=d,g=e);var h=function(a,b){return a<b?a+" "+b:b+" "+a},i=function(a,b){for(var c=0;c<a.length;c++)if(a[c]===b){a[c]=a[a.length-1],a.length--;return}},j=function(a,b,c){var d=O(b,c),e=B(I(d,O(a,c))/Y(d));return N(c,Q(d,e))},k=function(a,b,c,d,e,f){var g=c-e,h=d-f,i=B(J(g,h,a-e,b-f)/Z(g,h));return new G(e+g*i,f+h*i)},l=a.momentForCircle=function(a,b,c,d){return a*(.5*(b*b+c*c)+Y(d))},m=a.areaForCircle=function(a,b){return Math.PI*Math.abs(a*a-b*b)},n=a.momentForSegment=function(a,b,c){var d=Q(N(b,c),.5);return a*(eb(c,b)/12+Y(d))},o=a.areaForSegment=function(a,b,c){return c*(Math.PI*c+2*db(a,b))},p=a.momentForPoly=function(a,b,c){var d=0,e=0,f=b.length;for(var g=0;g<f;g+=2){var h=b[g]+c.x,i=b[g+1]+c.y,j=b[(g+2)%f]+c.x,k=b[(g+3)%f]+c.y,l=S(j,k,h,i),m=J(h,i,h,i)+J(h,i,j,k)+J(j,k,j,k);d+=l*m,e+=l}return a*d/(6*e)},q=a.areaForPoly=function(a){var b=0;for(var c=0,d=a.length;c<d;c+=2)b+=R(new G(a[c],a[c+1]),new G(a[(c+2)%d],a[(c+3)%d]));return-b/2},r=a.centroidForPoly=function(a){var b=0,c=new G(0,0);for(var d=0,e=a.length;d<e;d+=2){var f=new G(a[d],a[d+1]),g=new G(a[(d+2)%e],a[(d+3)%e]),h=R(f,g);b+=h,c=N(c,Q(N(f,g),h))}return Q(c,1/(3*b))},s=a.recenterPoly=function(a){var b=r(a);for(var c=0;c<a.length;c+=2)a[c]-=b.x,a[c+1]-=b.y},t=a.momentForBox=function(a,b,c){return a*(b*b+c*c)/12},u=a.momentForBox2=function(a,b){return width=b.r-b.l,height=b.t-b.b,offset=Q([b.l+b.r,b.b+b.t],.5),t(a,width,height)+a*Y(offset)},v=a.loopIndexes=function(a){var b=0,c=0,d,e,f,g;d=f=a[0],e=g=a[1];var h=a.length>>1;for(var i=1;i<h;i++){var j=a[i*2],k=a[i*2+1];if(j<d||j==d&&k<e)d=j,e=k,b=i;else if(j>f||j==f&&k>g)f=j,g=k,c=i}return[b,c]},w=function(a,b,c){var d=a[b*2];a[b*2]=a[c*2],a[c*2]=d,d=a[b*2+1],a[b*2+1]=a[c*2+1],a[c*2+1]=d},x=function(a,b,c,d,e,f){if(c===0)return 0;var g=0,h=b,i=O(e,d),j=f*K(i),k=b;for(var l=b+c-1;k<=l;){var m=new G(a[k*2],a[k*2+1]),n=R(i,O(m,d));n>j?(n>g&&(g=n,h=k),k++):(w(a,k,l),l--)}return h!=b&&w(a,b,h),k-b},y=function(a,b,c,d,e,f,g,h){if(d<0)return 0;if(d==0)return b[h*2]=f.x,b[h*2+1]=f.y,1;var i=x(b,c,d,e,f,a),j=new G(b[c*2],b[c*2+1]),k=y(a,b,c+1,i-1,e,j,f,h),l=h+k++;b[l*2]=f.x,b[l*2+1]=f.y;var m=x(b,c+i,d-i,f,g,a),n=new G(b[(c+i)*2],b[(c+i)*2+1]);return k+y(a,b,c+i+1,m-1,f,n,g,h+k)},z=a.convexHull=function(a,b,d){if(b)for(var e=0;e<a.length;e++)b[e]=a[e];else b=a;var f=v(a),g=f[0],h=f[1];if(g==h)return b.length=2,b;w(b,0,g),w(b,1,h==0?g:h);var i=new G(b[0],b[1]),j=new G(b[2],b[3]),k=a.length>>1,l=y(d,b,2,k-2,i,j,i,1)+1;return b.length=l*2,c(Lb(b),"Internal error: cpConvexHull() and cpPolyValidate() did not agree.Please report this error with as much info as you can."),b},A=function(a,b,c){return f(g(a,b),c)},B=function(a){return g(0,f(a,1))},C=function(a,b,c){return a*(1-c)+b*c},D=function(a,b,c){return a+A(b-a,-c,c)},E=0,F={},G=a.Vect=function(a,b){this.x=a,this.y=b,E++,Object.seal(this)};a.v=function(a,b){return new G(a,b)};var H=a.vzero=new G(0,0),I=a.v.dot=function(a,b){return a.x*b.x+a.y*b.y},J=function(a,b,c,d){return a*c+b*d},K=a.v.len=function(a){return Math.sqrt(I(a,a))},L=a.v.len2=function(a,b){return Math.sqrt(a*a+b*b)},M=a.v.eql=function(a,b){return a.x===b.x&&a.y===b.y},N=a.v.add=function(a,b){return new G(a.x+b.x,a.y+b.y)};G.prototype.add=function(a){return this.x+=a.x,this.y+=a.y,this};var O=a.v.sub=function(a,b){return new G(a.x-b.x,a.y-b.y)};G.prototype.sub=function(a){return this.x-=a.x,this.y-=a.y,this};var P=a.v.neg=function(a){return new G(-a.x,-a.y)};G.prototype.neg=function(){return this.x=-this.x,this.y=-this.y,this};var Q=a.v.mult=function(a,b){return new G(a.x*b,a.y*b)};G.prototype.mult=function(a){return this.x*=a,this.y*=a,this};var R=a.v.cross=function(a,b){return a.x*b.y-a.y*b.x},S=function(a,b,c,d){return a*d-b*c},T=a.v.perp=function(a){return new G(-a.y,a.x)},U=a.v.pvrperp=function(a){return new G(a.y,-a.x)},V=a.v.project=function(a,b){return Q(b,I(a,b)/Y(b))};G.prototype.project=function(a){return this.mult(I(this,a)/Y(a)),this};var W=a.v.rotate=function(a,b){return new G(a.x*b.x-a.y*b.y,a.x*b.y+a.y*b.x)};G.prototype.rotate=function(a){return this.x=this.x*a.x-this.y*a.y,this.y=this.x*a.y+this.y*a.x,this};var X=a.v.unrotate=function(a,b){return new G(a.x*b.x+a.y*b.y,a.y*b.x-a.x*b.y)},Y=a.v.lengthsq=function(a){return I(a,a)},Z=a.v.lengthsq2=function(a,b){return a*a+b*b},$=a.v.lerp=function(a,b,c){return N(Q(a,1-c),Q(b,c))},_=a.v.normalize=function(a){return Q(a,1/K(a))},ab=a.v.normalize_safe=function(a){return a.x===0&&a.y===0?H:_(a)},bb=a.v.clamp=function(a,b){return I(a,a)>b*b?Q(_(a),b):a},cb=a.v.lerpconst=function(a,b,c){return N(a,bb(O(b,a),c))},db=a.v.dist=function(a,b){return K(O(a,b))},eb=a.v.distsq=function(a,b){return Y(O(a,b))},fb=a.v.near=function(a,b,c){return eb(a,b)<c*c},gb=a.v.slerp=function(a,b,c){var d=Math.acos(I(a,b));if(d){var e=1/Math.sin(d);return N(Q(a,Math.sin((1-c)*d)*e),Q(b,Math.sin(c*d)*e))}return a},hb=a.v.slerpconst=function(a,b,c){var d=Math.acos(I(a,b));return gb(a,b,f(c,d)/d)},ib=a.v.forangle=function(a){return new G(Math.cos(a),Math.sin(a))},jb=a.v.toangle=function(a){return Math.atan2(a.y,a.x)},kb=a.v.str=function(a){return"("+a.x.toFixed(3)+", "+a.y.toFixed(3)+")"},lb=0,mb=a.BB=function(a,b,c,d){this.l=a,this.b=b,this.r=c,this.t=d,lb++};a.bb=function(a,b,c,d){return new mb(a,b,c,d)};var nb=function(a,b){return new mb(a.x-b,a.y-b,a.x+b,a.y+b)},ob=function(a,b){return a.l<=b.r&&b.l<=a.r&&a.b<=b.t&&b.b<=a.t},pb=function(a,b,c,d,e){return a.l<=d&&b<=a.r&&a.b<=e&&c<=a.t},qb=function(a,b){return a.l<=b.l&&a.r>=b.r&&a.b<=b.b&&a.t>=b.t},rb=function(a,b){return a.l<=b.x&&a.r>=b.x&&a.b<=b.y&&a.t>=b.y},sb=function(a,b,c,d,e){return a<=e.x&&c>=e.x&&b<=e.y&&d>=e.y},tb=function(a,b){return new mb(f(a.l,b.l),f(a.b,b.b),g(a.r,b.r),g(a.t,b.t))},ub=function(a,b){return new mb(f(a.l,b.x),f(a.b,b.y),g(a.r,b.x),g(a.t,b.y))},vb=function(a){return(a.r-a.l)*(a.t-a.b)},wb=function(a,b){return(g(a.r,b.r)-f(a.l,b.l))*(g(a.t,b.t)-f(a.b,b.b))},xb=function(a,b,c,d,e){return(g(a.r,d)-f(a.l,b))*(g(a.t,e)-f(a.b,c))},yb=function(a,b,c){return bbSegmentQuery(a,b,c)!=Infinity},zb=function(a,b){var c=f(g(a.l,b.x),a.r),d=f(g(a.b,b.y),a.t);return new G(c,d)},Ab=function(a,b){var c=Math.abs(a.r-a.l),d=(b.x-a.l)%c,e=d>0?d:d+c,f=Math.abs(a.t-a.b),g=(b.y-a.b)%f,h=g>0?g:g+f;return new G(e+a.l,h+a.b)},Bb=0,Cb=a.NO_GROUP=0,Db=a.ALL_LAYERS=-1;a.resetShapeIdCounter=function(){Bb=0};var Eb=a.Shape=function(a){this.body=a,this.bb_l=this.bb_b=this.bb_r=this.bb_t=0,this.hashid=Bb++,this.sensor=!1,this.e=0,this.u=0,this.surface_v=H,this.collision_type=0,this.group=0,this.layers=Db,this.space=null,this.collisionCode=this.collisionCode};Eb.prototype.setElasticity=function(a){this.e=a},Eb.prototype.setFriction=function(a){this.body.activate(),this.u=a},Eb.prototype.setLayers=function(a){this.body.activate(),this.layers=a},Eb.prototype.setSensor=function(a){this.body.activate(),this.sensor=a},Eb.prototype.setCollisionType=function(a){this.body.activate(),this.collision_type=a},Eb.prototype.getBody=function(){return this.body},Eb.prototype.active=function(){return this.body&&this.body.shapeList.indexOf(this)!==-1},Eb.prototype.setBody=function(a){b(!this.active(),"You cannot change the body on an active shape. You must remove the shape from the space before changing the body."),this.body=a},Eb.prototype.cacheBB=function(){return this.update(this.body.p,this.body.rot)},Eb.prototype.update=function(a,c){b(!isNaN(c.x),"Rotation is NaN"),b(!isNaN(a.x),"Position is NaN"),this.cacheData(a,c)},Eb.prototype.pointQuery=function(a){var b=this.nearestPointQuery(a);if(b.d<0)return b},Eb.prototype.getBB=function(){return new mb(this.bb_l,this.bb_b,this.bb_r,this.bb_t)};var Fb=function(a){this.shape=a,this.d=Infinity,this.n=H},Gb=function(a,b,c){this.shape=a,this.p=b,this.d=c},Hb=function(a,b,c){this.shape=a,this.t=b,this.n=c};Hb.prototype.hitPoint=function(a,b){return $(a,b,this.t)},Hb.prototype.hitDist=function(a,b){return db(a,b)*this.t};var Ib=a.CircleShape=function(a,b,c){this.c=this.tc=c,this.r=b,this.type="circle",Eb.call(this,a)};Ib.prototype=Object.create(Eb.prototype),Ib.prototype.cacheData=function(a,b){var c=this.tc=W(this.c,b).add(a),d=this.r;this.bb_l=c.x-d,this.bb_b=c.y-d,this.bb_r=c.x+d,this.bb_t=c.y+d},Ib.prototype.nearestPointQuery=function(a){var b=a.x-this.tc.x,c=a.y-this.tc.y,d=L(b,c),e=this.r,f=new G(this.tc.x+b*e/d,this.tc.y+c*e/d);return new Gb(this,f,d-e)};var Jb=function(a,b,c,d,e,f){d=O(d,b),e=O(e,b);var g=I(d,d)-2*I(d,e)+I(e,e),h=-2*I(d,d)+2*I(d,e),i=I(d,d)-c*c,j=h*h-4*g*i;if(j>=0){var k=(-h-Math.sqrt(j))/(2*g);if(0<=k&&k<=1)return new Hb(a,k,_($(d,e,k)))}};Ib.prototype.segmentQuery=function(a,b){return Jb(this,this.tc,this.r,a,b)};var Kb=a.SegmentShape=function(a,b,c,d){this.a=b,this.b=c,this.n=T(_(O(c,b))),this.ta=this.tb=this.tn=null,this.r=d,this.a_tangent=H,this.b_tangent=H,this.type="segment",Eb.call(this,a)};Kb.prototype=Object.create(Eb.prototype),Kb.prototype.cacheData=function(a,b){this.ta=N(a,W(this.a,b)),this.tb=N(a,W(this.b,b)),this.tn=W(this.n,b);var c,d,e,f;this.ta.x<this.tb.x?(c=this.ta.x,d=this.tb.x):(c=this.tb.x,d=this.ta.x),this.ta.y<this.tb.y?(e=this.ta.y,f=this.tb.y):(e=this.tb.y,f=this.ta.y);var g=this.r;this.bb_l=c-g,this.bb_b=e-g,this.bb_r=d+g,this.bb_t=f+g},Kb.prototype.nearestPointQuery=function(a){var b=j(a,this.ta,this.tb),c=a.x-b.x,d=a.y-b.y,e=L(c,d),f=this.r,g=e?N(b,Q(new G(c,d),f/e)):b;return new Gb(this,g,e-f)},Kb.prototype.segmentQuery=function(a,b){var c=this.tn,d=I(O(this.ta,a),c),e=this.r,f=d>0?P(c):c,g=O(Q(f,e),a),h=N(this.ta,g),i=N(this.tb,g),j=O(b,a);if(R(j,h)*R(j,i)<=0){var k=d+(d>0?-e:e),l=-k,m=I(j,c)-k;if(l*m<0)return new Hb(this,l/(l-m),f)}else if(e!==0){var n=Jb(this,this.ta,this.r,a,b),o=Jb(this,this.tb,this.r,a,b);return n?o&&o.t<n.t?o:n:o}},Kb.prototype.setNeighbors=function(a,b){this.a_tangent=O(a,this.a),this.b_tangent=O(b,this.b)},Kb.prototype.setEndpoints=function(a,b){this.a=a,this.b=b,this.n=T(_(O(b,a)))};var Lb=function(a){var b=a.length;for(var c=0;c<b;c+=2){var d=a[c],e=a[c+1],f=a[(c+2)%b],g=a[(c+3)%b],h=a[(c+4)%b],i=a[(c+5)%b];if(S(f-d,g-e,h-f,i-g)>0)return!1}return!0},Mb=a.PolyShape=function(a,b,c){this.setVerts(b,c),this.type="poly",Eb.call(this,a)};Mb.prototype=Object.create(Eb.prototype);var Nb=function(a,b){this.n=a,this.d=b};Nb.prototype.compare=function(a){return I(this.n,a)-this.d},Mb.prototype.setVerts=function(a,c){b(a.length>=4,"Polygons require some verts"),b(typeof a[0]=="number","Polygon verticies should be specified in a flattened list (eg [x1,y1,x2,y2,x3,y3,...])"),b(Lb(a),"Polygon is concave or has a reversed winding. Consider using cpConvexHull()");var d=a.length,e=d>>1;this.verts=new Array(d),this.tVerts=new Array(d),this.planes=new Array(e),this.tPlanes=new Array(e);for(var f=0;f<d;f+=2){var g=a[f]+c.x,h=a[f+1]+c.y,i=a[(f+2)%d]+c.x,j=a[(f+3)%d]+c.y,k=_(T(new G(i-g,j-h)));this.verts[f]=g,this.verts[f+1]=h,this.planes[f>>1]=new Nb(k,J(k.x,k.y,g,h)),this.tPlanes[f>>1]=new Nb(new G(0,0),0)}};var Ob=a.BoxShape=function(a,b,c){var d=b/2,e=c/2;return Pb(a,new mb(-d,-e,d,e))},Pb=a.BoxShape2=function(a,b){var c=[b.l,b.b,b.l,b.t,b.r,b.t,b.r,b.b];return new Mb(a,c,H)};Mb.prototype.transformVerts=function(a,b){var c=this.verts,d=this.tVerts,e=Infinity,h=-Infinity,i=Infinity,j=-Infinity;for(var k=0;k<c.length;k+=2){var l=c[k],m=c[k+1],n=a.x+l*b.x-m*b.y,o=a.y+l*b.y+m*b.x;d[k]=n,d[k+1]=o,e=f(e,n),h=g(h,n),i=f(i,o),j=g(j,o)}this.bb_l=e,this.bb_b=i,this.bb_r=h,this.bb_t=j},Mb.prototype.transformAxes=function(a,b){var c=this.planes,d=this.tPlanes;for(var e=0;e<c.length;e++){var f=W(c[e].n,b);d[e].n=f,d[e].d=I(a,f)+c[e].d}},Mb.prototype.cacheData=function(a,b){this.transformAxes(a,b),this.transformVerts(a,b)},Mb.prototype.nearestPointQuery=function(a){var b=this.tPlanes,c=this.tVerts,d=c[c.length-2],e=c[c.length-1],f=Infinity,g=H,h=!1;for(var i=0;i<b.length;i++){b[i].compare(a)>0&&(h=!0);var j=c[i*2],l=c[i*2+1],m=k(a.x,a.y,d,e,j,l),n=db(a,m);n<f&&(f=n,g=m),d=j,e=l}return new Gb(this,g,h?f:-f)},Mb.prototype.segmentQuery=function(a,b){var c=this.tPlanes,d=this.tVerts,e=c.length,f=e*2;for(var g=0;g<e;g++){var h=c[g].n,i=I(a,h);if(c[g].d>i)continue;var j=I(b,h),k=(c[g].d-i)/(j-i);if(k<0||1<k)continue;var l=$(a,b,k),m=-R(h,l),n=-S(h.x,h.y,d[g*2],d[g*2+1]),o=-S(h.x,h.y,d[(g*2+2)%f],d[(g*2+3)%f]);if(n<=m&&m<=o)return new Hb(this,k,h)}},Mb.prototype.valueOnAxis=function(a,b){var c=this.tVerts,d=J(a.x,a.y,c[0],c[1]);for(var e=2;e<c.length;e+=2)d=f(d,J(a.x,a.y,c[e],c[e+1]));return d-b},Mb.prototype.containsVert=function(a,b){var c=this.tPlanes;for(var d=0;d<c.length;d++){var e=c[d].n,f=J(e.x,e.y,a,b)-c[d].d;if(f>0)return!1}return!0},Mb.prototype.containsVertPartial=function(a,b,c){var d=this.tPlanes;for(var e=0;e<d.length;e++){var f=d[e].n;if(I(f,c)<0)continue;var g=J(f.x,f.y,a,b)-d[e].d;if(g>0)return!1}return!0},Mb.prototype.getNumVerts=function(){return this.verts.length/2},Mb.prototype.getVert=function(a){return new G(this.verts[a*2],this.verts[a*2+1])};var Qb=a.Body=function(a,b){this.p=new G(0,0),this.vx=this.vy=0,this.f=new G(0,0),this.w=0,this.t=0,this.v_limit=Infinity,this.w_limit=Infinity,this.v_biasx=this.v_biasy=0,this.w_bias=0,this.space=null,this.shapeList=[],this.arbiterList=null,this.constraintList=null,this.nodeRoot=null,this.nodeNext=null,this.nodeIdleTime=0,this.setMass(a),this.setMoment(b),this.rot=new G(0,0),this.setAngle(0)},Rb=function(){return body=new Qb(Infinity,Infinity),body.nodeIdleTime=Infinity,body};if(typeof DEBUG!="undefined"&&DEBUG){var Sb=function(a,c){b(a.x==a.x&&a.y==a.y,c)},Tb=function(a,c){b(Math.abs(a.x)!==Infinity&&Math.abs(a.y)!==Infinity,c)},Ub=function(a,b){Sb(a,b),Tb(a,b)};Qb.prototype.sanityCheck=function(){b(this.m===this.m&&this.m_inv===this.m_inv,"Body's mass is invalid."),b(this.i===this.i&&this.i_inv===this.i_inv,"Body's moment is invalid."),Ub(this.p,"Body's position is invalid."),Ub(this.f,"Body's force is invalid."),b(this.vx===this.vx&&Math.abs(this.vx)!==Infinity,"Body's velocity is invalid."),b(this.vy===this.vy&&Math.abs(this.vy)!==Infinity,"Body's velocity is invalid."),b(this.a===this.a&&Math.abs(this.a)!==Infinity,"Body's angle is invalid."),b(this.w===this.w&&Math.abs(this.w)!==Infinity,"Body's angular velocity is invalid."),b(this.t===this.t&&Math.abs(this.t)!==Infinity,"Body's torque is invalid."),Ub(this.rot,"Body's rotation vector is invalid."),b(this.v_limit===this.v_limit,"Body's velocity limit is invalid."),b(this.w_limit===this.w_limit,"Body's angular velocity limit is invalid.")}}else Qb.prototype.sanityCheck=function(){};Qb.prototype.getPos=function(){return this.p},Qb.prototype.getVel=function(){return new G(this.vx,this.vy)},Qb.prototype.getAngVel=function(){return this.w},Qb.prototype.isSleeping=function(){return this.nodeRoot!==null},Qb.prototype.isStatic=function(){return this.nodeIdleTime===Infinity},Qb.prototype.isRogue=function(){return this.space===null},Qb.prototype.setMass=function(a){b(a>0,"Mass must be positive and non-zero."),this.activate(),this.m=a,this.m_inv=1/a},Qb.prototype.setMoment=function(a){b(a>0,"Moment of Inertia must be positive and non-zero."),this.activate(),this.i=a,this.i_inv=1/a},Qb.prototype.addShape=function(a){this.shapeList.push(a)},Qb.prototype.removeShape=function(a){i(this.shapeList,a)};var Vb=function(a,b,c){return a===c?a.next(b):(a.a===b?a.next_a=Vb(a.next_a,b,c):a.next_b=Vb(a.next_b,b,c),a)};Qb.prototype.removeConstraint=function(a){this.constraintList=Vb(this.constraintList,this,a)},Qb.prototype.setPos=function(b){this.activate(),this.sanityCheck(),b===H&&(b=a.v(0,0)),this.p=b},Qb.prototype.setVel=function(a){this.activate(),this.vx=a.x,this.vy=a.y},Qb.prototype.setAngVel=function(a){this.activate(),this.w=a},Qb.prototype.setAngleInternal=function(a){b(!isNaN(a),"Internal Error: Attempting to set body's angle to NaN"),this.a=a,this.rot.x=Math.cos(a),this.rot.y=Math.sin(a)},Qb.prototype.setAngle=function(a){this.activate(),this.sanityCheck(),this.setAngleInternal(a)},Qb.prototype.velocity_func=function(a,b,c){var d=this.vx*b+(a.x+this.f.x*this.m_inv)*c,e=this.vy*b+(a.y+this.f.y*this.m_inv)*c,f=this.v_limit,g=d*d+e*e,h=g>f*f?f/Math.sqrt(g):1;this.vx=d*h,this.vy=e*h;var i=this.w_limit;this.w=A(this.w*b+this.t*this.i_inv*c,-i,i),this.sanityCheck()},Qb.prototype.position_func=function(a){this.p.x+=(this.vx+this.v_biasx)*a,this.p.y+=(this.vy+this.v_biasy)*a,this.setAngleInternal(this.a+(this.w+this.w_bias)*a),this.v_biasx=this.v_biasy=0,this.w_bias=0,this.sanityCheck()},Qb.prototype.resetForces=function(){this.activate(),this.f=new G(0,0),this.t=0},Qb.prototype.applyForce=function(a,b){this.activate(),this.f=N(this.f,a),this.t+=R(b,a)},Qb.prototype.applyImpulse=function(a,b){this.activate(),Yc(this,a.x,a.y,b)},Qb.prototype.getVelAtPoint=function(a){return N(new G(this.vx,this.vy),Q(T(a),this.w))},Qb.prototype.getVelAtWorldPoint=function(a){return this.getVelAtPoint(O(a,this.p))},Qb.prototype.getVelAtLocalPoint=function(a){return this.getVelAtPoint(W(a,this.rot))},Qb.prototype.eachShape=function(a){for(var b=0,c=this.shapeList.length;b<c;b++)a(this.shapeList[b])},Qb.prototype.eachConstraint=function(a){var b=this.constraintList;while(b){var c=b.next(this);a(b),b=c}},Qb.prototype.eachArbiter=function(a){var b=this.arbiterList;while(b){var c=b.next(this);b.swappedColl=this===b.body_b,a(b),b=c}},Qb.prototype.local2World=function(a){return N(this.p,W(a,this.rot))},Qb.prototype.world2Local=function(a){return X(O(a,this.p),this.rot)},Qb.prototype.kineticEnergy=function(){var a=this.vx*this.vx+this.vy*this.vy,b=this.w*this.w;return(a?a*this.m:0)+(b?b*this.i:0)};var Wb=a.SpatialIndex=function(a){this.staticIndex=a;if(a){if(a.dynamicIndex)throw new Error("This static index is already associated with a dynamic index.");a.dynamicIndex=this}};Wb.prototype.collideStatic=function(a,b){if(a.count>0){var c=a.query;this.each(function(a){c(a,new mb(a.bb_l,a.bb_b,a.bb_r,a.bb_t),b)})}};var Xb=a.BBTree=function(a){Wb.call(this,a),this.velocityFunc=null,this.leaves={},this.count=0,this.root=null,this.pooledNodes=null,this.pooledPairs=null,this.stamp=0};Xb.prototype=Object.create(Wb.prototype);var Yb=0,Zb=function(a,b,c){this.obj=null,this.bb_l=f(b.bb_l,c.bb_l),this.bb_b=f(b.bb_b,c.bb_b),this.bb_r=g(b.bb_r,c.bb_r),this.bb_t=g(b.bb_t,c.bb_t),this.parent=null,this.setA(b),this.setB(c)};Xb.prototype.makeNode=function(a,b){var c=this.pooledNodes;return c?(this.pooledNodes=c.parent,c.constructor(this,a,b),c):(Yb++,new Zb(this,a,b))};var $b=0,_b=function(a,b){this.obj=b,a.getBB(b,this),this.parent=null,this.stamp=1,this.pairs=null,$b++};Xb.prototype.getBB=function(a,b){var c=this.velocityFunc;if(c){var d=.1,e=(a.bb_r-a.bb_l)*d,h=(a.bb_t-a.bb_b)*d,i=Q(c(a),.1);b.bb_l=a.bb_l+f(-e,i.x),b.bb_b=a.bb_b+f(-h,i.y),b.bb_r=a.bb_r+g(e,i.x),b.bb_t=a.bb_t+g(h,i.y)}else b.bb_l=a.bb_l,b.bb_b=a.bb_b,b.bb_r=a.bb_r,b.bb_t=a.bb_t},Xb.prototype.getStamp=function(){var a=this.dynamicIndex;return a&&a.stamp?a.stamp:this.stamp},Xb.prototype.incrementStamp=function(){this.dynamicIndex&&this.dynamicIndex.stamp?this.dynamicIndex.stamp++:this.stamp++};var ac=0,bc=function(a,b,c,d){this.prevA=null,this.leafA=a,this.nextA=b,this.prevB=null,this.leafB=c,this.nextB=d};Xb.prototype.makePair=function(a,b,c,d){var e=this.pooledPairs;return e?(this.pooledPairs=e.prevA,e.prevA=null,e.leafA=a,e.nextA=b,e.prevB=null,e.leafB=c,e.nextB=d,e):(ac++,new bc(a,b,c,d))},bc.prototype.recycle=function(a){this.prevA=a.pooledPairs,a.pooledPairs=this};var cc=function(a,b,c){c&&(c.leafA===b?c.prevA=a:c.prevB=a),a?a.leafA===b?a.nextA=c:a.nextB=c:b.pairs=c};_b.prototype.clearPairs=function(a){var b=this.pairs,c;this.pairs=null;while(b)b.leafA===this?(c=b.nextA,cc(b.prevB,b.leafB,b.nextB)):(c=b.nextB,cc(b.prevA,b.leafA,b.nextA)),b.recycle(a),b=c};var dc=function(a,b,c){var d=a.pairs,e=b.pairs,f=c.makePair(a,d,b,e);a.pairs=b.pairs=f,d&&(d.leafA===a?d.prevA=f:d.prevB=f),e&&(e.leafA===b?e.prevA=f:e.prevB=f)};Zb.prototype.recycle=function(a){this.parent=a.pooledNodes,a.pooledNodes=this},_b.prototype.recycle=function(a){},Zb.prototype.setA=function(a){this.A=a,a.parent=this},Zb.prototype.setB=function(a){this.B=a,a.parent=this},_b.prototype.isLeaf=!0,Zb.prototype.isLeaf=!1,Zb.prototype.otherChild=function(a){return this.A==a?this.B:this.A},Zb.prototype.replaceChild=function(a,b,d){c(a==this.A||a==this.B,"Node is not a child of parent."),this.A==a?(this.A.recycle(d),this.setA(b)):(this.B.recycle(d),this.setB(b));for(var e=this;e;e=e.parent){var h=e.A,i=e.B;e.bb_l=f(h.bb_l,i.bb_l),e.bb_b=f(h.bb_b,i.bb_b),e.bb_r=g(h.bb_r,i.bb_r),e.bb_t=g(h.bb_t,i.bb_t)}},Zb.prototype.bbArea=_b.prototype.bbArea=function(){return(this.bb_r-this.bb_l)*(this.bb_t-this.bb_b)};var ec=function(a,b){return(g(a.bb_r,b.bb_r)-f(a.bb_l,b.bb_l))*(g(a.bb_t,b.bb_t)-f(a.bb_b,b.bb_b))},fc=function(a,b){return Math.abs(a.bb_l+a.bb_r-b.bb_l-b.bb_r)+Math.abs(a.bb_b+a.bb_t-b.bb_b-b.bb_t)},gc=function(a,b,c){if(a==null)return b;if(a.isLeaf)return c.makeNode(b,a);var d=a.B.bbArea()+ec(a.A,b),e=a.A.bbArea()+ec(a.B,b);return d===e&&(d=fc(a.A,b),e=fc(a.B,b)),e<d?a.setB(gc(a.B,b,c)):a.setA(gc(a.A,b,c)),a.bb_l=f(a.bb_l,b.bb_l),a.bb_b=f(a.bb_b,b.bb_b),a.bb_r=g(a.bb_r,b.bb_r),a.bb_t=g(a.bb_t,b.bb_t),a};Zb.prototype.intersectsBB=_b.prototype.intersectsBB=function(a){return this.bb_l<=a.r&&a.l<=this.bb_r&&this.bb_b<=a.t&&a.b<=this.bb_t};var hc=function(a,b,c){a.intersectsBB(b)&&(a.isLeaf?c(a.obj):(hc(a.A,b,c),hc(a.B,b,c)))},ic=function(a,b,c){var d=1/(c.x-b.x),e=a.bb_l==b.x?-Infinity:(a.bb_l-b.x)*d,h=a.bb_r==b.x?Infinity:(a.bb_r-b.x)*d,i=f(e,h),j=g(e,h),k=1/(c.y-b.y),l=a.bb_b==b.y?-Infinity:(a.bb_b-b.y)*k,m=a.bb_t==b.y?Infinity:(a.bb_t-b.y)*k,n=f(l,m),o=g(l,m);if(n<=j&&i<=o){var p=g(i,n),q=f(j,o);if(0<=q&&p<=1)return g(p,0)}return Infinity},jc=function(a,b,c,d,e){if(a.isLeaf)return e(a.obj);var g=ic(a.A,b,c),h=ic(a.B,b,c);return g<h?(g<d&&(d=f(d,jc(a.A,b,c,d,e))),h<d&&(d=f(d,jc(a.B,b,c,d,e)))):(h<d&&(d=f(d,jc(a.B,b,c,d,e))),g<d&&(d=f(d,jc(a.A,b,c,d,e)))),d};Xb.prototype.subtreeRecycle=function(a){a.isLeaf&&(this.subtreeRecycle(a.A),this.subtreeRecycle(a.B),a.recycle(this))};var kc=function(a,b,c){if(b==a)return null;var d=b.parent;if(d==a){var e=a.otherChild(b);return e.parent=a.parent,a.recycle(c),e}return d.parent.replaceChild(d,d.otherChild(b),c),a},lc=function(a,b){return a.bb_l<=b.bb_r&&b.bb_l<=a.bb_r&&a.bb_b<=b.bb_t&&b.bb_b<=a.bb_t};_b.prototype.markLeafQuery=function(a,b,c,d){lc(a,this)&&(b?dc(a,this,c):(this.stamp<a.stamp&&dc(this,a,c),d&&d(a.obj,this.obj)))},Zb.prototype.markLeafQuery=function(a,b,c,d){lc(a,this)&&(this.A.markLeafQuery(a,b,c,d),this.B.markLeafQuery(a,b,c,d))},_b.prototype.markSubtree=function(a,b,c){if(this.stamp==a.getStamp()){b&&b.markLeafQuery(this,!1,a,c);for(var d=this;d.parent;d=d.parent)d==d.parent.A?d.parent.B.markLeafQuery(this,!0,a,c):d.parent.A.markLeafQuery(this,!1,a,c)}else{var e=this.pairs;while(e)this===e.leafB?(c&&c(e.leafA.obj,this.obj),e=e.nextB):e=e.nextA}},Zb.prototype.markSubtree=function(a,b,c){this.A.markSubtree(a,b,c),this.B.markSubtree(a,b,c)},_b.prototype.containsObj=function(a){return this.bb_l<=a.bb_l&&this.bb_r>=a.bb_r&&this.bb_b<=a.bb_b&&this.bb_t>=a.bb_t},_b.prototype.update=function(a){var b=a.root,c=this.obj;return this.containsObj(c)?!1:(a.getBB(this.obj,this),b=kc(b,this,a),a.root=gc(b,this,a),this.clearPairs(a),this.stamp=a.getStamp(),!0)},_b.prototype.addPairs=function(a){var b=a.dynamicIndex;if(b){var c=b.root;c&&c.markLeafQuery(this,!0,b,null)}else{var d=a.staticIndex.root;this.markSubtree(a,d,null)}},Xb.prototype.insert=function(a,b){var c=new _b(this,a);this.leaves[b]=c,this.root=gc(this.root,c,this),this.count++,c.stamp=this.getStamp(),c.addPairs(this),this.incrementStamp()},Xb.prototype.remove=function(a,b){var c=this.leaves[b];delete this.leaves[b],this.root=kc(this.root,c,this),this.count--,c.clearPairs(this),c.recycle(this)},Xb.prototype.contains=function(a,b){return this.leaves[b]!=null};var mc=function(a,b){};Xb.prototype.reindexQuery=function(a){if(!this.root)return;var b,c=this.leaves;for(b in c)c[b].update(this);var d=this.staticIndex,e=d&&d.root;this.root.markSubtree(this,e,a),d&&!e&&this.collideStatic(this,d,a),this.incrementStamp()},Xb.prototype.reindex=function(){this.reindexQuery(mc)},Xb.prototype.reindexObject=function(a,b){var c=this.leaves[b];c&&(c.update(this)&&c.addPairs(this),this.incrementStamp())},Xb.prototype.pointQuery=function(a,b){this.query(new mb(a.x,a.y,a.x,a.y),b)},Xb.prototype.segmentQuery=function(a,b,c,d){this.root&&jc(this.root,a,b,c,d)},Xb.prototype.query=function(a,b){this.root&&hc(this.root,a,b)},Xb.prototype.count=function(){return this.count},Xb.prototype.each=function(a){var b;for(b in this.leaves)a(this.leaves[b].obj)};var nc=function(a,b,c,d,e){return(g(a.bb_r,d)-f(a.bb_l,b))*(g(a.bb_t,e)-f(a.bb_b,c))},oc=function(a,b,c,d){if(d==1)return b[c];if(d==2)return a.makeNode(b[c],b[c+1]);var e=b[c],h=e.bb_l,i=e.bb_b,j=e.bb_r,k=e.bb_t,l=c+d;for(var m=c+1;m<l;m++)e=b[m],h=f(h,e.bb_l),i=f(i,e.bb_b),j=g(j,e.bb_r),k=g(k,e.bb_t);var n=j-h>k-i,o=new Array(d*2);if(n)for(var m=c;m<l;m++)o[2*m+0]=b[m].bb_l,o[2*m+1]=b[m].bb_r;else for(var m=c;m<l;m++)o[2*m+0]=b[m].bb_b,o[2*m+1]=b[m].bb_t;o.sort(function(a,b){return a-b});var p=(o[d-1]+o[d])*.5,q=h,r=i,s=j,t=k,u=h,v=i,w=j,x=k;n?s=u=p:t=v=p;var y=l;for(var z=c;z<y;){var e=b[z];nc(e,u,v,w,x)<nc(e,q,r,s,t)?(y--,b[z]=b[y],b[y]=e):z++}if(y==d){var e=null;for(var m=c;m<l;m++)e=gc(e,b[m],a);return e}return NodeNew(a,oc(a,b,c,y-c),oc(a,b,y,l-y))};Xb.prototype.optimize=function(){var a=new Array(this.count),b=0;for(var c in this.leaves)a[b++]=this.nodes[c];tree.subtreeRecycle(root),this.root=oc(tree,a,a.length)};var pc=function(a,b){!a.isLeaf&&b<=10&&(pc(a.A,b+1),pc(a.B,b+1));var c="";for(var d=0;d<b;d++)c+=" ";console.log(c+a.bb_b+" "+a.bb_t)};Xb.prototype.log=function(){this.root&&pc(this.root,0)};var qc=a.CollisionHandler=function(){this.a=this.b=0};qc.prototype.begin=function(a,b){return!0},qc.prototype.preSolve=function(a,b){return!0},qc.prototype.postSolve=function(a,b){},qc.prototype.separate=function(a,b){};var rc=4,sc=function(a,b){this.e=0,this.u=0,this.surface_vr=H,this.a=a,this.body_a=a.body,this.b=b,this.body_b=b.body,this.thread_a_next=this.thread_a_prev=null,this.thread_b_next=this.thread_b_prev=null,this.contacts=null,this.stamp=0,this.handler=null,this.swappedColl=!1,this.state="first coll"};sc.prototype.getShapes=function(){return this.swappedColl?[this.b,this.a]:[this.a,this.b]},sc.prototype.totalImpulse=function(){var a=this.contacts,b=new G(0,0);for(var c=0,d=a.length;c<d;c++){var e=a[c];b.add(Q(e.n,e.jnAcc))}return this.swappedColl?b:b.neg()},sc.prototype.totalImpulseWithFriction=function(){var a=this.contacts,b=new G(0,0);for(var c=0,d=a.length;c<d;c++){var e=a[c];b.add((new G(e.jnAcc,e.jtAcc)).rotate(e.n))}return this.swappedColl?b:b.neg()},sc.prototype.totalKE=function(){var a=(1-this.e)/(1+this.e),b=0,c=this.contacts;for(var d=0,e=c.length;d<e;d++){var f=c[d],g=f.jnAcc,h=f.jtAcc;b+=a*g*g/f.nMass+h*h/f.tMass}return b},sc.prototype.ignore=function(){this.state="ignore"},sc.prototype.getA=function(){return this.swappedColl?this.b:this.a},sc.prototype.getB=function(){return this.swappedColl?this.a:this.b},sc.prototype.isFirstContact=function(){return this.state==="first coll"};var tc=function(a,b,c){this.point=a,this.normal=b,this.dist=c};sc.prototype.getContactPointSet=function(){var a=new Array(this.contacts.length),b;for(b=0;b<a.length;b++)a[b]=new tc(this.contacts[b].p,this.contacts[b].n,this.contacts[b].dist);return a},sc.prototype.getNormal=function(a){var b=this.contacts[a].n;return this.swappedColl?P(b):b},sc.prototype.getPoint=function(a){return this.contacts[a].p},sc.prototype.getDepth=function(a){return this.contacts[a].dist};var uc=function(a,b,c,d){c?c.body_a===b?c.thread_a_next=d:c.thread_b_next=d:b.arbiterList=d,d&&(d.body_a===b?d.thread_a_prev=c:d.thread_b_prev=c)};sc.prototype.unthread=function(){uc(this,this.body_a,this.thread_a_prev,this.thread_a_next),uc(this,this.body_b,this.thread_b_prev,this.thread_b_next),this.thread_a_prev=this.thread_a_next=null,this.thread_b_prev=this.thread_b_next=null},sc.prototype.update=function(a,b,c,d){if(this.contacts)for(var e=0;e<this.contacts.length;e++){var f=this.contacts[e];for(var g=0;g<a.length;g++){var h=a[g];h.hash===f.hash&&(h.jnAcc=f.jnAcc,h.jtAcc=f.jtAcc)}}this.contacts=a,this.handler=b,this.swappedColl=c.collision_type!==b.a,this.e=c.e*d.e,this.u=c.u*d.u,this.surface_vr=O(c.surface_v,d.surface_v),this.a=c,this.body_a=c.body,this.b=d,this.body_b=d.body,this.state=="cached"&&(this.state="first coll")},sc.prototype.preStep=function(a,b,c){var d=this.body_a,e=this.body_b;for(var g=0;g<this.contacts.length;g++){var h=this.contacts[g];h.r1=O(h.p,d.p),h.r2=O(h.p,e.p),h.nMass=1/ad(d,e,h.r1,h.r2,h.n),h.tMass=1/ad(d,e,h.r1,h.r2,T(h.n)),h.bias=-c*f(0,h.dist+b)/a,h.jBias=0,h.bounce=Xc(d,e,h.r1,h.r2,h.n)*this.e}},sc.prototype.applyCachedImpulse=function(a){if(this.isFirstContact())return;var b=this.body_a,c=this.body_b;for(var d=0;d<this.contacts.length;d++){var e=this.contacts[d],f=e.n.x,g=e.n.y,h=f*e.jnAcc-g*e.jtAcc,i=f*e.jtAcc+g*e.jnAcc;Zc(b,c,e.r1,e.r2,h*a,i*a)}};var vc=0,wc=0;sc.prototype.applyImpulse=function(){vc++;var a=this.body_a,b=this.body_b,c=this.surface_vr,d=this.u;for(var e=0;e<this.contacts.length;e++){wc++;var f=this.contacts[e],h=f.nMass,i=f.n,j=f.r1,k=f.r2,l=b.vx-k.y*b.w-(a.vx-j.y*a.w),m=b.vy+k.x*b.w-(a.vy+j.x*a.w),n=i.x*(b.v_biasx-k.y*b.w_bias-a.v_biasx+j.y*a.w_bias)+i.y*(k.x*b.w_bias+b.v_biasy-j.x*a.w_bias-a.v_biasy),o=J(l,m,i.x,i.y),p=J(l+c.x,m+c.y,-i.y,i.x),q=(f.bias-n)*h,r=f.jBias;f.jBias=g(r+q,0);var s=-(f.bounce+o)*h,t=f.jnAcc;f.jnAcc=g(t+s,0);var u=d*f.jnAcc,v=-p*f.tMass,w=f.jtAcc;f.jtAcc=A(w+v,-u,u);var x=i.x*(f.jBias-r),y=i.y*(f.jBias-r);$c(a,-x,-y,j),$c(b,x,y,k);var z=f.jnAcc-t,B=f.jtAcc-w;Zc(a,b,j,k,i.x*z-i.y*B,i.x*B+i.y*z)}},sc.prototype.callSeparate=function(a){var b=a.lookupHandler(this.a.collision_type,this.b.collision_type);b.separate(this,a)},sc.prototype.next=function(a){return this.body_a==a?this.thread_a_next:this.thread_b_next};var xc=0,yc=function(a,b,c,d){this.p=a,this.n=b,this.dist=c,this.r1=this.r2=H,this.nMass=this.tMass=this.bounce=this.bias=0,this.jnAcc=this.jtAcc=this.jBias=0,this.hash=d,xc++},zc=[],Ac=function(a,b,c,d){var e=c+d,f=O(b,a),g=Y(f);if(g>=e*e)return;var h=Math.sqrt(g);return new yc(N(a,Q(f,.5+(c-.5*e)/(h?h:Infinity))),h?Q(f,1/h):new G(1,0),h-e,0)},Bc=function(a,b){var c=Ac(a.tc,b.tc,a.r,b.r);return c?[c]:zc},Cc=function(a,b){var c=b.ta,d=b.tb,e=a.tc,f=O(d,c),g=B(I(f,O(e,c))/Y(f)),h=N(c,Q(f,g)),i=Ac(e,h,a.r,b.r);if(i){var j=i.n;return g===0&&I(j,b.a_tangent)<0||g===1&&I(j,b.b_tangent)<0?zc:[i]}return zc},Dc=0,Ec=function(a,b){var c=0,d=a.valueOnAxis(b[0].n,b[0].d);if(d>0)return-1;for(var e=1;e<b.length;e++){var f=a.valueOnAxis(b[e].n,b[e].d);if(f>0)return-1;f>d&&(d=f,c=e)}return Dc=d,c},Fc=function(a,b,c,d){var e=[],f=a.tVerts;for(var g=0;g<f.length;g+=2){var i=f[g],j=f[g+1];b.containsVertPartial(i,j,P(c))&&e.push(new yc(new G(i,j),c,d,h(a.hashid,g)))}var k=b.tVerts;for(var g=0;g<k.length;g+=2){var i=k[g],j=k[g+1];a.containsVertPartial(i,j,c)&&e.push(new yc(new G(i,j),c,d,h(b.hashid,g)))}return e},Gc=function(a,b,c,d){var e=[],f=a.tVerts;for(var g=0;g<f.length;g+=2){var i=f[g],j=f[g+1];b.containsVert(i,j)&&e.push(new yc(new G(i,j),c,d,h(a.hashid,g>>1)))}var k=b.tVerts;for(var g=0;g<k.length;g+=2){var i=k[g],j=k[g+1];a.containsVert(i,j)&&e.push(new yc(new G(i,j),c,d,h(b.hashid,g>>1)))}return e.length?e:Fc(a,b,c,d)},Hc=function(a,b){var c=Ec(b,a.tPlanes);if(c==-1)return zc;var d=Dc,e=Ec(a,b.tPlanes);if(e==-1)return zc;var f=Dc;return d>f?Gc(a,b,a.tPlanes[c].n,d):Gc(a,b,P(b.tPlanes[e].n),f)},Ic=function(a,b,c){var d=I(b,a.ta)-a.r,e=I(b,a.tb)-a.r;return f(d,e)-c},Jc=function(a,b,c,d,e){var f=R(b.tn,b.ta),g=R(b.tn,b.tb),i=Q(b.tn,e),j=c.tVerts;for(var k=0;k<j.length;k+=2){var l=j[k],m=j[k+1];if(J(l,m,i.x,i.y)<I(b.tn,b.ta)*e+b.r){var n=S(b.tn.x,b.tn.y,l,m);f>=n&&n>=g&&a.push(new yc(new G(l,m),i,d,h(c.hashid,k)))}}},Kc=function(a,b){var c=[],d=b.tPlanes,e=d.length,f=I(a.tn,a.ta),g=b.valueOnAxis(a.tn,f)-a.r,i=b.valueOnAxis(P(a.tn),-f)-a.r;if(i>0||g>0)return zc;var j=0,k=Ic(a,d[0].n,d[0].d);if(k>0)return zc;for(var l=0;l<e;l++){var m=Ic(a,d[l].n,d[l].d);if(m>0)return zc;m>k&&(k=m,j=l)}var n=P(d[j].n),o=N(a.ta,Q(n,a.r)),p=N(a.tb,Q(n,a.r));b.containsVert(o.x,o.y)&&c.push(new yc(o,n,k,h(a.hashid,0))),b.containsVert(p.x,p.y)&&c.push(new yc(p,n,k,h(a.hashid,1)));if(g>=k||i>=k)g>i?Jc(c,a,b,g,1):Jc(c,a,b,i,-1);if(c.length===0){var q=j*2,r=b.tVerts,s=new G(r[q],r[q+1]),t;if(t=Ac(a.ta,s,a.r,0,c))return[t];if(t=Ac(a.tb,s,a.r,0,c))return[t];var u=e*2,v=new G(r[(q+2)%u],r[(q+3)%u]);if(t=Ac(a.ta,v,a.r,0,c))return[t];if(t=Ac(a.tb,v,a.r,0,c))return[t]}return c},Lc=function(a,b){var c=b.tPlanes,d=0,e=I(c[0].n,a.tc)-c[0].d-a.r;for(var f=0;f<c.length;f++){var g=I(c[f].n,a.tc)-c[f].d-a.r;if(g>0)return zc;g>e&&(e=g,d=f)}var h=c[d].n,i=b.tVerts,j=i.length,k=d<<1,l=i[k],m=i[k+1],n=i[(k+2)%j],o=i[(k+3)%j],p=S(h.x,h.y,l,m),q=S(h.x,h.y,n,o),r=R(h,a.tc);if(r<q){var s=Ac(a.tc,new G(n,o),a.r,0,s);return s?[s]:zc}if(r<p)return[new yc(O(a.tc,Q(h,a.r+e/2)),P(h),e,0)];var s=Ac(a.tc,new G(l,m),a.r,0,s);return s?[s]:zc};Ib.prototype.collisionCode=0,Kb.prototype.collisionCode=1,Mb.prototype.collisionCode=2,Ib.prototype.collisionTable=[Bc,Cc,Lc],Kb.prototype.collisionTable=[null,function(a,b){return zc},Kc],Mb.prototype.collisionTable=[null,null,Hc];var Mc=a.collideShapes=function(a,c){return b(a.collisionCode<=c.collisionCode,"Collided shapes must be sorted by type"),a.collisionTable[c.collisionCode](a,c)},Nc=new qc,Oc=a.Space=function(){this.stamp=0,this.curr_dt=0,this.bodies=[],this.rousedBodies=[],this.sleepingComponents=[],this.staticShapes=new Xb(null),this.activeShapes=new Xb(this.staticShapes),this.arbiters=[],this.contactBuffersHead=null,this.cachedArbiters={},this.constraints=[],this.locked=0,this.collisionHandlers={},this.defaultHandler=Nc,this.postStepCallbacks=[],this.iterations=10,this.gravity=H,this.damping=1,this.idleSpeedThreshold=0,this.sleepTimeThreshold=Infinity,this.collisionSlop=.1,this.collisionBias=Math.pow(.9,60),this.collisionPersistence=3,this.enableContactGraph=!1,this.staticBody=new Qb(Infinity,Infinity),this.staticBody.nodeIdleTime=Infinity,this.collideShapes=this.makeCollideShapes()};Oc.prototype.getCurrentTimeStep=function(){return this.curr_dt},Oc.prototype.setIterations=function(a){this.iterations=a},Oc.prototype.isLocked=function(){return this.locked};var Pc=function(a){b(!a.locked,"This addition/removal cannot be done safely during a call to cpSpaceStep()  or during a query. Put these calls into a post-step callback.")};Oc.prototype.addCollisionHandler=function(a,b,c,d,e,f){Pc(this),this.removeCollisionHandler(a,b);var g=new qc;g.a=a,g.b=b,c&&(g.begin=c),d&&(g.preSolve=d),e&&(g.postSolve=e),f&&(g.separate=f),this.collisionHandlers[h(a,b)]=g},Oc.prototype.removeCollisionHandler=function(a,b){Pc(this),delete this.collisionHandlers[h(a,b)]},Oc.prototype.setDefaultCollisionHandler=function(a,b,c,d){Pc(this);var e=new qc;a&&(e.begin=a),b&&(e.preSolve=b),c&&(e.postSolve=c),d&&(e.separate=d),this.defaultHandler=e},Oc.prototype.lookupHandler=function(a,b){return this.collisionHandlers[h(a,b)]||this.defaultHandler},Oc.prototype.addShape=function(a){var c=a.body;return c.isStatic()?this.addStaticShape(a):(b(!a.space,"This shape is already added to a space and cannot be added to another."),Pc(this),c.activate(),c.addShape(a),a.update(c.p,c.rot),this.activeShapes.insert(a,a.hashid),a.space=this,a)},Oc.prototype.addStaticShape=function(a){b(!a.space,"This shape is already added to a space and cannot be added to another."),Pc(this);var c=a.body;return c.addShape(a),a.update(c.p,c.rot),this.staticShapes.insert(a,a.hashid),a.space=this,a},Oc.prototype.addBody=function(a){return b(!a.isStatic(),"Static bodies cannot be added to a space as they are not meant to be simulated."),b(!a.space,"This body is already added to a space and cannot be added to another."),Pc(this),this.bodies.push(a),a.space=this,a},Oc.prototype.addConstraint=function(a){b(!a.space,"This shape is already added to a space and cannot be added to another."),Pc(this);var c=a.a,d=a.b;return c.activate(),d.activate(),this.constraints.push(a),a.next_a=c.constraintList,c.constraintList=a,a.next_b=d.constraintList,d.constraintList=a,a.space=this,a},Oc.prototype.filterArbiters=function(a,b){for(var c in this.cachedArbiters){var d=this.cachedArbiters[c];if(a===d.body_a&&(b===d.a||b===null)||a===d.body_b&&(b===d.b||b===null))b&&d.state!=="cached"&&d.callSeparate(this),d.unthread(),i(this.arbiters,d),delete this.cachedArbiters[c]}},Oc.prototype.removeShape=function(a){var c=a.body;c.isStatic()?this.removeStaticShape(a):(b(this.containsShape(a),"Cannot remove a shape that was not added to the space. (Removed twice maybe?)"),Pc(this),c.activate(),c.removeShape(a),this.filterArbiters(c,a),this.activeShapes.remove(a,a.hashid),a.space=null)},Oc.prototype.removeStaticShape=function(a){b(this.containsShape(a),"Cannot remove a static or sleeping shape that was not added to the space. (Removed twice maybe?)"),Pc(this);var c=a.body;c.isStatic()&&c.activateStatic(a),c.removeShape(a),this.filterArbiters(c,a),this.staticShapes.remove(a,a.hashid),a.space=null},Oc.prototype.removeBody=function(a){b(this.containsBody(a),"Cannot remove a body that was not added to the space. (Removed twice maybe?)"),Pc(this),a.activate(),i(this.bodies,a),a.space=null},Oc.prototype.removeConstraint=function(a){b(this.containsConstraint(a),"Cannot remove a constraint that was not added to the space. (Removed twice maybe?)"),Pc(this),a.a.activate(),a.b.activate(),i(this.constraints,a),a.a.removeConstraint(a),a.b.removeConstraint(a),a.space=null},Oc.prototype.containsShape=function(a){return a.space===this},Oc.prototype.containsBody=function(a){return a.space==this},Oc.prototype.containsConstraint=function(a){return a.space==this},Oc.prototype.uncacheArbiter=function(a){delete this.cachedArbiters[h(a.a.hashid,a.b.hashid)],i(this.arbiters,a)},Oc.prototype.eachBody=function(a){this.lock();var b=this.bodies;for(var c=0;c<b.length;c++)a(b[c]);var d=this.sleepingComponents;for(var c=0;c<d.length;c++){var e=d[c],f=e;while(f){var g=f.nodeNext;a(f),f=g}}this.unlock(!0)},Oc.prototype.eachShape=function(a){this.lock(),this.activeShapes.each(a),this.staticShapes.each(a),this.unlock(!0)},Oc.prototype.eachConstraint=function(a){this.lock();var b=this.constraints;for(var c=0;c<b.length;c++)a(b[c]);this.unlock(!0)},Oc.prototype.reindexStatic=function(){b(!this.locked,"You cannot manually reindex objects while the space is locked. Wait until the current query or step is complete."),this.staticShapes.each(function(a){var b=a.body;a.update(b.p,b.rot)}),this.staticShapes.reindex()},Oc.prototype.reindexShape=function(a){b(!this.locked,"You cannot manually reindex objects while the space is locked. Wait until the current query or step is complete.");var c=a.body;a.update(c.p,c.rot),this.activeShapes.reindexObject(a,a.hashid),this.staticShapes.reindexObject(a,a.hashid)},Oc.prototype.reindexShapesForBody=function(a){for(var b=a.shapeList;b;b=b.next)this.reindexShape(b)},Oc.prototype.useSpatialHash=function(a,b){throw new Error("Spatial Hash not yet implemented!");var c,d},Oc.prototype.activateBody=function(a){b(!a.isRogue(),"Internal error: Attempting to activate a rogue body.");if(this.locked)this.rousedBodies.indexOf(a)===-1&&this.rousedBodies.push(a);else{this.bodies.push(a);for(var c=0;c<a.shapeList.length;c++){var d=a.shapeList[c];this.staticShapes.remove(d,d.hashid),this.activeShapes.insert(d,d.hashid)}for(var e=a.arbiterList;e;e=e.next(a)){var f=e.body_a;if(a===f||f.isStatic()){var g=e.a,i=e.b;this.cachedArbiters[h(g.hashid,i.hashid)]=e,e.stamp=this.stamp,e.handler=this.lookupHandler(g.collision_type,i.collision_type),this.arbiters.push(e)}}for(var j=a.constraintList;j;j=j.nodeNext){var f=j.a;(a===f||f.isStatic())&&this.constraints.push(j)}}},Oc.prototype.deactivateBody=function(a){b(!a.isRogue(),"Internal error: Attempting to deactivate a rogue body."),i(this.bodies,a);for(var c=0;c<a.shapeList.length;c++){var d=a.shapeList[c];this.activeShapes.remove(d,d.hashid),this.staticShapes.insert(d,d.hashid)}for(var e=a.arbiterList;e;e=e.next(a)){var f=e.body_a;(a===f||f.isStatic())&&this.uncacheArbiter(e)}for(var g=a.constraintList;g;g=g.nodeNext){var f=g.a;(a===f||f.isStatic())&&i(this.constraints,g)}};var Qc=function(a){return a?a.nodeRoot:null},Rc=function(a){if(!a||!a.isSleeping(a))return;b(!a.isRogue(),"Internal Error: componentActivate() called on a rogue body.");var c=a.space,d=a;while(d){var e=d.nodeNext;d.nodeIdleTime=0,d.nodeRoot=null,d.nodeNext=null,c.activateBody(d),d=e}i(c.sleepingComponents,a)};Qb.prototype.activate=function(){this.isRogue()||(this.nodeIdleTime=0,Rc(Qc(this)))},Qb.prototype.activateStatic=function(a){b(this.isStatic(),"Body.activateStatic() called on a non-static body.");for(var c=this.arbiterList;c;c=c.next(this))(!a||a==c.a||a==c.b)&&(c.body_a==this?c.body_b:c.body_a).activate()},Qb.prototype.pushArbiter=function(a){c((a.body_a===this?a.thread_a_next:a.thread_b_next)===null,"Internal Error: Dangling contact graph pointers detected. (A)"),c((a.body_a===this?a.thread_a_prev:a.thread_b_prev)===null,"Internal Error: Dangling contact graph pointers detected. (B)");var b=this.arbiterList;c(b===null||(b.body_a===this?b.thread_a_prev:b.thread_b_prev)===null,"Internal Error: Dangling contact graph pointers detected. (C)"),a.body_a===this?a.thread_a_next=b:a.thread_b_next=b,b&&(b.body_a===this?b.thread_a_prev=a:b.thread_b_prev=a),this.arbiterList=a};var Sc=function(a,b){b.nodeRoot=a,b!==a&&(b.nodeNext=a.nodeNext,a.nodeNext=b)},Tc=function(a,b){if(!b.isRogue()){var d=Qc(b);if(d==null){Sc(a,b);for(var e=b.arbiterList;e;e=e.next(b))Tc(a,b==e.body_a?e.body_b:e.body_a);for(var f=b.constraintList;f;f=f.next(b))Tc(a,b==f.a?f.b:f.a)}else c(d===a,"Internal Error: Inconsistency detected in the contact graph.")}},Uc=function(a,b){for(var c=a;c;c=c.nodeNext)if(c.nodeIdleTime<b)return!0;return!1};Oc.prototype.processComponents=function(a){var b=this.sleepTimeThreshold!==Infinity,d=this.bodies;for(var e=0;e<d.length;e++){var f=d[e];c(f.nodeNext===null,"Internal Error: Dangling next pointer detected in contact graph."),c(f.nodeRoot===null,"Internal Error: Dangling root pointer detected in contact graph.")}if(b){var g=this.idleSpeedThreshold,h=g?g*g:Y(this.gravity)*a*a;for(var e=0;e<d.length;e++){var f=d[e],i=h?f.m*h:0;f.nodeIdleTime=f.kineticEnergy()>i?0:f.nodeIdleTime+a}}var j=this.arbiters;for(var e=0,k=j.length;e<k;e++){var l=j[e],m=l.body_a,n=l.body_b;b&&((n.isRogue()&&!n.isStatic()||m.isSleeping())&&m.activate(),(m.isRogue()&&!m.isStatic()||n.isSleeping())&&n.activate()),m.pushArbiter(l),n.pushArbiter(l)}if(b){var o=this.constraints;for(var e=0;e<o.length;e++){var p=o[e],m=p.a,n=p.b;n.isRogue()&&!n.isStatic()&&m.activate(),m.isRogue()&&!m.isStatic()&&n.activate()}for(var e=0;e<d.length;){var f=d[e];if(Qc(f)===null){Tc(f,f);if(!Uc(f,this.sleepTimeThreshold)){this.sleepingComponents.push(f);for(var q=f;q;q=q.nodeNext)this.deactivateBody(q);continue}}e++,f.nodeRoot=null,f.nodeNext=null}}},Qb.prototype.sleep=function(){this.sleepWithGroup(null)},Qb.prototype.sleepWithGroup=function(a){b(!this.isStatic()&&!this.isRogue(),"Rogue and static bodies cannot be put to sleep.");var c=this.space;b(c,"Cannot put a rogue body to sleep."),b(!c.locked,"Bodies cannot be put to sleep during a query or a call to cpSpaceStep(). Put these calls into a post-step callback."),b(a===null||a.isSleeping(),"Cannot use a non-sleeping body as a group identifier.");if(this.isSleeping()){b(Qc(this)===Qc(a),"The body is already sleeping and it's group cannot be reassigned.");return}for(var d=0;d<this.shapeList.length;d++)this.shapeList[d].update(this.p,this.rot);c.deactivateBody(this);if(a){var e=Qc(a);this.nodeRoot=e,this.nodeNext=e.nodeNext,this.nodeIdleTime=0,e.nodeNext=this}else this.nodeRoot=this,this.nodeNext=null,this.nodeIdleTime=0,c.sleepingComponents.push(this);i(c.bodies,this)},Oc.prototype.activateShapesTouchingShape=function(a){this.sleepTimeThreshold!==Infinity&&this.shapeQuery(a,function(a,b){a.body.activate()})},Oc.prototype.pointQuery=function(a,b,c,d){var e=function(e){(!e.group||c!==e.group)&&b&e.layers&&e.pointQuery(a)&&d(e)},f=new mb(a.x,a.y,a.x,a.y);this.lock(),this.activeShapes.query(f,e),this.staticShapes.query(f,e),this.unlock(!0)},Oc.prototype.pointQueryFirst=function(a,b,c){var d=null;return this.pointQuery(a,b,c,function(a){a.sensor||(d=a)}),d},Oc.prototype.nearestPointQuery=function(a,b,c,d,e){var f=function(f){if((!f.group||d!==f.group)&&c&f.layers){var g=f.nearestPointQuery(a);g.d<b&&e(f,g.d,g.p)}},g=nb(a,b);this.lock(),this.activeShapes.query(g,f),this.staticShapes.query(g,f),this.unlock(!0)},Oc.prototype.nearestPointQueryNearest=function(a,b,c,d){var e,f=function(f){if((!f.group||d!==f.group)&&c&f.layers&&!f.sensor){var g=f.nearestPointQuery(a);g.d<b&&(!e||g.d<e.d)&&(e=g)}},g=nb(a,b);return this.activeShapes.query(g,f),this.staticShapes.query(g,f),e},Oc.prototype.segmentQuery=function(a,b,c,d,e){var f=function(f){var g;return(!f.group||d!==f.group)&&c&f.layers&&(g=f.segmentQuery(a,b))&&e(f,g.t,g.n),1};this.lock(),this.staticShapes.segmentQuery(a,b,1,f),this.activeShapes.segmentQuery(a,b,1,f),this.unlock(!0)},Oc.prototype.segmentQueryFirst=function(a,b,c,d){var e=null,f=function(f){var g;return(!f.group||d!==f.group)&&c&f.layers&&!f.sensor&&(g=f.segmentQuery(a,b))&&(e===null||g.t<e.t)&&(e=g),e?e.t:1};return this.staticShapes.segmentQuery(a,b,1,f),this.activeShapes.segmentQuery(a,b,e?e.t:1,f),e},Oc.prototype.bbQuery=function(a,b,c,d){var e=function(e){(!e.group||c!==e.group)&&b&e.layers&&pb(a,e.bb_l,e.bb_b,e.bb_r,e.bb_t)&&d(e)};this.lock(),this.activeShapes.query(a,e),this.staticShapes.query(a,e),this.unlock(!0)},Oc.prototype.shapeQuery=function(a,b){var c=a.body;c&&a.update(c.p,c.rot);var d=new mb(a.bb_l,a.bb_b,a.bb_r,a.bb_t),e=!1,f=function(c){var d=a;if(d.group&&d.group===c.group||!(d.layers&c.layers)||d===c)return;var f;if(d.collisionCode<=c.collisionCode)f=Mc(d,c);else{f=Mc(c,d);for(var g=0;g<f.length;g++)f[g].n=P(f[g].n)}if(f.length){e=!d.sensor&&!c.sensor;if(b){var h=new Array(f.length);for(var g=0;g<f.length;g++)h[g]=new tc(f[g].p,f[g].n,f[g].dist);b(c,h)}}};return this.lock(),this.activeShapes.query(d,f),this.staticShapes.query(d,f),this.unlock(!0),e},Oc.prototype.addPostStepCallback=function(a){c(this.locked,"Adding a post-step callback when the space is not locked is unnecessary. Post-step callbacks will not called until the end of the next call to cpSpaceStep() or the next query."),this.postStepCallbacks.push(a)},Oc.prototype.runPostStepCallbacks=function(){for(var a=0;a<this.postStepCallbacks.length;a++)this.postStepCallbacks[a]();this.postStepCallbacks=[]},Oc.prototype.lock=function(){this.locked++},Oc.prototype.unlock=function(a){this.locked--,b(this.locked>=0,"Internal Error: Space lock underflow.");if(this.locked===0&&a){var c=this.rousedBodies;for(var d=0;d<c.length;d++)this.activateBody(c[d]);c.length=0,this.runPostStepCallbacks()}},Oc.prototype.makeCollideShapes=function(){var a=this;return function(b,c){var d=a;if(!(b.bb_l<=c.bb_r&&c.bb_l<=b.bb_r&&b.bb_b<=c.bb_t&&c.bb_b<=b.bb_t)||b.body===c.body||b.group&&b.group===c.group||!(b.layers&c.layers))return;var e=d.lookupHandler(b.collision_type,c.collision_type),f=b.sensor||c.sensor;if(f&&e===Nc)return;if(b.collisionCode>c.collisionCode){var g=b;b=c,c=g}var i=Mc(b,c);if(i.length===0)return;var j=h(b.hashid,c.hashid),k=d.cachedArbiters[j];k||(k=d.cachedArbiters[j]=new sc(b,c)),k.update(i,e,b,c),k.state=="first coll"&&!e.begin(k,d)&&k.ignore(),k.state!=="ignore"&&e.preSolve(k,d)&&!f?d.arbiters.push(k):(k.contacts=null,k.state!=="ignore"&&(k.state="normal")),k.stamp=d.stamp}},Oc.prototype.arbiterSetFilter=function(a){var b=this.stamp-a.stamp,c=a.body_a,d=a.body_b;return(c.isStatic()||c.isSleeping())&&(d.isStatic()||d.isSleeping())?!0:(b>=1&&a.state!="cached"&&(a.callSeparate(this),a.state="cached"),b>=this.collisionPersistence?(a.contacts=null,!1):!0)};var Vc=function(a){var b=a.body;a.update(b.p,b.rot)};Oc.prototype.step=function(a){if(a===0)return;b(H.x===0&&H.y===0,"vzero is invalid"),this.stamp++;var c=this.curr_dt;this.curr_dt=a;var d,e,f,g=this.bodies,h=this.constraints,i=this.arbiters;for(d=0;d<i.length;d++){var j=i[d];j.state="normal",!j.body_a.isSleeping()&&!j.body_b.isSleeping()&&j.unthread()}i.length=0,this.lock();for(d=0;d<g.length;d++)g[d].position_func(a);this.activeShapes.each(Vc),this.activeShapes.reindexQuery(this.collideShapes),this.unlock(!1),this.processComponents(a),this.lock();for(f in this.cachedArbiters)this.arbiterSetFilter(this.cachedArbiters[f])||delete this.cachedArbiters[f];var k=this.collisionSlop,l=1-Math.pow(this.collisionBias,a);for(d=0;d<i.length;d++)i[d].preStep(a,k,l);for(d=0;d<h.length;d++){var m=h[d];m.preSolve(this),m.preStep(a)}var n=Math.pow(this.damping,a),o=this.gravity;for(d=0;d<g.length;d++)g[d].velocity_func(o,n,a);var p=c===0?0:a/c;for(d=0;d<i.length;d++)i[d].applyCachedImpulse(p);for(d=0;d<h.length;d++)h[d].applyCachedImpulse(p);for(d=0;d<this.iterations;d++){for(e=0;e<i.length;e++)i[e].applyImpulse();for(e=0;e<h.length;e++)h[e].applyImpulse()}for(d=0;d<h.length;d++)h[d].postSolve(this);for(d=0;d<i.length;d++)i[d].handler.postSolve(i[d],this);this.unlock(!0)};var Wc=function(a,b,c,d){var e=a.vx+ -c.y*a.w,f=a.vy+c.x*a.w,g=b.vx+ -d.y*b.w,h=b.vy+d.x*b.w;return new G(g-e,h-f)},Xc=function(a,b,c,d,e){var f=a.vx+ -c.y*a.w,g=a.vy+c.x*a.w,h=b.vx+ -d.y*b.w,i=b.vy+d.x*b.w;return J(h-f,i-g,e.x,e.y)},Yc=function(a,b,c,d){a.vx+=b*a.m_inv,a.vy+=c*a.m_inv,a.w+=a.i_inv*(d.x*c-d.y*b)},Zc=function(a,b,c,d,e,f){Yc(a,-e,-f,c),Yc(b,e,f,d)},$c=function(a,b,c,d){a.v_biasx+=b*a.m_inv,a.v_biasy+=c*a.m_inv,a.w_bias+=a.i_inv*S(d.x,d.y,b,c)},_c=function(a,b,c){var d=R(b,c);return a.m_inv+a.i_inv*d*d},ad=function(a,b,d,e,f){var g=_c(a,d,f)+_c(b,e,f);return c(g!==0,"Unsolvable collision or constraint."),g},bd=function(a,b,d,e,f,g){var h,i,j,k,l=a.m_inv+b.m_inv;h=l,i=0,j=0,k=l;var m=a.i_inv,n=d.x*d.x*m,o=d.y*d.y*m,p=-d.x*d.y*m;h+=o,i+=p,j+=p,k+=n;var q=b.i_inv,r=e.x*e.x*q,s=e.y*e.y*q,t=-e.x*e.y*q;h+=s,i+=t,j+=t,k+=r;var u=h*k-i*j;c(u!==0,"Unsolvable constraint.");var v=1/u;f.x=k*v,f.y=-i*v,g.x=-j*v,g.y=h*v},cd=function(a,b,c){return new G(I(a,b),I(a,c))},dd=function(a,b){return 1-Math.pow(a,b)},ed=a.Constraint=function(a,b){this.a=a,this.b=b,this.space=null,this.next_a=null,this.next_b=null,this.maxForce=Infinity,this.errorBias=Math.pow(.9,60),this.maxBias=Infinity};ed.prototype.activateBodies=function(){this.a&&this.a.activate(),this.b&&this.b.activate()},ed.prototype.preStep=function(a){},ed.prototype.applyCachedImpulse=function(a){},ed.prototype.applyImpulse=function(){},ed.prototype.getImpulse=function(){return 0},ed.prototype.preSolve=function(a){},ed.prototype.postSolve=function(a){},ed.prototype.next=function(a){return this.a===a?this.next_a:this.next_b};var fd=a.PinJoint=function(a,b,d,e){ed.call(this,a,b),this.anchr1=d,this.anchr2=e;var f=a?N(a.p,W(d,a.rot)):d,g=b?N(b.p,W(e,b.rot)):e;this.dist=K(O(g,f)),c(this.dist>0,"You created a 0 length pin joint. A pivot joint will be much more stable."),this.r1=this.r2=null,this.n=null,this.nMass=0,this.jnAcc=this.jnMax=0,this.bias=0};fd.prototype=Object.create(ed.prototype),fd.prototype.preStep=function(a){var b=this.a,c=this.b;this.r1=W(this.anchr1,b.rot),this.r2=W(this.anchr2,c.rot);var d=O(N(c.p,this.r2),N(b.p,this.r1)),e=K(d);this.n=Q(d,1/(e?e:Infinity)),this.nMass=1/ad(b,c,this.r1,this.r2,this.n);var f=this.maxBias;this.bias=A(-dd(this.errorBias,a)*(e-this.dist)/a,-f,f),this.jnMax=this.maxForce*a},fd.prototype.applyCachedImpulse=function(a){var b=Q(this.n,this.jnAcc*a);Zc(this.a,this.b,this.r1,this.r2,b.x,b.y)},fd.prototype.applyImpulse=function(){var a=this.a,b=this.b,c=this.n,d=Xc(a,b,this.r1,this.r2,c),e=(this.bias-d)*this.nMass,f=this.jnAcc;this.jnAcc=A(f+e,-this.jnMax,this.jnMax),e=this.jnAcc-f,Zc(a,b,this.r1,this.r2,c.x*e,c.y*e)},fd.prototype.getImpulse=function(){return Math.abs(this.jnAcc)};var gd=a.SlideJoint=function(a,b,c,d,e,f){ed.call(this,a,b),this.anchr1=c,this.anchr2=d,this.min=e,this.max=f,this.r1=this.r2=this.n=null,this.nMass=0,this.jnAcc=this.jnMax=0,this.bias=0};gd.prototype=Object.create(ed.prototype),gd.prototype.preStep=function(a){var b=this.a,c=this.b;this.r1=W(this.anchr1,b.rot),this.r2=W(this.anchr2,c.rot);var d=O(N(c.p,this.r2),N(b.p,this.r1)),e=K(d),f=0;e>this.max?(f=e-this.max,this.n=ab(d)):e<this.min?(f=this.min-e,this.n=P(ab(d))):(this.n=H,this.jnAcc=0),this.nMass=1/ad(b,c,this.r1,this.r2,this.n);var g=this.maxBias;this.bias=A(-dd(this.errorBias,a)*f/a,-g,g),this.jnMax=this.maxForce*a},gd.prototype.applyCachedImpulse=function(a){var b=this.jnAcc*a;Zc(this.a,this.b,this.r1,this.r2,this.n.x*b,this.n.y*b)},gd.prototype.applyImpulse=function(){if(this.n.x===0&&this.n.y===0)return;var a=this.a,b=this.b,c=this.n,d=this.r1,e=this.r2,f=Wc(a,b,d,e),g=I(f,c),h=(this.bias-g)*this.nMass,i=this.jnAcc;this.jnAcc=A(i+h,-this.jnMax,0),h=this.jnAcc-i,Zc(a,b,this.r1,this.r2,c.x*h,c.y*h)},gd.prototype.getImpulse=function(){return Math.abs(this.jnAcc)};var hd=a.PivotJoint=function(a,b,c,d){ed.call(this,a,b);if(typeof d=="undefined"){var e=c;c=a?a.world2Local(e):e,d=b?b.world2Local(e):e}this.anchr1=c,this.anchr2=d,this.r1=this.r2=H,this.k1=new G(0,0),this.k2=new G(0,0),this.jAcc=H,this.jMaxLen=0,this.bias=H};hd.prototype=Object.create(ed.prototype),hd.prototype.preStep=function(a){var b=this.a,c=this.b;this.r1=W(this.anchr1,b.rot),this.r2=W(this.anchr2,c.rot),bd(b,c,this.r1,this.r2,this.k1,this.k2),this.jMaxLen=this.maxForce*a;var d=O(N(c.p,this.r2),N(b.p,this.r1));this.bias=bb(Q(d,-dd(this.errorBias,a)/a),this.maxBias)},hd.prototype.applyCachedImpulse=function(a){Zc(this.a,this.b,this.r1,this.r2,this.jAcc.x*a,this.jAcc.y*a)},hd.prototype.applyImpulse=function(){var a=this.a,b=this.b,c=this.r1,d=this.r2,e=Wc(a,b,c,d),f=cd(O(this.bias,e),this.k1,this.k2),g=this.jAcc;this.jAcc=bb(N(this.jAcc,f),this.jMaxLen),Zc(a,b,this.r1,this.r2,this.jAcc.x-g.x,this.jAcc.y-g.y)},hd.prototype.getImpulse=function(){return K(this.jAcc)};var id=a.GrooveJoint=function(a,b,c,d,e){ed.call(this,a,b),this.grv_a=c,this.grv_b=d,this.grv_n=T(_(O(d,c))),this.anchr2=e,this.grv_tn=null,this.clamp=0,this.r1=this.r2=null,this.k1=new G(0,0),this.k2=new G(0,0),this.jAcc=H,this.jMaxLen=0,this.bias=null};id.prototype=Object.create(ed.prototype),id.prototype.preStep=function(a){var b=this.a,c=this.b,d=b.local2World(this.grv_a),e=b.local2World(this.grv_b),f=W(this.grv_n,b.rot),g=I(d,f);this.grv_tn=f,this.r2=W(this.anchr2,c.rot);var h=R(N(c.p,this.r2),f);h<=R(d,f)?(this.clamp=1,this.r1=O(d,b.p)):h>=R(e,f)?(this.clamp=-1,this.r1=O(e,b.p)):(this.clamp=0,this.r1=O(N(Q(T(f),-h),Q(f,g)),b.p)),bd(b,c,this.r1,this.r2,this.k1,this.k2),this.jMaxLen=this.maxForce*a;var i=O(N(c.p,this.r2),N(b.p,this.r1));this.bias=bb(Q(i,-dd(this.errorBias,a)/a),this.maxBias)},id.prototype.applyCachedImpulse=function(a){Zc(this.a,this.b,this.r1,this.r2,this.jAcc.x*a,this.jAcc.y*a)},id.prototype.grooveConstrain=function(a){var b=this.grv_tn,c=this.clamp*R(a,b)>0?a:V(a,b);return bb(c,this.jMaxLen)},id.prototype.applyImpulse=function(){var a=this.a,b=this.b,c=this.r1,d=this.r2,e=Wc(a,b,c,d),f=cd(O(this.bias,e),this.k1,this.k2),g=this.jAcc;this.jAcc=this.grooveConstrain(N(g,f)),Zc(a,b,this.r1,this.r2,this.jAcc.x-g.x,this.jAcc.y-g.y)},id.prototype.getImpulse=function(){return K(this.jAcc)},id.prototype.setGrooveA=function(a){this.grv_a=a,this.grv_n=T(_(O(this.grv_b,a))),this.activateBodies()},id.prototype.setGrooveB=function(a){this.grv_b=a,this.grv_n=T(_(O(a,this.grv_a))),this.activateBodies()};var jd=function(a,b){return(a.restLength-b)*a.stiffness},kd=a.DampedSpring=function(a,b,c,d,e,f,g){ed.call(this,a,b),this.anchr1=c,this.anchr2=d,this.restLength=e,this.stiffness=f,this.damping=g,this.springForceFunc=jd,this.target_vrn=this.v_coef=0,this.r1=this.r2=null,this.nMass=0,this.n=null};kd.prototype=Object.create(ed.prototype),kd.prototype.preStep=function(a){var b=this.a,d=this.b;this.r1=W(this.anchr1,b.rot),this.r2=W(this.anchr2,d.rot);var e=O(N(d.p,this.r2),N(b.p,this.r1)),f=K(e);this.n=Q(e,1/(f?f:Infinity));var g=ad(b,d,this.r1,this.r2,this.n);c(g!==0,"Unsolvable this."),this.nMass=1/g,this.target_vrn=0,this.v_coef=1-Math.exp(-this.damping*a*g);var h=this.springForceFunc(this,f);Zc(b,d,this.r1,this.r2,this.n.x*h*a,this.n.y*h*a)},kd.prototype.applyCachedImpulse=function(a){},kd.prototype.applyImpulse=function(){var a=this.a,b=this.b,c=this.n,d=this.r1,e=this.r2,f=Xc(a,b,d,e,c),g=(this.target_vrn-f)*this.v_coef;this.target_vrn=f+g,g*=this.nMass,Zc(a,b,this.r1,this.r2,this.n.x*g,this.n.y*g)},kd.prototype.getImpulse=function(){return 0};var ld=function(a,b){return(b-a.restAngle)*a.stiffness},md=a.DampedRotarySpring=function(a,b,c,d,e){ed.call(this,a,b),this.restAngle=c,this.stiffness=d,this.damping=e,this.springTorqueFunc=ld,this.target_wrn=0,this.w_coef=0,this.iSum=0};md.prototype=Object.create(ed.prototype),md.prototype.preStep=function(a){var b=this.a,d=this.b,e=b.i_inv+d.i_inv;c(e!==0,"Unsolvable spring."),this.iSum=1/e,this.w_coef=1-Math.exp(-this.damping*a*e),this.target_wrn=0;var f=this.springTorqueFunc(this,b.a-d.a)*a;b.w-=f*b.i_inv,d.w+=f*d.i_inv},md.prototype.applyImpulse=function(){var a=this.a,b=this.b,c=a.w-b.w,d=(this.target_wrn-c)*this.w_coef;this.target_wrn=c+d;var e=d*this.iSum;a.w+=e*a.i_inv,b.w-=e*b.i_inv};var nd=a.RotaryLimitJoint=function(a,b,c,d){ed.call(this,a,b),this.min=c,this.max=d,this.jAcc=0,this.iSum=this.bias=this.jMax=0};nd.prototype=Object.create(ed.prototype),nd.prototype.preStep=function(a){var b=this.a,c=this.b,d=c.a-b.a,e=0;d>this.max?e=this.max-d:d<this.min&&(e=this.min-d),this.iSum=1/(1/b.i+1/c.i);var f=this.maxBias;this.bias=A(-dd(this.errorBias,a)*e/a,-f,f),this.jMax=this.maxForce*a,this.bias||(this.jAcc=0)},nd.prototype.applyCachedImpulse=function(a){var b=this.a,c=this.b,d=this.jAcc*a;b.w-=d*b.i_inv,c.w+=d*c.i_inv},nd.prototype.applyImpulse=function(){if(!this.bias)return;var a=this.a,b=this.b,c=b.w-a.w,d=-(this.bias+c)*this.iSum,e=this.jAcc;this.bias<0?this.jAcc=A(e+d,0,this.jMax):this.jAcc=A(e+d,-this.jMax,0),d=this.jAcc-e,a.w-=d*a.i_inv,b.w+=d*b.i_inv},nd.prototype.getImpulse=function(){return Math.abs(joint.jAcc)};var od=a.RatchetJoint=function(a,b,c,d){ed.call(this,a,b),this.angle=0,this.phase=c,this.ratchet=d,this.angle=(b?b.a:0)-(a?a.a:0),this.iSum=this.bias=this.jAcc=this.jMax=0};od.prototype=Object.create(ed.prototype),od.prototype.preStep=function(a){var b=this.a,c=this.b,d=this.angle,e=this.phase,f=this.ratchet,g=c.a-b.a,h=d-g,i=0;h*f>0?i=h:this.angle=Math.floor((g-e)/f)*f+e,this.iSum=1/(b.i_inv+c.i_inv);var j=this.maxBias;this.bias=A(-dd(this.errorBias,a)*i/a,-j,j),this.jMax=this.maxForce*a,this.bias||(this.jAcc=0)},od.prototype.applyCachedImpulse=function(a){var b=this.a,c=this.b,d=this.jAcc*a;b.w-=d*b.i_inv,c.w+=d*c.i_inv},od.prototype.applyImpulse=function(){if(!this.bias)return;var a=this.a,b=this.b,c=b.w-a.w,d=this.ratchet,e=-(this.bias+c)*this.iSum,f=this.jAcc;this.jAcc=A((f+e)*d,0,this.jMax*Math.abs(d))/d,e=this.jAcc-f,a.w-=e*a.i_inv,b.w+=e*b.i_inv},od.prototype.getImpulse=function(a){return Math.abs(a.jAcc)};var pd=a.GearJoint=function(a,b,c,d){ed.call(this,a,b),this.phase=c,this.ratio=d,this.ratio_inv=1/d,this.jAcc=0,this.iSum=this.bias=this.jMax=0};pd.prototype=Object.create(ed.prototype),pd.prototype.preStep=function(a){var b=this.a,c=this.b;this.iSum=1/(b.i_inv*this.ratio_inv+this.ratio*c.i_inv);var d=this.maxBias;this.bias=A(-dd(this.errorBias,a)*(c.a*this.ratio-b.a-this.phase)/a,-d,d),this.jMax=this.maxForce*a},pd.prototype.applyCachedImpulse=function(a){var b=this.a,c=this.b,d=this.jAcc*a;b.w-=d*b.i_inv*this.ratio_inv,c.w+=d*c.i_inv},pd.prototype.applyImpulse=function(){var a=this.a,b=this.b,c=b.w*this.ratio-a.w,d=(this.bias-c)*this.iSum,e=this.jAcc;this.jAcc=A(e+d,-this.jMax,this.jMax),d=this.jAcc-e,a.w-=d*a.i_inv*this.ratio_inv,b.w+=d*b.i_inv},pd.prototype.getImpulse=function(){return Math.abs(this.jAcc)},pd.prototype.setRatio=function(a){this.ratio=a,this.ratio_inv=1/a,this.activateBodies()};var qd=a.SimpleMotor=function(a,b,c){ed.call(this,a,b),this.rate=c,this.jAcc=0,this.iSum=this.jMax=0};qd.prototype=Object.create(ed.prototype),qd.prototype.preStep=function(a){this.iSum=1/(this.a.i_inv+this.b.i_inv),this.jMax=this.maxForce*a},qd.prototype.applyCachedImpulse=function(a){var b=this.a,c=this.b,d=this.jAcc*a;b.w-=d*b.i_inv,c.w+=d*c.i_inv},qd.prototype.applyImpulse=function(){var a=this.a,b=this.b,c=b.w-a.w+this.rate,d=-c*this.iSum,e=this.jAcc;this.jAcc=A(e+d,-this.jMax,this.jMax),d=this.jAcc-e,a.w-=d*a.i_inv,b.w+=d*b.i_inv},qd.prototype.getImpulse=function(){return Math.abs(this.jAcc)}})(),this.createjs=this.createjs||{},function(){var a=function(a){this.initialize(a)},b=a.prototype;b.complete=!0,b.onComplete=null,b._animations=null,b._frames=null,b._images=null,b._data=null,b._loadCount=0,b._frameHeight=0,b._frameWidth=0,b._numFrames=0,b._regX=0,b._regY=0,b.initialize=function(a){var b,c,d,e;if(a==null)return;if(a.images&&(c=a.images.length)>0){e=this._images=[];for(b=0;b<c;b++){var f=a.images[b];if(typeof f=="string"){var g=f;f=new Image,f.src=g}e.push(f),!f.getContext&&!f.complete&&(this._loadCount++,this.complete=!1,function(a){f.onload=function(){a._handleImageLoad()}}(this))}}if(a.frames!=null)if(a.frames instanceof Array){this._frames=[],e=a.frames;for(b=0,c=e.length;b<c;b++){var h=e[b];this._frames.push({image:this._images[h[4]?h[4]:0],rect:new createjs.Rectangle(h[0],h[1],h[2],h[3]),regX:h[5]||0,regY:h[6]||0})}}else d=a.frames,this._frameWidth=d.width,this._frameHeight=d.height,this._regX=d.regX||0,this._regY=d.regY||0,this._numFrames=d.count,this._loadCount==0&&this._calculateFrames();if((d=a.animations)!=null){this._animations=[],this._data={};var i;for(i in d){var j={name:i},k=d[i];if(!isNaN(k))e=j.frames=[k];else if(k instanceof Array){j.frequency=k[3],j.next=k[2],e=j.frames=[];for(b=k[0];b<=k[1];b++)e.push(b)}else{j.frequency=k.frequency,j.next=k.next;var l=k.frames;e=j.frames=isNaN(l)?l.slice(0):[l]}j.next=e.length<2||j.next==0?null:j.next==null||j.next==1?i:j.next,j.frequency||(j.frequency=1),this._animations.push(i),this._data[i]=j}}},b.getNumFrames=function(a){if(a==null)return this._frames?this._frames.length:this._numFrames;var b=this._data[a];return b==null?0:b.frames.length},b.getAnimations=function(){return this._animations.slice(0)},b.getAnimation=function(a){return this._data[a]},b.getFrame=function(a){var b;return this.complete&&this._frames&&(b=this._frames[a])?b:null},b.toString=function(){return"[SpriteSheet]"},b.clone=function(){var b=new a;return b.complete=this.complete,b._animations=this._animations,b._frames=this._frames,b._images=this._images,b._data=this._data,b._frameHeight=this._frameHeight,b._frameWidth=this._frameWidth,b._numFrames=this._numFrames,b._loadCount=this._loadCount,b},b._handleImageLoad=function(){--this._loadCount==0&&(this._calculateFrames(),this.complete=!0,this.onComplete&&this.onComplete())},b._calculateFrames=function(){if(this._frames||this._frameWidth==0)return;this._frames=[];var a=0,b=this._frameWidth,c=this._frameHeight;for(var d=0,e=this._images;d<e.length;d++){var f=e[d],g=(f.width+1)/b|0,h=(f.height+1)/c|0,i=this._numFrames>0?Math.min(this._numFrames-a,g*h):g*h;for(var j=0;j<i;j++)this._frames.push({image:f,rect:new createjs.Rectangle(j%g*b,(j/g|0)*c,b,c),regX:this._regX,regY:this._regY});a+=i}this._numFrames=a},createjs.SpriteSheet=a}(),this.createjs=this.createjs||{},function(){var a=function(a,b,c,d){this.initialize(a,b,c,d)},b=a.prototype;b.x=0,b.y=0,b.width=0,b.height=0,b.initialize=function(a,b,c,d){this.x=a==null?0:a,this.y=b==null?0:b,this.width=c==null?0:c,this.height=d==null?0:d},b.clone=function(){return new a(this.x,this.y,this.width,this.height)},b.toString=function(){return"[Rectangle (x="+this.x+" y="+this.y+" width="+this.width+" height="+this.height+")]"},createjs.Rectangle=a}();var Stats=function(){var a=Date.now(),b=a,c=0,d=Infinity,e=0,f=0,g=Infinity,h=0,i=0,j=0,k=document.createElement("div");k.id="stats",k.addEventListener("mousedown",function(a){a.preventDefault(),s(++j%2)},!1),k.style.cssText="width:80px;opacity:0.9;cursor:pointer";var l=document.createElement("div");l.id="fps",l.style.cssText="padding:0 0 3px 3px;text-align:left;background-color:#002",k.appendChild(l);var m=document.createElement("div");m.id="fpsText",m.style.cssText="color:#0ff;font-family:Helvetica,Arial,sans-serif;font-size:9px;font-weight:bold;line-height:15px",m.innerHTML="FPS",l.appendChild(m);var n=document.createElement("div");n.id="fpsGraph",n.style.cssText="position:relative;width:74px;height:30px;background-color:#0ff";for(l.appendChild(n);74>n.children.length;){var o=document.createElement("span");o.style.cssText="width:1px;height:30px;float:left;background-color:#113",n.appendChild(o)}var p=document.createElement("div");p.id="ms",p.style.cssText="padding:0 0 3px 3px;text-align:left;background-color:#020;display:none",k.appendChild(p);var q=document.createElement("div");q.id="msText",q.style.cssText="color:#0f0;font-family:Helvetica,Arial,sans-serif;font-size:9px;font-weight:bold;line-height:15px",q.innerHTML="MS",p.appendChild(q);var r=document.createElement("div");r.id="msGraph",r.style.cssText="position:relative;width:74px;height:30px;background-color:#0f0";for(p.appendChild(r);74>r.children.length;)o=document.createElement("span"),o.style.cssText="width:1px;height:30px;float:left;background-color:#131",r.appendChild(o);var s=function(a){j=a;switch(j){case 0:l.style.display="block",p.style.display="none";break;case 1:l.style.display="none",p.style.display="block"}};return{REVISION:11,domElement:k,setMode:s,begin:function(){a=Date.now()},end:function(){var j=Date.now();c=j-a,d=Math.min(d,c),e=Math.max(e,c),q.textContent=c+" MS ("+d+"-"+e+")";var k=Math.min(30,30-30*(c/200));return r.appendChild(r.firstChild).style.height=k+"px",i++,j>b+1e3&&(f=Math.round(1e3*i/(j-b)),g=Math.min(g,f),h=Math.max(h,f),m.textContent=f+" FPS ("+g+"-"+h+")",k=Math.min(30,30-30*(f/100)),n.appendChild(n.firstChild).style.height=k+"px",b=j,i=0),j},update:function(){a=this.end()}}};(function(a){function B(){b.unbind(a.document,"DOMContentLoaded",B,!1),b.unbind(a,"load",B,!1),b.ready=!0}"use strict";var b=a.ec={};b.version="0.1.304",b.debug=0;var c,d,e,f,g,h,i,j,k,l,m=b.TIME_STEP=1e3/60,n=!1,o,p,q,r,s,t,u=null,v,w,x=2e3,y,z=function(a,b){if(!a)return!1;for(var c=0,d=b.length;c<d;c++)if(a[b[c]]===undefined)return!1;return!0},A=b.core={begin:function(){console.log("begin"),E(v),v=D(A.load),b.core.loadSettings(),b.core.trackEvent("core","preload",b.version,undefined,!0)},loadSettings:function(){var a=b.core.getLocal("version");a||b.core.clearLocal(),a!==b.version&&b.core.setLocal("version",b.version),b.debug=b.core.getLocal("debug",0,parseInt,[10])},load:function(c){var d=a.document,g=b.appCache||{};if(!g.complete&&!g.timedout||b.ready!==!0||!z(e,"testmap,courtyard".split(","))||!z(f,["enter_the_ninja"])){v=D(A.load),y||(y=d.createElement("p"),d.body.appendChild(y)),y.innerHTML=g.loaded?"Downloading Updates "+g.loaded+"/"+g.total:"Loading...",console.log("loading");return}y&&d.body.removeChild(y),b.EnemyInput.ready(),b.ShadowCloneInput.ready(),b.Player.ready(),b.Ninja.ready(),b.EmptyHand.ready(),b.Projectile.ready(),b.Puff.ready(),b.Box.ready(),b.Circle.ready(),A.init(c)},init:function(j){console.log("init"),o=j,p=0,s=null,t=null,q=new b.UserInput,r=new b.EnemyInput,c&&c.term(),b.world=c=c||new b.World,d=d||new b.Collisions,w||(w=new b.Sound,w.setVolume(b.core.getLocal("soundVolume",0,parseFloat))),b.sound=w,b.resizeDisplay(),b.SpriteSheets.init(),h=h||new b.Canvas2dView,h.removeAll(),i=i||new b.Canvas2dWorldView(c),h.add(i),h.add(q),b.view=h,b.addBrowserListeners(q);if(b.touch){var k=h.width*b.pixelRatio,l=h.height*b.pixelRatio;b.ButtonOverlay.viewWidth=k,b.ButtonOverlay.viewHeight=l,q.setLeftStickOverlay(q.addButtonOverlay(new b.ButtonOverlay({x:160,y:l-160,radius:150}))),q.setRightStickOverlay(q.addButtonOverlay(new b.ButtonOverlay({x:k-160,y:l-160,radius:150})));var m=q.addButtonOverlay(new b.ButtonOverlay({x:k,y:50,radius:150})),v=q.addButtonOverlay(new b.ButtonOverlay({x:0,y:50,radius:150}));b.bind(m,"touchend",b.core.togglePause,!1),b.bind(v,"touchend",b.core.cycleDebug,!1)}b.mobile&&a.scrollTo(0,1),w.stop(),n=!0,u=b.getImage("img/ui/startscreen.png"),b.bind(b.core.getViewDom(),b.touch?"touchend":"mouseup",b.core.start,!1);var x=f.enter_the_ninja;g=new b.Scene(x);var y=e[g.mapName];b.core.setupMap(y,g),b.debug&&b.core.setDebugLevel(b.debug),!!b.touch,b.core.trackEvent("core","inited",b.version,undefined,!0)},setupMap:function(a,e){console.log("setupMap",a),c.space&&(c.contains(s.attack)&&c.remove(s.attack),c.remove(s),c.remove(t)),c.setMap(a),d.init(c.space),i.loadMap(),l&&l.setSpace(c.space),p=0,s||(b.player=s=(new b.Player).setInput(q)),c.add(s),t||(t=(new b.Ninja).setInput(r)),c.add(t),E(v),v=D(e?A.animateScene:A.animate),s.setPos(a.width/2,a.height/2+450,0),t.setPos(a.width/2+200,a.height/2,0),e?(e.init({viewport:i.camera,monk:s,ninja:t}),e.step(0),c.stepScene(m)):(r.completeTask(),i.lookAt(s.body.p.x,-s.body.p.y-64))},cycleMap:function(){var a=e.courtyard;c.map===a&&(a=e.testmap),b.core.setupMap(a,null)},start:function(a){b.unbind(b.core.getViewDom(),a.type,b.core.start,!1),u=null,b.bind(b.core.getViewDom(),b.touch?"touchend":"mouseup",b.core.skipScene,!1),w.playGameMusic()},skipScene:function(a){!n&&g&&!g.complete&&(b.unbind(b.core.getViewDom(),a.type,b.core.skipScene,!1),g.skip())},userStarted:function(){b.touch?(u=b.getImage("img/ui/guide-touch.png"),b.core.trackEvent("game","guide","guide-touch")):(u=b.getImage("img/ui/guide-move-desktop.png"),b.core.trackEvent("game","guide","guide-move-desktop"))},userReady:function(){b.touch||(u=b.getImage("img/ui/guide-fight-desktop.png"),b.core.trackEvent("game","guide","guide-fight-desktop"))},userPlaying:function(){u=null},rollCredits:function(){b.playerInteractions=36,b.core.trackEvent("game","credits",b.version),E(v),v=D(A.animateCredits),b.clearCache(),j=j||new b.Canvas2dCreditsView,j.init(h.context),h.removeAll(),h.add(j),b.touch?b.bind(b.core.getViewDom(),"touchend",b.core.restart,!1):b.bind(b.core.getViewDom(),"mouseup",b.core.restart,!1),w.playEndingMusic()},restart:function(a){if(j.creditsTime<j.skipAfter)return;b.unbind(b.core.getViewDom(),a.type,b.core.restart,!1),h.remove(j),u=null,c&&c.space&&(c.contains(s.attack)&&c.remove(s.attack),c.remove(s),c.remove(t),c.term()),E(v),v=D(A.init)},animateCredits:function(a){b.debug>0&&(k.begin(),b.debug===1&&b.core.traceTime("animateCredits")),v=D(A.animateCredits);var c=a-o;o=a,c=Math.max(m,Math.min(c,m*10)),b.debug!==4&&h.draw(c),b.debug>0&&(b.debug===1&&b.core.traceTimeEnd("animateCredits"),k.end())},animateScene:function(a){b.debug>0&&(k.begin(),b.debug===1&&b.core.traceTime("animateScene"));if(!!g.complete){v=D(A.animate),g=null;return}v=D(A.animateScene);var d=a-o;o=a;if(!n){d=Math.max(m,Math.min(d,m*10)),g.step(d),p+=d;while(p>=m)p-=m,c.stepScene(m)}else d=0;b.debug!==4&&h.draw(d),b.debug>0&&(b.debug>2&&l.step(h),b.debug===1&&b.core.traceTimeEnd("animateScene"),k.end())},animate:function(a){b.debug>0&&(k.begin(),b.debug===1&&b.core.traceTime("animate")),v=D(A.animate);var d=a-o;o=a;if(!n){d=Math.max(m,Math.min(d,m*10)),p+=d;while(p>=m)p-=m,c.step(m);i.lookAt(s.body.p.x,-s.body.p.y-s.z-64);if(t.state==="dead"){t.decomposed+=d;if(t.decomposed>x){t.decomposed=0,b.core.rollCredits();return}}}else d=0;b.debug!==4&&h.draw(d),b.debug>0&&(b.debug>2&&l.step(h),b.debug===1&&b.core.traceTimeEnd("animate"),k.end())},getOverlay:function(){return u},pause:function(){console.log("pause"),n=!0,h.pause(),b.allowPinchZoom(),q.clearKeys()},resume:function(){console.log("resume"),n=!1,h.resume(),b.preventPinchZoom()},togglePause:function(){n?b.core.resume():b.core.pause()},paused:function(){return n},fullscreen:function(){if(b.fullscreen){var c=a.document.body;c.requestFullscreen=c.requestFullscreen||c.mozRequestFullscreen||c.mozRequestFullScreen||c.webkitRequestFullscreen,c.requestFullscreen()}},resize:function(){b.resizeDisplay()&&(h.resize(b.width,b.height,b.pixelRatio),l&&l.resize())},zoom:function(a){return i.zoom(a)},getViewDom:function(){return h.getDom()},getCamera:function(){return i.camera},setLocal:function(a,c){try{G.setItem(a,c)}catch(d){console.error("localStorage.setItem",d),b.core.trackEvent("error","localStorage.setItem",d.message,undefined,!0)}},getLocal:function(a,b,c,d){var e=G.getItem(a);return e===null&&b!==undefined?b:c?(d=d||[],d.unshift(e),c.apply(null,d)):e},removeLocal:function(a){return G.removeItem(a)},clearLocal:function(){G.clear()},trackPage:function(b){a._gaq&&a._gaq.push(["_trackPageview",b])},trackEvent:function(b,c,d,e,f){a._gaq&&a._gaq.push(["_trackEvent",b,c,d,e,f])},trackCustom:function(b,c,d,e){a._gaq&&a._gaq.push(["_setCustomVar",b,c,d,e])},setDebugLevel:function(a){a=isNaN(a)?0:a,a<0&&(a=4),l=l||new b.ChipmunkDebugView(c.space),k=k||new b.DebugView,k.hide(),l.hide();switch(a){case 4:case 3:l.show();case 2:case 1:k.show()}b.debug=a,b.core.setLocal("debug",a),console.log("debug level",a)},cycleDebug:function(){b.core.setDebugLevel(b.debug-1)},traceTime:function(a){a=a||"default",console.time=console.time||function(){},console.time(a)},traceTimeEnd:function(a){a=a||"default",console.timeEnd=console.timeEnd||function(){},console.timeEnd(a)}};b.loadMap=function(a){console.log("loadMap",a.name),e=e||{},e[a.name]=a},b.loadScene=function(a){console.log("loadScene",a.name),f=f||{},f[a.name]=a},b.extend=function(a,b){for(var c in b)if(b.hasOwnProperty(c)&&!a.hasOwnProperty(c)){var d=b[c];d!==undefined&&(a[c]=d)}return a},b.copy=function(a,b){a=a||{};for(var c in b)a[c]=b[c];return a},b.delegate=function(a,b){return function(){return b.apply(a,arguments)}},b.objectToProps=function(a,b){var c=[];for(var d=0,e=a.length;d<e;d++)c.push(a[d][b]);return c},b.bind=function(a,b,c,d){d=d||!1,a.addEventListener?a.addEventListener(b,c,d):a.attachEvent?a.attachEvent("on"+b,c):a["on"+b]=c},b.unbind=function(a,b,c,d){d=d||!1,a.removeEventListener?a.removeEventListener(b,c,d):a.detachEvent?a.detachEvent("on"+b,c):delete a["on"+b]},b.bind(a.document,"DOMContentLoaded",B,!1),b.bind(a,"load",B,!1),Date.now||(Date.now=function(){return+(new Date)});var C=function(a,b){return b[a]||b["webkit"+a]||b["moz"+a]||b["o"+a]||b["ms"+a]},D=a.requestAnimationFrame||C("RequestAnimationFrame",a),E=a.cancelAnimationFrame||C("CancelAnimationFrame",a)||C("CancelRequestAnimationFrame",a)||function(b){a.clearTimeout(b)};if(!D){var F=0;D=function(b){var c=Date.now(),d=Math.max(0,16-(c-F)),e=a.setTimeout(function(){b(c+d)},d);return F=c+d,e}}var G=a.localStorage||{_data:{},setItem:function(a,b){return this._data[a]=String(b)},getItem:function(a){return this._data.hasOwnProperty(a)?this._data[a]:undefined},removeItem:function(a){return delete this._data[a]},clear:function(){return this._data={}}};(function(){var c=a.document;b.touch="ontouchstart"in a||a.DocumentTouch&&c instanceof a.DocumentTouch,b.mobile=/iPhone|iPad|iPod|Android/.test(navigator.userAgent),b.ios=/iPhone|iPad|iPod/.test(navigator.userAgent),b.ipad=/iPad/.test(navigator.userAgent),b.android=/Android/.test(navigator.userAgent),b.standalone=!!navigator.standalone,b.webgl=!!a.WebGLRenderingContext,b.fullscreen=!!C("cancelFullScreen",c),b.webaudio=!!C("AudioContext",a),b.gamepads=!!C("getGamepads",navigator)})(),b.core.begin()})(window),function(a){"use strict",a.ec=a.ec||{};var b=a.applicationCache,c=5e3;ec.appCache={loaded:0,total:0,complete:!1,timedout:!1};if(b&&b.status!==b.UNCACHED){var d=a.setTimeout(function(){ec.appCache.timedout=!0},c);b.addEventListener("noupdate",function(){a.clearTimeout(d),ec.appCache.progress=100,ec.appCache.complete=!0},!1),b.addEventListener("downloading",function(){a.clearTimeout(d)},!1),b.addEventListener("progress",function(a){ec.appCache.loaded=a.loaded,ec.appCache.total=a.total},!1),b.addEventListener("updateready",function(){b.status===b.UPDATEREADY&&(ec.appCache.progress=100,a.clearTimeout(d),b.swapCache(),a.location.reload())},!1),b.addEventListener("cached",function(){ec.appCache.progress=100,ec.appCache.complete=!0,a.clearTimeout(d)},!1)}else ec.appCache.complete=!0}(window),function(a){"use strict";var b=a.ec,c=a.document,d=b.android&&c.querySelector&&c.querySelector('meta[name="viewport"]');b.addBrowserListeners=function(d){this.bind(a,"blur",this.core.pause,!1),b.touch?(this.bind(b.core.getViewDom(),"touchstart",d.touchstart,!1),this.bind(b.core.getViewDom(),"touchmove",d.touchmove,!1),this.bind(b.core.getViewDom(),"touchend",d.touchend,!1)):(this.bind(b.core.getViewDom(),"mousedown",d.mousedown,!1),this.bind(b.core.getViewDom(),"mouseup",d.mouseup,!1)),b.mobile||this.bind(a,"resize",this.core.resize,!1),this.bind(c,"keydown",d.keydown,!1),this.bind(c,"keyup",d.keyup,!1)},b.preventPinchZoom=function(){b.android&&d&&(d.content="width=device-width, user-scalable=0")},b.allowPinchZoom=function(){b.android&&d&&(d.content="width=device-width, user-scalable=1")}}(window),function(a){"use strict";var b=a.ec,c=a.document;b.resizeDisplay=function(){var d,e,f;d=b.forcePixelRatio||a.devicePixelRatio||1;if(b.mobile){var g=Math.max(a.screen.width,a.screen.height),h=Math.min(a.screen.width,a.screen.height);e=g,f=h,b.ipad&&(d=Math.min(1,d),b.standalone||(f-=96))}else{var i=16,j=9,k,l;e=i,f=j,k=a.innerWidth,l=a.innerHeight;while(e+i<=k&&f+j<=l)e+=i,f+=j;c.body.style.left=Math.floor((k-e)/2)+"px",c.body.style.top=Math.floor((l-f)/2)+"px"}return b.width!==e||b.height!==f||b.pixelRatio!==d?(b.pixelRatio=d,b.width=e,b.height=f,c.body.style.width=e+"px",c.body.style.height=f+"px",!0):!1}}(window),function(a){"use strict";var b=a.ec,c={},d={};b.clearImages=function(){c={}},b.clearCache=function(){d={}},b.getImage=function(a){var b=c[a];return b||(b=c[a]=new Image,b.src=a),b},b.getCached=function(a,c){c=c||a.src;var e=d[c];return e?e:!a.width||!a.height?a:b.appendCache(c,a)},b.appendCache=function(c,e){b.debug===1&&b.core.traceTime("appendCache "+c);var f=a.document.createElement("canvas");f.width=e.width,f.height=e.height;var g=f.getContext("2d");return g.drawImage(e,0,0),d[c]=f,b.debug===1&&b.core.traceTimeEnd("appendCache "+c),f}}(window),function(a){"use strict";var b=a.ec,c=a.cp,d=c.v,e=b.Entity=function(){this.setBaseProperties(),b.debug>1&&Object.seal(this)};e.groupId=1,e.labelPool=[],e.getLabel=function(a,c){var d=this.labelPool.pop();return d?d.setContext(a):d=new b.TextField(a,0,0),d.setSize(160,c).setStyle("#0ff")},e.prototype={getBaseProperties:function(){return{type:"Entity",isEntity:!0,pos:{x:0,y:0,z:0},groundZ:0,z:0,velZ:0,depth:32,shape:null,body:null,groupId:c.NO_GROUP,sortBounds:{top:0,front:0},mapCollision:[],maxCollisionTopZ:0,layerNum:0,layerName:"",label:null,input:null,climbHeight:128,attack:null,fx:null,hitTime:0,hitPoints:0,hitDuration:0,decomposed:0}},setBaseProperties:function(){b.extend(this,this.getBaseProperties())},term:function(){this.shape=null,this.body&&(this.body.userData&&(this.body.userData.parent=null,this.body.userData=null),this.body=null),this.pos=null,this.sortBounds=null,this.input=null,this.mapCollision=null,this.label&&(e.labelPool.push(this.label),this.label=null)},setView:function(a){return this.view=a,this},setInput:function(a){return this.input=a,this},step:function(a){return this},postStep:function(a){this.groundZ=this.z;var b,c=-10,d=1,e=0,f=5,g=this.getTargetZ(this.climbHeight);return b=g-this.z,b>0?b<=this.climbHeight&&(this.groundZ=this.z,this.velZ=this.velZ*d+(f+e*this.body.m_inv)*a/100,this.velZ<0&&(this.velZ=0),this.z=Math.min(g,this.z+this.velZ)):b<0?(this.velZ=this.velZ*d+(c+e*this.body.m_inv)*a/100,this.z=Math.max(g,this.z+this.velZ),this.groundZ=g):this.velZ=0,this.mapCollision.length>0&&this.maxCollisionTopZ>g&&this.hitMapWall(),this},hitMapWall:function(){this.input&&this.input.mapCollision(this)},postStepScene:function(a){this.groundZ=this.z;var b,c=32,d=this.getTargetZ(c);return b=d-this.z,b>=c?b<=0&&(this.groundZ=d):b<0&&(this.groundZ=d),this},getTargetZ:function(a){a=a||this.climbHeight;var b=0;this.maxCollisionTopZ=0;for(var c=0,d=this.mapCollision.length;c<d;c++){var e=this.mapCollision[c],f=e.getTop(this.body.p.x,-this.body.p.y);f>b&&f-this.z<=a&&(b=f),this.maxCollisionTopZ=Math.max(this.maxCollisionTopZ,f)}return b},addMapCollision:function(a){this.mapCollision.indexOf(a)<0&&this.mapCollision.push(a)},removeMapCollision:function(a){var b=this.mapCollision.indexOf(a);b>-1&&this.mapCollision.splice(b,1)},hit:function(a){return console.log("HIT",this),this},getSortBounds:function(){return this.sortBounds.top=this.z+this.depth,this.sortBounds.front=-this.body.p.y,this.sortBounds},getPos:function(){return this.pos.x=this.body.p.x,this.pos.y=-this.body.p.y,this.pos.z=this.z,this.pos},setPos:function(a,b,c){var d=this.body;c!==undefined&&(this.z=d.z=c),d.activate(),d.p.x=a,d.p.y=-b;if(d.isStatic())for(var e=0;e<d.shapeList.length;e++){var f=d.shapeList[e];f.update(d.p,d.rot),f.space&&f.space.staticShapes.reindexObject(f,f.hashid)}return this},setAngle:function(a,b){var c=this.body;return b!==undefined&&(c.w=b),a&&(a.x||a.y)?(c.a=Math.atan2(-a.y,a.x),c.rot.x=a.x,c.rot.y=-a.y):isNaN(a)||(c.a=a,c.rot.x=Math.cos(a),c.rot.y=-Math.sin(a)),this},setVelocity:function(a,b,c){var d=this.body;return d.vx=a,d.vy=b,c!==undefined&&(this.velZ=c),this},resetForces:function(){var a=this.body;a.f.x=0,a.f.y=0,a.t=0},getBody:function(a,b){var d=this.body;return d||(a===0?(d=new c.Body(Infinity,Infinity),d.nodeIdleTime=Infinity):d=new c.Body(a,b)),d},assignCircleShape:function(a,b,e){e=e||c.momentForCircle(b,0,a,d(0,0)),this.radius=a;var f=this.getBody(b,e);return this.setBody(f),this.shape=new c.CircleShape(f,a,d(0,0)),this},assignBoxShape:function(a,b,d,e){e=e||c.momentForBox(d,a,b),this.width=a,this.height=b;var f=this.getBody(d,e);return this.setBody(f),this.shape=new c.BoxShape(f,a,b),this},setBody:function(a){this.body=a,a.userData={parent:this}}}}(window),function(a){"use strict";var b=a.ec,c=64,d=64,e=b.Box=function(a,e,f){this.setBaseProperties(),e=e||c,f=f||d,a===undefined&&(a=1),this.assignBoxShape(e,f,a),this.shape.setElasticity(0),this.shape.setFriction(.6),this.shape.collision_type=b.Collisions.PROP,b.debug>1&&Object.seal(this)},f=e.prototype;e.ready=function(){b.extend(f,b.Entity.prototype)}}(window),function(a){"use strict";var b=a.ec,c=32,d=b.Circle=function(a,d,e){this.setBaseProperties(),e&&(d/=2),d=d||c,a===undefined&&(a=1),this.assignCircleShape(d,a),this.shape.setElasticity(0),this.shape.setFriction(.6),this.shape.collision_type=b.Collisions.PROP,b.debug>1&&Object.seal(this)},e=d.prototype;d.ready=function(){b.extend(e,b.Entity.prototype)}}(window),function(a){"use strict";var b=a.ec,c=a.cp,d=c.v,e=Math.abs,f=d(0,0),g=d(0,0);b.playerInteractions=-1;var h=b.Player=function(){this.setBaseProperties(),this.groupId=b.Entity.groupId++;var a=32,c=5;this.assignCircleShape(a,c),this.shape.setElasticity(0),this.shape.setFriction(0),this.shape.collision_type=b.Collisions.PLAYER,this.shape.group=this.groupId,this.state="standing",this.walkCount=0,this.speed=8,this.attack=new b.EmptyHand(a-4,1),this.depth=64,this.type="Player",b.debug>1&&Object.seal(this),b.core.trackCustom(1,"Player Interacted","No",2)},i=h.prototype;h.ready=function(){b.extend(i,b.Entity.prototype)},i.term=function(){b.Entity.prototype.term.apply(this),this.attack=null},i.punch=function(a,c,e){if(this.passive())return;var h=this.attack;h.shape.group===0&&(h.shape.group=this.groupId,this.attack=h);if(h.phase>b.EmptyHand.PASSIVE)return;c.contains(h)&&c.remove(h),h.time=0,h.startTime=a,h.phase=b.EmptyHand.PUSHING;var i=this.getPos();h.setPos(i.x,i.y,i.z),this.setAngle(g,0),h.setAngle(g,0);var j=.75;this.body.vx*=j,this.body.vy*=j,h.resetForces(),h.body.activate();var k=d.mult(g,this.speed*1e3/e);h.body.vx=k.x+f.x*j,h.body.vy=-k.y-f.y*j,c.add(h)},i.attackEnd=function(a,c){var d=this.attack;d.time=0,d.startTime=-1,d.phase=b.EmptyHand.PASSIVE,c.contains(d)&&c.remove(d),b.playerInteractions===2&&(b.playerInteractions=3,b.core.userPlaying())},i.passive=function(){return g.x===0&&g.y===0},i.step=function(a){this.input.poll(this,a),this.resetForces(),this.attack.entityStep(b.world.time,b.world,this),b.playerInteractions===-1&&(b.playerInteractions=0,b.core.userStarted());if(this.attack.phase===b.EmptyHand.PASSIVE||this.attack.phase===b.EmptyHand.PULLING){f.x=this.input.axes[0],f.y=this.input.axes[1];if(e(f.x)>.1||e(f.y)>.1){(e(f.x)>.7||e(f.y)>.7)&&f.mult(1/d.len(f)),this.state="walking",f.mult(this.speed*1e3/a),this.body.activate(),this.body.vx+=f.x,this.body.vy-=f.y,this.body.vx*=.5,this.body.vy*=.5;if(a){var c=Math.sqrt(this.body.vx*this.body.vx+this.body.vy*this.body.vy)*a/4e4;this.walkCount+=Math.max(.15,c)}this.setAngle(f,0),b.playerInteractions===0&&(b.playerInteractions=1,b.core.trackCustom(1,"Player Interacted","Yes",2))}else this.state="standing",this.walkCount=0,this.body.vx=0,this.body.vy=0,this.body.w*=.99,b.playerInteractions===1&&(b.playerInteractions=2,b.core.userReady())}return g.x=this.input.axes[2],g.y=this.input.axes[3],this.input.buttons[0]>0&&(g.x=Math.cos(this.body.a),g.y=-Math.sin(this.body.a)),e(g.x)>.1||e(g.y)>.1?(g.mult(1/d.len(g)),this.punch(b.world.time,b.world,a),this.state="punching"):(g.x=0,g.y=0),this}}(window),function(a){"use strict";var b=a.ec,c=b.EmptyHand=function(a,d){this.setBaseProperties(),a=a||24,d=d||1,this.assignCircleShape(a,d),this.shape.setElasticity(.5),this.shape.setFriction(1),this.shape.collision_type=b.Collisions.PLAYER_HAND,this.depth=64,this.time=0,this.startTime=-1,this.phase=c.PASSIVE,this.pushDuration=5e3/60,this.grabDuration=1e4/60,this.punchDuration=this.pushDuration+this.grabDuration/2,b.debug>1&&Object.seal(this)};c.PASSIVE=0,c.PUSHING=1,c.GRABBING=2,c.PULLING=3;var d=c.prototype;c.ready=function(){b.extend(d,b.Entity.prototype)},d.entityStep=function(a,c,d){if(this.phase){this.time=a-this.startTime;if(this.phase===b.EmptyHand.PUSHING)this.time<this.punchDuration||(d.passive()?d.attackEnd(a,c):this.time>this.pushDuration&&(this.phase=b.EmptyHand.GRABBING));else if(this.phase===b.EmptyHand.GRABBING){this.body.vx*=.9,this.body.vy*=.9;if(d.passive())d.attackEnd(a,c);else if(this.time>this.pushDuration+this.grabDuration){var e=!1;e||d.attackEnd(a,c)}}else this.phase===b.EmptyHand.PULLING&&d.passive()&&(d.attackEnd(a,c),console.log("pull ended passively"))}}}(window),function(a){"use strict";var b=a.ec,c=a.cp,d=c.v,e=Math.abs,f=d(0,0),g=d(0,0),h=b.Ninja=function(){this.setBaseProperties(),this.groupId=b.Entity.groupId++;var a=32,c=5;this.assignCircleShape(a,c),this.shape.setElasticity(0),this.shape.setFriction(0),this.shape.collision_type=b.Collisions.MONSTER,this.shape.group=this.groupId,this.state="standing",this.walkCount=0,this.speed=8,this.attack=new b.EmptyHand(a-4,1),this.depth=64,this.type="Ninja",this.isShadowClone=!1,this.shadowClones=null,this.master=null,this.fx=null,this.hitPoints=100,b.debug>1&&Object.seal(this)},i=h.prototype;h.ready=function(){b.extend(i,b.Entity.prototype)},i.term=function(){b.Entity.prototype.term.apply(this),this.attack=null,this.shadowClones=null,this.master=null,this.fx=null},i.shadowClone=function(){if(this.isShadowClone){console.error("shadow clone tried to clone itself!");return}var a=this.getPos(),c=(new b.Ninja).setPos(a.x,a.y,a.z).setInput(new b.ShadowCloneInput);c.isShadowClone=!0,c.master=this,this.shadowClones||(this.shadowClones=[]),this.shadowClones.push(c),b.world.add(c),this.puffSmoke(),c.puffSmoke()},i.getClones=function(){var a=this.shadowClones;a||(a=this.shadowClones=[]);for(var b=a.length;b-->0;)a[b].state==="dead"&&a.splice(b,1);return a},i.puffSmoke=function(){var a=new b.Puff(this.groupId);b.world.add(a),this.fx=a},i.throwStar=function(){var a=this.getPos(),c=this.body.a,d=800,e=20,f=(new b.Projectile).setPos(a.x,a.y,a.z+64).setAngle(c,e).setVelocity(Math.cos(c)*d,Math.sin(c)*d,0);f.shape.group=this.groupId,b.world.add(f)},i.hit=function(a,b){var c=a&&a.totalKE()||1e3;return c>0&&this.state!=="hit"&&this.state!=="dead"&&(this.state="hit",this.isShadowClone?(this.hitTime=400,this.hitPoints=b?0:this.hitPoints):(this.hitPoints-=b,this.hitTime=600),this.input.completeTask(),this.hitDuration=this.hitTime,this.body.w=c/1e4,this.body.vx*=2,this.body.vy*=2),this},i.updateFx=function(a){this.fx&&(this.fx.time>0?this.fx.update(this):this.fx=null)},i.step=function(a){if(this.hitTime>0)return this.isShadowClone&&this.hitTime===this.hitDuration&&this.hitPoints===0&&this.puffSmoke(),this.hitTime-=a,this.hitTime<=0&&(this.hitTime=0,this.hitPoints<=0?(this.state="dead",this.isShadowClone&&(b.world.remove(this),this.term())):this.state="standing"),this.updateFx(),this;if(this.isShadowClone&&this.master.hitPoints<=0)this.puffSmoke(),this.hit(null,b.world,1);else if(this.state==="dead")return this.body.vx=0,this.body.vy=0,this.body.w*=.5,this.updateFx(),this;this.input.poll(this,a),this.resetForces();if(this.attack.phase===b.EmptyHand.PASSIVE||this.attack.phase===b.EmptyHand.PULLING){f.x=this.input.axes[0],f.y=this.input.axes[1];if(e(f.x)>.1||e(f.y)>.1){(e(f.x)>.7||e(f.y)>.7)&&f.mult(1/d.len(f)),this.state="walking",f.mult(this.speed*1e3/a),this.body.activate(),this.body.vx+=f.x,this.body.vy-=f.y,this.body.vx*=.5,this.body.vy*=.5;if(a){var c=Math.sqrt(this.body.vx*this.body.vx+this.body.vy*this.body.vy)*a/4e4;this.walkCount+=Math.max(.15,c)}this.setAngle(f,0)}else this.state="standing",this.body.vx=0,this.body.vy=0,this.body.w*=.99}return g.x=this.input.axes[2],g.y=-this.input.axes[3],e(g.x)>.1||e(g.y)>.1?g.mult(1/d.len(g)):(g.x=0,g.y=0),this.updateFx(),this}}(window),function(a){"use strict";var b=a.ec,c=50,d=b.Puff=function(a){this.setBaseProperties(),this.groupId=a||b.Entity.groupId++,this.assignCircleShape(c,1),this.shape.setElasticity(0),this.shape.setFriction(0),this.shape.sensor=!0,this.time=this.duration=500,b.debug>1&&Object.seal(this)},e=d.prototype;d.ready=function(){b.extend(e,b.Entity.prototype)},e.step=function(a){this.time-=a,this.time<=0&&(this.time=0,b.world.remove(this),this.term())},e.update=function(a){if(this.time>0){var b=a.getPos();this.setPos(b.x,b.y+1,b.z+1),this.setVelocity(a.body.vx,a.body.vy,0)}}}(window),function(a){"use strict";var b=a.ec,c=b.Projectile=function(a,c){this.setBaseProperties(),a=a||12,c=c||2,this.assignCircleShape(a,c),this.shape.setElasticity(1),this.shape.setFriction(1),this.shape.collision_type=b.Collisions.PROJECTILE,this.vx=0,this.vy=0,this.distanceSq=0,this.maxDistanceSq=64e6,this.inactive=0,b.debug>1&&Object.seal(this)},d=c.prototype;d.climbHeight=0,c.ready=function(){b.extend(d,b.Entity.prototype)},d.setVelocity=function(a,b,c){var d=this.body;return d.vx=a,d.vy=b,this.vx=a,this.vy=b,c!==undefined&&(this.velZ=c),this},d.step=function(a){return this.vx=this.body.vx,this.vy=this.body.vy,this},d.postStep=function(a){this.groundZ=this.getTargetZ(this.climbHeight);if(this.inactive>0){this.inactive+=a,this.inactive>3e3&&(b.world.remove(this),this.term());return}var c=this.z+this.velZ*a/100;if(c<this.groundZ){this.z=this.groundZ,this.resetForces(),this.deactivate(a);return}this.z=c,this.maxDistanceSq&&this.mapCollision.length>0&&this.maxCollisionTopZ>this.groundZ&&this.hitObstacle(a),this.distanceSq+=this.vx*this.vx+this.vy*this.vy;if(this.distanceSq<this.maxDistanceSq)this.body.vx=this.vx,this.body.vy=this.vy;else{var d=-10,e=50/(Math.abs(this.body.w)+50),f=e;this.velZ=this.velZ*e+(d+f*this.body.m_inv)*a/100}},d.hit=function(a,b){console.log("projectile hit"),this.startFall(b)},d.hitObstacle=function(a){this.distanceSq<9e6||Math.random()>.8?this.deactivate(a):this.startFall(a),this.maxDistanceSq=0},d.startFall=function(a){this.resetForces(),this.velZ+=Math.random()*32-16,this.body.w=Math.random()*4-2},d.deactivate=function(a){this.setVelocity(0,0,0),this.body.w=0,this.inactive=a,this.shape.sensor=!0},d.postStepScene=function(a){this.groundZ=this.getTargetZ(this.climbHeight)}}(window),function(a){"use strict";var b=a.ec,c=b.MapElement=function(a){b.extend(this,{name:"",x:0,y:0,z:0,width:0,height:0,regX:0,regY:0,matrix:null,mapType:null,mass:0,mDepth:0,mHeight:0,mWidth:0,mZ:0,shape:null,type:null,image:null,layerNum:0,visible:!0,body:null,imageData:null,sortBounds:{top:0,front:0,back:0,inited:!1},label:null}),b.copy(this,a),this.init(),b.debug>1&&Object.seal(this)},d=c.prototype;d.init=function(){this.regX?(this.drawX=this.x-this.regX,this.drawY=this.y-this.regY):(this.drawX=this.x||0,this.drawY=this.y||0,this.regX=0,this.regY=0),this.z=this.mZ||this.z,this.y=this.y+this.z,this.depth=this.mDepth||this.depth;if(this.children)for(var a=this.children.length;a-->0;){var b=this.children[a];b.drawX=b.x,b.drawY=b.y}},d.loadImages=function(a){if(this.image||this.fillImage)this.imageData=b.getImage(a+"/"+(this.image||this.fillImage));this.fillColor&&this.fillColor.length===9&&(this.fillAlpha=255/parseInt(this.fillColor.substr(7),16),this.fillColor=this.fillColor.substr(0,7));if(this.children)for(var c=this.children.length;c-->0;)this.loadImages.apply(this.children[c],[a])},d.setBody=function(a){this.body=a,a.userData={parent:this}},d.isBehindEntity=function(a){switch(this.mapType){case"container":case"parallax":return!1}var b=this.getSortBounds();if(this.mapType==="floor"){if(a.mapCollision.length){if(a.mapCollision.indexOf(this)>-1&&a.z>=b.top)return!0}else if(a.z>=b.top)return!0}else{var c=a.getSortBounds();if(this.mapType==="wall"){if(c.front>b.front)return!0}else{if(this.mapType!=="steps")throw"can't test if element contains entity "+this.mapType;if(a.z>=this.z&&c.front>b.back)return!0}}return!1},d.getTop=function(a,b){if(this.mapType==="steps"){var c=this.z+this.depth*(this.y-b)/this.mHeight;return Math.min(this.z+this.depth,Math.max(0,c))}return this.z+this.depth},d.getSortBounds=function(){var a=this.sortBounds;if(!a.inited){a.inited=!0,a.top=this.z+this.depth,a.back=this.y-this.mHeight;if(this.mapType==="entity")throw"entity sorting should not be handled by element instances";if(this.shape==="polygons"&&this.shapes){var b=this.shapes;a.front=-Infinity,a.back=Infinity;var c;for(var d in b){c=this.y-(this.regY-b[d].y),this.mapType==="floor"&&(c+=this.depth);for(var e in b[d].polygons){var f=b[d].polygons[e];for(var g=0;g<f.length;g++){var h=f[g];a.front=Math.max(a.front,c+h[1]),a.back=Math.min(a.back,c+h[1])}}}console.log(this.mapType,this.name,"yd",this.y+this.depth,"r",this.regY,"offsetY",c)}else this.mapType==="wall"?a.front=this.y:this.mapType==="steps"?(a.front=this.y,a.top=this.z):this.mapType==="floor"?(a.back=this.y+this.depth-this.mHeight/2,a.front=a.back+this.mHeight):this.mapType==="parallax"?(a.front=-1,a.back=-1):a.front=this.y+this.mHeight}return a}}(window),function(a){"use strict";var b=a.ec,c=a.cp,d=c.v,e=b.World=function(){this.time=0,this.entities=[],this.elements=[],this.space=null,this.map=null,b.debug>1&&Object.seal(this)},f=1<<31,g=~f,h=e.prototype;h.init=function(){var a=this.space=new c.Space;a.gravity=d(0,0),a.iterations=10,a.sleepTimeThreshold=b.TIME_STEP*9,a.idleSpeedThreshold=.1,a.collisionSlop=.025,a.collisionBias=Math.pow(.25,60),a.damping=.5},h.term=function(){this.entities.length=0,this.elements.length=0;var a=this.space;a&&(a.locked=0,a.collisionHandlers.length=0,a.bodies.length=0,a.sleepingComponents.length=0,a.constraints.length=0,a.arbiters.length=0),this.space=null,this.map=null},h.setMap=function(a){this.term(),this.init(),this.addWalls(0,0,a.width,a.height);var b=a.layers;for(var c=0;c<b.length;c++){var d=b[c];d.layerNum=c;var e=d.elements||[],f=d.shapes||[],g,h;for(g=e.length;g-->0;)e[g].mapType==="entity"?h=this.add(this.initMapEntity(e[g])):(h=this.initMapElement(e[g]),this.addMapElementBody(h)),h.layerNum=c,h.isEntity?e.splice(g,1):(h.visible=!!h.image||!!h.children,e[g]=h);d.elements=e,d.shapes=f}this.map=a},h.initMapEntity=function(a){var c=a.x,d=a.y,e=a.mZ,f=b[a.type];console.log("map entity",a.type,c,d,e);var g=(new f(a.mass,a.mWidth,a.mHeight)).setPos(c,d,e);return g.depth=a.mDepth,g},h.initMapElement=function(a){return a instanceof b.MapElement?a:new b.MapElement(a)},h.addMapElementBody=function(a){var e=a.x,f=a.y,g,h,i,j,k,l;if(a.mapType==="wall"){var m;g=a.shapes;if(a.shape==="polygons"&&g){a.setBody(new c.Body(Infinity,Infinity));for(j in g){i=[],h=g[j];for(k in h.polygons){i=i.concat.apply(i,h.polygons[k]);for(l=1;l<i.length;l+=2)i[l]=-i[l];try{m=this.addPolygons(d(e,f),i,a.body,d(h.x-a.regX,a.regY-h.y)),m.depth=a.depth,m.collision_type=b.Collisions.MAP,console.log('Wall Polygon verts "'+a.name+'" ['+a.x+","+a.y+"]["+a.regY+","+a.regY+"] ["+h.x+","+h.y+"]"+i)}catch(n){console.error('Bad Wall Polygon in "'+a.name+'". '+n+" "+i)}}}}else m=this.addBox(d(e,f-a.mHeight/2),a.mWidth,a.mHeight),m.depth=a.depth,m.collision_type=b.Collisions.MAP,a.setBody(m.body);this.elements.push(a)}else if(a.mapType==="floor"){var o;g=a.shapes;if(a.shape==="polygons"&&g){a.setBody(new c.Body(Infinity,Infinity));for(j in g){i=[],h=g[j];for(k in h.polygons){i=i.concat.apply(i,h.polygons[k]);for(l=1;l<i.length;l+=2)i[l]=-i[l];try{o=this.addPolygons(d(e,f+a.depth),i,a.body,d(h.x-a.regX,a.regY-h.y)),o.depth=a.depth,o.collision_type=b.Collisions.MAP,console.log('Floor Polygon verts "'+a.name+'" ['+a.x+","+a.y+"] "+i)}catch(n){console.error('Bad Floor Polygon in "'+a.name+":"+k+'". '+n+" "+i)}}}}else o=this.addBox(d(e,f+a.depth),a.mWidth,a.mHeight),o.depth=a.depth,o.collision_type=b.Collisions.MAP,a.setBody(o.body);this.elements.push(a)}else if(a.mapType==="steps"){var p=this.addBox(d(e,f-a.mHeight/2),a.mWidth,a.mHeight);p.depth=a.depth,p.collision_type=b.Collisions.MAP,a.setBody(p.body),this.elements.push(a)}else if(a.mapType!=="container"&&a.mapType!=="parallax")throw"can't make cp shape for map shape: "+a.mapType},h.addWalls=function(a,b,c,e){this.addBox(d((c-a)/2,b-64),256+c-a,128),this.addBox(d((c-a)/2,e+64),256+c-a,128),this.addBox(d(c+64,(e-b)/2),128,e-b),this.addBox(d(a-64,(e-b)/2),128,e-b)},h.addBox=function(a,b,d){var e=new c.Body(Infinity,Infinity);e.nodeIdleTime=Infinity,a.y=-a.y,e.p=a;var f=this.space.addShape(new c.BoxShape(e,b,d));return f.setElasticity(0),f.setFriction(1),f.setLayers(g),f},h.addPolygons=function(a,b,e,f){e=e||new c.Body(Infinity,Infinity),f=f||d(0,0),e.nodeIdleTime=Infinity,a.y=-a.y,e.p=a;var h=this.space.addShape(new c.PolyShape(e,b,f));return h.setElasticity(0),h.setFriction(1),h.setLayers(g),h},h.addLineSegment=function(a,b){var d=this.space.addShape(new c.SegmentShape(this.space.staticBody,a,b,0));return d.setElasticity(0),d.setFriction(1),d.setLayers(g),d},h.add=function(a){return this.entities.indexOf(a)<0?(a.body.isStatic()||this.space.addBody(a.body),this.space.addShape(a.shape),this.entities.push(a),a):(console.error("entity already a child of world",a),null)},h.remove=function(a){var b=this.entities.indexOf(a);return b>-1?(a.body.isStatic()||this.space.removeBody(a.body),this.space.removeShape(a.shape),this.entities.splice(b,1),a.mapCollision.length=0,a):(console.error("entity not a child of world",a),null)},h.contains=function(a){return this.entities.indexOf(a)>-1},h.entityForBody=function(a){for(var b=this.entities.length;b-->0;)if(this.entities[b].body===a)return this.entities[b];return console.error("no entity for body",a),null},h.elementForBody=function(a){for(var b=this.elements.length;b-->0;)if(this.elements[b].body===a)return this.elements[b];return console.error("no elements for body",a),null},h.createStaticBody=function(){var a=new c.Body(Infinity,Infinity);return a.nodeIdleTime=Infinity,a},h.step=function(a){var b;for(b=this.entities.length;b-->0;)this.entities[b].step(a);this.space.step(a/1e3);for(b=this.entities.length;b-->0;)this.entities[b].postStep(a);this.time+=a},h.stepScene=function(a){var b;this.space.step(a/1e3);for(b=this.entities.length;b-->0;)this.entities[b].postStepScene(a);this.time+=a}}(window),function(a){"use strict";var b=a.ec,c=b.Scene=function(a){this.data=a,this.mapName=a.map,this.fps=this.data.useFrames?this.data.fps:1,this.duration=this.calculateTime(a.duration),this.time=0,this.complete=!1,this.animations=null,b.debug>1&&Object.seal(this)},d=c.prototype;d.init=function(a){this.time=0,this.complete=!1,this.animations=[];var c=this.data.tracks;for(var d=0;d<c.length;d++){var e=new b.Animation(c[d],a,this.fps);this.animations.push(e),e.actor.shape&&(e.sensor=e.actor.shape.sensor,e.actor.shape.sensor=!0)}},d.step=function(a){var b,c;a/=1e3,this.time+=a;if(this.time>this.duration){this.time=this.duration,this.complete=!0;for(b=0;b<this.animations.length;b++)c=this.animations[b],c.actor.shape&&(c.actor.shape.sensor=c.sensor)}for(b=0;b<this.animations.length;b++)c=this.animations[b],c.update(this.time)},d.skip=function(){this.time=this.duration,this.step(0)},d.calculateTime=function(a){return this.data.useFrames?a/this.fps:a}}(window),function(a){"use strict";var b=a.ec,c={x:0,y:0},d=b.Animation=function(a,c,d){b.extend(this,a),this.actor=c[this.element.name],this.sensor=!1,this.fps=d,this.complete=!1,this.index=-1,this.tween=null,this.update=this.nextTween,b.debug>1&&Object.seal(this)},e=d.prototype;e.idle=function(){},e.nextTween=function(a){var b=this.keyframes,c=++this.index;if(c>=b.length){this.tween&&!this.tween.complete&&this.updateTween(this.tween.endTime),this.update=this.idle,this.complete=!0;return}var d=this.tween={},e=b[c];d.index=c,d.from=e,d.startTime=this.calculateTime(e.start),d.duration=this.calculateTime(e.duration),d.endTime=this.calculateTime(e.start+e.duration);if(e.empty){console.log("empty keyframe",this),d.complete=!0,this.actor.z=1e4,this.checkNext(a);return}d.complete=!1;if(e.tween){var f=b[c+1];d.to=f,e.ease==="inout"?d.fn=this.easeInOutQuad:e.ease==="in"?d.fn=this.easeInQuad:e.ease==="out"?d.fn=this.easeOutQuad:d.fn=this.linearTween}this.updateTween(a)},e.updateTween=function(a){if(this.checkNext(a))return;var b=this.tween,d=b.from,e=d.x,f=d.y,g=d.z;if(d.tween){var h=b.to,i=a-b.startTime;e=b.fn(i,e,h.x-e,b.duration),f=b.fn(i,f,h.y-f,b.duration);if(i<0||i>b.duration)throw"Tween time is out of range of current keyframe";if(this.element.type==="Viewport")this.actor.lookAt(e,f);else{g!==undefined&&(h.z!==undefined&&(g=b.fn(i,d.z,h.z-d.z,b.duration)),f+=g);var j=this.actor.getPos();this.actor.setPos(e,f,g),c.x=e-j.x,c.y=f-j.y,this.actor.setAngle(c,0),this.actor.state="walking";if(c.x||c.y){var k=Math.sqrt(c.x*c.x+c.y*c.y)/4e4;this.actor.walkCount+=Math.max(.15,k)}}this.update=this.updateTween}else this.element.type==="Viewport"?this.actor.lookAt(e,f):(g!==undefined&&(f+=g),this.actor.setPos(e,f,g),this.actor.body.vy=.001,this.actor.state="standing"),b.complete=!0,this.update=this.checkNext},e.checkNext=function(a){return a>this.tween.endTime?(this.nextTween(a),!0):(this.update=this.checkNext,!1)},e.linearTween=function(a,b,c,d){return c*a/d+b},e.easeInQuad=function(a,b,c,d){return a/=d,c*a*a+b},e.easeOutQuad=function(a,b,c,d){return a/=d,-c*a*(a-2)+b},e.easeInOutQuad=function(a,b,c,d){return a/=d/2,a<1?c/2*a*a+b:(a--,-c/2*(a*(a-2)-1)+b)},e.calculateTime=function(a){return this.fps!==1?a/this.fps:a}}(window),function(a){"use strict";var b=a.ec,c=a.createjs;b.SpriteSheets={init:function(){b.SpriteSheets.monk=new c.SpriteSheet({images:["img/sprite/sprites_64.png"],frames:[[0,0,76,137,0,36,126],[77,0,68,142,0,36,125],[146,0,64,138,0,35,124],[211,0,72,136,0,35,126],[284,0,64,138,0,27,124],[349,0,64,142,0,26,125],[414,0,70,141,0,32,129],[485,0,61,139,0,28,126],[547,0,67,140,0,33,128],[615,0,65,139,0,31,126],[681,0,77,142,0,43,126],[759,0,49,143,0,26,125],[809,0,53,143,0,29,125],[863,0,64,135,0,32,126],[928,0,66,134,0,33,125],[0,144,51,136,0,26,123],[52,144,67,134,0,36,125],[120,144,66,136,0,39,123],[187,144,67,138,0,31,128],[255,144,64,140,0,32,126],[320,144,67,138,0,31,128],[388,144,64,140,0,29,126],[453,144,66,134,0,32,125],[520,144,51,136,0,24,123],[572,144,68,134,0,31,125],[641,144,66,136,0,26,123],[708,144,77,142,0,32,126],[786,144,48,143,0,20,125],[835,144,52,143,0,22,125],[888,144,64,135,0,30,126],[0,0,76,137,0,36,126],[0,288,74,138,0,32,116],[75,288,69,134,0,34,113],[145,288,74,144,0,33,100],[220,288,68,142,0,36,125],[289,288,50,142,0,43,124],[340,288,79,144,0,80,126],[420,288,91,135,0,108,116],[512,288,64,137,0,35,123],[577,288,67,139,0,38,126],[645,288,52,142,0,41,131],[698,288,47,140,0,54,131],[746,288,72,136,0,35,126],[819,288,66,137,0,32,136],[886,288,69,138,0,33,142],[956,288,61,138,0,34,144],[0,433,64,137,0,27,123],[65,433,68,139,0,28,126],[134,433,52,142,0,9,131],[187,433,47,140,0,-8,131],[235,433,64,142,0,26,125],[300,433,47,142,0,33,124],[348,433,77,144,0,-4,126],[426,433,91,135,0,-18,116]],animations:{standing:0,walk_0:6,walk_1:10,walk_2:14,walk_3:18,walk_4:22,walk_5:26,punch_0:30,punch_1:34,punch_2:38,punch_3:42,punch_4:46,punch_5:50}}),b.SpriteSheets.ninja=new c.SpriteSheet({images:["img/sprite/sprites_64.png"],frames:[[518,433,74,135,0,37,125],[593,433,60,143,0,31,125],[654,433,65,137,0,36,123],[720,433,74,132,0,37,126],[795,433,65,137,0,27,123],[861,433,60,143,0,27,125],[922,433,72,143,0,36,126],[0,578,72,143,0,36,125],[73,578,72,144,0,36,126],[146,578,72,143,0,36,125],[219,578,74,133,0,37,125],[294,578,74,135,0,37,124],[369,578,74,133,0,37,125],[444,578,74,134,0,37,123],[519,578,58,130,0,27,124],[578,578,59,130,0,28,123],[519,578,58,130,0,27,124],[578,578,59,130,0,28,123],[638,578,60,136,0,33,127],[699,578,60,136,0,33,126],[638,578,60,136,0,33,127],[760,578,60,136,0,33,126],[821,578,58,130,0,34,124],[880,578,59,130,0,34,123],[821,578,58,130,0,34,124],[880,578,59,130,0,34,123],[940,578,74,133,0,35,125],[0,723,74,135,0,35,124],[75,723,74,133,0,35,125],[150,723,74,134,0,35,123],[225,723,119,108,0,44,125],[345,723,127,78,0,47,93],[473,723,145,55,0,46,62],[619,723,140,44,0,41,32],[760,723,96,85,0,42,93],[857,723,101,113,0,51,99],[0,859,89,105,0,42,91],[90,859,81,85,0,41,83],[172,859,78,32,0,41,57]],animations:{standing:0,walk_0:6,walk_1:10,walk_2:14,walk_3:18,walk_4:22,walk_5:26,fall:30,puff:34}}),b.SpriteSheets.throwingStar=new c.SpriteSheet({images:["img/sprite/sprites_64.png"],frames:[[383,859,34,26,0,17,13],[418,859,34,26,0,17,13],[453,859,32,26,0,16,13],[486,859,30,22,0,15,11],[517,859,26,20,0,13,10],[544,859,30,22,0,15,11],[575,859,32,26,0,16,13],[608,859,34,26,0,17,13],[643,859,34,26,0,17,13],[678,859,34,26,0,17,13],[713,859,32,26,0,16,13],[746,859,30,22,0,15,11],[777,859,26,20,0,13,10],[804,859,30,22,0,15,11],[835,859,32,26,0,16,13],[868,859,34,26,0,17,13]]}),b.SpriteSheets.shadow=new c.SpriteSheet({images:["img/sprite/sprites_64.png"],frames:[[302,859,80,54,0,40,26]]}),b.SpriteSheets.shadowSmall=new c.SpriteSheet({images:["img/sprite/sprites_64.png"],frames:[[251,859,50,32,0,23,13]]}),b.SpriteSheets.lion=new c.SpriteSheet({images:["img/sprite/lion_64.png"],frames:[[0,0,80,212,0,40,180]]}),b.SpriteSheets.cauldron=new c.SpriteSheet({images:["img/sprite/cauldron_64.png"],frames:[[0,0,256,255,0,128,148]]})}}}(window),function(a){function h(a,b,f){var g=a.body.a,h=6,i=g+c/6,j,k,l;g===0&&(i-=.1);var m=(5-d(i*3/c))%6;while(m<0)m+=h;if(a.state==="walking")j=b.getAnimation("walk_"+m),j?(k=e(a.walkCount)%4,m=j.frames[0]+k):console.error("no walk_"+m);else if(a.state==="punching")j=b.getAnimation("punch_"+m),j?(l=a.attack.time/a.attack.pushDuration,k=Math.min(3,e(l*3)),m=j.frames[0]+k):console.error("no walk_"+m);else if(a.state==="hit"||a.state==="dead")j=b.getAnimation("fall"),j?(a.state==="dead"?k=3:a.isShadowClone?(l=(a.hitDuration-a.hitTime)/a.hitDuration,k=Math.min(3,e(l*2))):(l=(a.hitDuration-a.hitTime)/a.hitDuration,l<.33?k=-1:(l=(l-.33)*3/2,k=Math.min(3,e(l*3)))),m=k===-1?m:j.frames[0]+k):console.error("no fall");var n=b.getFrame(m);return n===null?(b.complete&&console.error("SpriteSheet null frame. Complete:",b.complete,m,"/",b.getNumFrames(),b.getAnimations()),null):n}function i(a,b,c,d){return c<=b.r&&b.l<=c+a.width&&d<=b.b&&b.t<=d+a.height}"use strict";var b=a.ec,c=Math.PI,d=Math.round,e=Math.floor,f=b.Canvas2dEntityView=function(){b.debug>1&&Object.seal(this)},g=f.prototype;g.draw=function(a,b,c,d){this.drawShadow(a,b,c),this.drawEntity(a,b,c,d)},g.drawShadow=function(a,c,d){var e;if(c instanceof b.Ninja||c instanceof b.Player)e=b.SpriteSheets.shadow.getFrame(0);else{if(!(c instanceof b.Projectile))return;e=b.SpriteSheets.shadowSmall.getFrame(0)}if(e){var f=c.getPos(),g=f.x,h=f.y-c.groundZ,j=e.rect;if(i(j,d,g-e.regX,h-e.regY)){a.save(),b.debug===1&&b.core.traceTime("drawImage shadow "+e.image.src);var k=b.getCached(e.image);a.drawImage(k,j.x,j.y,j.width,j.height,g-e.regX,h-e.regY,j.width,j.height),b.debug===1&&b.core.traceTimeEnd("drawImage shadow "+e.image.src),a.restore()}}},g.drawEntity=function(a,d,f,g){var j=d.getPos(),k=j.x,l=j.y-j.z,m,n,o,p;if(d instanceof b.Ninja)m=h(d,b.SpriteSheets.ninja,g);else if(d instanceof b.Puff){var q=b.SpriteSheets.ninja,r=q.getAnimation("puff");r&&(p=r.frames[0]+e(4.9*(d.duration-d.time)/d.duration),m=q.getFrame(p))}else if(d instanceof b.Projectile){var s=b.SpriteSheets.throwingStar,t=s.getNumFrames();p=e(d.body.a*t/c)%t,m=s.getFrame(p)}else d instanceof b.Player?m=h(d,b.SpriteSheets.monk,g):d instanceof b.Box?m=b.SpriteSheets.lion.getFrame(0):d instanceof b.Circle?m=b.SpriteSheets.cauldron.getFrame(0):d instanceof b.EmptyHand||(b.debug===1&&b.core.traceTime("draw entity"),a.save(),d.radius?(a.fillStyle="#ff8000",a.beginPath(),a.arc(k,l,d.radius,0,2*c,!1),a.fill()):d.width&&d.height?(a.fillStyle="#0008ff",a.beginPath(),a.fillRect(k-d.width/2,l-d.height/2,d.width,d.height)):(a.fillStyle="#000088",a.beginPath(),a.fillRect(k-32,l-32,64,64)),a.restore(),b.debug===1&&b.core.traceTimeEnd("draw entity"));m&&i(m.rect,f,k-m.regX,l-m.regY)&&(o=b.getCached(m.image),n=m.rect,b.debug===1&&b.core.traceTime("drawImage "+m.image.src),a.drawImage(o,n.x,n.y,n.width,n.height,k-m.regX,l-m.regY,n.width,n.height),b.debug===1&&b.core.traceTimeEnd("drawImage "+m.image.src));if(b.debug>1){var u=48;d.label=d.label||b.Entity.getLabel(a,u),d.label.setPos(k-16,l-(m&&m.regY+u||0));var v=""+d.layerNum+": "+d.layerName;d.mapCollision.length&&(v+="\r"+b.objectToProps(d.mapCollision,"name").join(","));if(d.input){var w=d.input.goal;w&&(v+="\r"+w.name+" "+(w.taskIndex+1)+"/"+w.tasks.length+" "+(w.taskTime/1e3).toFixed(1))}d.label.setText(v)}}}(window),function(a){"use strict";var b=a.ec,c=b.Canvas2dMapView=function(){this.layers=[],b.debug>1&&Object.seal(this)},d=c.prototype;d.loadLayers=function(a){var b=this.layers=a.layers;for(var c=b.length;c-->0;)this.loadLayer(b[c],a.path)},d.loadLayer=function(a,b){a.visible!==!1&&(a.visible=!0);for(var c=a.elements.length;c-->0;)a.elements[c].loadImages(b)},d.getLayers=function(){return this.layers||[]},d.getItemsInLayer=function(a,b,c){c=c||[];var d=a.elements;for(var e=b.length;e-->0;){var f=b[e];f.layerNum=-1;for(var g=d.length;g-->0;)if(d[g].isBehindEntity(f)){f.layerNum=a.layerNum,f.layerName=a.name,b.splice(e,1),c.push(f);break}}return c},d.draw=function(a,b){var c=this.layers;for(var d=c.length;d-->0;)this.drawLayer(c[d],a,b)},d.drawLayer=function(a,b,c,d){if(!a.visible)return!1;var e=a.elements;for(var f=e.length;f-->0;)this.drawElement(e[f],b,c,d);return!0},d.drawElement=function(a,c,d,e){if(!a.visible)return!1;if(a.width===0||this.intersects(a,d)){c.save(),c.globalAlpha=a.alpha;var f=a.matrix;f?c.transform(f.a,f.b,f.c,f.d,f.tx-a.regX*f.a,f.ty-a.regY*f.d):c.transform(1,0,0,1,a.drawX,a.drawY);if(a.children){var g=a.children;for(var h=0;h<g.length;h++){var i=g[h];if(a.width||this.intersects(i,d))i.image&&i.imageData?this.drawImage(i,c):this.drawShape(i,c)}}a.imageData&&this.drawImageInplace(a,c),c.restore()}if(b.debug>1){var j=a.getSortBounds(),k=a.mapType==="floor"?"#f00":"#f0f";a.label=a.label||new b.TextField(c,0,0,512,null,k),a.label.setPos(16+a.x-a.width/2,j.back+2),a.label.setText(a.name+": "+a.mapType+" ("+a.y+", "+a.z+", "+a.depth+", "+a.height+", "+a.mHeight+")"+j.back+","+j.front),c.strokeStyle=k,c.lineWidth=1,c.beginPath(),c.rect(a.x-a.width/2,j.back,a.width,j.front-j.back),c.stroke()}return!0},d.drawShape=function(a,c){b.debug===1&&b.core.traceTime("drawShape "+a.fillImage);if(a.fillImage){var d=b.getCached(a.imageData,a.fillImage);c.fillStyle=c.createPattern(d,"repeat")}else c.fillStyle=a.fillColor||"#00f";if(a.polygons){c.save(),c.translate(a.x,a.y);for(var e=0;e<a.polygons.length;e++)this.drawPolygon(a.polygons[e],c);c.restore()}else if(a.oval)c.beginPath(),c.arc(a.x,a.y,a.width/2,0,2*Math.PI,!1),c.fill();else{if(!a.rectangle)throw b.debug===1&&b.core.traceTimeEnd("drawShape "+a.fillImage),"what kind of shape is this? "+a;c.fillRect(a.x,a.y,a.width,a.height)}return b.debug===1&&b.core.traceTimeEnd("drawShape "+a.fillImage),!0},d.drawPolygon=function(a,b){b.beginPath();var c=0;b.moveTo(a[c][0],a[c][1]);for(c=1;c<a.length;c++)b.lineTo(a[c][0],a[c][1]);return b.fill(),!0},d.drawImage=function(a,c){b.debug===1&&b.core.traceTime("drawImage map child "+a.image);var d=b.getCached(a.imageData,a.image);return c.drawImage(d,a.x,a.y,a.width,a.height),b.debug===1&&b.core.traceTimeEnd("drawImage map child "+a.image),!0},d.drawImageInplace=function(a,c){b.debug===1&&b.core.traceTime("drawImage map "+a.image);var d=b.getCached(a.imageData,a.image);c.drawImage(d,0,0),b.debug===1&&b.core.traceTimeEnd("drawImage map "+a.image)},d.intersects=function(a,b){return a.drawX<=b.r&&b.l<=a.drawX+a.width&&a.drawY<=b.b&&b.t<=a.drawY+a.height},d.containsViewPort=function(a,b){return a.drawX<=b.l&&b.r>=a.drawX+a.width&&a.drawY<=b.t&&b.b>=a.drawY+a.height},d.insideViewPort=function(a,b){return b.l<=a.drawX&&a.drawX+a.width>=b.r&&b.t<=a.drawY&&a.drawY+a.height>=b.b}}(window),function(a){"use strict";var b=a.ec,c=b.Canvas2dWorldView=function(a){this.world=a,this.mapRenderer=new b.Canvas2dMapView,this.entityRenderer=new b.Canvas2dEntityView,this.camera={lookAt:function(a,b){this.x=-this.width/this.scaleX/2+a,this.y=-this.height/this.scaleY/2+b}},this.camera.x=this.camera.y=16,this.camera.zoom=1,this.viewport={l:0,t:0,r:0,b:0},b.debug>1&&Object.seal(this)},d=c.prototype;d.loadMap=function(){this.mapRenderer.loadLayers(this.world.map)},d.updateViewport=function(a){var b=this.viewport;return b.l=a.x,b.t=a.y,b.r=b.l+a.width/a.scaleX,b.b=b.t+a.height/a.scaleY,b},d.draw=function(a,b){a.setTransform(1,0,0,1,0,0),a.fillStyle="#888888",a.globalAlpha=1,a.fillRect(0,0,this.camera.width,this.camera.height),a.save(),a.setTransform(this.camera.scaleX,0,0,this.camera.scaleY,-this.camera.x*this.camera.scaleX,-this.camera.y*this.camera.scaleY);var c=this.world.entities.slice(),d=this.mapRenderer.getLayers(),f,g,h,i=[];for(f=d.length;f-->0;){var j=this.mapRenderer.getItemsInLayer(d[f],c,i[f]);j.sort(e),i[f]=j}c.length&&console.error(c.length+" elements did not get placed in a layer");var k=this.updateViewport(this.camera);for(f=0,h=d.length;f<h;f++){this.mapRenderer.drawLayer(d[f],a,k,b);var l=i[f];for(g=0;g<l.length;g++)this.entityRenderer.drawShadow(a,l[g],k,b);for(g=0;g<l.length;g++)this.entityRenderer.drawEntity(a,l[g],k,b)}a.restore()},d.lookAt=function(a,b){this.camera.lookAt(a,b)},d.resize=function(a,b,c){this.camera.width=a*c,this.camera.height=b*c,this.camera.pixelRatio=c,this.zoom(this.camera.zoom)},d.zoom=function(a){var c=b.height<=640?640:720;this.camera.zoom=a,a=a*b.height/c,this.camera.scaleX=this.camera.pixelRatio*a,this.camera.scaleY=this.camera.pixelRatio*a,console.log("zoom",this.camera.zoom,"factor",a,"x,y:",this.camera.scaleX,this.camera.scaleY,"w,h:",this.camera.width,this.camera.height,"px:",this.camera.pixelRatio)};var e=function(a,b){return a.body.p.y>b.body.p.y?-1:b.body.p.y>a.body.p.y?1:0}}(window),function(a){"use strict";var b=a.ec,c=b.Canvas2dCreditsView=function(){this.creditsTime=-1,this.skipAfter=3500,this.overlay=b.getImage("img/ui/credits.png"),b.debug>1&&Object.seal(this)},d=c.prototype;d.init=function(a){this.creditsTime=0,a.setTransform(1,0,0,1,0,0),a.fillStyle="#000",a.globalAlpha=.1},d.draw=function(a,b){a.fillRect(0,0,this.width,this.height),a.globalAlpha=Math.min(1,a.globalAlpha+.1),this.creditsTime+=b;var c=Math.floor(this.creditsTime*24/1e3)*4,d=this.overlay;if(d.height){var e=this.height/d.height,f=this.width-d.width*e,g=Math.max(-258*e,this.height-c);a.drawImage(d,f/2,g,d.width*e,d.height*e)}},d.resize=function(a,b,c){this.width=a*c,this.height=b*c}}(window),function(a){"use strict";var b=a.ec,c=b.Canvas2dView=function(){this.children=[];var c=this.canvas=a.document.createElement("canvas");c.style.position="absolute",this.context=c.getContext("2d"),this.resize(b.width,b.height,b.pixelRatio),a.document.body.appendChild(this.canvas),b.debug>1&&Object.seal(this)},d=c.prototype;d.draw=function(a){var b=this.context,c=this.children;for(var d=0,e=c.length;d<e;d++)c[d].draw(b,a)},d.pause=function(){},d.resume=function(){},d.getDom=function(){return this.canvas},d.add=function(a){return this.children.indexOf(a)<0?(a.resize(this.width,this.height,this.pixelRatio),this.children.push(a),a):(console.error("object already a child of world",a),null)},d.remove=function(a){var b=this.children.indexOf(a);return b>-1?(this.children.splice(b,1),a):(console.error("object not a child of world",a),null)},d.removeAll=function(){this.children.length=0},d.resize=function(a,b,c){var d=this.canvas;this.width=a,this.height=b,this.pixelRatio=c,d.width=a*c,d.height=b*c,d.style.width=this.width+"px",d.style.height=this.height+"px";var e=this.children;for(var f=0,g=e.length;f<g;f++)e[f].resize(a,b,c)},d.debugGui=function(a){var c=this,d=function(){var a=b.pixelRatio;b.resizeDisplay(),b.pixelRatio=a,c.resize(b.width,b.height,a)};a.addGui([{name:"view",remember:!0,target:c[0],props:[{name:"x",params:{min:-480,max:1600}},{name:"y",params:{min:-320,max:1600}},{name:"zoom",onChange:function(a){c.zoom(a)},params:{step:.01,min:.25,max:4}}]},{name:"pixelRatio",target:b,props:[{name:"pixelRatio",params:{min:1,max:2,step:.5},onChange:d}]}])}}(window),function(a){"use strict";var b=a.ec,c={type:"circle",x:0,y:0,radius:50},d=b.ButtonOverlay=function(a){a=b.extend(a||{},c),b.extend(this,a),this.radiusSq=this.radius?this.radius*this.radius:0,this.touches=[],this.pressed=!1,this.vx=this.vy=0,b.debug>1&&Object.seal(this)};d.viewWidth=1280,d.viewHeight=720;var e=d.prototype;e.containerWidth=d.viewWidth,e.containerHeight=d.viewHeight,e.hitTest=function(a,b,c,e){this.containerWidth=c,this.containerHeight=e;if(this.type==="circle"){var f=a*d.viewWidth/c-this.x,g=b*d.viewHeight/e-this.y;if(f*f+g*g<=this.radiusSq)return!0}else if(this.type==="rectangle"){if(a>this.left&&a<this.right&&b>this.top&&b<this.buttom)return!0}else console.error(this,"invalid type:",this.type);return!1},e.addTouch=function(a){this.touches.indexOf(a)<0&&this.touches.push(a)},e.removeTouch=function(a){var b=this.touches.indexOf(a);b>-1&&(this.touches.splice(b,1),this.vx=this.vy=0)},e.hasTouch=function(a){return this.touches.indexOf(a)>-1},e.updateTouch=function(a,b,c){var e=b*d.viewWidth/this.containerWidth-this.x,f=c*d.viewHeight/this.containerHeight-this.y,g=Math.sqrt(e*e+f*f);Math.abs(e)>Math.abs(e*100/g)&&(e=e*100/g),Math.abs(f)>Math.abs(f*100/g)&&(f=f*100/g),this.vx=e,this.vy=f},e.touchStart=function(a,b){this.addTouch(b),this.pressed=!0,this.updateTouch(b,a.clientX,a.clientY)},e.touchEnd=function(a,b){this.hasTouch(b)&&(this.removeTouch(b),this.pressed=!1)},e.draw=function(a,b,c){this.type==="circle"&&(a.beginPath(),a.fillStyle="#000000",a.globalAlpha=.05,a.arc(this.x*d.viewWidth/b,this.y*d.viewHeight/c,this.radius*d.viewWidth/b,0,2*Math.PI,!1),a.fill(),this.pressed&&(a.beginPath(),a.fillStyle="#000000",a.globalAlpha=.1,a.arc((this.x+this.vx)*d.viewWidth/b,(this.y+this.vy)*d.viewHeight/c,80*d.viewWidth/b,0,2*Math.PI,!1),a.fill()))}}(window),function(a){"use strict";var b=a.ec,c=b.TextField=function(a,c,d,e,f,g){this.setContext(a),this.text="",this.multiline=!0,this.x=c||0,this.y=d||0,this.width=0,this.height=0,this.ratio=1,this.canvas=document.createElement("canvas"),this.context=this.canvas.getContext("2d"),this.context.textAlign="start",this.context.textBaseline="top",this.context.font="12px sans-serif",this.lineHeight=14,(e||f)&&this.setSize(e,f),g&&this.setStyle(g),b.debug>1&&Object.seal(this)};c.prototype.setText=function(a){return this.text!==a&&(this.text=a,this.redraw()),this.draw(),this},c.prototype.setContext=function(a){return this.ctx=a,this},c.prototype.setSize=function(a,c){this.width=a||100,this.height=c||this.lineHeight+2;var d=this.ratio=b.pixelRatio||1;return this.canvas.width=this.width*d,this.canvas.height=this.height*d,this.context.scale(d,d),this},c.prototype.setStyle=function(a){return this.context.fillStyle=a||"black",this.text&&this.redraw(),this},c.prototype.setMultiline=function(a){return this.multiline=a,this.text&&this.redraw(),this},c.prototype.setPos=function(a,b){return this.x=a,this.y=b,this},c.prototype.redraw=function(){this.context.clearRect(0,0,this.width,this.height),b.debug===1&&b.core.traceTime("fillText TextField "+this.text.length);if(this.multiline){var a=this.text.split(/[\r\n]/),c=this.lineHeight;for(var d=0;d<a.length;d++)this.context.fillText(a[d],0,c,this.width),c+=this.lineHeight}else this.context.fillText(this.text,0,0,this.width);b.debug===1&&b.core.traceTimeEnd("fillText TextField "+this.text.length)},c.prototype.draw=function(){b.debug===1&&b.core.traceTime("draw TextField canvas"),this.ctx.drawImage(this.canvas,this.x,this.y,this.width,this.height),b.debug===1&&b.core.traceTimeEnd("draw TextField canvas")}}(window),function(a){"use strict";var b=a.ec,c=b.Sound=function(){this.volume=1,this.buffers={},this.sources={};if(b.webaudio)try{var c;a.AudioContext?c=new a.AudioContext:a.webkitAudioContext&&(c=new a.webkitAudioContext),c&&(this.gainNode=c.createGainNode(),this.gainNode.gain.value=this.volume,this.gainNode.connect(c.destination),this.context=c)}catch(d){console.error("Web Audio API not supported")}b.debug>1&&Object.seal(this)},d=c.prototype;d.playGameMusic=function(){this.context&&(this.playSound("audio/game.ogg","game",!0),this.sources.ending&&this.sources.ending.disconnect(0))},d.playEndingMusic=function(){this.context&&(this.playSound("audio/ending.ogg","ending"),this.sources.game&&this.sources.game.disconnect(0))},d.setVolume=function(a){this.volume=a,this.gainNode&&(this.gainNode.gain.value=a)},d.playSound=function(a,b,c){if(this.volume===0)return;var d=this.buffers[b];if(d){var e=this.sources[b]=this.context.createBufferSource();e.buffer=d,e.loop=c===!0,e.connect(this.gainNode),e.noteOn(0)}else this.loadSound(a,b)},d.stop=function(){this.sources.game&&this.sources.game.disconnect(0),this.sources.ending&&this.sources.ending.disconnect(0)},d.loadSound=function(a,c){var d=this.context,e=new XMLHttpRequest;e.open("GET",a,!0),e.responseType="arraybuffer";var f=b.delegate(this,function(b){this.buffers[c]=b,this.playSound(a,c)});e.onload=function(){d.decodeAudioData(e.response,f,this.onError)},e.send()},d.onError=function(){console.error("Audio Error",arguments)}}(window),function(a){"use strict";var b=a.document,c=a.ec,d=a.cp,e=d.v,f=1<<31,g=~f,h=2*Math.PI,i=function(a,b){return a-=b,function(){return a+=b,a}},j=function(){var a=e(0,0);return function(b,c){return a.x=b,a.y=c,a}}(),k=c.ChipmunkDebugView=function(a){this.setSpace(a);var g=this.canvas=b.createElement("canvas");g.style.position="absolute",this.ctx=g.getContext("2d"),this.resize(),this.scale=.1,this.orthoPos=e.mult(this.orthoSize,.5).add(j(0,-this.orthoSize.y)),this.maxArbiters=null,this.maxContacts=null,this.mouseDown=null,this.mouse=e(0,0);var h=this.width-10,k=i(5,15),l=this.infoFields=[];for(var m=6;m-->0;)l.push(new c.TextField(this.ctx,5,k(),h));l[5].setPos(5,this.height-50);var n=this,o=this.canvas2point=function(a,b){return e(a/n.scale-n.orthoPos.x,n.orthoPos.y-b/n.scale)};this.point2canvas=function(a){return e((a.x+n.orthoPos.x)*n.scale,(n.orthoPos.y-a.y)*n.scale)},this.canvas.onmousemove=function(a){n.mouse=o(a.offsetX,a.offsetY);if(n.mouseDown&&!n.mouseJoint){var b=j(a.offsetX-n.mouseDown.x,a.offsetY-n.mouseDown.y).mult(1/n.scale);n.mouseDown.x=a.offsetX,n.mouseDown.y=a.offsetY,n.orthoPos.add(b)}};var p=this.mouseBody=new d.Body(Infinity,Infinity);this.canvas.onmousedown=function(b){var c=b.which===3;if(!c&&!n.mouseJoint){var g=o(b.offsetX,b.offsetY);n.mouseDown=e(b.offsetX,b.offsetY);var h=a.pointQueryFirst(g,f,d.NO_GROUP);if(h){var i=h.body;if(!i.isStatic()){var j=n.mouseJoint=new d.PivotJoint(p,i,e(0,0),i.world2Local(g));j.maxForce=5e4,j.errorBias=Math.pow(.85,60),a.addConstraint(j)}}}},this.canvas.onmouseup=function(b){var c=b.which===3;c||(n.mouseJoint&&(a.removeConstraint(n.mouseJoint),n.mouseJoint=null),n.mouseDown=null)},this.canvas.onmousewheel=function(a){var b=a.detail?a.detail*-1:(a.wheelDeltaY?a.wheelDeltaY:a.wheelDelta)/40;n.scale=Math.min(Math.max(.005,n.scale+b/(-999*n.scale+1e3)),1);var c=e.sub(n.orthoSize,j(n.width,n.height).mult(1/n.scale));n.orthoSize.sub(c),n.orthoPos.sub(c.mult(.5))},c.debug>1&&Object.seal(this)};k.prototype.setSpace=function(a){this.space=a},k.prototype.show=function(){this.canvas.style.display="block",b.body.appendChild(this.canvas)},k.prototype.hide=function(){this.canvas.style.display="none",this.canvas.parentNode&&b.body.removeChild(this.canvas)},k.prototype.resize=function(a){a=a||.36;var b=this.ratio=c.pixelRatio||1;this.width=Math.max(160/b,Math.round(c.width*a)),this.height=Math.max(90/b,Math.round(c.height*a)),this.scale=this.width*a/c.width,this.orthoSize=e(this.width,this.height).mult(1/this.scale);var d=this.canvas;d.width=this.width*b,d.height=this.height*b,d.style.width=this.width+"px",d.style.height=this.height+"px",d.style.left=0,d.style.top=c.height-this.height+"px",this.ctx.scale(b,b)},k.prototype.step=function(a){var b=e.lerp(this.mouseBody.p,this.mouse,.25);this.mouseBody.v=e.mult(e.sub(b,this.mouseBody.p),60),this.mouseBody.p=b,this.draw(a)},k.prototype.draw=function(a){var b=this.ctx,c=this;b.clearRect(0,0,this.width,this.height),b.fillStyle="#ACF",b.globalAlpha=.5,b.fillRect(0,0,this.width,this.height),b.globalAlpha=1,b.strokeStyle="black",this.space.eachShape(function(d){b.fillStyle=d.style(),d.draw(b,c.scale,c.point2canvas)}),b.strokeStyle="red",b.lineWidth=2;var d=this.space.arbiters;for(var e=0;e<d.length;e++){var f=d[e].contacts;for(var g=0;g<f.length;g++){var i=this.point2canvas(f[g].p);b.beginPath(),b.moveTo(i.x-2,i.y-2),b.lineTo(i.x+2,i.y+2),b.stroke(),b.beginPath(),b.moveTo(i.x+2,i.y-2),b.lineTo(i.x-2,i.y+2),b.stroke()}}if(this.mouseJoint){b.beginPath();var j=this.point2canvas(this.mouseBody.p);b.arc(j.x,j.y,this.scale*5,0,h,!1),b.fill(),b.stroke()}this.space.eachConstraint(function(a){a.draw&&a.draw(b,c.scale,c.point2canvas)}),this.drawInfo(a)},k.prototype.drawInfo=function(a){var d=this.space,e=this.infoFields,f=0;this.ctx.textAlign="start",this.ctx.textBaseline="alphabetic",this.ctx.fillStyle="black",e[f++].setText(b.body.clientWidth+","+b.body.clientHeight+" x "+c.pixelRatio);var g=a.children[0];e[f++].setText(a.canvas.width+","+a.canvas.height+" x "+g.camera.zoom+" : "+g.camera.width+","+g.camera.height+" : "+g.camera.scaleX+","+g.camera.scaleY);var h=d.arbiters.length;this.maxArbiters=this.maxArbiters?Math.max(this.maxArbiters,h):h,e[f++].setText("Arbiters: "+h+" (Max: "+this.maxArbiters+")");var i=0;for(var j=0;j<h;j++)i+=d.arbiters[j].contacts.length;this.maxContacts=this.maxContacts?Math.max(this.maxContacts,i):i,e[f++].setText("Contact points: "+i+" (Max: "+this.maxContacts+")"),e[f++].setText("Mouse: "+this.mouse.x.toFixed(0)+", "+this.mouse.y.toFixed(0)),this.message&&e[f++].setText(this.message)};var l=function(b,c,d,e,f){e=d(e),b.beginPath(),b.arc(e.x,e.y,c*f,0,h,!1),b.fill(),b.stroke()},m=function(b,c,d,e){d=c(d),e=c(e),b.beginPath(),b.moveTo(d.x,d.y),b.lineTo(e.x,e.y),b.stroke()},n=[e(0,0),e(.2,0),e(.25,3),e(.3,-6),e(.35,6),e(.4,-6),e(.45,6),e(.5,-6),e(.55,6),e(.6,-6),e(.65,6),e(.7,-3),e(.75,6),e(.8,0),e(1,0)],o=function(b,c,d,f,g){f=d(f),g=d(g),b.beginPath(),b.moveTo(f.x,f.y);var h=e.sub(g,f),i=e.len(h),k=e.mult(h,1/i);for(var l=1;l<n.length;l++){var m=e.add(f,e.rotate(j(n[l].x*i,n[l].y*c),k));b.lineTo(m.x,m.y)}b.stroke()};d.PolyShape.prototype.draw=function(a,b,c){a.beginPath();var d=this.tVerts,e=d.length,f=c(j(d[e-2],d[e-1]));a.moveTo(f.x,f.y);for(var g=0;g<e;g+=2){var h=c(j(d[g],d[g+1]));a.lineTo(h.x,h.y)}a.fill(),a.stroke()},d.SegmentShape.prototype.draw=function(a,b,c){var d=a.lineWidth;a.lineWidth=Math.max(1,this.r*b*2),m(a,c,this.ta,this.tb),a.lineWidth=d},d.CircleShape.prototype.draw=function(a,b,c){l(a,b,c,this.tc,this.r),m(a,c,this.tc,e.mult(this.body.rot,this.r).add(this.tc))},d.PinJoint.prototype.draw=function(a,b,c){var d=this.a.local2World(this.anchr1),e=this.b.local2World(this.anchr2);a.lineWidth=2,a.strokeStyle="grey",m(a,c,d,e)},d.SlideJoint.prototype.draw=function(a,b,c){var d=this.a.local2World(this.anchr1),f=this.b.local2World(this.anchr2),g=e.add(d,e.clamp(e.sub(f,d),this.min));a.lineWidth=2,a.strokeStyle="grey",m(a,c,d,f),a.strokeStyle="red",m(a,c,d,g)},d.PivotJoint.prototype.draw=function(a,b,c){var d=this.a.local2World(this.anchr1),e=this.b.local2World(this.anchr2);a.strokeStyle="grey",a.fillStyle="grey",l(a,b,c,d,2),l(a,b,c,e,2)},d.GrooveJoint.prototype.draw=function(a,b,c){var d=this.a.local2World(this.grv_a),e=this.a.local2World(this.grv_b),f=this.b.local2World(this.anchr2);a.strokeStyle="grey",m(a,c,d,e),l(a,b,c,f,3)},d.DampedSpring.prototype.draw=function(a,b,c){var d=this.a.local2World(this.anchr1),e=this.b.local2World(this.anchr2);a.strokeStyle="grey",o(a,b,c,d,e)};var p=function(){return Math.floor(Math.random()*256)},q=[];for(var r=0;r<100;r++)q.push("rgb("+p()+", "+p()+", "+p()+")");d.Shape.prototype.style=function(){var a;return this.sensor?"rgba(255,255,255,0.1)":(a=this.body,a.isSleeping()?"rgba(50,50,50,0.5)":a.nodeIdleTime>this.space.sleepTimeThreshold?"rgba(170,170,170,0.5)":q[this.hashid%q.length])}}(window),function(a){"use strict";var b=a.ec,c=a.Stats,d=a.dat,e=b.DebugView=function(){var a=this.stats=new c;a.domElement.style.position="absolute",a.domElement.style.left="0px",a.domElement.style.top="0px",b.debug>1&&Object.seal(this)};e.prototype.begin=function(){this.stats.begin()},e.prototype.end=function(){this.stats.end()},e.prototype.show=function(){this.stats.domElement.style.display="block",a.document.body.appendChild(this.stats.domElement)},e.prototype.hide=function(){this.stats.domElement.style.display="none",this.stats.domElement.parentNode&&a.document.body.appendChild(this.stats.domElement)},e.prototype.addGui=function(a){var b=new d.GUI,c=b;for(var e=0;e<a.length;e++){var f=a[e];f.remember&&b.remember(f.target),f.name&&(c=b.addFolder(f.name),c.open());for(var g=0;g<f.props.length;g++){var h=f.props[g],i=h,j=null,k;h.name&&(j=h.params,i=h.name),j?j.min!==undefined&&j.max!==undefined?k=c.add(f.target,i,j.min,j.max,j.step):j.step&&(k=c.add(f.target,i).step(j.step)):k=c.add(f.target,i,j),h.listen&&k.listen(),h.onChange&&k.onChange(h.onChange)}}return b},e.prototype.worldGui=function(a){this.addGui([{name:"space",remember:!0,target:a.space,props:[{name:"iterations",params:{min:1,max:40}},{name:"sleepTimeThreshold",params:{step:b.TIME_STEP,min:b.TIME_STEP,max:1}},{name:"collisionSlop",params:{step:.1,min:.1,max:1}},"damping",{name:"idleSpeedThreshold",listen:!0,params:{min:0,max:50}},{name:"collisionBias"},"enableContactGraph"]}]),this.addGui([{name:"gravity",target:a.space.gravity,props:[{name:"x",params:{step:10,min:-1e3,max:1e3}},{name:"y",params:{step:10,min:-1e3,max:1e3}}]}])}}(window),function(a){function c(){this.row=-1,this.col=-1}"use strict";var b=a.Hungarian={skillMatrix:null,matrix:null,stars:null,rCov:[],cCov:[],rows:0,cols:0,dim:0,solutions:0,FORBIDDEN_VALUE:-999999,hungarianAlgortithm:function(a,c){b.init(a,c),b.matrix=b.subtractRowMins(b.matrix),b.findZeros(b.matrix);var d=!1;while(!d){var e=b.coverColumns(b.matrix);e>b.solutions-1&&(d=!0);if(!d){d=b.coverZeros(b.matrix);while(d){var f=b.findSmallestUncoveredVal(b.matrix);b.matrix=b.uncoverSmallest(f,b.matrix),d=b.coverZeros(b.matrix)}}}return b.getSolution(a,c)},init:function(a,c){b.cols=c.length,b.rows=a.length,b.dim=Math.max(b.rows,b.cols),b.solutions=b.dim,b.matrix=b.initMatrix(b.dim,b.dim),b.stars=b.initMatrix(b.dim,b.dim),b.matrix=b.loadMatrix(c,a,b.matrix,!1),b.rCov=new Array(b.dim),b.cCov=new Array(b.dim),b.initArray(b.cCov,0),b.initArray(b.rCov,0)},initMatrix:function(a,c){var d=new Array(a);for(var e=0;e<a;e++)d[e]=new Array(c),b.initArray(d[e],0);return d},loadMatrix:function(a,c,d,e){return d=b.loadYourMatrix(a,c,d),e&&(d=b.reverseMatrix(b.findMaxValue(d),d)),d},loadYourMatrix:function(a,b,c){for(var d=0;d<c.length;d++){var e=b[d];for(var f=0;f<c[d].length;f++){var g=a[f];if(g){var h=a[f].getPos(),i=h.x-e.x,j=h.y-e.y;c[d][f]=i*i+j*j}else c[d][f]=0,console.error("entity missing from squad: "+f+" "+a)}}return c},findMaxValue:function(a){var b=0;for(var c=0;c<a.length;c++)for(var d=0;d<a[c].length;d++)a[c][d]>b&&(b=a[c][d]);return Number(b)},reverseMatrix:function(a,b){for(var c=0;c<b.length;c++)for(var d=0;d<b[c].length;d++)b[c][d]=(Number(a)-Number(b[c][d])).toFixed(0);return b},subtractRowMins:function(a){for(var b=0;b<a.length;b++){var c=Number.MAX_VALUE;for(var d=0;d<a[b].length;d++)a[b][d]<c&&(c=Number(a[b][d]));for(var e=0;e<a[b].length;e++)a[b][e]=a[b][e]-c}return a},subtractColMins:function(a){for(var b=0;b<a[0].length;b++){var c=Number.MAX_VALUE;for(var d=0;d<a.length;d++)a[d][b]<c&&(c=Number(a[d][b]));for(var e=0;e<a[0].length;e++)a[e][b]=a[e][b]-c}return a},findZeros:function(a){for(var c=0;c<a.length;c++)for(var d=0;d<a[c].length;d++)a[c][d]===0&&b.rCov[c]===0&&b.cCov[d]===0&&(b.stars[c][d]=1,b.cCov[d]=1,b.rCov[c]=1);b.initArray(b.cCov,0),b.initArray(b.rCov,0)},initArray:function(a,b){for(var c=0;c<a.length;c++)a[c]=Number(b)},coverColumns:function(a){var c=0;for(var d=0;d<a.length;d++)for(var e=0;e<a[d].length;e++)b.stars[d][e]===1&&(b.cCov[e]=1);for(var f=0;f<b.cCov.length;f++)c=Number(b.cCov[f])+Number(c);return c},coverZeros:function(a){var c=!0,d=b.findUncoveredZero(a);while(d.row>-1&&c===!0){b.stars[d.row][d.col]=2;var e=b.foundStarInRow(d.row,a);e>-1?(b.rCov[d.row]=1,b.cCov[e]=0):(b.starZeroInRow(d),c=!1),c===!0&&(d=b.findUncoveredZero(a))}return c},findUncoveredZero:function(a){var d=new c;for(var e=0;e<a.length;e++)for(var f=0;f<a[e].length;f++)a[e][f]===0&&b.rCov[e]===0&&b.cCov[f]===0&&(d.row=e,d.col=f,f=a[e].length,e=a.length-1);return d},foundStarInRow:function(a,c){var d=-1;for(var e=0;e<c[a].length;e++)b.stars[a][e]===1&&(d=e,e=c[a].length);return d},starZeroInRow:function(a){var c=!1,d=0,e=b.initMatrix(b.dim*2,2);e[d][0]=a.row,e[d][1]=a.col;while(!c){var f=b.findStarInCol(e[d][1]);f>-1?(d++,e[d][0]=f,e[d][1]=e[d-1][1]):c=!0;if(!c){var g=b.findPrimeInRow(e[d][0]);d++,e[d][0]=e[d-1][0],e[d][1]=g}}b.convertPath(e,d),b.initArray(b.cCov,0),b.initArray(b.rCov,0),b.erasePrimes()},findStarInCol:function(a){var c=-1;for(var d=0;d<b.stars.length;d++)b.stars[d][a]===1&&(c=d,d=b.stars.length);return c},findPrimeInRow:function(a){var c=-1;for(var d=0;d<b.stars[a].length;d++)b.stars[a][d]===2&&(c=d,d=b.stars[a].length);return c},convertPath:function(a,c){for(var d=0;d<c+1;d++){var e=a[d][0],f=a[d][1];b.stars[e][f]===1?b.stars[e][f]=0:b.stars[e][f]===2&&(b.stars[e][f]=1)}},erasePrimes:function(){for(var a=0;a<b.stars.length;a++)for(var c=0;c<b.stars[a].length;c++)b.stars[a][c]===2&&(b.stars[a][c]=0)},findSmallestUncoveredVal:function(a){var c=Number.MAX_VALUE;for(var d=0;d<a.length;d++)for(var e=0;e<a[d].length;e++)b.rCov[d]===0&&b.cCov[e]===0&&c>a[d][e]&&(c=a[d][e]);return c},uncoverSmallest:function(a,c){for(var d=0;d<c.length;d++)for(var e=0;e<c[d].length;e++)b.rCov[d]===1&&(c[d][e]+=a),b.cCov[e]===0&&(c[d][e]-=a);return c},getSolution:function(a,c){var d=[];for(var e=0;e<b.rows;e++)for(var f=0;f<b.cols;f++)b.stars[e][f]===1&&d.push([e,f]);return d}}}(window),function(a){"use strict";var b=a.ec,c=a.cp,d=a.Hungarian,e=c.v,f=b.Formations=function(){this.positions=[],b.debug>1&&Object.seal(this)},g=f.prototype;g.lineupPositions=function(a,b,c,d,f){d=d||96,f=f||128;var g=e.sub(a,b),h=e.len(g);h===0?(g.x=0,g.y=f):h<f&&(g=e.normalize(g).mult(f));var i=e.mult(g,.5),j=e.normalize(e.perp(g)).mult(d);i.sub(e.mult(j,(c-1)/2));var k=Math.atan2(-g.y,g.x)+Math.PI,l=this.getFormationVectors(c),m=[];for(var n=0;n<c;n++)l[n].x=i.x,l[n].y=i.y,m[n]=k,i.add(j);return{positions:l,angles:m}},g.circlePositions=function(a,b,c,d){var f=Math.PI,g=2*f,h=this.getFormationVectors(c),i=[];for(var j=0;j<c;j++){var k=g*j/c,l=e.forangle(k).mult(d);h[j].x=l.x,h[j].y=l.y,i[j]=Math.atan2(-l.y,l.x)+f}return{positions:h,angles:i}},g.updateUnitsHungarian=function(a,b,c){return c=c||b.length,b=b.slice(0,c),a=a.slice(0,c),d.hungarianAlgortithm(b,a)},g.getFormationVectors=function(a){for(var b=0;b<a;b++)this.positions[b]=this.positions[b]||e(0,0);return this.positions},g.newFormationVectors=function(){this.positions=[]}}(window),function(a){function e(a,b){var c=a.swappedColl?a.body_a:a.body_b,e=c.userData.parent;return e?(e.hit(a,d),a.ignore(),!1):a.contacts&&a.contacts.length}function f(a,b){var c=a.body_a.userData.parent,d=a.body_b.userData.parent;return c&&d&&(c.hitTime&&!d.hitTime?d.hit(a,0):d.hitTime&&!c.hitTime&&c.hit(a,0)),!0}function g(a,c){var d=a.swappedColl?a.body_b:a.body_a,e=a.swappedColl?a.body_a:a.body_b,f=d.userData.parent,g=e.userData.parent;return!(b.debug>0),f.addMapCollision(g),!0}function h(a,c){var d=a.swappedColl?a.body_b:a.body_a,e=a.swappedColl?a.body_a:a.body_b,f=d.userData.parent,g=e.userData.parent;!(b.debug>0),f.removeMapCollision(g)}function i(a,b){var c=a.swappedColl?a.body_b:a.body_a,d=a.swappedColl?a.body_a:a.body_b;return j(c.userData.parent,d.userData.parent)}function j(a,c){var d=a.getSortBounds();if(d.top<c.z)return!1;var e=c.getSortBounds();return a.z>e.top?!1:a.z===e.top?!1:(!(b.debug>0),!0)}function k(){return!1}"use strict";var b=a.ec,c=b.Collisions=function(){b.debug>1&&Object.seal(this)};c.PLAYER=1,c.PLAYER_HAND=2,c.MONSTER=10,c.PROJECTILE=12,c.MAP=50,c.PROP=100;var d=10;c.prototype={init:function(a){var b=null;a.addCollisionHandler(c.PLAYER_HAND,c.MONSTER,i,b,e,b),a.addCollisionHandler(c.PLAYER_HAND,c.PROJECTILE,i,b,e,b),a.addCollisionHandler(c.MONSTER,c.MONSTER,i,b,f,b),a.addCollisionHandler(c.PROJECTILE,c.PROP,i,b,f,b),a.addCollisionHandler(c.PROJECTILE,c.PLAYER,i,b,e,b),a.addCollisionHandler(c.PLAYER,c.MAP,g,i,b,h),a.addCollisionHandler(c.MONSTER,c.MAP,g,i,b,h),a.addCollisionHandler(c.PROJECTILE,c.MAP,g,i,b,h),a.addCollisionHandler(c.PLAYER_HAND,c.MAP,i,b,b,b)},term:function(){}}}(window),function(a){"use strict";var b=a.ec,c=[undefined,undefined,undefined,undefined];b.keyPressed={};var d,e=b.UserInput=function(c){d=this,this.index=c||0,this.gamepadTime=1;var e=this.buttons=[];for(var f=0;f<17;f++)e[f]=0;this.axes=[0,0,0,0],b.gamepads&&(b.bind(a,"MozGamepadConnected",this.onGamepadConnect,!1),b.bind(a,"MozGamepadDisconnected",this.onGamepadDisconnect,!1)),this.pollGamePad=navigator.webkitGetGamepads!==undefined?this.pollGamePadList:this.pollDummyGamePadList,this.keyboardAxes1=!1,this.keyboardAxes2=!1,this.overlays=[],this.width=0,this.height=0,this.pixelRatio=1,b.debug>1&&Object.seal(this)},f=e.prototype;f.addButtonOverlay=function(a){var b=this.overlays.indexOf(a);return b<0?(this.overlays.push(a),a):(console.error("overlay already a child of input",a),null)},f.removeButtonOverlay=function(a){var c=this.overlays.indexOf(a);return c>-1?(this.overlays.splice(c,1),b.unbind(a,"touchstart",a.touchStart,!1),b.unbind(a,"touchend",a.touchEnd,!1),a):(console.error("overlay not a child of input",a),null)},f.draw=function(a,c){a.save();var d;for(var e=0,f=this.overlays.length;e<f;e++)d=this.overlays[e],d.draw(a,this.width,this.height);b.core.paused()?(a.fillStyle="#000000",a.globalAlpha=.33,a.fillRect(0,0,this.width,this.height),a.fillStyle="#ffffff",a.globalAlpha=.8,a.beginPath(),a.moveTo(this.width-15,35),a.lineTo(this.width-50,15),a.lineTo(this.width-50,55),a.fill()):b.touch&&(a.fillStyle="#ffffff",a.globalAlpha=.8,a.fillRect(this.width-43,15,10,40),a.fillRect(this.width-25,15,10,40)),d=b.core.getOverlay();if(d){var g=Math.min(this.height/d.height,this.width/d.width),h=this.width-d.width*g,i=this.height-d.height*g;a.globalAlpha=1,b.debug===1&&b.core.traceTime("drawImage overlay "+d.src),a.drawImage(d,h/2,i/2,d.width*g,d.height*g),b.debug===1&&b.core.traceTimeEnd("drawImage overlay "+d.src)}a.restore()},f.resize=function(a,b,c){this.width=a*c,this.height=b*c,this.pixelRatio=c},f.testOverlays=function(a,b,c){var d=this.width/this.pixelRatio,e=this.height/this.pixelRatio;for(var f=0,g=this.overlays.length;f<g;f++){var h=this.overlays[f];a==="touchend"&&(h===this.leftStickOverlay||h===this.rightStickOverlay)&&h["on"+a]!==undefined&&h["on"+a].apply(h,[b,c]);if(h.hitTest(b.clientX,b.clientY,d,e))return h["on"+a]!==undefined&&h["on"+a].apply(h,[b,c]),h}return null},f.setLeftStickOverlay=function(a){this.leftStickOverlay=a,b.bind(a,"touchstart",a.touchStart,!1),b.bind(a,"touchend",a.touchEnd,!1)},f.setRightStickOverlay=function(a){this.rightStickOverlay=a,b.bind(a,"touchstart",a.touchStart,!1),b.bind(a,"touchend",a.touchEnd,!1)},f.setAxes1=function(a,b){this.axes[0]=a,this.axes[1]=b},f.setAxes2=function(a,b){this.axes[2]=a,this.axes[3]=b},f.setButton=function(a,b){this.buttons[a]=b},f.mapButton=function(a,b){h[a]=b},f.poll=function(a,c){this.leftStickOverlay&&!this.keyboardAxes1&&this.setAxes1(this.leftStickOverlay.vx/100,this.leftStickOverlay.vy/100),this.rightStickOverlay&&!this.keyboardAxes2&&this.setAxes2(this.rightStickOverlay.vx/100,this.rightStickOverlay.vy/100);var d=this.pollGamePad()[this.index];d&&this.gamepadTime!==d.timestamp&&(this.gamepadTime=d.timestamp||1,d.buttons[9]===1&&this.buttons[9]!==1&&b.core.togglePause(),d.buttons.join("")!==this.buttons.join("")&&console.log("gamepad button change",d.buttons.indexOf(1),this.buttons.indexOf(1),d.axes),this.buttons=d.buttons.slice(0),this.keyboardAxes1||this.setAxes1(d.axes[0],d.axes[1]),this.keyboardAxes2||this.setAxes2(d.axes[3],d.axes[4]))},f.mapCollision=function(a,b){},f.touchstart=function(a){if(b.core.paused())return;for(var c=0,e=a.changedTouches.length;c<e;c++)d.testOverlays(a.type,a.changedTouches[c],a.changedTouches[c].identifier)},f.touchmove=function(a){for(var b=0,c=d.overlays.length;b<c;b++){var e=d.overlays[b];for(var f=0,g=a.changedTouches.length;f<g;f++)if(e.hasTouch(a.changedTouches[f].identifier)){e.updateTouch(a.changedTouches[f].identifier,a.changedTouches[f].clientX,a.changedTouches[f].clientY);break}}a.preventDefault()},f.touchend=function(a){if(b.core.paused()){b.core.resume();return}for(var c=0,e=a.changedTouches.length;c<e;c++)d.testOverlays(a.type,a.changedTouches[c],a.changedTouches[c].identifier)},f.mousedown=function(c){if(b.core.paused())return;d.testOverlays(c.type,c,-1)||(b.bind(b.core.getViewDom(),"mousemove",d.mouseRightStick,!1),b.bind(a,"mouseup",d.mouseRightStickEnd,!1),d.mouseRightStick(c))},f.mouseRightStick=function(a){var c=a.target.width/2,e=a.target.height/2,f=a.offsetX-c,g=a.offsetY-e,h=b.core.getCamera();g-=64*h.scaleY;var i=Math.sqrt(f*f+g*g);f/=i,g/=i,d.setAxes2(f,g)},f.mouseRightStickEnd=function(a){b.unbind(b.core.getViewDom(),"mousemove",d.mouseRightStick,!1),d.setAxes2(0,0)},f.mouseup=function(a){if(b.core.paused()){b.core.resume();return}d.testOverlays(a.type,a,-1)},f.keydown=function(a){var c=a.keyCode||a.which;b.keyPressed[c]=!0;switch(c){case g.RIGHT:case g.D:case g.LEFT:case g.A:case g.UP:case g.W:case g.DOWN:case g.S:d.updateAxes1FromKeys();break;case g.SPACE:case g.ENTER:d.setButton(h.SELECT,1);break;case g.BACKSLASH:d.setButton(h.CANCEL,1)}},f.keyup=function(a){var c=a.keyCode||a.which;b.keyPressed[c]=!1;switch(c){case g.RIGHT:case g.D:case g.LEFT:case g.A:case g.UP:case g.W:case g.DOWN:case g.S:d.updateAxes1FromKeys();break;case g.SPACE:case g.ENTER:d.setButton(h.SELECT,0);break;case g.BACKSLASH:d.setButton(h.CANCEL,0);break;case g.P:b.core.paused()?b.core.resume():b.core.pause();break;case g.O:b.core.cycleDebug();break;case g.M:b.core.cycleMap();break;case g.F:case g.SLASH:b.core.fullscreen();break;default:console.log(String.fromCharCode(c),c)}},f.clearKeys=function(){b.keyPressed={},this.keyboardAxes1=!1,this.keyboardAxes2=!1,this.setAxes1(0,0),this.setAxes2(0,0),this.setButton(h.SELECT,0),this.setButton(h.CANCEL,0)},f.updateAxes1FromKeys=function(){var a=(b.keyPressed[g.LEFT]||b.keyPressed[g.A]?-1:0)+(b.keyPressed[g.RIGHT]||b.keyPressed[g.D]?1:0),c=(b.keyPressed[g.UP]||b.keyPressed[g.W]?-1:0)+(b.keyPressed[g.DOWN]||b.keyPressed[g.S]?1:0);this.keyboardAxes1=a||c,this.setAxes1(a,c)},f.pollDummyGamePadList=function(){return c},f.pollGamePadList=function(){return navigator.webkitGetGamepads()},f.onGamepadConnect=function(a){console.log("onGamepadConnect",a);if(a.gamepad.index===0){var b=a.gamepad;this.pollGamePad=function(){return b}}},f.onGamepadDisconnect=function(a){console.log("onGamepadDisconnect",a),a.gamepad.index===0&&(this.pollGamePad=this.pollDummyGamePadList)};var g={LEFT:37,UP:38,RIGHT:39,DOWN:40,ENTER:13,SHIFT:16,CTRL:17,ALT:18,SPACE:32,NUM0:48,NUM1:49,NUM2:50,NUM3:51,NUM4:52,NUM5:53,NUM6:54,NUM7:55,NUM8:56,NUM9:57,A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90,SLASH:191,BACKSLASH:220},h={SELECT:0,CANCEL:1}}(window),function(a){"use strict";var b=a.ec,c=a.cp,d=b.GoalBasedInput=function(){this.setBaseProperties(),b.debug>1&&Object.seal(this)},e=d.prototype;e.getBaseProperties=function(){return{axes:[0,0,0,0],goal:null,goalIndex:-1,targetPos:null,targetAngle:null,targetEntity:null}},e.setBaseProperties=function(){b.extend(this,this.getBaseProperties())},e.poll=function(a,b){if(this.state==="dead")return;var c=this.goal;if(!c||c.met){c=this.selectGoal();if(c===null)return;this.setGoal(c)}var d=c.task;if(!d||d.complete)d=this.selectTask(c,a);d&&(c.taskTime+=b,d.apply(this,arguments))},e.mapCollision=function(a){this.completeTask(),this.goal&&(this.goal.mapCollisions++,this.goal.task&&this.goal.task.mapCollisions++)},e.setAxes1=function(a,b){this.axes[0]=a,this.axes[1]=b},e.setAxes2=function(a,b){this.axes[2]=a,this.axes[3]=b},e.selectGoal=function(){return null},e.setGoal=function(a){a.met=!1,a.task=null,a.taskIndex=-1,a.taskTime=0,a.mapCollisions=0,this.goal=a},e.selectTask=function(a,b){var c,d;return d=a.taskIndex+1,d>=a.tasks.length?(a.met=!0,null):(c=a.tasks[d],c.complete=!1,c.mapCollisions=0,a.task=c,a.taskIndex=d,a.taskTime=0,c)},e.completeTask=function(){this.goal&&this.goal.task&&(this.goal.task.complete=!0)},e.updateTargetPos=function(){var a=this.targetPos||c.v(0,0);if(!this.targetEntity)return console.error("update target: targetEntity not set"),this.completeTask(),a;var b=this.targetEntity.getPos();return a.x=b.x,a.y=b.y,this.targetPos=a,a}}(window),function(a){function i(){return function(b){this.targetPos=d(Math.random()*1e3,Math.random()*1e3+1e3),b.speed=6,this.completeTask()}}function j(a,b){return a=a||A,b=b||6,function(c){if(!this.targetPos){this.setAxes1(0,0),this.completeTask();return}var e=d.sub(this.targetPos,c.getPos());if(F(e)<a*a){this.completeTask();var f=this.targetAngle;f?c.body.a=f:c.setAngle(e,0),this.targetPos=null,this.setAxes1(0,0);return}G(e,!0),this.setAxes1(e.x,e.y)}}function k(a,b){return a=a||B,b=b||6,function(c){if(!this.targetPos){this.completeTask();return}var e=d.sub(c.getPos(),this.targetPos);if(F(e)>a*a){this.completeTask(),this.targetPos=null,this.setAxes1(0,0),c.setAngle(e,0);return}G(e,!0),this.setAxes1(e.x,e.y)}}function l(a,b){return a=a||B,b=b||6,function(c){if(!this.targetPos){this.completeTask();return}var e=d.sub(this.targetPos,c.getPos());if(F(e)>a*a+A*A){G(e,!0),this.setAxes1(e.x,e.y);return}if(F(e)<a*a){G(e,!0),this.setAxes1(-e.x,-e.y);return}this.completeTask(),this.targetPos=null,this.setAxes1(0,0),c.setAngle(e,0)}}function m(a,b){a=a||A,b=b||6;var c=j(a);return function(d){d.speed=b,this.updateTargetPos(),c.apply(this,arguments)}}function n(a,b){a=a||A,b=b||6;var c=l(a);return function(d){d.speed=b,this.updateTargetPos(),c.apply(this,arguments)}}function o(a,b){a=a||A,b=b||6;var c=l(a);return function(d){d.speed=b,this.updateTargetPos(),c.apply(this,arguments)}}function p(){var a=j(0,8);return function(c){g.apply(this,arguments),a.apply(this,arguments)}}function q(a,b){a=a||7,b=b||a;var c=r(a,b);return function(d){if(d.getClones().length>=a){this.completeTask();return}this.turns+=.5,d.body.a+=.5,this.turns>11&&(this.turns=0,this.goal.task=c,this.goal.taskTime=0)}}function r(a,b){return a=a||7,b=b||b,function(d){++this.clones>b||d.getClones().length>=a?(this.clones=0,this.completeTask()):d.shadowClone()}}function s(a,b,c){return a=a||128,b=b||128,c=c||100,function(e){var f=e.getClones(),g=Math.min(c,f.length),h=this.updateTargetPos(),i=this.formations.lineupPositions(e.getPos(),h,g,a,b),j=this.formations.updateUnitsHungarian(f,i.positions,g);v(f,i,j,g,h),this.completeTask()}}function t(a,b){return a=a||256,b=b||100,function(d){var e=d.getClones().slice(0);e.unshift(d);var f=Math.min(b,e.length),g=this.updateTargetPos(),h=this.formations.circlePositions(d.getPos(),g,f,a),i=this.formations.updateUnitsHungarian(e,h.positions,f);v(e,h,i,f,g),this.completeTask()}}function u(a,b){return a=a||256,b=b||100,function(d){var e=d.getClones(),f=Math.min(b,e.length),g=this.updateTargetPos(),h=this.formations.circlePositions(d.getPos(),g,f,a),i=this.formations.updateUnitsHungarian(e,h.positions,f);v(e,h,i,f,g),this.completeTask()}}function v(a,b,c,e,f){e=e||c.length;var g=f?f.x:0,h=f?f.y:0,i=b.positions,k=b.angles;for(var l=0;l<e;l++){var m=i[c[l][0]],n=k[c[l][0]],o=a[c[l][1]],p=o.input,q=p.targetPos||d(0,0);q.x=m.x+g,q.y=m.y+h,p.targetPos===null&&(p.targetPos=q),p.targetAngle=n,o.isShadowClone&&p.setGoal({name:"move to",tasks:[j(A/2)]})}}function w(a,b,c,e){c=c||a.length;var f=e?e.x:0,g=e?e.y:0,h=b.positions,i=b.angles;for(var k=0;k<c;k++){var l=h[k],m=i[k],n=a[k],o=n.input,p=o.targetPos||d(0,0);p.x=l.x+f,p.y=l.y+g,o.targetPos===null&&(o.targetPos=p),o.targetAngle=m,n.isShadowClone&&o.setGoal({name:"move to",tasks:[j(A/2)]})}}function x(a){return a=a||1e3,function(c){if(this.goal.taskTime<a){var d=c.getClones();for(var e=0;e<d.length;e++){var f=d[e].input;if(f.goal&&!f.goal.met)return}}this.completeTask()}}function y(){return function(b){var c=b.getClones();for(var d=0;d<c.length;d++){var e=c[d].input;e.goal&&e.goal.met&&e.goal.mapCollisions===0&&c[d].throwStar()}this.completeTask()}}function z(a){return a=a||120,function(){this.goal.taskTime>=a&&this.completeTask()}}function F(a){return a.x*a.x+a.y*a.y}function G(a,c){c||(a=b.copy({},a));var d=Math.sqrt(F(a));return a.x=a.x/d,a.y=a.y/d,a}"use strict";var b=a.ec,c=a.cp,d=c.v,e=b.EnemyInput=function(){this.setBaseProperties(),this.turns=0,this.clones=0,this.formations=new b.Formations,b.debug>1&&Object.seal(this)},f=e.prototype;e.ready=function(){b.extend(f,b.GoalBasedInput.prototype)},f.selectGoal=function(){var a,b;return b=this.goalIndex+1,b>=E.length&&(b=0),a=E[b],this.goalIndex=b,a};var g=function(){this.targetEntity=b.player,this.completeTask()},h=function(){this.targetEntity=b.player,this.updateTargetPos(),this.completeTask()},A=64,B=512,C=12,D={faceOff:{name:"face off",tasks:[g,n(200,C),z(250)]},formLine:{name:"formation line",tasks:[g,n(350,C),z(33),q(8),r(8),s(80,200),z(166)]},waitForClones:{name:"wait for clones",tasks:[x(800)]},throwStars:{name:"throw stars",tasks:[g,y(),z(600)]},formCircleWithLeader:{name:"formation circle with leader",tasks:[g,q(8),r(8),t(360),j(A/2),z(1500)]},formCircle:{name:"formation circle",tasks:[g,n(360),q(8),r(8),u(200),z(1500)]},circleTarget:{name:"circle target",tasks:[z(1)]},rush:{name:"rush",tasks:[h,j(100),p()]},scatter:{name:"scatter",tasks:[i(),j()]},avoid:{name:"avoid",tasks:[h,k(600),z(300)]},moveToPosition:{name:"move to",tasks:[j(A/2)]}},E=[D.formLine,D.waitForClones,D.throwStars,D.formCircleWithLeader,D.formCircle]}(window),function(a){"use strict";var b=a.ec,c=b.ShadowCloneInput=function(){this.setBaseProperties(),b.debug>1&&Object.seal(this)},d=c.prototype;c.ready=function(){b.extend(d,b.GoalBasedInput.prototype)}}(window);