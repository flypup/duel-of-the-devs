(function(){Object.create=Object.create||function(a){function b(){}return b.prototype=a,new b};var a;typeof exports=="undefined"?(a={},typeof window=="object"&&(window.cp=a)):a=exports;var b=function(a,b){if(!a)throw new Error("Assertion failed: "+b)},c=function(a,b){!a&&console&&console.warn&&(console.warn("ASSERTION FAILED: "+b),console.trace&&console.trace())},d=function(a,b){return a<b?a:b},e=function(a,b){return a>b?a:b},f,g;typeof window=="object"&&window.navigator.userAgent.indexOf("Firefox")>-1?(f=Math.min,g=Math.max):(f=d,g=e);var h=function(a,b){return a<b?a+" "+b:b+" "+a},i=function(a,b){for(var c=0;c<a.length;c++)if(a[c]===b){a[c]=a[a.length-1],a.length--;return}},j=a.momentForCircle=function(a,b,c,d){return a*(.5*(b*b+c*c)+Q(d))},k=a.areaForCircle=function(a,b){return Math.PI*Math.abs(a*a-b*b)},l=a.momentForSegment=function(a,b,c){var d=D(G(c,b)),e=I(F(b,c),.5);return a*(d*d/12+Q(e))},m=a.areaForSegment=function(a,b,c){return c*(Math.PI*c+2*W(a,b))},n=a.momentForPoly=function(a,b,c){var d=0,e=0,f=b.length;for(var g=0;g<f;g+=2){var h=b[g]+c.x,i=b[g+1]+c.y,j=b[(g+2)%f]+c.x,k=b[(g+3)%f]+c.y,l=K(j,k,h,i),m=C(h,i,h,i)+C(h,i,j,k)+C(j,k,j,k);d+=l*m,e+=l}return a*d/(6*e)},o=a.areaForPoly=function(a){var b=0;for(var c=0,d=a.length;c<d;c+=2)b+=J(new z(a[c],a[c+1]),new z(a[(c+2)%d],a[(c+3)%d]));return-b/2},p=a.centroidForPoly=function(a){var b=0,c=new z(0,0);for(var d=0,e=a.length;d<e;d+=2){var f=new z(a[d],a[d+1]),g=new z(a[(d+2)%e],a[(d+3)%e]),h=J(f,g);b+=h,c=F(c,I(F(f,g),h))}return I(c,1/(3*b))},q=a.recenterPoly=function(a){var b=p(a);for(var c=0;c<a.length;c+=2)a[c]-=b.x,a[c+1]-=b.y},r=a.momentForBox=function(a,b,c){return a*(b*b+c*c)/12},s=a.momentForBox2=function(a,b){return width=b.r-b.l,height=b.t-b.b,offset=I([b.l+b.r,b.b+b.t],.5),r(a,width,height)+a*Q(offset)},t=function(a,b,c){return f(g(a,b),c)},u=function(a){return g(0,f(a,1))},v=function(a,b,c){return a*(1-c)+b*c},w=function(a,b,c){return a+t(b-a,-c,c)},x=0,y={},z=a.Vect=function(a,b){this.x=a,this.y=b,x++};a.v=function(a,b){return new z(a,b)};var A=a.vzero=new z(0,0),B=a.v.dot=function(a,b){return a.x*b.x+a.y*b.y},C=function(a,b,c,d){return a*c+b*d},D=a.v.len=function(a){return Math.sqrt(B(a,a))},E=a.v.eql=function(a,b){return a.x===b.x&&a.y===b.y},F=a.v.add=function(a,b){return new z(a.x+b.x,a.y+b.y)};z.prototype.add=function(a){return this.x+=a.x,this.y+=a.y,this};var G=a.v.sub=function(a,b){return new z(a.x-b.x,a.y-b.y)};z.prototype.sub=function(a){return this.x-=a.x,this.y-=a.y,this};var H=a.v.neg=function(a){return new z(-a.x,-a.y)};z.prototype.neg=function(){return this.x=-this.x,this.y=-this.y,this};var I=a.v.mult=function(a,b){return new z(a.x*b,a.y*b)};z.prototype.mult=function(a){return this.x*=a,this.y*=a,this};var J=a.v.cross=function(a,b){return a.x*b.y-a.y*b.x},K=function(a,b,c,d){return a*d-b*c},L=a.v.perp=function(a){return new z(-a.y,a.x)},M=a.v.pvrperp=function(a){return new z(a.y,-a.x)},N=a.v.project=function(a,b){return I(b,B(a,b)/Q(b))};z.prototype.project=function(a){return this.mult(B(this,a)/Q(a)),this};var O=a.v.rotate=function(a,b){return new z(a.x*b.x-a.y*b.y,a.x*b.y+a.y*b.x)};z.prototype.rotate=function(a){return this.x=this.x*a.x-this.y*a.y,this.y=this.x*a.y+this.y*a.x,this};var P=a.v.unrotate=function(a,b){return new z(a.x*b.x+a.y*b.y,a.y*b.x-a.x*b.y)},Q=a.v.lengthsq=function(a){return B(a,a)},R=a.v.lerp=function(a,b,c){return F(I(a,1-c),I(b,c))},S=a.v.normalize=function(a){return I(a,1/D(a))},T=a.v.normalize_safe=function(a){return a.x===0&&a.y===0?A:S(a)},U=a.v.clamp=function(a,b){return B(a,a)>b*b?I(S(a),b):a},V=a.v.lerpconst=function(a,b,c){return F(a,U(G(b,a),c))},W=a.v.dist=function(a,b){return D(G(a,b))},X=a.v.distsq=function(a,b){return Q(G(a,b))},Y=a.v.near=function(a,b,c){return X(a,b)<c*c},Z=a.v.slerp=function(a,b,c){var d=Math.acos(B(a,b));if(d){var e=1/Math.sin(d);return F(I(a,Math.sin((1-c)*d)*e),I(b,Math.sin(c*d)*e))}return a},$=a.v.slerpconst=function(a,b,c){var d=Math.acos(B(a,b));return Z(a,b,f(c,d)/d)},_=a.v.forangle=function(a){return new z(Math.cos(a),Math.sin(a))},ab=a.v.toangle=function(a){return Math.atan2(a.y,a.x)},bb=a.v.str=function(a){return"("+a.x.toFixed(3)+", "+a.y.toFixed(3)+")"},cb=0,db=a.BB=function(a,b,c,d){this.l=a,this.b=b,this.r=c,this.t=d,cb++};a.bb=function(a,b,c,d){return new db(a,b,c,d)};var eb=function(a,b){return new db(a.x-b,a.y-b,a.x+b,a.y+b)},fb=function(a,b){return a.l<=b.r&&b.l<=a.r&&a.b<=b.t&&b.b<=a.t},gb=function(a,b,c,d,e){return a.l<=d&&b<=a.r&&a.b<=e&&c<=a.t},hb=function(a,b){return a.l<=b.l&&a.r>=b.r&&a.b<=b.b&&a.t>=b.t},ib=function(a,b){return a.l<=b.x&&a.r>=b.x&&a.b<=b.y&&a.t>=b.y},jb=function(a,b,c,d,e){return a<=e.x&&c>=e.x&&b<=e.y&&d>=e.y},kb=function(a,b){return new db(f(a.l,b.l),f(a.b,b.b),g(a.r,b.r),g(a.t,b.t))},lb=function(a,b){return new db(f(a.l,b.x),f(a.b,b.y),g(a.r,b.x),g(a.t,b.y))},mb=function(a){return(a.r-a.l)*(a.t-a.b)},nb=function(a,b){return(g(a.r,b.r)-f(a.l,b.l))*(g(a.t,b.t)-f(a.b,b.b))},ob=function(a,b,c,d,e){return(g(a.r,d)-f(a.l,b))*(g(a.t,e)-f(a.b,c))},pb=function(a,b,c){return bbSegmentQuery(a,b,c)!=Infinity},qb=function(a,b){var c=f(g(a.l,b.x),a.r),d=f(g(a.b,b.y),a.t);return new z(c,d)},rb=function(a,b){var c=Math.abs(a.r-a.l),d=(b.x-a.l)%c,e=d>0?d:d+c,f=Math.abs(a.t-a.b),g=(b.y-a.b)%f,h=g>0?g:g+f;return new z(e+a.l,h+a.b)},sb=0,tb=a.NO_GROUP=0,ub=a.ALL_LAYERS=-1;a.resetShapeIdCounter=function(){sb=0};var vb=a.Shape=function(a){this.body=a,this.bb_l=this.bb_b=this.bb_r=this.bb_t=0,this.hashid=sb++,this.sensor=!1,this.e=0,this.u=0,this.surface_v=A,this.collision_type=0,this.group=0,this.layers=ub,this.space=null,this.collisionCode=this.collisionCode};vb.prototype.setElasticity=function(a){this.e=a},vb.prototype.setFriction=function(a){this.body.activate(),this.u=a},vb.prototype.setLayers=function(a){this.body.activate(),this.layers=a},vb.prototype.setSensor=function(a){this.body.activate(),this.sensor=a},vb.prototype.setCollisionType=function(a){this.body.activate(),this.collision_type=a},vb.prototype.getBody=function(){return this.body},vb.prototype.active=function(){return this.body&&this.body.shapeList.indexOf(this)!==-1},vb.prototype.setBody=function(a){b(!this.active(),"You cannot change the body on an active shape. You must remove the shape, then "),this.body=a},vb.prototype.cacheBB=function(){return this.update(this.body.p,this.body.rot)},vb.prototype.update=function(a,c){b(!isNaN(c.x),"Rotation is NaN"),b(!isNaN(a.x),"Position is NaN"),this.cacheData(a,c)},vb.prototype.getBB=function(){return new db(this.bb_l,this.bb_b,this.bb_r,this.bb_t)};var wb=function(a){this.shape=a,this.d=Infinity,this.n=A},xb=function(a,b,c){this.shape=a,this.t=b,this.n=c};xb.prototype.hitPoint=function(a,b){return R(a,b,this.t)},xb.prototype.hitDist=function(a,b){return W(a,b)*this.t};var yb=a.CircleShape=function(a,b,c){this.c=this.tc=c,this.r=b,this.type="circle",vb.call(this,a)};yb.prototype=Object.create(vb.prototype),yb.prototype.cacheData=function(a,b){var c=this.tc=O(this.c,b).add(a),d=this.r;this.bb_l=c.x-d,this.bb_b=c.y-d,this.bb_r=c.x+d,this.bb_t=c.y+d},yb.prototype.pointQuery=function(a){var b=G(a,this.tc),c=Q(b),d=this.r;if(c<d*d){var e=new wb(this),f=Math.sqrt(c);return e.d=d-f,e.n=I(b,1/f),e}};var zb=function(a,b,c,d,e,f){d=G(d,b),e=G(e,b);var g=B(d,d)-2*B(d,e)+B(e,e),h=-2*B(d,d)+2*B(d,e),i=B(d,d)-c*c,j=h*h-4*g*i;if(j>=0){var k=(-h-Math.sqrt(j))/(2*g);if(0<=k&&k<=1)return new xb(a,k,S(R(d,e,k)))}};yb.prototype.segmentQuery=function(a,b){return zb(this,this.tc,this.r,a,b)};var Ab=a.SegmentShape=function(a,b,c,d){this.a=b,this.b=c,this.n=L(S(G(c,b))),this.ta=this.tb=this.tn=null,this.r=d,this.a_tangent=A,this.b_tangent=A,this.type="segment",vb.call(this,a)};Ab.prototype=Object.create(vb.prototype),Ab.prototype.cacheData=function(a,b){this.ta=F(a,O(this.a,b)),this.tb=F(a,O(this.b,b)),this.tn=O(this.n,b);var c,d,e,f;this.ta.x<this.tb.x?(c=this.ta.x,d=this.tb.x):(c=this.tb.x,d=this.ta.x),this.ta.y<this.tb.y?(e=this.ta.y,f=this.tb.y):(e=this.tb.y,f=this.ta.y);var g=this.r;this.bb_l=c-g,this.bb_b=e-g,this.bb_r=d+g,this.bb_t=f+g},Ab.prototype.pointQuery=function(a){if(!jb(this.bb_l,this.bb_b,this.bb_r,this.bb_t,a))return;var b=this.ta,c=this.tb,d=G(c,b),e=u(B(d,G(a,b))/Q(d)),f=F(b,I(d,e)),g=G(a,f),h=Q(g),i=this.r;if(h<i*i){var j=new wb(this),k=Math.sqrt(h);return j.d=i-k,j.n=I(g,1/k),j}},Ab.prototype.segmentQuery=function(a,b){var c=this.tn,d=B(G(this.ta,a),c),e=this.r,f=d>0?H(c):c,g=G(I(f,e),a),h=F(this.ta,g),i=F(this.tb,g),j=G(b,a);if(J(j,h)*J(j,i)<=0){var k=d+(d>0?-e:e),l=-k,m=B(j,c)-k;if(l*m<0)return new xb(this,l/(l-m),f)}else if(e!==0){var n=zb(this,this.ta,this.r,a,b),o=zb(this,this.tb,this.r,a,b);return n?o&&o.t<n.t?o:n:o}},Ab.prototype.setNeighbors=function(a,b){this.a_tangent=G(a,this.a),this.b_tangent=G(b,this.b)},Ab.prototype.setEndpoints=function(a,b){this.a=a,this.b=b,this.n=L(S(G(b,a)))};var Bb=function(a){var b=a.length;for(var c=0;c<b;c+=2){var d=a[c],e=a[c+1],f=a[(c+2)%b],g=a[(c+3)%b],h=a[(c+4)%b],i=a[(c+5)%b];if(K(f-d,g-e,h-f,i-g)>0)return!1}return!0},Cb=a.PolyShape=function(a,c,d){b(c.length>=4,"Polygons require some verts"),b(typeof c[0]=="number","Polygon verticies should be specified in a flattened list"),b(Bb(c),"Polygon is concave or has a reversed winding."),this.setVerts(c,d),this.type="poly",vb.call(this,a)};Cb.prototype=Object.create(vb.prototype);var Db=function(a,b){this.n=a,this.d=b};Cb.prototype.setVerts=function(a,b){var c=a.length,d=c>>1;this.verts=new Array(c),this.tVerts=new Array(c),this.axes=new Array(d),this.tAxes=new Array(d);for(var e=0;e<c;e+=2){var f=a[e]+b.x,g=a[e+1]+b.y,h=a[(e+2)%c]+b.x,i=a[(e+3)%c]+b.y,j=S(L(new z(h-f,i-g)));this.verts[e]=f,this.verts[e+1]=g,this.axes[e>>1]=new Db(j,C(j.x,j.y,f,g)),this.tAxes[e>>1]=new Db(new z(0,0),0)}};var Eb=a.BoxShape=function(a,b,c){var d=b/2,e=c/2;return Fb(a,new db(-d,-e,d,e))},Fb=a.BoxShape2=function(a,b){var c=[b.l,b.b,b.l,b.t,b.r,b.t,b.r,b.b];return new Cb(a,c,A)};Cb.prototype.transformVerts=function(a,b){var c=this.verts,d=this.tVerts,e=Infinity,h=-Infinity,i=Infinity,j=-Infinity;for(var k=0;k<c.length;k+=2){var l=c[k],m=c[k+1],n=a.x+l*b.x-m*b.y,o=a.y+l*b.y+m*b.x;d[k]=n,d[k+1]=o,e=f(e,n),h=g(h,n),i=f(i,o),j=g(j,o)}this.bb_l=e,this.bb_b=i,this.bb_r=h,this.bb_t=j},Cb.prototype.transformAxes=function(a,b){var c=this.axes,d=this.tAxes;for(var e=0;e<c.length;e++){var f=O(c[e].n,b);d[e].n=f,d[e].d=B(a,f)+c[e].d}},Cb.prototype.cacheData=function(a,b){this.transformAxes(a,b),this.transformVerts(a,b)},Cb.prototype.pointQuery=function(a){if(!jb(this.bb_l,this.bb_b,this.bb_r,this.bb_t,a))return;var b=new wb(this),c=this.tAxes;for(var d=0;d<c.length;d++){var e=c[d].n,f=c[d].d-B(e,a);if(f<0)return;f<b.d&&(b.d=f,b.n=e)}return b},Cb.prototype.segmentQuery=function(a,b){var c=this.tAxes,d=this.tVerts,e=c.length,f=e*2;for(var g=0;g<e;g++){var h=c[g].n,i=B(a,h);if(c[g].d>i)continue;var j=B(b,h),k=(c[g].d-i)/(j-i);if(k<0||1<k)continue;var l=R(a,b,k),m=-J(h,l),n=-K(h.x,h.y,d[g*2],d[g*2+1]),o=-K(h.x,h.y,d[(g*2+2)%f],d[(g*2+3)%f]);if(n<=m&&m<=o)return new xb(this,k,h)}},Cb.prototype.getNumVerts=function(){return this.verts.length/2},Cb.prototype.getVert=function(a){return new z(this.verts[a*2],this.verts[a*2+1])},Cb.prototype.valueOnAxis=function(a,b){var c=this.tVerts,d=C(a.x,a.y,c[0],c[1]);for(var e=2;e<c.length;e+=2)d=f(d,C(a.x,a.y,c[e],c[e+1]));return d-b},Cb.prototype.containsVert=function(a,b){var c=this.tAxes;for(var d=0;d<c.length;d++){var e=c[d].n,f=C(e.x,e.y,a,b)-c[d].d;if(f>0)return!1}return!0},Cb.prototype.containsVertPartial=function(a,b,c){var d=this.tAxes;for(var e=0;e<d.length;e++){var c=d[e].n;if(B(c,c)<0)continue;var f=C(c.x,c.y,a,b)-d[e].d;if(f>0)return!1}return!0},Cb.prototype.getNumVerts=function(){return this.verts.length/2},Cb.prototype.getVert=function(a){return new z(this.verts[a*2],this.verts[a*2+1])};var Gb=a.Body=function(a,b){this.p=new z(0,0),this.vx=this.vy=0,this.f=new z(0,0),this.w=0,this.t=0,this.v_limit=Infinity,this.w_limit=Infinity,this.v_biasx=this.v_biasy=0,this.w_bias=0,this.space=null,this.shapeList=[],this.arbiterList=null,this.constraintList=null,this.nodeRoot=null,this.nodeNext=null,this.nodeIdleTime=0,this.setMass(a),this.setMoment(b),this.rot=new z(0,0),this.setAngle(0)},Hb=function(){return body=new Gb(Infinity,Infinity),body.nodeIdleTime=Infinity,body};if(typeof DEBUG!="undefined"&&DEBUG){var Ib=function(a,c){b(a.x==a.x&&a.y==a.y,c)},Jb=function(a,c){b(Math.abs(a.x)!==Infinity&&Math.abs(a.y)!==Infinity,c)},Kb=function(a,b){Ib(a,b),Jb(a,b)};Gb.prototype.sanityCheck=function(){b(this.m===this.m&&this.m_inv===this.m_inv,"Body's mass is invalid."),b(this.i===this.i&&this.i_inv===this.i_inv,"Body's moment is invalid."),Kb(this.p,"Body's position is invalid."),Kb(this.f,"Body's force is invalid."),b(this.vx===this.vx&&Math.abs(this.vx)!==Infinity,"Body's velocity is invalid."),b(this.vy===this.vy&&Math.abs(this.vy)!==Infinity,"Body's velocity is invalid."),b(this.a===this.a&&Math.abs(this.a)!==Infinity,"Body's angle is invalid."),b(this.w===this.w&&Math.abs(this.w)!==Infinity,"Body's angular velocity is invalid."),b(this.t===this.t&&Math.abs(this.t)!==Infinity,"Body's torque is invalid."),Kb(this.rot,"Internal error: Body's rotation vector is invalid."),b(this.v_limit===this.v_limit,"Body's velocity limit is invalid."),b(this.w_limit===this.w_limit,"Body's angular velocity limit is invalid.")}}else Gb.prototype.sanityCheck=function(){};Gb.prototype.getPos=function(){return this.p},Gb.prototype.getVel=function(){return new z(this.vx,this.vy)},Gb.prototype.getAngVel=function(){return this.w},Gb.prototype.isSleeping=function(){return this.nodeRoot!==null},Gb.prototype.isStatic=function(){return this.nodeIdleTime===Infinity},Gb.prototype.isRogue=function(){return this.space===null},Gb.prototype.setMass=function(a){b(a>0,"Mass must be positive and non-zero."),this.activate(),this.m=a,this.m_inv=1/a},Gb.prototype.setMoment=function(a){b(a>0,"Moment of Inertia must be positive and non-zero."),this.activate(),this.i=a,this.i_inv=1/a},Gb.prototype.addShape=function(a){this.shapeList.push(a)},Gb.prototype.removeShape=function(a){i(this.shapeList,a)};var Lb=function(a,b,c){return a===c?a.next(b):(a.a===b?a.next_a=Lb(a.next_a,b,c):a.next_b=Lb(a.next_b,b,c),a)};Gb.prototype.removeConstraint=function(a){this.constraintList=Lb(this.constraintList,this,a)},Gb.prototype.setPos=function(a){this.activate(),this.sanityCheck(),this.p=a},Gb.prototype.setVel=function(a){this.activate(),this.vx=a.x,this.vy=a.y},Gb.prototype.setAngVel=function(a){this.activate(),this.w=a},Gb.prototype.setAngleInternal=function(a){b(!isNaN(a),"Internal Error: Attempting to set body's angle to NaN"),this.a=a,this.rot.x=Math.cos(a),this.rot.y=Math.sin(a)},Gb.prototype.setAngle=function(a){this.activate(),this.sanityCheck(),this.setAngleInternal(a)},Gb.prototype.velocity_func=function(a,b,c){var d=this.vx*b+(a.x+this.f.x*this.m_inv)*c,e=this.vy*b+(a.y+this.f.y*this.m_inv)*c,f=this.v_limit,g=d*d+e*e,h=g>f*f?f/Math.sqrt(len):1;this.vx=d*h,this.vy=e*h;var i=this.w_limit;this.w=t(this.w*b+this.t*this.i_inv*c,-i,i),this.sanityCheck()},Gb.prototype.position_func=function(a){this.p.x+=(this.vx+this.v_biasx)*a,this.p.y+=(this.vy+this.v_biasy)*a,this.setAngleInternal(this.a+(this.w+this.w_bias)*a),this.v_biasx=this.v_biasy=0,this.w_bias=0,this.sanityCheck()},Gb.prototype.resetForces=function(){this.activate(),this.f=new z(0,0),this.t=0},Gb.prototype.applyForce=function(a,b){this.activate(),this.f=F(this.f,a),this.t+=J(b,a)},Gb.prototype.applyImpulse=function(a,b){this.activate(),Qc(this,a.x,a.y,b)},Gb.prototype.getVelAtPoint=function(a){return F(new z(this.vx,this.vy),I(L(a),this.w))},Gb.prototype.getVelAtWorldPoint=function(a){return this.getVelAtPoint(G(a,this.p))},Gb.prototype.getVelAtLocalPoint=function(a){return this.getVelAtPoint(O(a,this.rot))},Gb.prototype.eachShape=function(a){for(var b=0,c=this.shapeList.length;b<c;b++)a(this.shapeList[b])},Gb.prototype.eachConstraint=function(a){var b=this.constraintList;while(b){var c=b.next(this);a(b),b=c}},Gb.prototype.eachArbiter=function(a){var b=this.arbiterList;while(b){var c=b.next(this);b.swappedColl=this===b.body_b,a(b),b=c}},Gb.prototype.local2World=function(a){return F(this.p,O(a,this.rot))},Gb.prototype.world2Local=function(a){return P(G(a,this.p),this.rot)},Gb.prototype.kineticEnergy=function(){var a=this.vx*this.vx+this.vy*this.vy,b=this.w*this.w;return(a?a*this.m:0)+(b?b*this.i:0)};var Mb=a.SpatialIndex=function(a){this.staticIndex=a,a&&(b(!a.dynamicIndex,"This static index is already associated with a dynamic index."),a.dynamicIndex=this)};Mb.prototype.collideStatic=function(a,b){if(a.count>0){var c=a.query;this.each(function(a){c(a,new db(a.bb_l,a.bb_b,a.bb_r,a.bb_t),b)})}};var Nb=a.BBTree=function(a){Mb.call(this,a),this.velocityFunc=null,this.leaves={},this.count=0,this.root=null,this.stamp=0};Nb.prototype=Object.create(Mb.prototype);var Ob=0,Pb=function(a,b,c){this.obj=null,this.bb_l=f(b.bb_l,c.bb_l),this.bb_b=f(b.bb_b,c.bb_b),this.bb_r=g(b.bb_r,c.bb_r),this.bb_t=g(b.bb_t,c.bb_t),this.parent=null,this.setA(b),this.setB(c),Ob++},Qb=0,Rb=function(a,b){this.obj=b,a.getBB(b,this),this.parent=null,this.stamp=1,this.pairs=null,Qb++};Nb.prototype.getBB=function(a,b){var c=this.velocityFunc;if(c){var d=.1,e=(a.bb_r-a.bb_l)*d,h=(a.bb_t-a.bb_b)*d,i=I(c(a),.1);b.bb_l=a.bb_l+f(-e,i.x),b.bb_b=a.bb_b+f(-h,i.y),b.bb_r=a.bb_r+g(e,i.x),b.bb_t=a.bb_t+g(h,i.y)}else b.bb_l=a.bb_l,b.bb_b=a.bb_b,b.bb_r=a.bb_r,b.bb_t=a.bb_t},Nb.prototype.getStamp=function(){var a=this.dynamicIndex;return a&&a.stamp?a.stamp:this.stamp},Nb.prototype.incrementStamp=function(){this.dynamicIndex&&this.dynamicIndex.stamp?this.dynamicIndex.stamp++:this.stamp++};var Sb=function(a,b){this.a=a,this.b=b},Tb=function(a,b){this.prev=null,this.next=b,this.leaf=a};Tb.prototype.unlink=function(){var a=this.next,b=this.prev;a&&(a.a.leaf==this.leaf?a.a.prev=b:a.b.prev=b),b?b.a.leaf==this.leaf?b.a.next=a:b.b.next=a:this.leaf.pairs=a},Rb.prototype.clearPairs=function(a){var b=this.pairs,c;this.pairs=null;while(b)b.a.leaf==this?(c=b.a.next,b.b.unlink(),b=c):(c=b.b.next,b.a.unlink(),b=c)};var Ub=function(a,b,c){var d=a.pairs,e=b.pairs,f=new Sb(new Tb(a,d),new Tb(b,e));a.pairs=b.pairs=f,d&&(d.a.leaf==a?d.a.prev=f:d.b.prev=f),e&&(e.a.leaf==b?e.a.prev=f:e.b.prev=f)};Pb.prototype.setA=function(a){this.A=a,a.parent=this},Pb.prototype.setB=function(a){this.B=a,a.parent=this},Rb.prototype.isLeaf=!0,Pb.prototype.isLeaf=!1,Pb.prototype.otherChild=function(a){return this.A==a?this.B:this.A},Pb.prototype.replaceChild=function(a,b,d){c(a==this.A||a==this.B,"Node is not a child of parent."),this.A==a?this.setA(b):this.setB(b);for(var e=this;e;e=e.parent){var h=e.A,i=e.B;e.bb_l=f(h.bb_l,i.bb_l),e.bb_b=f(h.bb_b,i.bb_b),e.bb_r=g(h.bb_r,i.bb_r),e.bb_t=g(h.bb_t,i.bb_t)}},Pb.prototype.bbArea=Rb.prototype.bbArea=function(){return(this.bb_r-this.bb_l)*(this.bb_t-this.bb_b)};var Vb=function(a,b){return(g(a.bb_r,b.bb_r)-f(a.bb_l,b.bb_l))*(g(a.bb_t,b.bb_t)-f(a.bb_b,b.bb_b))},Wb=function(a,b){return Math.abs(a.bb_l+a.bb_r-b.bb_l-b.bb_r)+Math.abs(a.bb_b+b.bb_t-b.bb_b-b.bb_t)},Xb=function(a,b,c){if(a==null)return b;if(a.isLeaf)return new Pb(c,b,a);var d=a.B.bbArea()+Vb(a.A,b),e=a.A.bbArea()+Vb(a.B,b);return d===e&&(d=Wb(a.A,b),e=Wb(a.B,b)),e<d?a.setB(Xb(a.B,b,c)):a.setA(Xb(a.A,b,c)),a.bb_l=f(a.bb_l,b.bb_l),a.bb_b=f(a.bb_b,b.bb_b),a.bb_r=g(a.bb_r,b.bb_r),a.bb_t=g(a.bb_t,b.bb_t),a};Pb.prototype.intersectsBB=Rb.prototype.intersectsBB=function(a){return this.bb_l<=a.r&&a.l<=this.bb_r&&this.bb_b<=a.t&&a.b<=this.bb_t};var Yb=function(a,b,c){a.intersectsBB(b)&&(a.isLeaf?c(a.obj):(Yb(a.A,b,c),Yb(a.B,b,c)))},Zb=function(a,b,c){var d=1/(c.x-b.x),e=a.bb_l==b.x?-Infinity:(a.bb_l-b.x)*d,h=a.bb_r==b.x?Infinity:(a.bb_r-b.x)*d,i=f(e,h),j=g(e,h),k=1/(c.y-b.y),l=a.bb_b==b.y?-Infinity:(a.bb_b-b.y)*k,m=a.bb_t==b.y?Infinity:(a.bb_t-b.y)*k,n=f(l,m),o=g(l,m);if(n<=j&&i<=o){var p=g(i,n),q=f(j,o);if(0<=q&&p<=1)return g(p,0)}return Infinity},$b=function(a,b,c,d,e){if(a.isLeaf)return e(a.obj);var g=Zb(a.A,b,c),h=Zb(a.B,b,c);return g<h?(g<d&&(d=f(d,$b(a.A,b,c,d,e))),h<d&&(d=f(d,$b(a.B,b,c,d,e)))):(h<d&&(d=f(d,$b(a.B,b,c,d,e))),g<d&&(d=f(d,$b(a.A,b,c,d,e)))),d},_b=function(a,b,c){if(b==a)return null;var d=b.parent;if(d==a){var e=a.otherChild(b);return e.parent=a.parent,e}return d.parent.replaceChild(d,d.otherChild(b),c),a},ac=function(a,b){return a.bb_l<=b.bb_r&&b.bb_l<=a.bb_r&&a.bb_b<=b.bb_t&&b.bb_b<=a.bb_t},bc=function(a,b,c,d,e){ac(b,a)&&(a.isLeaf?c?Ub(b,a,d):(a.stamp<b.stamp&&Ub(a,b,d),e&&e(b.obj,a.obj)):(bc(a.A,b,c,d,e),bc(a.B,b,c,d,e)))},cc=function(a,b,c,d){if(a.stamp==b.getStamp()){c&&bc(c,a,!1,b,d);for(var e=a;e.parent;e=e.parent)e==e.parent.A?bc(e.parent.B,a,!0,b,d):bc(e.parent.A,a,!1,b,d)}else{var f=a.pairs;while(f)a==f.b.leaf?(d&&d(f.a.leaf.obj,a.obj),f=f.b.next):f=f.a.next}},dc=function(a,b,c,d){a.isLeaf?cc(a,b,c,d):(dc(a.A,b,c,d),dc(a.B,b,c,d))};Rb.prototype.containsObj=function(a){return this.bb_l<=a.bb_l&&this.bb_r>=a.bb_r&&this.bb_b<=a.bb_b&&this.bb_t>=a.bb_t},Rb.prototype.update=function(a){var b=a.root,c=this.obj;return this.containsObj(c)?!1:(a.getBB(this.obj,this),b=_b(b,this,a),a.root=Xb(b,this,a),this.clearPairs(a),this.stamp=a.getStamp(),!0)},Rb.prototype.addPairs=function(a){var b=a.dynamicIndex;if(b){var c=b.root;c&&bc(c,this,!0,b,null)}else{var d=a.staticIndex.root;cc(this,a,d,null)}},Nb.prototype.insert=function(a,b){var c=new Rb(this,a);this.leaves[b]=c,this.root=Xb(this.root,c,this),this.count++,c.stamp=this.getStamp(),c.addPairs(this),this.incrementStamp()},Nb.prototype.remove=function(a,b){var c=this.leaves[b];delete this.leaves[b],this.root=_b(this.root,c,this),this.count--,c.clearPairs(this)},Nb.prototype.contains=function(a,b){return this.leaves[b]!=null};var ec=function(a,b){};Nb.prototype.reindexQuery=function(a){if(!this.root)return;var b,c=this.leaves;for(b in c)c[b].update(this);var d=this.staticIndex,e=d&&d.root;dc(this.root,this,e,a),d&&!e&&this.collideStatic(this,d,a),this.incrementStamp()},Nb.prototype.reindex=function(){this.reindexQuery(ec)},Nb.prototype.reindexObject=function(a,b){var c=this.leaves[b];c&&(c.update(this)&&c.addPairs(this),this.incrementStamp())},Nb.prototype.pointQuery=function(a,b){this.root&&Yb(this.root,new db(a.x,a.y,a.x,a.y),b)},Nb.prototype.segmentQuery=function(a,b,c,d){this.root&&$b(this.root,a,b,c,d)},Nb.prototype.query=function(a,b){this.root&&Yb(this.root,a,b)},Nb.prototype.count=function(){return this.count},Nb.prototype.each=function(a){var b;for(b in this.leaves)a(this.leaves[b].obj)};var fc=function(a,b,c,d,e){return(g(a.bb_r,d)-f(a.bb_l,b))*(g(a.bb_t,e)-f(a.bb_b,c))},gc=function(a,b,c,d){if(d==1)return b[c];if(d==2)return new Pb(a,b[c],b[c+1]);var e=b[c],h=e.bb_l,i=e.bb_b,j=e.bb_r,k=e.bb_t,l=c+d;for(var m=c+1;m<l;m++)e=b[m],h=f(h,e.bb_l),i=f(i,e.bb_b),j=g(j,e.bb_r),k=g(k,e.bb_t);var n=j-h>k-i,o=new Array(d*2);if(n)for(var m=c;m<l;m++)o[2*m+0]=b[m].bb_l,o[2*m+1]=b[m].bb_r;else for(var m=c;m<l;m++)o[2*m+0]=b[m].bb_b,o[2*m+1]=b[m].bb_t;o.sort(function(a,b){return a-b});var p=(o[d-1]+o[d])*.5,q=h,r=i,s=j,t=k,u=h,v=i,w=j,x=k;n?s=u=p:t=v=p;var y=l;for(var z=c;z<y;){var e=b[z];fc(e,u,v,w,x)<fc(e,q,r,s,t)?(y--,b[z]=b[y],b[y]=e):z++}if(y==d){var e=null;for(var m=c;m<l;m++)e=Xb(e,b[m],a);return e}return NodeNew(a,gc(a,b,c,y-c),gc(a,b,y,l-y))};Nb.prototype.optimize=function(){var a=new Array(this.count),b=0;for(var c in this.leaves)a[b++]=this.nodes[c];this.root=gc(tree,a,a.length)};var hc=function(a,b){!a.isLeaf&&b<=10&&(hc(a.a,b+1),hc(a.b,b+1));var c="";for(var d=0;d<b;d++)c+=" "};Nb.prototype.log=function(){this.root&&hc(this.root,0)};var ic=a.CollisionHandler=function(){this.a=this.b=0};ic.prototype.begin=function(a,b){return!0},ic.prototype.preSolve=function(a,b){return!0},ic.prototype.postSolve=function(a,b){},ic.prototype.separate=function(a,b){};var jc=4,kc=function(a,b){this.e=0,this.u=0,this.surface_vr=A,this.a=a,this.body_a=a.body,this.b=b,this.body_b=b.body,this.thread_a_next=this.thread_a_prev=null,this.thread_b_next=this.thread_b_prev=null,this.contacts=null,this.stamp=0,this.handler=null,this.swappedColl=!1,this.state="first coll"};kc.prototype.getShapes=function(){return this.swappedColl?[this.b,this.a]:[this.a,this.b]},kc.prototype.totalImpulse=function(){var a=this.contacts,b=new z(0,0);for(var c=0,d=a.length;c<d;c++){var e=a[c];b.add(I(e.n,e.jnAcc))}return this.swappedColl?b:b.neg()},kc.prototype.totalImpulseWithFriction=function(){var a=this.contacts,b=new z(0,0);for(var c=0,d=a.length;c<d;c++){var e=a[c];b.add((new z(e.jnAcc,e.jtAcc)).rotate(e.n))}return this.swappedColl?b:b.neg()},kc.prototype.totalKE=function(){var a=(1-this.e)/(1+this.e),b=0,c=this.contacts;for(var d=0,e=c.length;d<e;d++){var f=c[d],g=f.jnAcc,h=f.jtAcc;b+=a*g*g/f.nMass+h*h/f.tMass}return b},kc.prototype.ignore=function(){this.state="ignore"},kc.prototype.getA=function(){return this.swappedColl?this.b:this.a},kc.prototype.getB=function(){return this.swappedColl?this.a:this.b},kc.prototype.isFirstContact=function(){return this.state==="first coll"};var lc=function(a,b,c){this.point=a,this.normal=b,this.dist=c};kc.prototype.getContactPointSet=function(){var a=new Array(this.contacts.length),b;for(b=0;b<a.length;b++)a[b]=new lc(this.contacts[b].p,this.contacts[b].n,this.contacts[b].dist);return a},kc.prototype.getNormal=function(a){var b=this.contacts[a].n;return this.swappedColl?H(b):b},kc.prototype.getPoint=function(a){return this.contacts[a].p},kc.prototype.getDepth=function(a){return this.contacts[a].dist};var mc=function(a,b,c,d){c?c.body_a===b?c.thread_a_next=d:c.thread_b_next=d:b.arbiterList=d,d&&(d.body_a===b?d.thread_a_prev=c:d.thread_b_prev=c)};kc.prototype.unthread=function(){mc(this,this.body_a,this.thread_a_prev,this.thread_a_next),mc(this,this.body_b,this.thread_b_prev,this.thread_b_next),this.thread_a_prev=this.thread_a_next=null,this.thread_b_prev=this.thread_b_next=null},kc.prototype.update=function(a,b,c,d){if(this.contacts)for(var e=0;e<this.contacts.length;e++){var f=this.contacts[e];for(var g=0;g<a.length;g++){var h=a[g];h.hash===f.hash&&(h.jnAcc=f.jnAcc,h.jtAcc=f.jtAcc)}}this.contacts=a,this.handler=b,this.swappedColl=c.collision_type!==b.a,this.e=c.e*d.e,this.u=c.u*d.u,this.surface_vr=G(c.surface_v,d.surface_v),this.a=c,this.body_a=c.body,this.b=d,this.body_b=d.body,this.state=="cached"&&(this.state="first coll")},kc.prototype.preStep=function(a,b,c){var d=this.body_a,e=this.body_b;for(var g=0;g<this.contacts.length;g++){var h=this.contacts[g];h.r1=G(h.p,d.p),h.r2=G(h.p,e.p),h.nMass=1/Uc(d,e,h.r1,h.r2,h.n),h.tMass=1/Uc(d,e,h.r1,h.r2,L(h.n)),h.bias=-c*f(0,h.dist+b)/a,h.jBias=0,h.bounce=Pc(d,e,h.r1,h.r2,h.n)*this.e}},kc.prototype.applyCachedImpulse=function(a){if(this.isFirstContact())return;var b=this.body_a,c=this.body_b;for(var d=0;d<this.contacts.length;d++){var e=this.contacts[d],f=e.n.x,g=e.n.y,h=f*e.jnAcc-g*e.jtAcc,i=f*e.jtAcc+g*e.jnAcc;Rc(b,c,e.r1,e.r2,h*a,i*a)}};var nc=0,oc=0;kc.prototype.applyImpulse=function(){nc++;var a=this.body_a,b=this.body_b,c=this.surface_vr,d=this.u;for(var e=0;e<this.contacts.length;e++){oc++;var f=this.contacts[e],h=f.nMass,i=f.n,j=f.r1,k=f.r2,l=b.vx-k.y*b.w-(a.vx-j.y*a.w),m=b.vy+k.x*b.w-(a.vy+j.x*a.w),n=i.x*(b.v_biasx-k.y*b.w_bias-a.v_biasx+j.y*a.w_bias)+i.y*(k.x*b.w_bias+b.v_biasy-j.x*a.w_bias-a.v_biasy),o=C(l,m,i.x,i.y),p=C(l+c.x,m+c.y,-i.y,i.x),q=(f.bias-n)*h,r=f.jBias;f.jBias=g(r+q,0);var s=-(f.bounce+o)*h,u=f.jnAcc;f.jnAcc=g(u+s,0);var v=d*f.jnAcc,w=-p*f.tMass,x=f.jtAcc;f.jtAcc=t(x+w,-v,v);var y=i.x*(f.jBias-r),z=i.y*(f.jBias-r);Sc(a,-y,-z,j),Sc(b,y,z,k);var A=f.jnAcc-u,B=f.jtAcc-x;Rc(a,b,j,k,i.x*A-i.y*B,i.x*B+i.y*A)}},kc.prototype.callSeparate=function(a){var b=a.lookupHandler(this.a.collision_type,this.b.collision_type);b.separate(this,a)},kc.prototype.next=function(a){return this.body_a==a?this.thread_a_next:this.thread_b_next};var pc=0,qc=function(a,b,c,d){this.p=a,this.n=b,this.dist=c,this.r1=this.r2=A,this.nMass=this.tMass=this.bounce=this.bias=0,this.jnAcc=this.jtAcc=this.jBias=0,this.hash=d,pc++},rc=[],sc=function(a,b,c,d){var e=c+d,f=G(b,a),g=Q(f);if(g>=e*e)return;var h=Math.sqrt(g);return new qc(F(a,I(f,.5+(c-.5*e)/(h?h:Infinity))),h?I(f,1/h):new z(1,0),h-e,0)},tc=function(a,b){var c=sc(a.tc,b.tc,a.r,b.r);return c?[c]:rc},uc=function(a,b){var c=b.ta,d=b.tb,e=a.tc,f=G(d,c),g=u(B(f,G(e,c))/Q(f)),h=F(c,I(f,g)),i=sc(e,h,a.r,b.r);if(i){var j=i.n;return g===0&&B(j,b.a_tangent)<0||g===1&&B(j,b.b_tangent)<0?rc:[i]}return rc},vc=0,wc=function(a,b){var c=0,d=a.valueOnAxis(b[0].n,b[0].d);if(d>0)return-1;for(var e=1;e<b.length;e++){var f=a.valueOnAxis(b[e].n,b[e].d);if(f>0)return-1;f>d&&(d=f,c=e)}return vc=d,c},xc=function(a,b,c,d){var e=[],f=a.tVerts;for(var g=0;g<f.length;g+=2){var i=f[g],j=f[g+1];b.containsVertPartial(i,j,H(c))&&e.push(new qc(new z(i,j),c,d,h(a.hashid,g)))}var k=b.tVerts;for(var g=0;g<k.length;g+=2){var i=k[g],j=k[g+1];a.containsVertPartial(i,j,c)&&e.push(new qc(new z(i,j),c,d,h(b.hashid,g)))}return e},yc=function(a,b,c,d){var e=[],f=a.tVerts;for(var g=0;g<f.length;g+=2){var i=f[g],j=f[g+1];b.containsVert(i,j)&&e.push(new qc(new z(i,j),c,d,h(a.hashid,g>>1)))}var k=b.tVerts;for(var g=0;g<k.length;g+=2){var i=k[g],j=k[g+1];a.containsVert(i,j)&&e.push(new qc(new z(i,j),c,d,h(b.hashid,g>>1)))}return e.length?e:xc(a,b,c,d)},zc=function(a,b){var c=wc(b,a.tAxes);if(c==-1)return rc;var d=vc,e=wc(a,b.tAxes);if(e==-1)return rc;var f=vc;return d>f?yc(a,b,a.tAxes[c].n,d):yc(a,b,H(b.tAxes[e].n),f)},Ac=function(a,b,c){var d=B(b,a.ta)-a.r,e=B(b,a.tb)-a.r;return f(d,e)-c},Bc=function(a,b,c,d,e){var f=J(b.tn,b.ta),g=J(b.tn,b.tb),i=I(b.tn,e),j=c.tVerts;for(var k=0;k<j.length;k+=2){var l=j[k],m=j[k+1];if(C(l,m,i.x,i.y)<B(b.tn,b.ta)*e+b.r){var n=K(b.tn.x,b.tn.y,l,m);f>=n&&n>=g&&a.push(new qc(new z(l,m),i,d,h(c.hashid,k)))}}},Cc=function(a,b){var c=[],d=b.tAxes,e=d.length,f=B(a.tn,a.ta),g=b.valueOnAxis(a.tn,f)-a.r,i=b.valueOnAxis(H(a.tn),-f)-a.r;if(i>0||g>0)return rc;var j=0,k=Ac(a,d[0].n,d[0].d);if(k>0)return rc;for(var l=0;l<e;l++){var m=Ac(a,d[l].n,d[l].d);if(m>0)return rc;m>k&&(k=m,j=l)}var n=H(d[j].n),o=F(a.ta,I(n,a.r)),p=F(a.tb,I(n,a.r));b.containsVert(o.x,o.y)&&c.push(new qc(o,n,k,h(a.hashid,0))),b.containsVert(p.x,p.y)&&c.push(new qc(p,n,k,h(a.hashid,1)));if(g>=k||i>=k)g>i?Bc(c,a,b,g,1):Bc(c,a,b,i,-1);if(c.length===0){var q=j*2,r=b.tVerts,s=new z(r[q],r[q+1]),t;if(t=sc(a.ta,s,a.r,0,c))return[t];if(t=sc(a.tb,s,a.r,0,c))return[t];var u=e*2,v=new z(r[(q+2)%u],r[(q+3)%u]);if(t=sc(a.ta,v,a.r,0,c))return[t];if(t=sc(a.tb,v,a.r,0,c))return[t]}return c},Dc=function(a,b){var c=b.tAxes,d=0,e=B(c[0].n,a.tc)-c[0].d-a.r;for(var f=0;f<c.length;f++){var g=B(c[f].n,a.tc)-c[f].d-a.r;if(g>0)return rc;g>e&&(e=g,d=f)}var h=c[d].n,i=b.tVerts,j=i.length,k=d<<1,l=i[k],m=i[k+1],n=i[(k+2)%j],o=i[(k+3)%j],p=K(h.x,h.y,l,m),q=K(h.x,h.y,n,o),r=J(h,a.tc);if(r<q){var s=sc(a.tc,new z(n,o),a.r,0,s);return s?[s]:rc}if(r<p)return[new qc(G(a.tc,I(h,a.r+e/2)),H(h),e,0)];var s=sc(a.tc,new z(l,m),a.r,0,s);return s?[s]:rc};yb.prototype.collisionCode=0,Ab.prototype.collisionCode=1,Cb.prototype.collisionCode=2,yb.prototype.collisionTable=[tc,uc,Dc],Ab.prototype.collisionTable=[null,function(a,a){return rc},Cc],Cb.prototype.collisionTable=[null,null,zc];var Ec=a.collideShapes=function(a,c){return b(a.collisionCode<=c.collisionCode,"Collided shapes must be sorted by type"),a.collisionTable[c.collisionCode](a,c)},Fc=new ic,Gc=a.Space=function(){this.stamp=0,this.curr_dt=0,this.bodies=[],this.rousedBodies=[],this.sleepingComponents=[],this.staticShapes=new Nb(null),this.activeShapes=new Nb(this.staticShapes),this.arbiters=[],this.contactBuffersHead=null,this.cachedArbiters={},this.constraints=[],this.locked=0,this.collisionHandlers={},this.defaultHandler=Fc,this.postStepCallbacks=[],this.iterations=10,this.gravity=A,this.damping=1,this.idleSpeedThreshold=0,this.sleepTimeThreshold=Infinity,this.collisionSlop=.1,this.collisionBias=Math.pow(.9,60),this.collisionPersistence=3,this.enableContactGraph=!1,this.staticBody=new Gb(Infinity,Infinity),this.staticBody.nodeIdleTime=Infinity,this.collideShapes=this.makeCollideShapes()};Gc.prototype.getCurrentTimeStep=function(){return this.curr_dt},Gc.prototype.isLocked=function(){return this.locked};var Hc=function(a){b(!a.locked,"This addition/removal cannot be done safely during a call to cpSpaceStep()  or during a query. Put these calls into a post-step callback.")};Gc.prototype.addCollisionHandler=function(a,b,c,d,e,f){Hc(this),this.removeCollisionHandler(a,b);var g=new ic;g.a=a,g.b=b,c&&(g.begin=c),d&&(g.preSolve=d),e&&(g.postSolve=e),f&&(g.separate=f),this.collisionHandlers[h(a,b)]=g},Gc.prototype.removeCollisionHandler=function(a,b){Hc(this),delete this.collisionHandlers[h(a,b)]},Gc.prototype.setDefaultCollisionHandler=function(a,b,c,d){Hc(this);var e=new ic;a&&(e.begin=a),b&&(e.preSolve=b),c&&(e.postSolve=c),d&&(e.separate=d),this.defaultHandler=e},Gc.prototype.lookupHandler=function(a,b){return this.collisionHandlers[h(a,b)]||this.defaultHandler},Gc.prototype.addShape=function(a){var c=a.body;return c.isStatic()?this.addStaticShape(a):(b(!a.space,"This shape is already added to a space and cannot be added to another."),Hc(this),c.activate(),c.addShape(a),a.update(c.p,c.rot),this.activeShapes.insert(a,a.hashid),a.space=this,a)},Gc.prototype.addStaticShape=function(a){b(!a.space,"This shape is already added to a space and cannot be added to another."),Hc(this);var c=a.body;return c.addShape(a),a.update(c.p,c.rot),this.staticShapes.insert(a,a.hashid),a.space=this,a},Gc.prototype.addBody=function(a){return b(!a.isStatic(),"Static bodies cannot be added to a space as they are not meant to be simulated."),b(!a.space,"This body is already added to a space and cannot be added to another."),Hc(this),this.bodies.push(a),a.space=this,a},Gc.prototype.addConstraint=function(a){b(!a.space,"This shape is already added to a space and cannot be added to another."),Hc(this);var c=a.a,d=a.b;return c.activate(),d.activate(),this.constraints.push(a),a.next_a=c.constraintList,c.constraintList=a,a.next_b=d.constraintList,d.constraintList=a,a.space=this,a},Gc.prototype.filterArbiters=function(a,b){for(var c in this.cachedArbiters){var d=this.cachedArbiters[c];if(a===d.body_a&&(b===d.a||b===null)||a===d.body_b&&(b===d.b||b===null))b&&d.state!=="cached"&&d.callSeparate(this),d.unthread(),i(this.arbiters,d),delete this.cachedArbiters[c]}},Gc.prototype.removeShape=function(a){var c=a.body;c.isStatic()?this.removeStaticShape(a):(b(this.containsShape(a),"Cannot remove a shape that was not added to the space. (Removed twice maybe?)"),Hc(this),c.activate(),c.removeShape(a),this.filterArbiters(c,a),this.activeShapes.remove(a,a.hashid),a.space=null)},Gc.prototype.removeStaticShape=function(a){b(this.containsShape(a),"Cannot remove a static or sleeping shape that was not added to the space. (Removed twice maybe?)"),Hc(this);var c=a.body;c.isStatic()&&c.activateStatic(a),c.removeShape(a),this.filterArbiters(c,a),this.staticShapes.remove(a,a.hashid),a.space=null},Gc.prototype.removeBody=function(a){b(this.containsBody(a),"Cannot remove a body that was not added to the space. (Removed twice maybe?)"),Hc(this),a.activate(),i(this.bodies,a),a.space=null},Gc.prototype.removeConstraint=function(a){b(this.containsConstraint(a),"Cannot remove a constraint that was not added to the space. (Removed twice maybe?)"),Hc(this),a.a.activate(),a.b.activate(),i(this.constraints,a),a.a.removeConstraint(a),a.b.removeConstraint(a),a.space=null},Gc.prototype.containsShape=function(a){return a.space===this},Gc.prototype.containsBody=function(a){return a.space==this},Gc.prototype.containsConstraint=function(a){return a.space==this},Gc.prototype.uncacheArbiter=function(a){delete this.cachedArbiters[h(a.a.hashid,a.b.hashid)],i(this.arbiters,a)},Gc.prototype.eachBody=function(a){this.lock();var b=this.bodies;for(var c=0;c<b.length;c++)a(b[c]);var d=this.sleepingComponents;for(var c=0;c<d.length;c++){var e=d[c],f=e;while(f){var g=f.nodeNext;a(f),f=g}}this.unlock(!0)},Gc.prototype.eachShape=function(a){this.lock(),this.activeShapes.each(a),this.staticShapes.each(a),this.unlock(!0)},Gc.prototype.eachConstraint=function(a){this.lock();var b=this.constraints;for(var c=0;c<b.length;c++)a(b[c]);this.unlock(!0)},Gc.prototype.reindexStatic=function(){b(!this.locked,"You cannot manually reindex objects while the space is locked. Wait until the current query or step is complete."),this.staticShapes.each(function(a){var b=a.body;a.update(b.p,b.rot)}),this.staticShapes.reindex()},Gc.prototype.reindexShape=function(a){b(!this.locked,"You cannot manually reindex objects while the space is locked. Wait until the current query or step is complete.");var c=a.body;a.update(c.p,c.rot),this.activeShapes.reindexObject(a,a.hashid),this.staticShapes.reindexObject(a,a.hashid)},Gc.prototype.reindexShapesForBody=function(a){for(var b=a.shapeList;b;b=b.next)this.reindexShape(b)},Gc.prototype.useSpatialHash=function(a,b){throw new Error("Spatial Hash not yet implemented!");var c,d},Gc.prototype.activateBody=function(a){b(!a.isRogue(),"Internal error: Attempting to activate a rogue body.");if(this.locked)this.rousedBodies.indexOf(a)===-1&&this.rousedBodies.push(a);else{this.bodies.push(a);for(var c=0;c<a.shapeList.length;c++){var d=a.shapeList[c];this.staticShapes.remove(d,d.hashid),this.activeShapes.insert(d,d.hashid)}for(var e=a.arbiterList;e;e=e.next(a)){var f=e.body_a;if(a===f||f.isStatic()){var g=e.a,i=e.b;this.cachedArbiters[h(g.hashid,i.hashid)]=e,e.stamp=this.stamp,e.handler=this.lookupHandler(g.collision_type,i.collision_type),this.arbiters.push(e)}}for(var j=a.constraintList;j;j=j.nodeNext){var f=j.a;(a===f||f.isStatic())&&this.constraints.push(j)}}},Gc.prototype.deactivateBody=function(a){b(!a.isRogue(),"Internal error: Attempting to deactivate a rogue body."),i(this.bodies,a);for(var c=0;c<a.shapeList.length;c++){var d=a.shapeList[c];this.activeShapes.remove(d,d.hashid),this.staticShapes.insert(d,d.hashid)}for(var e=a.arbiterList;e;e=e.next(a)){var f=e.body_a;(a===f||f.isStatic())&&this.uncacheArbiter(e)}for(var g=a.constraintList;g;g=g.nodeNext){var f=g.a;(a===f||f.isStatic())&&i(this.constraints,g)}};var Ic=function(a){return a?a.nodeRoot:null},Jc=function(a){if(!a||!a.isSleeping(a))return;b(!a.isRogue(),"Internal Error: componentActivate() called on a rogue body.");var c=a.space,d=a;while(d){var e=d.nodeNext;d.nodeIdleTime=0,d.nodeRoot=null,d.nodeNext=null,c.activateBody(d),d=e}i(c.sleepingComponents,a)};Gb.prototype.activate=function(){this.isRogue()||(this.nodeIdleTime=0,Jc(Ic(this)))},Gb.prototype.activateStatic=function(a){b(this.isStatic(),"Body.activateStatic() called on a non-static body.");for(var c=this.arbiterList;c;c=c.next(this))(!a||a==c.a||a==c.b)&&(c.body_a==this?c.body_b:c.body_a).activate()},Gb.prototype.pushArbiter=function(a){c((a.body_a===this?a.thread_a_next:a.thread_b_next)===null,"Internal Error: Dangling contact graph pointers detected. (A)"),c((a.body_a===this?a.thread_a_prev:a.thread_b_prev)===null,"Internal Error: Dangling contact graph pointers detected. (B)");var b=this.arbiterList;c(b===null||(b.body_a===this?b.thread_a_prev:b.thread_b_prev)===null,"Internal Error: Dangling contact graph pointers detected. (C)"),a.body_a===this?a.thread_a_next=b:a.thread_b_next=b,b&&(b.body_a===this?b.thread_a_prev=a:b.thread_b_prev=a),this.arbiterList=a};var Kc=function(a,b){b.nodeRoot=a,b!==a&&(b.nodeNext=a.nodeNext,a.nodeNext=b)},Lc=function(a,b){if(!b.isRogue()){var d=Ic(b);if(d==null){Kc(a,b);for(var e=b.arbiterList;e;e=e.next(b))Lc(a,b==e.body_a?e.body_b:e.body_a);for(var f=b.constraintList;f;f=f.next(b))Lc(a,b==f.a?f.b:f.a)}else c(d===a,"Internal Error: Inconsistency detected in the contact graph.")}},Mc=function(a,b){for(var c=a;c;c=c.nodeNext)if(c.nodeIdleTime<b)return!0;return!1};Gc.prototype.processComponents=function(a){var b=this.sleepTimeThreshold!==Infinity,d=this.bodies;for(var e=0;e<d.length;e++){var f=d[e];c(f.nodeNext===null,"Internal Error: Dangling next pointer detected in contact graph."),c(f.nodeRoot===null,"Internal Error: Dangling root pointer detected in contact graph.")}if(b){var g=this.idleSpeedThreshold,h=g?g*g:Q(this.gravity)*a*a;for(var e=0;e<d.length;e++){var f=d[e],i=h?f.m*h:0;f.nodeIdleTime=f.kineticEnergy()>i?0:f.nodeIdleTime+a}}var j=this.arbiters;for(var e=0,k=j.length;e<k;e++){var l=j[e],m=l.body_a,n=l.body_b;b&&((n.isRogue()&&!n.isStatic()||m.isSleeping())&&m.activate(),(m.isRogue()&&!m.isStatic()||n.isSleeping())&&n.activate()),m.pushArbiter(l),n.pushArbiter(l)}if(b){var o=this.constraints;for(var e=0;e<o.length;e++){var p=o[e],m=p.a,n=p.b;n.isRogue()&&!n.isStatic()&&m.activate(),m.isRogue()&&!m.isStatic()&&n.activate()}for(var e=0;e<d.length;){var f=d[e];if(Ic(f)===null){Lc(f,f);if(!Mc(f,this.sleepTimeThreshold)){this.sleepingComponents.push(f);for(var q=f;q;q=q.nodeNext)this.deactivateBody(q);continue}}e++,f.nodeRoot=null,f.nodeNext=null}}},Gb.prototype.sleep=function(){this.sleepWithGroup(null)},Gb.prototype.sleepWithGroup=function(a){b(!this.isStatic()&&!this.isRogue(),"Rogue and static bodies cannot be put to sleep.");var c=this.space;b(c,"Cannot put a rogue body to sleep."),b(!c.locked,"Bodies cannot be put to sleep during a query or a call to cpSpaceStep(). Put these calls into a post-step callback."),b(a===null||a.isSleeping(),"Cannot use a non-sleeping body as a group identifier.");if(this.isSleeping()){b(Ic(this)===Ic(a),"The body is already sleeping and it's group cannot be reassigned.");return}for(var d=0;d<body.shapeList.length;d++)body.shapeList.update(this.p,this.rot);c.deactivateBody(this);if(a){var e=Ic(a);this.nodeRoot=e,this.nodeNext=e.nodeNext,this.nodeIdleTime=0,e.nodeNext=this}else this.nodeRoot=this,this.nodeNext=null,this.nodeIdleTime=0,c.sleepingComponents.push(this);i(c.bodies,this)},Gc.prototype.activateShapesTouchingShape=function(a){this.sleepTimeThreshold!==Infinity&&this.shapeQuery(a,function(a,b){a.body.activate()})},Gc.prototype.pointQuery=function(a,b,c,d){var e=function(e){(!e.group||c!==e.group)&&b&e.layers&&e.pointQuery(a)&&d(e)};this.lock(),this.activeShapes.pointQuery(a,e),this.staticShapes.pointQuery(a,e),this.unlock(!0)},Gc.prototype.pointQueryFirst=function(a,b,c){var d=null;return this.pointQuery(a,b,c,function(a){a.sensor||(d=a)}),d},Gc.prototype.segmentQuery=function(a,b,c,d,e){var f=function(f){var g;return(!f.group||d!==f.group)&&c&f.layers&&(g=f.segmentQuery(a,b))&&e(f,g.t,g.n),1};this.lock(),this.staticShapes.segmentQuery(a,b,1,f),this.activeShapes.segmentQuery(a,b,1,f),this.unlock(!0)},Gc.prototype.segmentQueryFirst=function(a,b,c,d){var e=null,f=function(f){var g;return(!f.group||d!==f.group)&&c&f.layers&&!f.sensor&&(g=f.segmentQuery(a,b))&&(e===null||g.t<e.t)&&(e=g),e?e.t:1};return this.staticShapes.segmentQuery(a,b,1,f),this.activeShapes.segmentQuery(a,b,e?e.t:1,f),e},Gc.prototype.bbQuery=function(a,b,c,d){var e=function(e){(!e.group||c!==e.group)&&b&e.layers&&gb(a,e.bb_l,e.bb_b,e.bb_r,e.bb_t)&&d(e)};this.lock(),this.activeShapes.query(a,e),this.staticShapes.query(a,e),this.unlock(!0)},Gc.prototype.shapeQuery=function(a,b){var c=a.body;c&&a.update(c.p,c.rot);var d=new db(a.bb_l,a.bb_b,a.bb_r,a.bb_t),e=!1,f=function(c){var d=a;if(d.group&&d.group===c.group||!(d.layers&c.layers)||d===c)return;var f;if(d.collisionCode<=c.collisionCode)f=cpCollideShapes(d,c);else{f=cpCollideShapes(c,d);for(var g=0;g<f.length;g++)f[g].n=H(f[g].n)}if(f.length){e=!d.sensor&&!c.sensor;if(b){var h=new Array(f.length);for(var g=0;g<f.length;g++)h[g]=new lc(f[g].p,f[g].n,f[g].dist);b(c,h)}}};return this.lock(),this.activeShapes.query(d,f),this.staticShapes.query(d,f),this.unlock(!0),e},Gc.prototype.addPostStepCallback=function(a){c(this.locked,"Adding a post-step callback when the space is not locked is unnecessary. Post-step callbacks will not called until the end of the next call to cpSpaceStep() or the next query."),this.postStepCallbacks.push(a)},Gc.prototype.runPostStepCallbacks=function(){for(var a=0;a<this.postStepCallbacks.length;a++)this.postStepCallbacks[a]();this.postStepCallbacks=[]},Gc.prototype.lock=function(){this.locked++},Gc.prototype.unlock=function(a){this.locked--,b(this.locked>=0,"Internal Error: Space lock underflow.");if(!this.locked&&a){var c=this.rousedBodies;for(var d=0;d<c.length;d++)this.activateBody(c[d]);c.length=0,this.runPostStepCallbacks()}},Gc.prototype.makeCollideShapes=function(){var a=this;return function(b,c){var d=a;if(!(b.bb_l<=c.bb_r&&c.bb_l<=b.bb_r&&b.bb_b<=c.bb_t&&c.bb_b<=b.bb_t)||b.body===c.body||b.group&&b.group===c.group||!(b.layers&c.layers))return;var e=d.lookupHandler(b.collision_type,c.collision_type),f=b.sensor||c.sensor;if(f&&e===Fc)return;if(b.collisionCode>c.collisionCode){var g=b;b=c,c=g}var i=Ec(b,c);if(i.length===0)return;var j=h(b.hashid,c.hashid),k=d.cachedArbiters[j];k||(k=d.cachedArbiters[j]=new kc(b,c)),k.update(i,e,b,c),k.state=="first coll"&&!e.begin(k,d)&&k.ignore(),k.state!=="ignore"&&e.preSolve(k,d)&&!f?d.arbiters.push(k):(k.contacts=null,k.state!=="ignore"&&(k.state="normal")),k.stamp=d.stamp}},Gc.prototype.arbiterSetFilter=function(a){var b=this.stamp-a.stamp,c=a.body_a,d=a.body_b;return(c.isStatic()||c.isSleeping())&&(d.isStatic()||d.isSleeping())?!0:(b>=1&&a.state!="cached"&&(a.callSeparate(this),a.state="cached"),b>=this.collisionPersistence?(a.contacts=null,!1):!0)};var Nc=function(a){var b=a.body;a.update(b.p,b.rot)};Gc.prototype.step=function(a){if(a===0)return;b(A.x===0&&A.y===0,"vzero is invalid"),this.stamp++;var c=this.curr_dt;this.curr_dt=a;var d=this.bodies,e=this.constraints,f=this.arbiters;for(var g=0;g<f.length;g++){var h=f[g];h.state="normal",!h.body_a.isSleeping()&&!h.body_b.isSleeping()&&h.unthread()}f.length=0,this.lock();for(var g=0;g<d.length;g++){var i=d[g];i.position_func(a)}this.activeShapes.each(Nc),this.activeShapes.reindexQuery(this.collideShapes),this.unlock(!1),this.processComponents(a),this.lock();for(var j in this.cachedArbiters)this.arbiterSetFilter(this.cachedArbiters[j])||delete this.cachedArbiters[j];var k=this.collisionSlop,l=1-Math.pow(this.collisionBias,a);for(var g=0;g<f.length;g++)f[g].preStep(a,k,l);for(var g=0;g<e.length;g++){var m=e[g];m.preSolve(this),m.preStep(a)}var n=Math.pow(this.damping,a),o=this.gravity;for(var g=0;g<d.length;g++){var i=d[g];i.velocity_func(o,n,a)}var p=c===0?0:a/c;for(var g=0;g<f.length;g++)f[g].applyCachedImpulse(p);for(var g=0;g<e.length;g++){var m=e[g];m.applyCachedImpulse(p)}for(var g=0;g<this.iterations;g++){for(var q=0;q<f.length;q++)f[q].applyImpulse();for(var q=0;q<e.length;q++)e[q].applyImpulse()}for(var g=0;g<e.length;g++)e[g].postSolve(this);for(var g=0;g<f.length;g++){var h=f[g];h.handler.postSolve(h,this)}this.unlock(!0)};var Oc=function(a,b,c,d){var e=a.vx+ -c.y*a.w,f=a.vy+c.x*a.w,g=b.vx+ -d.y*b.w,h=b.vy+d.x*b.w;return new z(g-e,h-f)},Pc=function(a,b,c,d,e){var f=a.vx+ -c.y*a.w,g=a.vy+c.x*a.w,h=b.vx+ -d.y*b.w,i=b.vy+d.x*b.w;return C(h-f,i-g,e.x,e.y)},Qc=function(a,b,c,d){a.vx+=b*a.m_inv,a.vy+=c*a.m_inv,a.w+=a.i_inv*(d.x*c-d.y*b)},Rc=function(a,b,c,d,e,f){Qc(a,-e,-f,c),Qc(b,e,f,d)},Sc=function(a,b,c,d){a.v_biasx+=b*a.m_inv,a.v_biasy+=c*a.m_inv,a.w_bias+=a.i_inv*K(d.x,d.y,b,c)},Tc=function(a,b,c){var d=J(b,c);return a.m_inv+a.i_inv*d*d},Uc=function(a,b,d,e,f){var g=Tc(a,d,f)+Tc(b,e,f);return c(g!==0,"Unsolvable collision or constraint."),g},Vc=function(a,b,d,e,f,g){var h,i,j,k,l=a.m_inv+b.m_inv;h=l,i=0,j=0,k=l;var m=a.i_inv,n=d.x*d.x*m,o=d.y*d.y*m,p=-d.x*d.y*m;h+=o,i+=p,j+=p,k+=n;var q=b.i_inv,r=e.x*e.x*q,s=e.y*e.y*q,t=-e.x*e.y*q;h+=s,i+=t,j+=t,k+=r;var u=h*k-i*j;c(u!==0,"Unsolvable constraint.");var v=1/u;f.x=k*v,f.y=-i*v,g.x=-j*v,g.y=h*v},Wc=function(a,b,c){return new z(B(a,b),B(a,c))},Xc=function(a,b){return 1-Math.pow(a,b)},Yc=a.Constraint=function(a,b){this.a=a,this.b=b,this.space=null,this.next_a=null,this.next_b=null,this.maxForce=Infinity,this.errorBias=Math.pow(.9,60),this.maxBias=Infinity};Yc.prototype.activateBodies=function(){this.a&&this.a.activate(),this.b&&this.b.activate()},Yc.prototype.preStep=function(a){},Yc.prototype.applyCachedImpulse=function(a){},Yc.prototype.applyImpulse=function(){},Yc.prototype.getImpulse=function(){return 0},Yc.prototype.preSolve=function(a){},Yc.prototype.postSolve=function(a){},Yc.prototype.next=function(a){return this.a===a?this.next_a:this.next_b};var Zc=a.PinJoint=function(a,b,d,e){Yc.call(this,a,b),this.anchr1=d,this.anchr2=e;var f=a?F(a.p,O(d,a.rot)):d,g=b?F(b.p,O(e,b.rot)):e;this.dist=D(G(g,f)),c(this.dist>0,"You created a 0 length pin joint. A pivot joint will be much more stable."),this.r1=this.r2=null,this.n=null,this.nMass=0,this.jnAcc=this.jnMax=0,this.bias=0};Zc.prototype=Object.create(Yc.prototype),Zc.prototype.preStep=function(a){var b=this.a,c=this.b;this.r1=O(this.anchr1,b.rot),this.r2=O(this.anchr2,c.rot);var d=G(F(c.p,this.r2),F(b.p,this.r1)),e=D(d);this.n=I(d,1/(e?e:Infinity)),this.nMass=1/Uc(b,c,this.r1,this.r2,this.n);var f=this.maxBias;this.bias=t(-Xc(this.errorBias,a)*(e-this.dist)/a,-f,f),this.jnMax=this.maxForce*a},Zc.prototype.applyCachedImpulse=function(a){var b=I(this.n,this.jnAcc*a);Rc(this.a,this.b,this.r1,this.r2,b.x,b.y)},Zc.prototype.applyImpulse=function(){var a=this.a,b=this.b,c=this.n,d=Pc(a,b,this.r1,this.r2,c),e=(this.bias-d)*this.nMass,f=this.jnAcc;this.jnAcc=t(f+e,-this.jnMax,this.jnMax),e=this.jnAcc-f,Rc(a,b,this.r1,this.r2,c.x*e,c.y*e)},Zc.prototype.getImpulse=function(){return Math.abs(this.jnAcc)};var $c=a.SlideJoint=function(a,b,c,d,e,f){Yc.call(this,a,b),this.anchr1=c,this.anchr2=d,this.min=e,this.max=f,this.r1=this.r2=this.n=null,this.nMass=0,this.jnAcc=this.jnMax=0,this.bias=0};$c.prototype=Object.create(Yc.prototype),$c.prototype.preStep=function(a){var b=this.a,c=this.b;this.r1=O(this.anchr1,b.rot),this.r2=O(this.anchr2,c.rot);var d=G(F(c.p,this.r2),F(b.p,this.r1)),e=D(d),f=0;e>this.max?(f=e-this.max,this.n=T(d)):e<this.min?(f=this.min-e,this.n=H(T(d))):(this.n=A,this.jnAcc=0),this.nMass=1/Uc(b,c,this.r1,this.r2,this.n);var g=this.maxBias;this.bias=t(-Xc(this.errorBias,a)*f/a,-g,g),this.jnMax=this.maxForce*a},$c.prototype.applyCachedImpulse=function(a){var b=this.jnAcc*a;Rc(this.a,this.b,this.r1,this.r2,this.n.x*b,this.n.y*b)},$c.prototype.applyImpulse=function(){if(this.n.x===0&&this.n.y===0)return;var a=this.a,b=this.b,c=this.n,d=this.r1,e=this.r2,f=Oc(a,b,d,e),g=B(f,c),h=(this.bias-g)*this.nMass,i=this.jnAcc;this.jnAcc=t(i+h,-this.jnMax,0),h=this.jnAcc-i,Rc(a,b,this.r1,this.r2,c.x*h,c.y*h)},$c.prototype.getImpulse=function(){return Math.abs(this.jnAcc)};var _c=a.PivotJoint=function(a,b,c,d){Yc.call(this,a,b);if(typeof d=="undefined"){var e=c;c=a?a.world2Local(e):e,d=b?b.world2Local(e):e}this.anchr1=c,this.anchr2=d,this.r1=this.r2=A,this.k1=new z(0,0),this.k2=new z(0,0),this.jAcc=A,this.jMaxLen=0,this.bias=A};_c.prototype=Object.create(Yc.prototype),_c.prototype.preStep=function(a){var b=this.a,c=this.b;this.r1=O(this.anchr1,b.rot),this.r2=O(this.anchr2,c.rot),Vc(b,c,this.r1,this.r2,this.k1,this.k2),this.jMaxLen=this.maxForce*a;var d=G(F(c.p,this.r2),F(b.p,this.r1));this.bias=U(I(d,-Xc(this.errorBias,a)/a),this.maxBias)},_c.prototype.applyCachedImpulse=function(a){Rc(this.a,this.b,this.r1,this.r2,this.jAcc.x*a,this.jAcc.y*a)},_c.prototype.applyImpulse=function(){var a=this.a,b=this.b,c=this.r1,d=this.r2,e=Oc(a,b,c,d),f=Wc(G(this.bias,e),this.k1,this.k2),g=this.jAcc;this.jAcc=U(F(this.jAcc,f),this.jMaxLen),Rc(a,b,this.r1,this.r2,this.jAcc.x-g.x,this.jAcc.y-g.y)},_c.prototype.getImpulse=function(){return D(this.jAcc)};var ad=a.GrooveJoint=function(a,b,c,d,e){Yc.call(this,a,b),this.grv_a=c,this.grv_b=d,this.grv_n=L(S(G(d,c))),this.anchr2=e,this.grv_tn=null,this.clamp=0,this.r1=this.r2=null,this.k1=new z(0,0),this.k2=new z(0,0),this.jAcc=A,this.jMaxLen=0,this.bias=null};ad.prototype=Object.create(Yc.prototype),ad.prototype.preStep=function(a){var b=this.a,c=this.b,d=b.local2World(this.grv_a),e=b.local2World(this.grv_b),f=O(this.grv_n,b.rot),g=B(d,f);this.grv_tn=f,this.r2=O(this.anchr2,c.rot);var h=J(F(c.p,this.r2),f);h<=J(d,f)?(this.clamp=1,this.r1=G(d,b.p)):h>=J(e,f)?(this.clamp=-1,this.r1=G(e,b.p)):(this.clamp=0,this.r1=G(F(I(L(f),-h),I(f,g)),b.p)),Vc(b,c,this.r1,this.r2,this.k1,this.k2),this.jMaxLen=this.maxForce*a;var i=G(F(c.p,this.r2),F(b.p,this.r1));this.bias=U(I(i,-Xc(this.errorBias,a)/a),this.maxBias)},ad.prototype.applyCachedImpulse=function(a){Rc(this.a,this.b,this.r1,this.r2,this.jAcc.x*a,this.jAcc.y*a)},ad.prototype.grooveConstrain=function(a){var b=this.grv_tn,c=this.clamp*J(a,b)>0?a:N(a,b);return U(c,this.jMaxLen)},ad.prototype.applyImpulse=function(){var a=this.a,b=this.b,c=this.r1,d=this.r2,e=Oc(a,b,c,d),f=Wc(G(this.bias,e),this.k1,this.k2),g=this.jAcc;this.jAcc=this.grooveConstrain(F(g,f)),Rc(a,b,this.r1,this.r2,this.jAcc.x-g.x,this.jAcc.y-g.y)},ad.prototype.getImpulse=function(){return D(this.jAcc)},ad.prototype.setGrooveA=function(a){this.grv_a=a,this.grv_n=L(S(G(this.grv_b,a))),this.activateBodies()},ad.prototype.setGrooveB=function(a){this.grv_b=a,this.grv_n=L(S(G(a,this.grv_a))),this.activateBodies()};var bd=function(a,b){return(a.restLength-b)*a.stiffness},cd=a.DampedSpring=function(a,b,c,d,e,f,g){Yc.call(this,a,b),this.anchr1=c,this.anchr2=d,this.restLength=e,this.stiffness=f,this.damping=g,this.springForceFunc=bd,this.target_vrn=this.v_coef=0,this.r1=this.r2=null,this.nMass=0,this.n=null};cd.prototype=Object.create(Yc.prototype),cd.prototype.preStep=function(a){var b=this.a,d=this.b;this.r1=O(this.anchr1,b.rot),this.r2=O(this.anchr2,d.rot);var e=G(F(d.p,this.r2),F(b.p,this.r1)),f=D(e);this.n=I(e,1/(f?f:Infinity));var g=Uc(b,d,this.r1,this.r2,this.n);c(g!==0,"Unsolvable this."),this.nMass=1/g,this.target_vrn=0,this.v_coef=1-Math.exp(-this.damping*a*g);var h=this.springForceFunc(this,f);Rc(b,d,this.r1,this.r2,this.n.x*h*a,this.n.y*h*a)},cd.prototype.applyCachedImpulse=function(a){},cd.prototype.applyImpulse=function(){var a=this.a,b=this.b,c=this.n,d=this.r1,e=this.r2,f=Pc(a,b,d,e,c),g=(this.target_vrn-f)*this.v_coef;this.target_vrn=f+g,g*=this.nMass,Rc(a,b,this.r1,this.r2,this.n.x*g,this.n.y*g)},cd.prototype.getImpulse=function(){return 0};var dd=function(a,b){return(b-a.restAngle)*a.stiffness},ed=a.DampedRotarySpring=function(a,b,c,d,e){Yc.call(this,a,b),this.restAngle=c,this.stiffness=d,this.damping=e,this.springTorqueFunc=dd,this.target_wrn=0,this.w_coef=0,this.iSum=0};ed.prototype=Object.create(Yc.prototype),ed.prototype.preStep=function(a){var b=this.a,d=this.b,e=b.i_inv+d.i_inv;c(e!==0,"Unsolvable spring."),this.iSum=1/e,this.w_coef=1-Math.exp(-this.damping*a*e),this.target_wrn=0;var f=this.springTorqueFunc(this,b.a-d.a)*a;b.w-=f*b.i_inv,d.w+=f*d.i_inv},ed.prototype.applyImpulse=function(){var a=this.a,b=this.b,c=a.w-b.w,d=(this.target_wrn-c)*this.w_coef;this.target_wrn=c+d;var e=d*this.iSum;a.w+=e*a.i_inv,b.w-=e*b.i_inv};var fd=a.RotaryLimitJoint=function(a,b,c,d){Yc.call(this,a,b),this.min=c,this.max=d,this.jAcc=0,this.iSum=this.bias=this.jMax=0};fd.prototype=Object.create(Yc.prototype),fd.prototype.preStep=function(a){var b=this.a,c=this.b,d=c.a-b.a,e=0;d>this.max?e=this.max-d:d<this.min&&(e=this.min-d),this.iSum=1/(1/b.i+1/c.i);var f=this.maxBias;this.bias=t(-Xc(this.errorBias,a)*e/a,-f,f),this.jMax=this.maxForce*a,this.bias||(this.jAcc=0)},fd.prototype.applyCachedImpulse=function(a){var b=this.a,c=this.b,d=this.jAcc*a;b.w-=d*b.i_inv,c.w+=d*c.i_inv},fd.prototype.applyImpulse=function(){if(!this.bias)return;var a=this.a,b=this.b,c=b.w-a.w,d=-(this.bias+c)*this.iSum,e=this.jAcc;this.bias<0?this.jAcc=t(e+d,0,this.jMax):this.jAcc=t(e+d,-this.jMax,0),d=this.jAcc-e,a.w-=d*a.i_inv,b.w+=d*b.i_inv},fd.prototype.getImpulse=function(){return Math.abs(joint.jAcc)};var gd=a.RatchetJoint=function(a,b,c,d){Yc.call(this,a,b),this.angle=0,this.phase=c,this.ratchet=d,this.angle=(b?b.a:0)-(a?a.a:0),this.iSum=this.bias=this.jAcc=this.jMax=0};gd.prototype=Object.create(Yc.prototype),gd.prototype.preStep=function(a){var b=this.a,c=this.b,d=this.angle,e=this.phase,f=this.ratchet,g=c.a-b.a,h=d-g,i=0;h*f>0?i=h:this.angle=Math.floor((g-e)/f)*f+e,this.iSum=1/(b.i_inv+c.i_inv);var j=this.maxBias;this.bias=t(-Xc(this.errorBias,a)*i/a,-j,j),this.jMax=this.maxForce*a,this.bias||(this.jAcc=0)},gd.prototype.applyCachedImpulse=function(a){var b=this.a,c=this.b,d=this.jAcc*a;b.w-=d*b.i_inv,c.w+=d*c.i_inv},gd.prototype.applyImpulse=function(){if(!this.bias)return;var a=this.a,b=this.b,c=b.w-a.w,d=this.ratchet,e=-(this.bias+c)*this.iSum,f=this.jAcc;this.jAcc=t((f+e)*d,0,this.jMax*Math.abs(d))/d,e=this.jAcc-f,a.w-=e*a.i_inv,b.w+=e*b.i_inv},gd.prototype.getImpulse=function(a){return Math.abs(a.jAcc)};var hd=a.GearJoint=function(a,b,c,d){Yc.call(this,a,b),this.phase=c,this.ratio=d,this.ratio_inv=1/d,this.jAcc=0,this.iSum=this.bias=this.jMax=0};hd.prototype=Object.create(Yc.prototype),hd.prototype.preStep=function(a){var b=this.a,c=this.b;this.iSum=1/(b.i_inv*this.ratio_inv+this.ratio*c.i_inv);var d=this.maxBias;this.bias=t(-Xc(this.errorBias,a)*(c.a*this.ratio-b.a-this.phase)/a,-d,d),this.jMax=this.maxForce*a},hd.prototype.applyCachedImpulse=function(a){var b=this.a,c=this.b,d=this.jAcc*a;b.w-=d*b.i_inv*this.ratio_inv,c.w+=d*c.i_inv},hd.prototype.applyImpulse=function(){var a=this.a,b=this.b,c=b.w*this.ratio-a.w,d=(this.bias-c)*this.iSum,e=this.jAcc;this.jAcc=t(e+d,-this.jMax,this.jMax),d=this.jAcc-e,a.w-=d*a.i_inv*this.ratio_inv,b.w+=d*b.i_inv},hd.prototype.getImpulse=function(){return Math.abs(this.jAcc)},hd.prototype.setRatio=function(a){this.ratio=a,this.ratio_inv=1/a,this.activateBodies()};var id=a.SimpleMotor=function(a,b,c){Yc.call(this,a,b),this.rate=c,this.jAcc=0,this.iSum=this.jMax=0};id.prototype=Object.create(Yc.prototype),id.prototype.preStep=function(a){this.iSum=1/(this.a.i_inv+this.b.i_inv),this.jMax=this.maxForce*a},id.prototype.applyCachedImpulse=function(a){var b=this.a,c=this.b,d=this.jAcc*a;b.w-=d*b.i_inv,c.w+=d*c.i_inv},id.prototype.applyImpulse=function(){var a=this.a,b=this.b,c=b.w-a.w+this.rate,d=-c*this.iSum,e=this.jAcc;this.jAcc=t(e+d,-this.jMax,this.jMax),d=this.jAcc-e,a.w-=d*a.i_inv,b.w+=d*b.i_inv},id.prototype.getImpulse=function(){return Math.abs(this.jAcc)}})(),this.createjs=this.createjs||{},function(){var a=function(a){this.initialize(a)},b=a.prototype;b.complete=!0,b.onComplete=null,b._animations=null,b._frames=null,b._images=null,b._data=null,b._loadCount=0,b._frameHeight=0,b._frameWidth=0,b._numFrames=0,b._regX=0,b._regY=0,b.initialize=function(a){var b,c,d,e;if(a==null)return;if(a.images&&(c=a.images.length)>0){e=this._images=[];for(b=0;b<c;b++){var f=a.images[b];if(typeof f=="string"){var g=f;f=new Image,f.src=g}e.push(f),!f.getContext&&!f.complete&&(this._loadCount++,this.complete=!1,function(a){f.onload=function(){a._handleImageLoad()}}(this))}}if(a.frames!=null)if(a.frames instanceof Array){this._frames=[],e=a.frames;for(b=0,c=e.length;b<c;b++){var h=e[b];this._frames.push({image:this._images[h[4]?h[4]:0],rect:new createjs.Rectangle(h[0],h[1],h[2],h[3]),regX:h[5]||0,regY:h[6]||0})}}else d=a.frames,this._frameWidth=d.width,this._frameHeight=d.height,this._regX=d.regX||0,this._regY=d.regY||0,this._numFrames=d.count,this._loadCount==0&&this._calculateFrames();if((d=a.animations)!=null){this._animations=[],this._data={};var i;for(i in d){var j={name:i},k=d[i];if(!isNaN(k))e=j.frames=[k];else if(k instanceof Array){j.frequency=k[3],j.next=k[2],e=j.frames=[];for(b=k[0];b<=k[1];b++)e.push(b)}else{j.frequency=k.frequency,j.next=k.next;var l=k.frames;e=j.frames=isNaN(l)?l.slice(0):[l]}j.next=e.length<2||j.next==0?null:j.next==null||j.next==1?i:j.next,j.frequency||(j.frequency=1),this._animations.push(i),this._data[i]=j}}},b.getNumFrames=function(a){if(a==null)return this._frames?this._frames.length:this._numFrames;var b=this._data[a];return b==null?0:b.frames.length},b.getAnimations=function(){return this._animations.slice(0)},b.getAnimation=function(a){return this._data[a]},b.getFrame=function(a){var b;return this.complete&&this._frames&&(b=this._frames[a])?b:null},b.toString=function(){return"[SpriteSheet]"},b.clone=function(){var b=new a;return b.complete=this.complete,b._animations=this._animations,b._frames=this._frames,b._images=this._images,b._data=this._data,b._frameHeight=this._frameHeight,b._frameWidth=this._frameWidth,b._numFrames=this._numFrames,b._loadCount=this._loadCount,b},b._handleImageLoad=function(){--this._loadCount==0&&(this._calculateFrames(),this.complete=!0,this.onComplete&&this.onComplete())},b._calculateFrames=function(){if(this._frames||this._frameWidth==0)return;this._frames=[];var a=0,b=this._frameWidth,c=this._frameHeight;for(var d=0,e=this._images;d<e.length;d++){var f=e[d],g=(f.width+1)/b|0,h=(f.height+1)/c|0,i=this._numFrames>0?Math.min(this._numFrames-a,g*h):g*h;for(var j=0;j<i;j++)this._frames.push({image:f,rect:new createjs.Rectangle(j%g*b,(j/g|0)*c,b,c),regX:this._regX,regY:this._regY});a+=i}this._numFrames=a},createjs.SpriteSheet=a}(),this.createjs=this.createjs||{},function(){var a=function(a,b,c,d){this.initialize(a,b,c,d)},b=a.prototype;b.x=0,b.y=0,b.width=0,b.height=0,b.initialize=function(a,b,c,d){this.x=a==null?0:a,this.y=b==null?0:b,this.width=c==null?0:c,this.height=d==null?0:d},b.clone=function(){return new a(this.x,this.y,this.width,this.height)},b.toString=function(){return"[Rectangle (x="+this.x+" y="+this.y+" width="+this.width+" height="+this.height+")]"},createjs.Rectangle=a}();var Stats=function(){var a=Date.now(),b=a,c=0,d=Infinity,e=0,f=0,g=Infinity,h=0,i=0,j=0,k=document.createElement("div");k.id="stats",k.addEventListener("mousedown",function(a){a.preventDefault(),s(++j%2)},!1),k.style.cssText="width:80px;opacity:0.9;cursor:pointer";var l=document.createElement("div");l.id="fps",l.style.cssText="padding:0 0 3px 3px;text-align:left;background-color:#002",k.appendChild(l);var m=document.createElement("div");m.id="fpsText",m.style.cssText="color:#0ff;font-family:Helvetica,Arial,sans-serif;font-size:9px;font-weight:bold;line-height:15px",m.innerHTML="FPS",l.appendChild(m);var n=document.createElement("div");n.id="fpsGraph",n.style.cssText="position:relative;width:74px;height:30px;background-color:#0ff";for(l.appendChild(n);74>n.children.length;){var o=document.createElement("span");o.style.cssText="width:1px;height:30px;float:left;background-color:#113",n.appendChild(o)}var p=document.createElement("div");p.id="ms",p.style.cssText="padding:0 0 3px 3px;text-align:left;background-color:#020;display:none",k.appendChild(p);var q=document.createElement("div");q.id="msText",q.style.cssText="color:#0f0;font-family:Helvetica,Arial,sans-serif;font-size:9px;font-weight:bold;line-height:15px",q.innerHTML="MS",p.appendChild(q);var r=document.createElement("div");r.id="msGraph",r.style.cssText="position:relative;width:74px;height:30px;background-color:#0f0";for(p.appendChild(r);74>r.children.length;)o=document.createElement("span"),o.style.cssText="width:1px;height:30px;float:left;background-color:#131",r.appendChild(o);var s=function(a){j=a;switch(j){case 0:l.style.display="block",p.style.display="none";break;case 1:l.style.display="none",p.style.display="block"}};return{REVISION:11,domElement:k,setMode:s,begin:function(){a=Date.now()},end:function(){var j=Date.now();c=j-a,d=Math.min(d,c),e=Math.max(e,c),q.textContent=c+" MS ("+d+"-"+e+")";var k=Math.min(30,30-30*(c/200));return r.appendChild(r.firstChild).style.height=k+"px",i++,j>b+1e3&&(f=Math.round(1e3*i/(j-b)),g=Math.min(g,f),h=Math.max(h,f),m.textContent=f+" FPS ("+g+"-"+h+")",k=Math.min(30,30-30*(f/100)),n.appendChild(n.firstChild).style.height=k+"px",b=j,i=0),j},update:function(){a=this.end()}}},dat=dat||{};dat.gui=dat.gui||{},dat.utils=dat.utils||{},dat.controllers=dat.controllers||{},dat.dom=dat.dom||{},dat.color=dat.color||{},dat.utils.css=function(){return{load:function(a,b){b=b||document;var c=b.createElement("link");c.type="text/css",c.rel="stylesheet",c.href=a,b.getElementsByTagName("head")[0].appendChild(c)},inject:function(a,b){b=b||document;var c=document.createElement("style");c.type="text/css",c.innerHTML=a,b.getElementsByTagName("head")[0].appendChild(c)}}}(),dat.utils.common=function(){var a=Array.prototype.forEach,b=Array.prototype.slice;return{BREAK:{},extend:function(a){return this.each(b.call(arguments,1),function(b){for(var c in b)this.isUndefined(b[c])||(a[c]=b[c])},this),a},defaults:function(a){return this.each(b.call(arguments,1),function(b){for(var c in b)this.isUndefined(a[c])&&(a[c]=b[c])},this),a},compose:function(){var a=b.call(arguments);return function(){var c=b.call(arguments);for(var d=a.length-1;d>=0;d--)c=[a[d].apply(this,c)];return c[0]}},each:function(b,c,d){if(a&&b.forEach===a)b.forEach(c,d);else if(b.length===b.length+0){for(var e=0,f=b.length;e<f;e++)if(e in b&&c.call(d,b[e],e)===this.BREAK)return}else for(var e in b)if(c.call(d,b[e],e)===this.BREAK)return},defer:function(a){setTimeout(a,0)},toArray:function(a){return a.toArray?a.toArray():b.call(a)},isUndefined:function(a){return a===undefined},isNull:function(a){return a===null},isNaN:function(a){return a!==a},isArray:Array.isArray||function(a){return a.constructor===Array},isObject:function(a){return a===Object(a)},isNumber:function(a){return a===a+0},isString:function(a){return a===a+""},isBoolean:function(a){return a===!1||a===!0},isFunction:function(a){return Object.prototype.toString.call(a)==="[object Function]"}}}(),dat.controllers.Controller=function(a){var b=function(a,b){this.initialValue=a[b],this.domElement=document.createElement("div"),this.object=a,this.property=b,this.__onChange=undefined,this.__onFinishChange=undefined};return a.extend(b.prototype,{onChange:function(a){return this.__onChange=a,this},onFinishChange:function(a){return this.__onFinishChange=a,this},setValue:function(a){return this.object[this.property]=a,this.__onChange&&this.__onChange.call(this,a),this.updateDisplay(),this},getValue:function(){return this.object[this.property]},updateDisplay:function(){return this},isModified:function(){return this.initialValue!==this.getValue()}}),b}(dat.utils.common),dat.dom.dom=function(a){function e(b){if(b==="0"||a.isUndefined(b))return 0;var c=b.match(d);return a.isNull(c)?0:parseFloat(c[1])}var b={HTMLEvents:["change"],MouseEvents:["click","mousemove","mousedown","mouseup","mouseover"],KeyboardEvents:["keydown"]},c={};a.each(b,function(b,d){a.each(b,function(a){c[a]=d})});var d=/(\d+(\.\d+)?)px/,f={makeSelectable:function(a,b){if(a===undefined||a.style===undefined)return;a.onselectstart=b?function(){return!1}:function(){},a.style.MozUserSelect=b?"auto":"none",a.style.KhtmlUserSelect=b?"auto":"none",a.unselectable=b?"on":"off"},makeFullscreen:function(b,c,d){a.isUndefined(c)&&(c=!0),a.isUndefined(d)&&(d=!0),b.style.position="absolute",c&&(b.style.left=0,b.style.right=0),d&&(b.style.top=0,b.style.bottom=0)},fakeEvent:function(b,d,e,f){e=e||{};var g=c[d];if(!g)throw new Error("Event type "+d+" not supported.");var h=document.createEvent(g);switch(g){case"MouseEvents":var i=e.x||e.clientX||0,j=e.y||e.clientY||0;h.initMouseEvent(d,e.bubbles||!1,e.cancelable||!0,window,e.clickCount||1,0,0,i,j,!1,!1,!1,!1,0,null);break;case"KeyboardEvents":var k=h.initKeyboardEvent||h.initKeyEvent;a.defaults(e,{cancelable:!0,ctrlKey:!1,altKey:!1,shiftKey:!1,metaKey:!1,keyCode:undefined,charCode:undefined}),k(d,e.bubbles||!1,e.cancelable,window,e.ctrlKey,e.altKey,e.shiftKey,e.metaKey,e.keyCode,e.charCode);break;default:h.initEvent(d,e.bubbles||!1,e.cancelable||!0)}a.defaults(h,f),b.dispatchEvent(h)},bind:function(a,b,c,d){return d=d||!1,a.addEventListener?a.addEventListener(b,c,d):a.attachEvent&&a.attachEvent("on"+b,c),f},unbind:function(a,b,c,d){return d=d||!1,a.removeEventListener?a.removeEventListener(b,c,d):a.detachEvent&&a.detachEvent("on"+b,c),f},addClass:function(a,b){if(a.className===undefined)a.className=b;else if(a.className!==b){var c=a.className.split(/ +/);c.indexOf(b)==-1&&(c.push(b),a.className=c.join(" ").replace(/^\s+/,"").replace(/\s+$/,""))}return f},removeClass:function(a,b){if(b){if(a.className!==undefined)if(a.className===b)a.removeAttribute("class");else{var c=a.className.split(/ +/),d=c.indexOf(b);d!=-1&&(c.splice(d,1),a.className=c.join(" "))}}else a.className=undefined;return f},hasClass:function(a,b){return(new RegExp("(?:^|\\s+)"+b+"(?:\\s+|$)")).test(a.className)||!1},getWidth:function(a){var b=getComputedStyle(a);return e(b["border-left-width"])+e(b["border-right-width"])+e(b["padding-left"])+e(b["padding-right"])+e(b.width)},getHeight:function(a){var b=getComputedStyle(a);return e(b["border-top-width"])+e(b["border-bottom-width"])+e(b["padding-top"])+e(b["padding-bottom"])+e(b.height)},getOffset:function(a){var b={left:0,top:0};if(a.offsetParent)do b.left+=a.offsetLeft,b.top+=a.offsetTop;while(a=a.offsetParent);return b},isActive:function(a){return a===document.activeElement&&(a.type||a.href)}};return f}(dat.utils.common),dat.controllers.OptionController=function(a,b,c){var d=function(a,e,f){d.superclass.call(this,a,e);var g=this;this.__select=document.createElement("select");if(c.isArray(f)){var h={};c.each(f,function(a){h[a]=a}),f=h}c.each(f,function(a,b){var c=document.createElement("option");c.innerHTML=b,c.setAttribute("value",a),g.__select.appendChild(c)}),this.updateDisplay(),b.bind(this.__select,"change",function(){var a=this.options[this.selectedIndex].value;g.setValue(a)}),this.domElement.appendChild(this.__select)};return d.superclass=a,c.extend(d.prototype,a.prototype,{setValue:function(a){var b=d.superclass.prototype.setValue.call(this,a);return this.__onFinishChange&&this.__onFinishChange.call(this,this.getValue()),b},updateDisplay:function(){return this.__select.value=this.getValue(),d.superclass.prototype.updateDisplay.call(this)}}),d}(dat.controllers.Controller,dat.dom.dom,dat.utils.common),dat.controllers.NumberController=function(a,b){function d(a){return a=a.toString(),a.indexOf(".")>-1?a.length-a.indexOf(".")-1:0}var c=function(a,e,f){c.superclass.call(this,a,e),f=f||{},this.__min=f.min,this.__max=f.max,this.__step=f.step,b.isUndefined(this.__step)?this.initialValue==0?this.__impliedStep=1:this.__impliedStep=Math.pow(10,Math.floor(Math.log(this.initialValue)/Math.LN10))/10:this.__impliedStep=this.__step,this.__precision=d(this.__impliedStep)};return c.superclass=a,b.extend(c.prototype,a.prototype,{setValue:function(a){return this.__min!==undefined&&a<this.__min?a=this.__min:this.__max!==undefined&&a>this.__max&&(a=this.__max),this.__step!==undefined&&a%this.__step!=0&&(a=Math.round(a/this.__step)*this.__step),c.superclass.prototype.setValue.call(this,a)},min:function(a){return this.__min=a,this},max:function(a){return this.__max=a,this},step:function(a){return this.__step=a,this}}),c}(dat.controllers.Controller,dat.utils.common),dat.controllers.NumberControllerBox=function(a,b,c){function e(a,b){var c=Math.pow(10,b);return Math.round(a*c)/c}var d=function(a,e,f){function i(){var a=parseFloat(g.__input.value);c.isNaN(a)||g.setValue(a)}function j(){i(),g.__onFinishChange&&g.__onFinishChange.call(g,g.getValue())}function k(a){b.bind(window,"mousemove",l),b.bind(window,"mouseup",m),h=a.clientY}function l(a){var b=h-a.clientY;g.setValue(g.getValue()+b*g.__impliedStep),h=a.clientY}function m(){b.unbind(window,"mousemove",l),b.unbind(window,"mouseup",m)}this.__truncationSuspended=!1,d.superclass.call(this,a,e,f);var g=this,h;this.__input=document.createElement("input"),this.__input.setAttribute("type","text"),b.bind(this.__input,"change",i),b.bind(this.__input,"blur",j),b.bind(this.__input,"mousedown",k),b.bind(this.__input,"keydown",function(a){a.keyCode===13&&(g.__truncationSuspended=!0,this.blur(),g.__truncationSuspended=!1)}),this.updateDisplay(),this.domElement.appendChild(this.__input)};return d.superclass=a,c.extend(d.prototype,a.prototype,{updateDisplay:function(){return this.__input.value=this.__truncationSuspended?this.getValue():e(this.getValue(),this.__precision),d.superclass.prototype.updateDisplay.call(this)}}),d}(dat.controllers.NumberController,dat.dom.dom,dat.utils.common),dat.controllers.NumberControllerSlider=function(a,b,c,d,e){function g(a,b,c,d,e){return d+(e-d)*((a-b)/(c-b))}var f=function(a,c,d,e,h){function j(a){b.bind(window,"mousemove",k),b.bind(window,"mouseup",l),k(a)}function k(a){a.preventDefault();var c=b.getOffset(i.__background),d=b.getWidth(i.__background);return i.setValue(g(a.clientX,c.left,c.left+d,i.__min,i.__max)),!1}function l(){b.unbind(window,"mousemove",k),b.unbind(window,"mouseup",l),i.__onFinishChange&&i.__onFinishChange.call(i,i.getValue())}f.superclass.call(this,a,c,{min:d,max:e,step:h});var i=this;this.__background=document.createElement("div"),this.__foreground=document.createElement("div"),b.bind(this.__background,"mousedown",j),b.addClass(this.__background,"slider"),b.addClass(this.__foreground,"slider-fg"),this.updateDisplay(),this.__background.appendChild(this.__foreground),this.domElement.appendChild(this.__background)};return f.superclass=a,f.useDefaultStyles=function(){c.inject(e)},d.extend(f.prototype,a.prototype,{updateDisplay:function(){var a=(this.getValue()-this.__min)/(this.__max-this.__min);return this.__foreground.style.width=a*100+"%",f.superclass.prototype.updateDisplay.call(this)}}),f}(dat.controllers.NumberController,dat.dom.dom,dat.utils.css,dat.utils.common,".slider {\n  box-shadow: inset 0 2px 4px rgba(0,0,0,0.15);\n  height: 1em;\n  border-radius: 1em;\n  background-color: #eee;\n  padding: 0 0.5em;\n  overflow: hidden;\n}\n\n.slider-fg {\n  padding: 1px 0 2px 0;\n  background-color: #aaa;\n  height: 1em;\n  margin-left: -0.5em;\n  padding-right: 0.5em;\n  border-radius: 1em 0 0 1em;\n}\n\n.slider-fg:after {\n  display: inline-block;\n  border-radius: 1em;\n  background-color: #fff;\n  border:  1px solid #aaa;\n  content: '';\n  float: right;\n  margin-right: -1em;\n  margin-top: -1px;\n  height: 0.9em;\n  width: 0.9em;\n}"),dat.controllers.FunctionController=function(a,b,c){var d=function(a,c,e){d.superclass.call(this,a,c);var f=this;this.__button=document.createElement("div"),this.__button.innerHTML=e===undefined?"Fire":e,b.bind(this.__button,"click",function(a){return a.preventDefault(),f.fire(),!1}),b.addClass(this.__button,"button"),this.domElement.appendChild(this.__button)};return d.superclass=a,c.extend(d.prototype,a.prototype,{fire:function(){this.__onChange&&this.__onChange.call(this),this.__onFinishChange&&this.__onFinishChange.call(this,this.getValue()),this.getValue().call(this.object)}}),d}(dat.controllers.Controller,dat.dom.dom,dat.utils.common),dat.controllers.BooleanController=function(a,b,c){var d=function(a,c){function f(){e.setValue(!e.__prev)}d.superclass.call(this,a,c);var e=this;this.__prev=this.getValue(),this.__checkbox=document.createElement("input"),this.__checkbox.setAttribute("type","checkbox"),b.bind(this.__checkbox,"change",f,!1),this.domElement.appendChild(this.__checkbox),this.updateDisplay()};return d.superclass=a,c.extend(d.prototype,a.prototype,{setValue:function(a){var b=d.superclass.prototype.setValue.call(this,a);return this.__onFinishChange&&this.__onFinishChange.call(this,this.getValue()),this.__prev=this.getValue(),b},updateDisplay:function(){return this.getValue()===!0?(this.__checkbox.setAttribute("checked","checked"),this.__checkbox.checked=!0):this.__checkbox.checked=!1,d.superclass.prototype.updateDisplay.call(this)}}),d}(dat.controllers.Controller,dat.dom.dom,dat.utils.common),dat.color.toString=function(a){return function(b){if(b.a==1||a.isUndefined(b.a)){var c=b.hex.toString(16);while(c.length<6)c="0"+c;return"#"+c}return"rgba("+Math.round(b.r)+","+Math.round(b.g)+","+Math.round(b.b)+","+b.a+")"}}(dat.utils.common),dat.color.interpret=function(a,b){var c,d,e=function(){d=!1;var a=arguments.length>1?b.toArray(arguments):arguments[0];return b.each(f,function(e){if(e.litmus(a))return b.each(e.conversions,function(e,f){c=e.read(a);if(d===!1&&c!==!1)return d=c,c.conversionName=f,c.conversion=e,b.BREAK}),b.BREAK}),d},f=[{litmus:b.isString,conversions:{THREE_CHAR_HEX:{read:function(a){var b=a.match(/^#([A-F0-9])([A-F0-9])([A-F0-9])$/i);return b===null?!1:{space:"HEX",hex:parseInt("0x"+b[1].toString()+b[1].toString()+b[2].toString()+b[2].toString()+b[3].toString()+b[3].toString())}},write:a},SIX_CHAR_HEX:{read:function(a){var b=a.match(/^#([A-F0-9]{6})$/i);return b===null?!1:{space:"HEX",hex:parseInt("0x"+b[1].toString())}},write:a},CSS_RGB:{read:function(a){var b=a.match(/^rgb\(\s*(.+)\s*,\s*(.+)\s*,\s*(.+)\s*\)/);return b===null?!1:{space:"RGB",r:parseFloat(b[1]),g:parseFloat(b[2]),b:parseFloat(b[3])}},write:a},CSS_RGBA:{read:function(a){var b=a.match(/^rgba\(\s*(.+)\s*,\s*(.+)\s*,\s*(.+)\s*\,\s*(.+)\s*\)/);return b===null?!1:{space:"RGB",r:parseFloat(b[1]),g:parseFloat(b[2]),b:parseFloat(b[3]),a:parseFloat(b[4])}},write:a}}},{litmus:b.isNumber,conversions:{HEX:{read:function(a){return{space:"HEX",hex:a,conversionName:"HEX"}},write:function(a){return a.hex}}}},{litmus:b.isArray,conversions:{RGB_ARRAY:{read:function(a){return a.length!=3?!1:{space:"RGB",r:a[0],g:a[1],b:a[2]}},write:function(a){return[a.r,a.g,a.b]}},RGBA_ARRAY:{read:function(a){return a.length!=4?!1:{space:"RGB",r:a[0],g:a[1],b:a[2],a:a[3]}},write:function(a){return[a.r,a.g,a.b,a.a]}}}},{litmus:b.isObject,conversions:{RGBA_OBJ:{read:function(a){return b.isNumber(a.r)&&b.isNumber(a.g)&&b.isNumber(a.b)&&b.isNumber(a.a)?{space:"RGB",r:a.r,g:a.g,b:a.b,a:a.a}:!1},write:function(a){return{r:a.r,g:a.g,b:a.b,a:a.a}}},RGB_OBJ:{read:function(a){return b.isNumber(a.r)&&b.isNumber(a.g)&&b.isNumber(a.b)?{space:"RGB",r:a.r,g:a.g,b:a.b}:!1},write:function(a){return{r:a.r,g:a.g,b:a.b}}},HSVA_OBJ:{read:function(a){return b.isNumber(a.h)&&b.isNumber(a.s)&&b.isNumber(a.v)&&b.isNumber(a.a)?{space:"HSV",h:a.h,s:a.s,v:a.v,a:a.a}:!1},write:function(a){return{h:a.h,s:a.s,v:a.v,a:a.a}}},HSV_OBJ:{read:function(a){return b.isNumber(a.h)&&b.isNumber(a.s)&&b.isNumber(a.v)?{space:"HSV",h:a.h,s:a.s,v:a.v}:!1},write:function(a){return{h:a.h,s:a.s,v:a.v}}}}}];return e}(dat.color.toString,dat.utils.common),dat.GUI=dat.gui.GUI=function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o){function A(a,b,c,f){if(b[c]===undefined)throw new Error("Object "+b+' has no property "'+c+'"');var g;if(f.color)g=new k(b,c);else{var h=[b,c].concat(f.factoryArgs);g=d.apply(a,h)}f.before instanceof e&&(f.before=f.before.__li),D(a,g),n.addClass(g.domElement,"c");var i=document.createElement("span");n.addClass(i,"property-name"),i.innerHTML=g.property;var j=document.createElement("div");j.appendChild(i),j.appendChild(g.domElement);var l=B(a,j,f.before);return n.addClass(l,z.CLASS_CONTROLLER_ROW),n.addClass(l,typeof g.getValue()),C(a,l,g),a.__controllers.push(g),g}function B(a,b,c){var d=document.createElement("li");return b&&d.appendChild(b),c?a.__ul.insertBefore(d,params.before):a.__ul.appendChild(d),a.onResize(),d}function C(a,b,c){c.__li=b,c.__gui=a,o.extend(c,{options:function(b){if(arguments.length>1)return c.remove(),A(a,c.object,c.property,{before:c.__li.nextElementSibling,factoryArgs:[o.toArray(arguments)]});if(o.isArray(b)||o.isObject(b))return c.remove(),A(a,c.object,c.property,{before:c.__li.nextElementSibling,factoryArgs:[b]})},name:function(a){return c.__li.firstElementChild.firstElementChild.innerHTML=a,c},listen:function(){return c.__gui.listen(c),c},remove:function(){return c.__gui.remove(c),c}});if(c instanceof i){var d=new h(c.object,c.property,{min:c.__min,max:c.__max,step:c.__step});o.each(["updateDisplay","onChange","onFinishChange"],function(a){var b=c[a],e=d[a];c[a]=d[a]=function(){var a=Array.prototype.slice.call(arguments);return b.apply(c,a),e.apply(d,a)}}),n.addClass(b,"has-slider"),c.domElement.insertBefore(d.domElement,c.domElement.firstElementChild)}else if(c instanceof h){var e=function(b){return o.isNumber(c.__min)&&o.isNumber(c.__max)?(c.remove(),A(a,c.object,c.property,{before:c.__li.nextElementSibling,factoryArgs:[c.__min,c.__max,c.__step]})):b};c.min=o.compose(e,c.min),c.max=o.compose(e,c.max)}else c instanceof f?(n.bind(b,"click",function(){n.fakeEvent(c.__checkbox,"click")}),n.bind(c.__checkbox,"click",function(a){a.stopPropagation()})):c instanceof g?(n.bind(b,"click",function(){n.fakeEvent(c.__button,"click")}),n.bind(b,"mouseover",function(){n.addClass(c.__button,"hover")}),n.bind(b,"mouseout",function(){n.removeClass(c.__button,"hover")})):c instanceof k&&(n.addClass(b,"color"),c.updateDisplay=o.compose(function(a){return b.style.borderLeftColor=c.__color.toString(),a},c.updateDisplay),c.updateDisplay());c.setValue=o.compose(function(b){return a.getRoot().__preset_select&&c.isModified()&&L(a.getRoot(),!0),b},c.setValue)}function D(a,b){var c=a.getRoot(),d=c.__rememberedObjects.indexOf(b.object);if(d!=-1){var e=c.__rememberedObjectIndecesToControllers[d];e===undefined&&(e={},c.__rememberedObjectIndecesToControllers[d]=e),e[b.property]=b;if(c.load&&c.load.remembered){var f=c.load.remembered,g;if(f[a.preset])g=f[a.preset];else{if(!f[s])return;g=f[s]}if(g[d]&&g[d][b.property]!==undefined){var h=g[d][b.property];b.initialValue=h,b.setValue(h)}}}}function E(a,b){return document.location.href+"."+b}function F(a){var b=a.__save_row=document.createElement("li");n.addClass(a.domElement,"has-save"),a.__ul.insertBefore(b,a.__ul.firstChild),n.addClass(b,"save-row");var c=document.createElement("span");c.innerHTML="&nbsp;",n.addClass(c,"button gears");var d=document.createElement("span");d.innerHTML="Save",n.addClass(d,"button"),n.addClass(d,"save");var e=document.createElement("span");e.innerHTML="New",n.addClass(e,"button"),n.addClass(e,"save-as");var f=document.createElement("span");f.innerHTML="Revert",n.addClass(f,"button"),n.addClass(f,"revert");var g=a.__preset_select=document.createElement("select");a.load&&a.load.remembered?o.each(a.load.remembered,function(b,c){J(a,c,c==a.preset)}):J(a,s,!1),n.bind(g,"change",function(){for(var b=0;b<a.__preset_select.length;b++)a.__preset_select[b].innerHTML=a.__preset_select[b].value;a.preset=this.value}),b.appendChild(g),b.appendChild(c),b.appendChild(d),b.appendChild(e),b.appendChild(f);if(t){var h=document.getElementById("dg-save-locally"),i=document.getElementById("dg-local-explain");h.style.display="block";var j=document.getElementById("dg-local-storage");localStorage.getItem(E(a,"isLocal"))==="true"&&j.setAttribute("checked","checked");function k(){i.style.display=a.useLocalStorage?"block":"none"}k(),n.bind(j,"change",function(){a.useLocalStorage=!a.useLocalStorage,k()})}var l=document.getElementById("dg-new-constructor");n.bind(l,"keydown",function(a){a.metaKey&&(a.which===67||a.keyCode==67)&&u.hide()}),n.bind(c,"click",function(){l.innerHTML=JSON.stringify(a.getSaveObject(),undefined,2),u.show(),l.focus(),l.select()}),n.bind(d,"click",function(){a.save()}),n.bind(e,"click",function(){var b=prompt("Enter a new preset name.");b&&a.saveAs(b)}),n.bind(f,"click",function(){a.revert()})}function G(a){function c(c){return c.preventDefault(),b=c.clientX,n.addClass(a.__closeButton,z.CLASS_DRAG),n.bind(window,"mousemove",d),n.bind(window,"mouseup",e),!1}function d(c){return c.preventDefault(),a.width+=b-c.clientX,a.onResize(),b=c.clientX,!1}function e(){n.removeClass(a.__closeButton,z.CLASS_DRAG),n.unbind(window,"mousemove",d),n.unbind(window,"mouseup",e)}a.__resize_handle=document.createElement("div"),o.extend(a.__resize_handle.style,{width:"6px",marginLeft:"-3px",height:"200px",cursor:"ew-resize",position:"absolute"});var b;n.bind(a.__resize_handle,"mousedown",c),n.bind(a.__closeButton,"mousedown",c),a.domElement.insertBefore(a.__resize_handle,a.domElement.firstElementChild)}function H(a,b){a.domElement.style.width=b+"px",a.__save_row&&a.autoPlace&&(a.__save_row.style.width=b+"px"),a.__closeButton&&(a.__closeButton.style.width=b+"px")}function I(a,b){var c={};return o.each(a.__rememberedObjects,function(d,e){var f={},g=a.__rememberedObjectIndecesToControllers[e];o.each(g,function(a,c){f[c]=b?a.initialValue:a.getValue()}),c[e]=f}),c}function J(a,b,c){var d=document.createElement("option");d.innerHTML=b,d.value=b,a.__preset_select.appendChild(d),c&&(a.__preset_select.selectedIndex=a.__preset_select.length-1)}function K(a){for(var b=0;b<a.__preset_select.length;b++)a.__preset_select[b].value==a.preset&&(a.__preset_select.selectedIndex=b)}function L(a,b){var c=a.__preset_select[a.__preset_select.selectedIndex];b?c.innerHTML=c.value+"*":c.innerHTML=c.value}function M(a){a.length!=0&&l(function(){M(a)}),o.each(a,function(a){a.updateDisplay()})}a.inject(c);var p="dg",q=72,r=20,s="Default",t=function(){try{return"localStorage"in window&&window.localStorage!==null}catch(a){return!1}}(),u,v=!0,w,x=!1,y=[],z=function(a){function h(){localStorage.setItem(E(b,"gui"),JSON.stringify(b.getSaveObject()))}function j(){var a=b.getRoot();a.width+=1,o.defer(function(){a.width-=1})}var b=this;this.domElement=document.createElement("div"),this.__ul=document.createElement("ul"),this.domElement.appendChild(this.__ul),n.addClass(this.domElement,p),this.__folders={},this.__controllers=[],this.__rememberedObjects=[],this.__rememberedObjectIndecesToControllers=[],this.__listening=[],a=a||{},a=o.defaults(a,{autoPlace:!0,width:z.DEFAULT_WIDTH}),a=o.defaults(a,{resizable:a.autoPlace,hideable:a.autoPlace}),o.isUndefined(a.load)?a.load={preset:s}:a.preset&&(a.load.preset=a.preset),o.isUndefined(a.parent)&&a.hideable&&y.push(this),a.resizable=o.isUndefined(a.parent)&&a.resizable,a.autoPlace&&o.isUndefined(a.scrollable)&&(a.scrollable=!0);var c=t&&localStorage.getItem(E(this,"isLocal"))==="true";Object.defineProperties(this,{parent:{get:function(){return a.parent}},scrollable:{get:function(){return a.scrollable}},autoPlace:{get:function(){return a.autoPlace}},preset:{get:function(){return b.parent?b.getRoot().preset:a.load.preset},set:function(c){b.parent?b.getRoot().preset=c:a.load.preset=c,K(this),b.revert()}},width:{get:function(){return a.width},set:function(c){a.width=c,H(b,c)}},name:{get:function(){return a.name},set:function(b){a.name=b,e&&(e.innerHTML=a.name)}},closed:{get:function(){return a.closed},set:function(c){a.closed=c,a.closed?n.addClass(b.__ul,z.CLASS_CLOSED):n.removeClass(b.__ul,z.CLASS_CLOSED),this.onResize(),b.__closeButton&&(b.__closeButton.innerHTML=c?z.TEXT_OPEN:z.TEXT_CLOSED)}},load:{get:function(){return a.load}},useLocalStorage:{get:function(){return c},set:function(a){t&&(c=a,a?n.bind(window,"unload",h):n.unbind(window,"unload",h),localStorage.setItem(E(b,"isLocal"),a))}}});if(o.isUndefined(a.parent)){a.closed=!1,n.addClass(this.domElement,z.CLASS_MAIN),n.makeSelectable(this.domElement,!1);if(t&&c){b.useLocalStorage=!0;var d=localStorage.getItem(E(this,"gui"));d&&(a.load=JSON.parse(d))}this.__closeButton=document.createElement("div"),this.__closeButton.innerHTML=z.TEXT_CLOSED,n.addClass(this.__closeButton,z.CLASS_CLOSE_BUTTON),this.domElement.appendChild(this.__closeButton),n.bind(this.__closeButton,"click",function(){b.closed=!b.closed})}else{a.closed===undefined&&(a.closed=!0);var e=document.createTextNode(a.name);n.addClass(e,"controller-name");var f=B(b,e),g=function(a){return a.preventDefault(),b.closed=!b.closed,!1};n.addClass(this.__ul,z.CLASS_CLOSED),n.addClass(f,"title"),n.bind(f,"click",g),a.closed||(this.closed=!1)}a.autoPlace&&(o.isUndefined(a.parent)&&(v&&(w=document.createElement("div"),n.addClass(w,p),n.addClass(w,z.CLASS_AUTO_PLACE_CONTAINER),document.body.appendChild(w),v=!1),w.appendChild(this.domElement),n.addClass(this.domElement,z.CLASS_AUTO_PLACE)),this.parent||H(b,a.width)),n.bind(window,"resize",function(){b.onResize()}),n.bind(this.__ul,"webkitTransitionEnd",function(){b.onResize()}),n.bind(this.__ul,"transitionend",function(){b.onResize()}),n.bind(this.__ul,"oTransitionEnd",function(){b.onResize()}),this.onResize(),a.resizable&&G(this);var i=b.getRoot();a.parent||j()};return z.toggleHide=function(){x=!x,o.each(y,function(a){a.domElement.style.zIndex=x?-999:999,a.domElement.style.opacity=x?0:1})},z.CLASS_AUTO_PLACE="a",z.CLASS_AUTO_PLACE_CONTAINER="ac",z.CLASS_MAIN="main",z.CLASS_CONTROLLER_ROW="cr",z.CLASS_TOO_TALL="taller-than-window",z.CLASS_CLOSED="closed",z.CLASS_CLOSE_BUTTON="close-button",z.CLASS_DRAG="drag",z.DEFAULT_WIDTH=245,z.TEXT_CLOSED="Close Controls",z.TEXT_OPEN="Open Controls",n.bind(window,"keydown",function(a){document.activeElement.type!=="text"&&(a.which===q||a.keyCode==q)&&z.toggleHide()},!1),o.extend(z.prototype,{add:function(a,b){return A(this,a,b,{factoryArgs:Array.prototype.slice.call(arguments,2)})},addColor:function(a,b){return A(this,a,b,{color:!0})},remove:function(a){this.__ul.removeChild(a.__li),this.__controllers.slice(this.__controllers.indexOf(a),1);var b=this;o.defer(function(){b.onResize()})},destroy:function(){this.autoPlace&&w.removeChild(this.domElement)},addFolder:function(a){if(this.__folders[a]!==undefined)throw new Error('You already have a folder in this GUI by the name "'+a+'"');var b={name:a,parent:this};b.autoPlace=this.autoPlace,this.load&&this.load.folders&&this.load.folders[a]&&(b.closed=this.load.folders[a].closed,b.load=this.load.folders[a]);var c=new z(b);this.__folders[a]=c;var d=B(this,c.domElement);return n.addClass(d,"folder"),c},open:function(){this.closed=!1},close:function(){this.closed=!0},onResize:function(){var a=this.getRoot();if(a.scrollable){var b=n.getOffset(a.__ul).top,c=0;o.each(a.__ul.childNodes,function(b){if(!a.autoPlace||b!==a.__save_row)c+=n.getHeight(b)}),window.innerHeight-b-r<c?(n.addClass(a.domElement,z.CLASS_TOO_TALL),a.__ul.style.height=window.innerHeight-b-r+"px"):(n.removeClass(a.domElement,z.CLASS_TOO_TALL),a.__ul.style.height="auto")}a.__resize_handle&&o.defer(function(){a.__resize_handle.style.height=a.__ul.offsetHeight+"px"}),a.__closeButton&&(a.__closeButton.style.width=a.width+"px")},remember:function(){o.isUndefined(u)&&(u=new m,u.domElement.innerHTML=b);if(this.parent)throw new Error("You can only call remember on a top level GUI.");var a=this;o.each(Array.prototype.slice.call(arguments),function(b){a.__rememberedObjects.length==0&&F(a),a.__rememberedObjects.indexOf(b)==-1&&a.__rememberedObjects.push(b)}),this.autoPlace&&H(this,this.width)},getRoot:function(){var a=this;while(a.parent)a=a.parent;return a},getSaveObject:function(){var a=this.load;return a.closed=this.closed,this.__rememberedObjects.length>0&&(a.preset=this.preset,a.remembered||(a.remembered={}),a.remembered[this.preset]=I(this)),a.folders={},o.each(this.__folders,function(b,c){a.folders[c]=b.getSaveObject()}),a},save:function(){this.load.remembered||(this.load.remembered={}),this.load.remembered[this.preset]=I(this),L(this,!1)},saveAs:function(a){this.load.remembered||(this.load.remembered={},this.load.remembered[s]=I(this,!0)),this.load.remembered[a]=I(this),this.preset=a,J(this,a,!0)},revert:function(a){o.each(this.__controllers,function(b){this.getRoot().load.remembered?D(a||this.getRoot(),b):b.setValue(b.initialValue)},this),o.each(this.__folders,function(a){a.revert(a)}),a||L(this.getRoot(),!1)},listen:function(a){var b=this.__listening.length==0;this.__listening.push(a),b&&M(this.__listening)}}),z}(dat.utils.css,'<div id="dg-save" class="dg dialogue">\n\n  Here\'s the new load parameter for your <code>GUI</code>\'s constructor:\n\n  <textarea id="dg-new-constructor"></textarea>\n\n  <div id="dg-save-locally">\n\n    <input id="dg-local-storage" type="checkbox"/> Automatically save\n    values to <code>localStorage</code> on exit.\n\n    <div id="dg-local-explain">The values saved to <code>localStorage</code> will\n      override those passed to <code>dat.GUI</code>\'s constructor. This makes it\n      easier to work incrementally, but <code>localStorage</code> is fragile,\n      and your friends may not see the same values you do.\n      \n    </div>\n    \n  </div>\n\n</div>',".dg ul{list-style:none;margin:0;padding:0;width:100%;clear:both}.dg.ac{position:fixed;top:0;left:0;right:0;height:0;z-index:0}.dg:not(.ac) .main{overflow:hidden}.dg.main{-webkit-transition:opacity 0.1s linear;-o-transition:opacity 0.1s linear;-moz-transition:opacity 0.1s linear;transition:opacity 0.1s linear}.dg.main.taller-than-window{overflow-y:auto}.dg.main.taller-than-window .close-button{opacity:1;margin-top:-1px;border-top:1px solid #2c2c2c}.dg.main ul.closed .close-button{opacity:1 !important}.dg.main:hover .close-button,.dg.main .close-button.drag{opacity:1}.dg.main .close-button{-webkit-transition:opacity 0.1s linear;-o-transition:opacity 0.1s linear;-moz-transition:opacity 0.1s linear;transition:opacity 0.1s linear;border:0;position:absolute;line-height:19px;height:20px;cursor:pointer;text-align:center;background-color:#000}.dg.main .close-button:hover{background-color:#111}.dg.a{float:right;margin-right:15px;overflow-x:hidden}.dg.a.has-save ul{margin-top:27px}.dg.a.has-save ul.closed{margin-top:0}.dg.a .save-row{position:fixed;top:0;z-index:1002}.dg li{-webkit-transition:height 0.1s ease-out;-o-transition:height 0.1s ease-out;-moz-transition:height 0.1s ease-out;transition:height 0.1s ease-out}.dg li:not(.folder){cursor:auto;height:27px;line-height:27px;overflow:hidden;padding:0 4px 0 5px}.dg li.folder{padding:0;border-left:4px solid rgba(0,0,0,0)}.dg li.title{cursor:pointer;margin-left:-4px}.dg .closed li:not(.title),.dg .closed ul li,.dg .closed ul li > *{height:0;overflow:hidden;border:0}.dg .cr{clear:both;padding-left:3px;height:27px}.dg .property-name{cursor:default;float:left;clear:left;width:40%;overflow:hidden;text-overflow:ellipsis}.dg .c{float:left;width:60%}.dg .c input[type=text]{border:0;margin-top:4px;padding:3px;width:100%;float:right}.dg .has-slider input[type=text]{width:30%;margin-left:0}.dg .slider{float:left;width:66%;margin-left:-5px;margin-right:0;height:19px;margin-top:4px}.dg .slider-fg{height:100%}.dg .c input[type=checkbox]{margin-top:9px}.dg .c select{margin-top:5px}.dg .cr.function,.dg .cr.function .property-name,.dg .cr.function *,.dg .cr.boolean,.dg .cr.boolean *{cursor:pointer}.dg .selector{display:none;position:absolute;margin-left:-9px;margin-top:23px;z-index:10}.dg .c:hover .selector,.dg .selector.drag{display:block}.dg li.save-row{padding:0}.dg li.save-row .button{display:inline-block;padding:0px 6px}.dg.dialogue{background-color:#222;width:460px;padding:15px;font-size:13px;line-height:15px}#dg-new-constructor{padding:10px;color:#222;font-family:Monaco, monospace;font-size:10px;border:0;resize:none;box-shadow:inset 1px 1px 1px #888;word-wrap:break-word;margin:12px 0;display:block;width:440px;overflow-y:scroll;height:100px;position:relative}#dg-local-explain{display:none;font-size:11px;line-height:17px;border-radius:3px;background-color:#333;padding:8px;margin-top:10px}#dg-local-explain code{font-size:10px}#dat-gui-save-locally{display:none}.dg{color:#eee;font:11px 'Lucida Grande', sans-serif;text-shadow:0 -1px 0 #111}.dg.main::-webkit-scrollbar{width:5px;background:#1a1a1a}.dg.main::-webkit-scrollbar-corner{height:0;display:none}.dg.main::-webkit-scrollbar-thumb{border-radius:5px;background:#676767}.dg li:not(.folder){background:#1a1a1a;border-bottom:1px solid #2c2c2c}.dg li.save-row{line-height:25px;background:#dad5cb;border:0}.dg li.save-row select{margin-left:5px;width:108px}.dg li.save-row .button{margin-left:5px;margin-top:1px;border-radius:2px;font-size:9px;line-height:7px;padding:4px 4px 5px 4px;background:#c5bdad;color:#fff;text-shadow:0 1px 0 #b0a58f;box-shadow:0 -1px 0 #b0a58f;cursor:pointer}.dg li.save-row .button.gears{background:#c5bdad url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAsAAAANCAYAAAB/9ZQ7AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAQJJREFUeNpiYKAU/P//PwGIC/ApCABiBSAW+I8AClAcgKxQ4T9hoMAEUrxx2QSGN6+egDX+/vWT4e7N82AMYoPAx/evwWoYoSYbACX2s7KxCxzcsezDh3evFoDEBYTEEqycggWAzA9AuUSQQgeYPa9fPv6/YWm/Acx5IPb7ty/fw+QZblw67vDs8R0YHyQhgObx+yAJkBqmG5dPPDh1aPOGR/eugW0G4vlIoTIfyFcA+QekhhHJhPdQxbiAIguMBTQZrPD7108M6roWYDFQiIAAv6Aow/1bFwXgis+f2LUAynwoIaNcz8XNx3Dl7MEJUDGQpx9gtQ8YCueB+D26OECAAQDadt7e46D42QAAAABJRU5ErkJggg==) 2px 1px no-repeat;height:7px;width:8px}.dg li.save-row .button:hover{background-color:#bab19e;box-shadow:0 -1px 0 #b0a58f}.dg li.folder{border-bottom:0}.dg li.title{padding-left:16px;background:#000 url(data:image/gif;base64,R0lGODlhBQAFAJEAAP////Pz8////////yH5BAEAAAIALAAAAAAFAAUAAAIIlI+hKgFxoCgAOw==) 6px 10px no-repeat;cursor:pointer;border-bottom:1px solid rgba(255,255,255,0.2)}.dg .closed li.title{background-image:url(data:image/gif;base64,R0lGODlhBQAFAJEAAP////Pz8////////yH5BAEAAAIALAAAAAAFAAUAAAIIlGIWqMCbWAEAOw==)}.dg .cr.boolean{border-left:3px solid #806787}.dg .cr.function{border-left:3px solid #e61d5f}.dg .cr.number{border-left:3px solid #2fa1d6}.dg .cr.number input[type=text]{color:#2fa1d6}.dg .cr.string{border-left:3px solid #1ed36f}.dg .cr.string input[type=text]{color:#1ed36f}.dg .cr.function:hover,.dg .cr.boolean:hover{background:#111}.dg .c input[type=text]{background:#303030;outline:none}.dg .c input[type=text]:hover{background:#3c3c3c}.dg .c input[type=text]:focus{background:#494949;color:#fff}.dg .c .slider{background:#303030;cursor:ew-resize}.dg .c .slider-fg{background:#2fa1d6}.dg .c .slider:hover{background:#3c3c3c}.dg .c .slider:hover .slider-fg{background:#44abda}\n",dat.controllers.factory=function(a,b,c,d,e,f,g){return function(h,i){var j=h[i];if(g.isArray(arguments[2])||g.isObject(arguments[2]))return new a(h,i,arguments[2]);if(g.isNumber(j))return g.isNumber(arguments[2])&&g.isNumber(arguments[3])?new c(h,i,arguments[2],arguments[3]):new b(h,i,{min:arguments[2],max:arguments[3]});if(g.isString(j))return new d(h,i);if(g.isFunction(j))return new e(h,i,"");if(g.isBoolean(j))return new f(h,i)}}(dat.controllers.OptionController,dat.controllers.NumberControllerBox,dat.controllers.NumberControllerSlider,dat.controllers.StringController=function(a,b,c){var d=function(a,c){function f(){e.setValue(e.__input.value)}function g(){e.__onFinishChange&&e.__onFinishChange.call(e,e.getValue())}d.superclass.call(this,a,c);var e=this;this.__input=document.createElement("input"),this.__input.setAttribute("type","text"),b.bind(this.__input,"keyup",f),b.bind(this.__input,"change",f),b.bind(this.__input,"blur",g),b.bind(this.__input,"keydown",function(a){a.keyCode===13&&this.blur()}),this.updateDisplay(),this.domElement.appendChild(this.__input)};return d.superclass=a,c.extend(d.prototype,a.prototype,{updateDisplay:function(){return b.isActive(this.__input)||(this.__input.value=this.getValue()),d.superclass.prototype.updateDisplay.call(this)}}),d}(dat.controllers.Controller,dat.dom.dom,dat.utils.common),dat.controllers.FunctionController,dat.controllers.BooleanController,dat.utils.common),dat.controllers.Controller,dat.controllers.BooleanController,dat.controllers.FunctionController,dat.controllers.NumberControllerBox,dat.controllers.NumberControllerSlider,dat.controllers.OptionController,dat.controllers.ColorController=function(a,b,c,d,e){function h(a,b,c,d){a.style.background="",e.each(g,function(e){a.style.cssText+="background: "+e+"linear-gradient("+b+", "+c+" 0%, "+d+" 100%); "})}function i(a){a.style.background="",a.style.cssText+="background: -moz-linear-gradient(top,  #ff0000 0%, #ff00ff 17%, #0000ff 34%, #00ffff 50%, #00ff00 67%, #ffff00 84%, #ff0000 100%);",a.style.cssText+="background: -webkit-linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);",a.style.cssText+="background: -o-linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);",a.style.cssText+="background: -ms-linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);",a.style.cssText+="background: linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);"}var f=function(a,g){function l(a){p(a),b.bind(window,"mousemove",p),b.bind(window,"mouseup",m)}function m(){b.unbind(window,"mousemove",p),b.unbind(window,"mouseup",m)}function n(){var a=d(this.value);a!==!1?(j.__color.__state=a,j.setValue(j.__color.toOriginal())):this.value=j.__color.toString()}function o(){b.unbind(window,"mousemove",q),b.unbind(window,"mouseup",o)}function p(a){a.preventDefault();var c=b.getWidth(j.__saturation_field),d=b.getOffset(j.__saturation_field),e=(a.clientX-d.left+document.body.scrollLeft)/c,f=1-(a.clientY-d.top+document.body.scrollTop)/c;return f>1?f=1:f<0&&(f=0),e>1?e=1:e<0&&(e=0),j.__color.v=f,j.__color.s=e,j.setValue(j.__color.toOriginal()),!1}function q(a){a.preventDefault();var c=b.getHeight(j.__hue_field),d=b.getOffset(j.__hue_field),e=1-(a.clientY-d.top+document.body.scrollTop)/c;return e>1?e=1:e<0&&(e=0),j.__color.h=e*360,j.setValue(j.__color.toOriginal()),!1}f.superclass.call(this,a,g),this.__color=new c(this.getValue()),this.__temp=new c(0);var j=this;this.domElement=document.createElement("div"),b.makeSelectable(this.domElement,!1),this.__selector=document.createElement("div"),this.__selector.className="selector",this.__saturation_field=document.createElement("div"),this.__saturation_field.className="saturation-field",this.__field_knob=document.createElement("div"),this.__field_knob.className="field-knob",this.__field_knob_border="2px solid ",this.__hue_knob=document.createElement("div"),this.__hue_knob.className="hue-knob",this.__hue_field=document.createElement("div"),this.__hue_field.className="hue-field",this.__input=document.createElement("input"),this.__input.type="text",this.__input_textShadow="0 1px 1px ",b.bind(this.__input,"keydown",function(a){a.keyCode===13&&n.call(this)}),b.bind(this.__input,"blur",n),b.bind(this.__selector,"mousedown",function(a){b.addClass(this,"drag").bind(window,"mouseup",function(a){b.removeClass(j.__selector,"drag")})});var k=document.createElement("div");e.extend(this.__selector.style,{width:"122px",height:"102px",padding:"3px",backgroundColor:"#222",boxShadow:"0px 1px 3px rgba(0,0,0,0.3)"}),e.extend(this.__field_knob.style,{position:"absolute",width:"12px",height:"12px",border:this.__field_knob_border+(this.__color.v<.5?"#fff":"#000"),boxShadow:"0px 1px 3px rgba(0,0,0,0.5)",borderRadius:"12px",zIndex:1}),e.extend(this.__hue_knob.style,{position:"absolute",width:"15px",height:"2px",borderRight:"4px solid #fff",zIndex:1}),e.extend(this.__saturation_field.style,{width:"100px",height:"100px",border:"1px solid #555",marginRight:"3px",display:"inline-block",cursor:"pointer"}),e.extend(k.style,{width:"100%",height:"100%",background:"none"}),h(k,"top","rgba(0,0,0,0)","#000"),e.extend(this.__hue_field.style,{width:"15px",height:"100px",display:"inline-block",border:"1px solid #555",cursor:"ns-resize"}),i(this.__hue_field),e.extend(this.__input.style,{outline:"none",textAlign:"center",color:"#fff",border:0,fontWeight:"bold",textShadow:this.__input_textShadow+"rgba(0,0,0,0.7)"}),b.bind(this.__saturation_field,"mousedown",l),b.bind(this.__field_knob,"mousedown",l),b.bind(this.__hue_field,"mousedown",function(a){q(a),b.bind(window,"mousemove",q),b.bind(window,"mouseup",o)}),this.__saturation_field.appendChild(k),this.__selector.appendChild(this.__field_knob),this.__selector.appendChild(this.__saturation_field),this.__selector.appendChild(this.__hue_field),this.__hue_field.appendChild(this.__hue_knob),this.domElement.appendChild(this.__input),this.domElement.appendChild(this.__selector),this.updateDisplay()};f.superclass=a,e.extend(f.prototype,a.prototype,{updateDisplay:function(){var a=d(this.getValue());if(a!==!1){var b=!1;e.each(c.COMPONENTS,function(c){if(!e.isUndefined(a[c])&&!e.isUndefined(this.__color.__state[c])&&a[c]!==this.__color.__state[c])return b=!0,{}},this),b&&e.extend(this.__color.__state,a)}e.extend(this.__temp.__state,this.__color.__state),this.__temp.a=1;var f=this.__color.v<.5||this.__color.s>.5?255:0,g=255-f;e.extend(this.__field_knob.style,{marginLeft:100*this.__color.s-7+"px",marginTop:100*(1-this.__color.v)-7+"px",backgroundColor:this.__temp.toString(),border:this.__field_knob_border+"rgb("+f+","+f+","+f+")"}),this.__hue_knob.style.marginTop=(1-this.__color.h/360)*100+"px",this.__temp.s=1,this.__temp.v=1,h(this.__saturation_field,"left","#fff",this.__temp.toString()),e.extend(this.__input.style,{backgroundColor:this.__input.value=this.__color.toString(),color:"rgb("+f+","+f+","+f+")",textShadow:this.__input_textShadow+"rgba("+g+","+g+","+g+",.7)"})}});var g=["-moz-","-o-","-webkit-","-ms-",""];return f}(dat.controllers.Controller,dat.dom.dom,dat.color.Color=function(a,b,c,d){function f(a,b,c){Object.defineProperty(a,b,{get:function(){return this.__state.space==="RGB"?this.__state[b]:(h(this,b,c),this.__state[b])},set:function(a){this.__state.space!=="RGB"&&(h(this,b,c),this.__state.space="RGB"),this.__state[b]=a}})}function g(a,b){Object.defineProperty(a,b,{get:function(){return this.__state.space==="HSV"?this.__state[b]:(i(this),this.__state[b])},set:function(a){this.__state.space!=="HSV"&&(i(this),this.__state.space="HSV"),this.__state[b]=a}})}function h(a,c,e){if(a.__state.space==="HEX")a.__state[c]=b.component_from_hex(a.__state.hex,e);else{if(a.__state.space!=="HSV")throw"Corrupted color state";d.extend(a.__state,b.hsv_to_rgb(a.__state.h,a.__state.s,a.__state.v))}}function i(a){var c=b.rgb_to_hsv(a.r,a.g,a.b);d.extend(a.__state,{s:c.s,v:c.v}),d.isNaN(c.h)?d.isUndefined(a.__state.h)&&(a.__state.h=0):a.__state.h=c.h}var e=function(){this.__state=a.apply(this,arguments);if(this.__state===!1)throw"Failed to interpret color arguments";this.__state.a=this.__state.a||1};return e.COMPONENTS=["r","g","b","h","s","v","hex","a"],d.extend(e.prototype,{toString:function(){return c(this)},toOriginal:function(){return this.__state.conversion.write(this)}}),f(e.prototype,"r",2),f(e.prototype,"g",1),f(e.prototype,"b",0),g(e.prototype,"h"),g(e.prototype,"s"),g(e.prototype,"v"),Object.defineProperty(e.prototype,"a",{get:function(){return this.__state.a},set:function(a){this.__state.a=a}}),Object.defineProperty(e.prototype,"hex",{get:function(){return!this.__state.space!=="HEX"&&(this.__state.hex=b.rgb_to_hex(this.r,this.g,this.b)),this.__state.hex},set:function(a){this.__state.space="HEX",this.__state.hex=a}}),e}(dat.color.interpret,dat.color.math=function(){var a;return{hsv_to_rgb:function(a,b,c){var d=Math.floor(a/60)%6,e=a/60-Math.floor(a/60),f=c*(1-b),g=c*(1-e*b),h=c*(1-(1-e)*b),i=[[c,h,f],[g,c,f],[f,c,h],[f,g,c],[h,f,c],[c,f,g]][d];return{r:i[0]*255,g:i[1]*255,b:i[2]*255}},rgb_to_hsv:function(a,b,c){var d=Math.min(a,b,c),e=Math.max(a,b,c),f=e-d,g,h;return e==0?{h:NaN,s:0,v:0}:(h=f/e,a==e?g=(b-c)/f:b==e?g=2+(c-a)/f:g=4+(a-b)/f,g/=6,g<0&&(g+=1),{h:g*360,s:h,v:e/255})},rgb_to_hex:function(a,b,c){var d=this.hex_with_component(0,2,a);return d=this.hex_with_component(d,1,b),d=this.hex_with_component(d,0,c),d},component_from_hex:function(a,b){return a>>b*8&255},hex_with_component:function(b,c,d){return d<<(a=c*8)|b&~(255<<a)}}}(),dat.color.toString,dat.utils.common),dat.color.interpret,dat.utils.common),dat.utils.requestAnimationFrame=function(){return window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a,b){window.setTimeout(a,1e3/60)}}(),dat.dom.CenteredDiv=function(a,b){function d(a){console.log(a)}var c=function(){this.backgroundElement=document.createElement("div"),b.extend(this.backgroundElement.style,{backgroundColor:"rgba(0,0,0,0.8)",top:0,left:0,display:"none",zIndex:"1000",opacity:0,WebkitTransition:"opacity 0.2s linear"}),a.makeFullscreen(this.backgroundElement),this.backgroundElement.style.position="fixed",this.domElement=document.createElement("div"),b.extend(this.domElement.style,{position:"fixed",display:"none",zIndex:"1001",opacity:0,WebkitTransition:"-webkit-transform 0.2s ease-out, opacity 0.2s linear"}),document.body.appendChild(this.backgroundElement),document.body.appendChild(this.domElement);var c=this;a.bind(this.backgroundElement,"click",function(){c.hide()})};return c.prototype.show=function(){var a=this;this.backgroundElement.style.display="block",this.domElement.style.display="block",this.domElement.style.opacity=0,this.domElement.style.webkitTransform="scale(1.1)",this.layout(),b.defer(function(){a.backgroundElement.style.opacity=1,a.domElement.style.opacity=1,a.domElement.style.webkitTransform="scale(1)"})},c.prototype.hide=function(){var b=this,c=function(){b.domElement.style.display="none",b.backgroundElement.style.display="none",a.unbind(b.domElement,"webkitTransitionEnd",c),a.unbind(b.domElement,"transitionend",c),a.unbind(b.domElement,"oTransitionEnd",c)};a.bind(this.domElement,"webkitTransitionEnd",c),a.bind(this.domElement,"transitionend",c),a.bind(this.domElement,"oTransitionEnd",c),this.backgroundElement.style.opacity=0,this.domElement.style.opacity=0,this.domElement.style.webkitTransform="scale(1.1)"},c.prototype.layout=function(){this.domElement.style.left=window.innerWidth/2-a.getWidth(this.domElement)/2+"px",this.domElement.style.top=window.innerHeight/2-a.getHeight(this.domElement)/2+"px"},c}(dat.dom.dom,dat.utils.common),dat.dom.dom,dat.utils.common);var ec=ec||{version:"0.1.200",debug:0};(function(a){"use strict",a.ec=ec;var b=a.document;ec.debug=0;var c,d,e,f,g,h,i=ec.TIME_STEP=1e3/60,j=!1,k,l,m,n,o,p,q=null,r,s,t=2e3,u="extend,resizeDisplay,addBrowserListeners,Entity,Box,Circle,EmptyHand,Player,Ninja,Puff,World,Canvas2dView,Canvas2dWorldView,Canvas2dMapView,Canvas2dEntityView,Canvas2dCreditsView,TextField,ChipmunkDebugView,DebugView,UserInput,EnemyInput,SpriteSheets,ButtonOverlay,Sound".split(","),v="cp,createjs,Stats,dat".split(","),w=function(a,b){for(var c=0,d=b.length;c<d;c++)if(a[b[c]]===undefined)return!1;return!0},x=ec.core={load:function(b){if(!w(a,v)||!w(ec,u)){console.log("loading"),z(x.load);return}s=new ec.Sound,console.log("init"),x.init(b)},init:function(b){l=b,m=0,r=z(x.animate),n=new ec.UserInput,ec.world=c=new ec.World,c.addWalls(),ec.player=o=c.add((new ec.Player).setPos(-2,-155,0).setInput(n)),c.add((new ec.Circle(0,96)).setPos(-384,-208,0)),c.add((new ec.Circle(0,96)).setPos(384,-208,0)),c.add((new ec.Box(0)).setPos(-250,0,0)),c.add((new ec.Box(0)).setPos(250,0,0)),c.add((new ec.Box(0)).setPos(-250,250,0)),c.add((new ec.Box(0)).setPos(250,250,0)),c.add((new ec.Box(0)).setPos(-250,500,0)),c.add((new ec.Box(0)).setPos(250,500,0)),c.add((new ec.Box(0)).setPos(-500,-500,0)),c.add((new ec.Box(0)).setPos(500,-500,0));var f=new ec.EnemyInput;p=c.add((new ec.Ninja).setPos(250,64,0).setInput(f)),ec.resizeDisplay(),ec.SpriteSheets.init(),d=d||new ec.Canvas2dView,d.removeAll(),e=new ec.Canvas2dWorldView(c),d.add(e),d.add(n),h=new ec.ChipmunkDebugView(c.space),g=new ec.DebugView,ec.debug&&ec.core.setDebugLevel(ec.debug),ec.addBrowserListeners(n);if(ec.touch){var i=d.width*ec.pixelRatio,k=d.height*ec.pixelRatioY||ec.pixelRatio;ec.ButtonOverlay.viewWidth=i,ec.ButtonOverlay.viewHeight=k,n.setLeftStickOverlay(n.addButtonOverlay(new ec.ButtonOverlay({x:160,y:k-160,radius:150}))),n.setRightStickOverlay(n.addButtonOverlay(new ec.ButtonOverlay({x:i-160,y:k-160,radius:150})));var t=n.addButtonOverlay(new ec.ButtonOverlay({x:i,y:50,radius:150})),u=n.addButtonOverlay(new ec.ButtonOverlay({x:0,y:50,radius:150}));ec.bind(t,"touchend",ec.core.togglePause,!1),ec.bind(u,"touchend",ec.core.cycleDebug,!1)}ec.mobile&&a.scrollTo(0,1),j=!0,q=new Image,q.src="img/ui/startscreen.png?v="+ec.version,e.lookAt(o.body.p.x,-o.body.p.y),ec.touch?ec.bind(ec.core.getViewDom(),"touchend",ec.core.start,!1):ec.bind(ec.core.getViewDom(),"mouseup",ec.core.start,!1),!!ec.touch,ec.core.trackEvent("core","inited",ec.version,undefined,!0),s.stop()},start:function(a){ec.unbind(ec.core.getViewDom(),a.type,ec.core.start,!1),q=null,ec.playerInteractions<1&&(q=new Image,ec.touch?(q.src="img/ui/guide-touch.png?v="+ec.version,ec.core.trackEvent("game","guide","guide-touch")):(q.src="img/ui/guide-move-desktop.png?v="+ec.version,ec.core.trackEvent("game","guide","guide-move-desktop"))),s.playGameMusic()},userReady:function(){q&&(ec.touch||(q=null,q=new Image,q.src="img/ui/guide-fight-desktop.png?v="+ec.version,ec.core.trackEvent("game","guide","guide-fight-desktop")))},userPlaying:function(){q=null},rollCredits:function(){ec.playerInteractions=36,ec.core.trackEvent("game","credits",ec.version),A(r),r=z(x.animateCredits),f=f||new ec.Canvas2dCreditsView,f.init(d.context),d.removeAll(),d.add(f),ec.touch?ec.bind(ec.core.getViewDom(),"touchend",ec.core.restart,!1):ec.bind(ec.core.getViewDom(),"mouseup",ec.core.restart,!1),c.term(),s.playEndingMusic()},restart:function(a){if(f.creditsTime<f.skipAfter)return;ec.unbind(ec.core.getViewDom(),a.type,ec.core.restart,!1),d.remove(f),q=null,A(r),r=z(x.init)},animateCredits:function(a){r=z(x.animateCredits),ec.debug>0&&g.stats.begin(),k=a-l,l=a,k=Math.max(i,Math.min(k,i*10)),ec.debug<3&&d.draw(k),ec.debug>0&&g.stats.end()},animate:function(a){r=z(x.animate),ec.debug>0&&g.stats.begin(),k=a-l,l=a,k=Math.max(i,Math.min(k,i*10));if(!j){m+=k;while(m>=i)m-=i,c.step(i);e.lookAt(o.body.p.x,-o.body.p.y)}if(p.state==="dead"){p.decomposed=p.decomposed||0,p.decomposed+=k;if(p.decomposed>t){delete p.decomposed,ec.core.rollCredits();return}}ec.debug<3&&d.draw(k),ec.debug>0&&(ec.debug>1&&h.step(),g.stats.end())},getOverlay:function(){return q},pause:function(){console.log("pause"),j=!0,d.pause(),ec.allowPinchZoom()},resume:function(){console.log("resume"),j=!1,d.resume(),ec.preventPinchZoom()},togglePause:function(){ec.core.paused()?ec.core.resume():ec.core.pause()},paused:function(){return j},fullscreen:function(){if(ec.fullscreen){var a=b.body;a.requestFullscreen=a.requestFullscreen||a.mozRequestFullscreen||a.mozRequestFullScreen||a.webkitRequestFullscreen,a.requestFullscreen()}},resize:function(){ec.resizeDisplay()&&(d.resize(ec.width,ec.height),h.resize())},getViewDom:function(){return d.getDom()},trackPage:function(b){a._gaq&&a._gaq.push(["_trackPageview",b])},trackEvent:function(b,c,d,e,f){a._gaq&&a._gaq.push(["_trackEvent",b,c,d,e,f])},trackCustom:function(b,c,d,e){a._gaq&&a._gaq.push(["_setCustomVar",b,c,d,e])},setDebugLevel:function(a){a<0&&(a=3),g.hide(),h.hide();switch(a){case 3:case 2:h.show();case 1:g.show()}ec.debug=a,console.log("debug level",a)},cycleDebug:function(){ec.core.setDebugLevel(ec.debug-1)}};ec.extend=function(a,b){for(var c in b)if(b.hasOwnProperty(c)&&!a.hasOwnProperty(c)){var d=b[c];d!==undefined&&(a[c]=b[c])}return a},ec.create=function(a){function b(){}return b.prototype=a,new b},ec.delegate=function(a,b){return function(){return b.apply(a,arguments)}};var y=function(a,b){return b[a]||b["webkit"+a]||b["moz"+a]||b["o"+a]||b["ms"+a]};ec.touch="ontouchstart"in a||a.DocumentTouch&&b instanceof a.DocumentTouch,ec.mobile=/iPhone|iPad|iPod|Android/.test(navigator.userAgent),ec.ios=/iPhone|iPad|iPod/.test(navigator.userAgent),ec.ipad=/iPad/.test(navigator.userAgent),ec.android=/Android/.test(navigator.userAgent),ec.standalone=!!navigator.standalone,ec.webgl=!!a.WebGLRenderingContext,ec.fullscreen=!!y("cancelFullScreen",b),ec.webaudio=!!y("AudioContext",a),ec.gamepads=!!y("getGamepads",navigator),Date.now||(Date.now=function(){return+(new Date)});var z=a.requestAnimationFrame||y("RequestAnimationFrame",a),A=a.cancelAnimationFrame||y("CancelAnimationFrame",a)||y("CancelRequestAnimationFrame",a)||function(b){a.clearTimeout(b)};if(!z){var B=0;z=function(b,c){var d=Date.now(),e=Math.max(0,16-(d-B)),f=a.setTimeout(function(){b(d+e)},e);return B=d+e,f}}z(x.load),ec.core.trackEvent("core","preload",ec.version,undefined,!0)})(window),function(a){"use strict";var b=a.ec,c=a.document,d=b.android&&c.querySelector&&c.querySelector('meta[name="viewport"]');b.addBrowserListeners=function(d){this.bind(a,"blur",this.core.pause,!1),b.touch?(this.bind(b.core.getViewDom(),"touchstart",d.touchstart,!1),this.bind(b.core.getViewDom(),"touchmove",d.touchmove,!1),this.bind(b.core.getViewDom(),"touchend",d.touchend,!1)):(this.bind(b.core.getViewDom(),"mousedown",d.mousedown,!1),this.bind(b.core.getViewDom(),"mouseup",d.mouseup,!1)),b.mobile||this.bind(a,"resize",this.core.resize,!1),this.bind(c,"keydown",d.keydown,!1),this.bind(c,"keyup",d.keyup,!1)},b.preventPinchZoom=function(){b.android&&d&&(d.content="width=device-width, user-scalable=0")},b.allowPinchZoom=function(){b.android&&d&&(d.content="width=device-width, user-scalable=1")},b.bind=function(a,b,c,d){d=d||!1,a.addEventListener?a.addEventListener(b,c,d):a.attachEvent?a.attachEvent("on"+b,c):a["on"+b]=c},b.unbind=function(a,b,c,d){d=d||!1,a.removeEventListener?a.removeEventListener(b,c,d):a.detachEvent?a.detachEvent("on"+b,c):delete a["on"+b]}}(window),function(a){"use strict";var b=a.ec,c=a.document;b.resizeDisplay=function(){var d,e,f,g;d=e=b.forcePixelRatio||a.devicePixelRatio||1,b.ipad&&!b.webgl&&(e=Math.min(1.333333,d),d=Math.min(1,d));if(b.mobile){var h=Math.max(a.screen.width,a.screen.height),i=Math.min(a.screen.width,a.screen.height);f=h,g=i}else{var j=16,k=9,l,m;f=j,g=k,l=a.innerWidth,m=a.innerHeight;while(f+j<=l&&g+k<=m)f+=j,g+=k;c.body.style.left=Math.floor((l-f)/2)+"px",c.body.style.top=Math.floor((m-g)/2)+"px"}return b.width!==f||b.height!==g||b.pixelRatio!==d||b.pixelRatioY!==e?(b.pixelRatio=d,b.pixelRatioY=e,b.width=f,b.height=g,c.body.style.width=f+"px",c.body.style.height=g+"px",!0):!1}}(window),function(a){"use strict";var b=a.cp,c=b.v,d=a.ec.Entity=function(){console.log("new Entity",this)};d.groupId=1;var e=d.prototype;e.z=0,e.groupId=b.NO_GROUP,e.setView=function(a){return this.view=a,this},e.setInput=function(a){return this.input=a,this},e.step=function(a){return this},e.hit=function(a){return console.log("HIT",this),this},e.setPos=function(a,b,c){this.body.activate(),this.body.p.x=a,this.body.p.y=b,c!==undefined&&(this.z=this.body.z=c);if(this.body.isStatic())for(var d=0;d<this.body.shapeList.length;d++){var e=this.body.shapeList[d];e.update(this.body.p,this.body.rot),e.space&&e.space.staticShapes.reindexObject(e,e.hashid)}return this};var f=function(a,c){var d;return a===0?(d=new b.Body(Infinity,Infinity),d.nodeIdleTime=Infinity):d=new b.Body(a,c),d};e.assignCircleShape=function(a,d,e){return e=e||b.momentForCircle(d,0,a,c(0,0)),this.radius=a,this.body=f(d,e),this.shape=new b.CircleShape(this.body,a,c(0,0)),this},e.assignBoxShape=function(a,c,d,e){return e=e||b.momentForBox(d,a,c),this.width=a,this.height=c,this.body=f(d,e),this.shape=new b.BoxShape(this.body,a,c),this}}(window),function(a){"use strict";var b=a.ec,c=64,d=64,e=a.ec.Box=function(a,e,f){e=e||c,f=f||d,a===undefined&&(a=1),this.assignBoxShape(e,f,a),this.shape.setElasticity(0),this.shape.setFriction(.6),this.setPos(-64,0,0),this.shape.collision_type=b.World.PROP_TYPE},f=e.prototype;b.extend(f,b.Entity.prototype)}(window),function(a){"use strict";var b=a.ec,c=32,d=a.ec.Circle=function(a,d){d=d||c,a===undefined&&(a=1),this.assignCircleShape(d,a),this.shape.setElasticity(0),this.shape.setFriction(.6),this.setPos(64,64,0),this.shape.collision_type=b.World.PROP_TYPE},e=d.prototype;b.extend(e,b.Entity.prototype)}(window),function(a){"use strict";var b=a.ec,c=a.cp,d=c.v,e=Math.abs,f=32,g=d(0,0),h=d(0,0);b.playerInteractions=0;var i=a.ec.Player=function(){this.groupId=b.Entity.groupId++,this.assignCircleShape(f,1),this.shape.setElasticity(0),this.shape.setFriction(0),this.body.a=-1.57,this.shape.collision_type=b.World.PLAYER_TYPE,this.shape.group=this.groupId,this.state="standing",this.walkCount=0,this.speed=8,this.attack=new b.EmptyHand(f-4,1),b.core.trackCustom(1,"Player Interacted","No",2)},j=i.prototype;b.extend(j,b.Entity.prototype),j.punch=function(a,c,e){if(this.passive())return;var f=this.attack;f.shape.group===0&&(f.shape.group=this.groupId,this.attack=f);if(f.phase>b.EmptyHand.PASSIVE)return;c.contains(f)&&c.remove(f),f.time=0,f.startTime=a,f.phase=b.EmptyHand.PUSHING,f.setPos(this.body.p.x,this.body.p.y,this.z),this.body.w=0,this.body.a=f.body.a=Math.atan2(h.y,h.x);var i=.75;this.body.vx*=i,this.body.vy*=i,f.body.resetForces(),f.body.activate();var j=d.mult(h,this.speed*1e3/e);f.body.vx=j.x+g.x*i,f.body.vy=j.y+g.y*i,c.add(f)},j.attackEnd=function(a,c){var d=this.attack;d.time=0,d.startTime=-1,d.phase=b.EmptyHand.PASSIVE,c.contains(d)&&c.remove(d),b.playerInteractions===2&&(b.playerInteractions=3,b.core.userPlaying())},j.passive=function(){return h.x===0&&h.y===0},j.step=function(a){this.input.poll(),this.body.resetForces(),this.attack.entityStep(b.world.time,b.world,this);if(this.attack.phase===b.EmptyHand.PASSIVE||this.attack.phase===b.EmptyHand.PULLING)g.x=this.input.axes[0],g.y=-this.input.axes[1],e(g.x)>.1||e(g.y)>.1?((e(g.x)>.7||e(g.y)>.7)&&g.mult(1/d.len(g)),this.state="walking",g.mult(this.speed*1e3/a),this.body.activate(),this.body.vx+=g.x,this.body.vy+=g.y,this.body.vx*=.5,this.body.vy*=.5,this.body.w=0,this.body.a=Math.atan2(g.y,g.x),b.playerInteractions===0&&(b.playerInteractions=1,b.core.trackCustom(1,"Player Interacted","Yes",2))):(this.state="standing",this.walkCount=0,this.body.vx=0,this.body.vy=0,this.body.w*=.99,b.playerInteractions===1&&(b.playerInteractions=2,b.core.userReady()));return h.x=this.input.axes[2],h.y=-this.input.axes[3],this.input.buttons[0]>0&&(h.x=Math.cos(this.body.a),h.y=Math.sin(this.body.a)),e(h.x)>.1||e(h.y)>.1?(h.mult(1/d.len(h)),this.punch(b.world.time,b.world,a),this.state="punching"):(h.x=0,h.y=0),this}}(window),function(a){"use strict";var b=a.ec,c=a.cp,d=c.v,e=b.EmptyHand=function(a,c){a=a||24,c=c||1,this.assignCircleShape(a,c),this.shape.setElasticity(.5),this.shape.setFriction(1),this.shape.collision_type=b.World.PLAYER_HAND,this.setPos(64,64,64),this.time=0,this.startTime=-1,this.phase=e.PASSIVE,this.pushDuration=5e3/60,this.grabDuration=1e4/60,this.punchDuration=this.pushDuration+this.grabDuration/2};e.PASSIVE=0,e.PUSHING=1,e.GRABBING=2,e.PULLING=3;var f=e.prototype;b.extend(f,b.Entity.prototype),f.entityStep=function(a,c,d){if(this.phase){this.time=a-this.startTime;if(this.phase===b.EmptyHand.PUSHING)this.time<this.punchDuration||(d.passive()?d.attackEnd(a,c):this.time>this.pushDuration&&(this.phase=b.EmptyHand.GRABBING));else if(this.phase===b.EmptyHand.GRABBING){this.body.vx*=.9,this.body.vy*=.9;if(d.passive())d.attackEnd(a,c);else if(this.time>this.pushDuration+this.grabDuration){var e=!1;e||d.attackEnd(a,c)}}else this.phase===b.EmptyHand.PULLING&&d.passive()&&(d.attackEnd(a,c),console.log("pull ended passively"))}}}(window),function(a){"use strict";var b=a.ec,c=a.cp,d=c.v,e=Math.abs,f=32,g=d(0,0),h=d(0,0),i=b.Ninja=function(){this.groupId=b.Entity.groupId++,this.assignCircleShape(f,1),this.shape.setElasticity(0),this.shape.setFriction(0),this.body.a=3,this.shape.collision_type=b.World.MONSTER_TYPE,this.shape.group=this.groupId,this.state="standing",this.walkCount=0,this.speed=8,this.attack=new b.EmptyHand(f-4,1),this.isShadowClone=!1,this.hitPoints=100},j=i.prototype;b.extend(j,b.Entity.prototype),j.shadowClone=function(){if(this.isShadowClone){console.error("shadow clone tried to clone itself!");return}var a=(new b.Ninja).setPos(this.body.p.x,this.body.p.y,0).setInput(new b.EnemyInput);a.isShadowClone=!0,a.master=this,b.world.add(a),b.world.add(new b.Puff(this)),b.world.add(new b.Puff(a))},j.hit=function(a,b,c){var d=a&&a.totalKE()||1e3;return d>0&&this.state!=="hit"&&this.state!=="dead"&&(this.state="hit",this.isShadowClone?(this.hitTime=400,this.hitPoints=c?0:this.hitPoints):(this.hitPoints-=c,this.hitTime=600),this.hitDuration=this.hitTime,this.body.w=d/1e4,this.body.vx*=2,this.body.vy*=2),this},j.step=function(a){if(this.hitTime>0)return this.isShadowClone&&this.hitTime===this.hitDuration&&this.hitPoints===0&&b.world.add(new b.Puff(this)),this.hitTime-=a,this.hitTime<=0&&(this.hitTime=0,this.hitPoints<=0?(this.state="dead",this.isShadowClone&&b.world.remove(this)):this.state="standing"),this;if(this.isShadowClone&&this.master.hitPoints<=0)b.world.add(new b.Puff(this)),this.hit(null,b.world,1);else if(this.state==="dead")return this.body.vx=0,this.body.vy=0,this.body.w*=.5,this;this.input.poll(this),this.body.resetForces();if(this.attack.phase===b.EmptyHand.PASSIVE||this.attack.phase===b.EmptyHand.PULLING)g.x=this.input.axes[0],g.y=-this.input.axes[1],e(g.x)>.1||e(g.y)>.1?((e(g.x)>.7||e(g.y)>.7)&&g.mult(1/d.len(g)),g.mult(this.speed*1e3/a),this.body.activate(),this.body.vx+=g.x,this.body.vy+=g.y,this.body.vx*=.5,this.body.vy*=.5,this.body.w=0,this.body.a=Math.atan2(g.y,g.x)):(this.body.vx=0,this.body.vy=0,this.body.w*=.99);return h.x=this.input.axes[2],h.y=-this.input.axes[3],e(h.x)>.1||e(h.y)>.1?h.mult(1/d.len(h)):(h.x=0,h.y=0),this}}(window),function(a){"use strict";var b=a.ec,c=50,d=b.Puff=function(a){this.groupId=a.groupId,this.assignCircleShape(c,1),this.shape.setElasticity(0),this.shape.setFriction(0),this.shape.sensor=!0,this.time=this.duration=500,this.master=a,this.setPos(a.body.p.x,a.body.p.y-1,0)},e=d.prototype;b.extend(e,b.Entity.prototype),e.step=function(a){this.time-=a,this.time<=0?(this.time=0,b.world.remove(this),delete this.master):this.setPos(this.master.body.p.x,this.master.body.p.y-1,this.z+1)}}(window),function(a){"use strict";var b=a.ec,c=a.cp,d=c.v,e=1<<31,f=~e,g=640,h=b.World=function(){this.time=0;var a=this.space=new c.Space;a.gravity=d(0,0),a.iterations=10,a.sleepTimeThreshold=b.TIME_STEP*9,a.idleSpeedThreshold=.1,a.collisionSlop=.025,a.collisionBias=Math.pow(.25,60),a.damping=.5;var e=b.delegate(this,this.pushCollision),f=b.delegate(this,this.bumpCollision);a.addCollisionHandler(h.PLAYER_HAND,h.MONSTER_TYPE,null,null,e,null),a.addCollisionHandler(h.MONSTER_TYPE,h.MONSTER_TYPE,f,null,f,null),this.entities=[]};h.PLAYER_TYPE=1,h.PLAYER_HAND=2,h.MONSTER_TYPE=10,h.PROP_TYPE=100;var i=h.prototype;i.term=function(){this.entities.length=0;var a=this.space;a.locked=0,a.removeCollisionHandler(h.PLAYER_HAND,h.MONSTER_TYPE),a.removeCollisionHandler(h.MONSTER_TYPE,h.MONSTER_TYPE),a.bodies.length=0,a.sleepingComponents.length=0,a.constraints.length=0,a.arbiters.length=0,a.constraints.length=0,delete this.space};var j=10;i.pushCollision=function(a,b){var c=a.swappedColl?a.body_a:a.body_b,d=this.entityForBody(c);return d?(d.hit(a,this,j),a.ignore(),!1):a.contacts&&a.contacts.length},i.bumpCollision=function(a,b){var c=this.entityForBody(a.body_a),d=this.entityForBody(a.body_b);return c&&d?(c.hitTime&&!d.hitTime?d.hit(a,this,0):d.hitTime&&!c.hitTime&&c.hit(a,this,0),!(c.hitTime>0&&d.hitTime>0)):!0},i.addWalls=function(){this.addBox(d(0,-g-64),g*2+256,128),this.addBox(d(0,g+64),g*2+256,128),this.addBox(d(g+64,0),128,g*2+256),this.addBox(d(-g-64,0),128,g*2+256)},i.addBox=function(a,b,d){var e=new c.Body(Infinity,Infinity);e.nodeIdleTime=Infinity,e.p=a;var g=this.space.addShape(new c.BoxShape(e,b,d));return g.setElasticity(0),g.setFriction(1),g.setLayers(f),g},i.addLineSegment=function(a,b){var d=this.space.addShape(new c.SegmentShape(this.space.staticBody,a,b,0));return d.setElasticity(0),d.setFriction(1),d.setLayers(f),d},i.add=function(a){return this.entities.indexOf(a)<0?(a.body.isStatic()||this.space.addBody(a.body),this.space.addShape(a.shape),this.entities.push(a),a):(console.error("entity already a child of world",a),null)},i.remove=function(a){var b=this.entities.indexOf(a);return b>-1?(a.body.isStatic()||this.space.removeBody(a.body),this.space.removeShape(a.shape),this.entities.splice(b,1),a):(console.error("entity not a child of world",a),null)},i.contains=function(a){return this.entities.indexOf(a)>-1},i.entityForBody=function(a){for(var b=this.entities.length;b-->0;)if(this.entities[b].body===a)return this.entities[b];return console.error("no entity for body",a),null},i.createStaticBody=function(){var a=new c.Body(Infinity,Infinity);return a.nodeIdleTime=Infinity,a},i.step=function(a){for(var b=this.entities.length;b-->0;)this.entities[b].step(a);this.space.step(a/1e3),this.time+=a}}(window),function(a){"use strict";var b=a.ec;b.SpriteSheets={init:function(){b.SpriteSheets.monk=new a.createjs.SpriteSheet({images:["img/sprite/minimonk_64.png?v="+b.version],frames:[[0,0,74,137,0,37,126],[74,0,64,142,0,36,125],[138,0,64,137,0,35,123],[202,0,72,136,0,35,126],[274,0,64,137,0,27,123],[338,0,64,142,0,26,125],[402,0,74,141,0,40,129],[0,142,61,139,0,32,126],[61,142,67,141,0,33,129],[128,142,65,140,0,33,127],[193,142,77,142,0,43,126],[270,142,48,143,0,26,125],[318,142,53,143,0,29,125],[371,142,64,135,0,32,126],[435,142,66,134,0,33,125],[0,285,51,136,0,26,123],[51,285,68,134,0,36,125],[119,285,66,136,0,39,123],[185,285,67,138,0,34,128],[252,285,64,140,0,30,126],[316,285,67,138,0,34,128],[383,285,64,140,0,33,126],[0,425,66,134,0,32,125],[66,425,51,136,0,24,123],[117,425,68,134,0,31,125],[185,425,66,136,0,26,123],[251,425,77,142,0,32,126],[328,425,48,143,0,20,125],[376,425,53,143,0,22,125],[429,425,64,135,0,30,126],[0,568,74,137,0,37,126],[74,568,74,138,0,41,116],[148,568,69,134,0,34,113],[217,568,73,144,0,40,100],[74,0,64,142,0,36,125],[290,568,48,142,0,43,124],[338,568,77,144,0,80,126],[415,568,91,135,0,108,116],[0,712,64,137,0,35,123],[64,712,68,139,0,38,126],[132,712,52,142,0,41,131],[184,712,45,139,0,46,130],[229,712,72,136,0,35,126],[301,712,64,137,0,30,136],[365,712,67,138,0,34,142],[432,712,61,138,0,34,144],[0,854,64,137,0,27,123],[64,854,68,139,0,28,126],[132,854,52,142,0,9,131],[184,854,45,139,0,-2,130],[338,0,64,142,0,26,125],[229,854,47,142,0,33,124],[276,854,77,144,0,-4,126],[353,854,91,135,0,-18,116]],animations:{standing:0,walk_0:6,walk_1:10,walk_2:14,walk_3:18,walk_4:22,walk_5:26,punch_0:30,punch_1:34,punch_2:38,punch_3:42,punch_4:46,punch_5:50}}),b.SpriteSheets.ninja=new a.createjs.SpriteSheet({images:["img/sprite/ninja_64.png?v="+b.version],frames:[[0,0,74,137,0,37,126],[74,0,59,141,0,32,124],[133,0,69,138,0,35,124],[202,0,73,138,0,36,127],[275,0,69,138,0,32,124],[344,0,59,141,0,25,124],[403,0,96,85,0,42,93],[0,141,101,113,0,51,99],[101,141,89,105,0,42,91],[190,141,81,85,0,41,83],[271,141,78,32,0,41,57],[349,141,119,108,0,44,125],[0,254,127,78,0,47,93],[127,254,145,55,0,53,62],[272,254,140,43,0,58,31]],animations:{standing:0,puff:6,fall:11}}),b.SpriteSheets.lion=new a.createjs.SpriteSheet({images:["img/sprite/lion_64.png?v="+b.version],frames:[[0,0,80,212,0,40,180]]}),b.SpriteSheets.shadow=new a.createjs.SpriteSheet({images:["img/sprite/shadow_64.png?v="+b.version],frames:[[0,0,80,54,0,40,26]]}),b.SpriteSheets.cauldron=new a.createjs.SpriteSheet({images:["img/sprite/cauldron_64.png?v="+b.version],frames:[[0,0,256,255,0,128,148]]})}}}(window),function(a){"use strict";var b=a.ec,c=b.Canvas2dEntityView=function(){this.shadow=b.SpriteSheets.shadow.getFrame(0)},d=c.prototype;d.draw=function(a,b){},d.drawShadow=function(a,c){var d=this.shadow||b.SpriteSheets.shadow.getFrame(0);if(d){var e=c.body.p.x,f=-c.body.p.y-c.z,g=d.rect;a.save(),(c instanceof b.Ninja||c instanceof b.Player)&&a.drawImage(d.image,g.x,g.y,g.width,g.height,e-d.regX,f-d.regY,g.width,g.height),a.restore()}}}(window),function(a){"use strict";var b=a.ec,c=b.Canvas2dMapView=function(){this.canvas=a.document.createElement("canvas"),this.canvas.width=1280,this.canvas.height=1280;var b=this.context=this.canvas.getContext("2d");this.tile=new Image,this.tile.onload=function(){console.log("loaded",this.width,this.height);for(var a=0;a<400;a++){var c=a%20*64,d=Math.floor(a/20)*64;b.drawImage(this,c,d,this.width,this.height)}},this.tile.src="img/tile/floor_8888_64.png"},d=c.prototype;d.draw=function(a){a.drawImage(this.canvas,-640,-640,this.canvas.width,this.canvas.height)}}(window),function(a){"use strict";var b=a.ec,c=b.Canvas2dWorldView=function(a){this.world=a,this.mapRenderer=new b.Canvas2dMapView,this.entityRenderer=new b.Canvas2dEntityView,this.drawEntityHandler=this.drawEntity(),this.camera={},this.camera.x=this.camera.y=16,this.camera.zoom=1},d=c.prototype;d.draw=function(a){a.setTransform(1,0,0,1,0,0),a.fillStyle="#888888",a.globalAlpha=1,a.fillRect(0,0,this.width,this.height),a.save(),a.scale(this.scaleX,this.scaleY),a.translate(-this.camera.x,-this.camera.y),this.mapRenderer.draw(a);var b=this.world.entities;this.world.space.activeShapes.count>0&&b.sort(e);for(var c=0,d=b.length;c<d;c++)this.entityRenderer.drawShadow(a,b[c]),this.drawEntityHandler(a,b[c]);a.restore()},d.lookAt=function(a,b){this.camera.x=-this.width/this.scaleX/2+a,this.camera.y=-this.height/this.scaleY/2+b-64},d.resize=function(a,c){var d=b.pixelRatio,e=b.pixelRatioY||d;this.width=a*d,this.height=c*e,this.zoom(this.camera.zoom)},d.zoom=function(a){var c=b.pixelRatio,d=b.pixelRatioY||c;this.camera.zoom=a,a=a*b.height/640,this.scaleX=c*a,this.scaleY=d*a,console.log("zoom",this.camera.zoom,"factor",a,"x,y:",this.scaleX,this.scaleY)};var e=function(a,b){return a.body.p.y>b.body.p.y?-1:b.body.p.y>a.body.p.y?1:0};d.drawEntity=function(){var a=b.SpriteSheets.monk,c=b.SpriteSheets.ninja,d=Math.PI,e=Math.round,f=function(a,b){var c=a.body.a,f=6,g=c+d/6,h,i,j;c===0&&(g-=.1);var k=(5-e(g*3/d))%6;while(k<0)k+=f;if(a.state==="walking"){var l=Math.sqrt(a.body.vx*a.body.vx+a.body.vy*a.body.vy);a.walkCount+=Math.max(.15,l/2500),h=b.getAnimation("walk_"+k),h?(i=Math.floor(a.walkCount)%4,k=h.frames[0]+i):console.error("no walk_"+k)}else if(a.state==="punching")h=b.getAnimation("punch_"+k),h?(j=a.attack.time/a.attack.pushDuration,i=Math.min(3,Math.floor(j*3)),k=h.frames[0]+i):console.error("no walk_"+k);else if(a.state==="hit"||a.state==="dead")h=b.getAnimation("fall"),h?(a.state==="dead"?i=3:a.isShadowClone?(j=(a.hitDuration-a.hitTime)/a.hitDuration,i=Math.min(3,Math.floor(j*2))):(j=(a.hitDuration-a.hitTime)/a.hitDuration,j<.33?i=-1:(j=(j-.33)*3/2,i=Math.min(3,Math.floor(j*3)))),k=i===-1?k:h.frames[0]+i):console.error("no fall");var m=b.getFrame(k);return m===null?(b.complete&&console.error("SpriteSheet null frame. Complete:",b.complete,k,"/",b.getNumFrames(),b.getAnimations()),null):m},g=b.SpriteSheets.lion.getFrame(0),h=b.SpriteSheets.cauldron.getFrame(0);return function(e,i){var j=i.body.p.x,k=-i.body.p.y-i.z,l,m;e.save();if(i instanceof b.Ninja)l=f(i,c),l&&(m=l.rect,e.drawImage(l.image,m.x,m.y,m.width,m.height,j-l.regX,k-l.regY,m.width,m.height));else if(i instanceof b.Puff){var n=c.getAnimation("puff");if(n){var o=n.frames[0]+Math.floor(4.9*(i.duration-i.time)/i.duration);l=c.getFrame(o),l&&(m=l.rect,e.drawImage(l.image,m.x,m.y,m.width,m.height,j-l.regX,k-l.regY,m.width,m.height))}else console.error("no puff")}else i instanceof b.Player?(l=f(i,a),l&&(m=l.rect,e.drawImage(l.image,m.x,m.y,m.width,m.height,j-l.regX,k-l.regY,m.width,m.height))):i instanceof b.EmptyHand||(i instanceof b.Box?(e.fillStyle="#888888",l=g||b.SpriteSheets.lion.getFrame(0),l&&(m=l.rect,e.drawImage(l.image,m.x,m.y,m.width,m.height,j-l.regX,k-l.regY,m.width,m.height))):i instanceof b.Circle?(e.fillStyle="#888888",l=h||b.SpriteSheets.cauldron.getFrame(0),l&&(m=l.rect,e.drawImage(l.image,m.x,m.y,m.width,m.height,j-l.regX,k-l.regY,m.width,m.height))):i.radius?(e.fillStyle="#ff8000",e.beginPath(),e.arc(j,k,i.radius,0,2*d,!1),e.fill()):i.width&&i.height?(e.fillStyle="#0008ff",e.beginPath(),e.fillRect(j-i.width/2,k-i.height/2,i.width,i.height)):(e.fillStyle="#000088",e.beginPath(),e.fillRect(j-32,k-32,64,64)));e.restore()}}}(window),function(a){"use strict";var b=a.ec,c=b.Canvas2dCreditsView=function(){this.creditsTime=-1,this.skipAfter=3500,this.overlay=new Image,this.overlay.src="img/ui/credits.png?v="+b.version},d=c.prototype;d.init=function(a){this.creditsTime=0,a.setTransform(1,0,0,1,0,0),a.fillStyle="#000",a.globalAlpha=.1},d.draw=function(a,b){a.fillRect(0,0,this.width,this.height),a.globalAlpha=Math.min(1,a.globalAlpha+.1),this.creditsTime+=b;var c=Math.floor(this.creditsTime*24/1e3)*4,d=this.overlay;if(d.height){var e=this.height/d.height,f=this.width-d.width*e,g=Math.max(-258*e,this.height-c);a.drawImage(d,f/2,g,d.width*e,d.height*e)}},d.resize=function(a,c){var d=b.pixelRatio,e=b.pixelRatioY||d;this.width=a*d,this.height=c*e}}(window),function(a){"use strict";var b=a.ec,c=b.Canvas2dView=function(){this.children=[];var c=this.canvas=a.document.createElement("canvas");c.style.position="absolute",this.context=c.getContext("2d"),this.resize(b.width,b.height),a.document.body.appendChild(this.canvas)},d=c.prototype;d.draw=function(a){var b=this.context,c=this.children;for(var d=0,e=c.length;d<e;d++)c[d].draw(b,a)},d.pause=function(){},d.resume=function(){},d.getDom=function(){return this.canvas},d.add=function(a){return this.children.indexOf(a)<0?(a.resize(this.width,this.height),this.children.push(a),a):(console.error("object already a child of world",a),null)},d.remove=function(a){var b=this.children.indexOf(a);return b>-1?(this.children.splice(b,1),a):(console.error("object not a child of world",a),null)},d.removeAll=function(){this.children.length=0},d.resize=function(a,c){var d=b.pixelRatio,e=b.pixelRatioY||d,f=this.canvas;this.width=a,this.height=c,f.width=a*d,f.height=c*e,f.style.width=this.width+"px",f.style.height=this.height+"px";var g=this.children;for(var h=0,i=g.length;h<i;h++)g[h].resize(a,c)},d.debugGui=function(a){var c=this,d=function(){var a=b.pixelRatio,d=b.pixelRatioY;b.resizeDisplay(),b.pixelRatio=a,b.pixelRatioY=d,c.resize()};a.addGui([{name:"view",remember:!0,target:c,props:[{name:"x",params:{min:-480,max:1600}},{name:"y",params:{min:-320,max:1600}},{name:"scale",onChange:function(a){c.zoom(a)},params:{step:.01,min:.25,max:4}}]},{name:"pixelRatio",target:b,props:[{name:"pixelRatio",params:{min:1,max:2,step:.5},onChange:d},{name:"pixelRatioY",params:{min:1,max:2,step:.5},onChange:d}]}])}}(window),function(a){"use strict";var b=a.ec,c={type:"circle",x:0,y:0,radius:50},d=b.ButtonOverlay=function(a){a=b.extend(a||{},c),b.extend(this,a),this.radiusSq=this.radius?this.radius*this.radius:0,this.touches=[],this.pressed=!1,this.vx=this.vy=0};d.viewWidth=1280,d.viewHeight=720;var e=d.prototype;e.containerWidth=d.viewWidth,e.containerHeight=d.viewHeight,e.hitTest=function(a,b,c,e){this.containerWidth=c,this.containerHeight=e;if(this.type==="circle"){var f=a*d.viewWidth/c-this.x,g=b*d.viewHeight/e-this.y;if(f*f+g*g<=this.radiusSq)return!0}else if(this.type==="rectangle"){if(a>this.left&&a<this.right&&b>this.top&&b<this.buttom)return!0}else console.error(this,"invalid type:",this.type);return!1},e.addTouch=function(a){this.touches.indexOf(a)<0&&this.touches.push(a)},e.removeTouch=function(a){var b=this.touches.indexOf(a);b>-1&&(this.touches.splice(b,1),this.vx=this.vy=0)},e.hasTouch=function(a){return this.touches.indexOf(a)>-1},e.updateTouch=function(a,b,c){var e=b*d.viewWidth/this.containerWidth-this.x,f=c*d.viewHeight/this.containerHeight-this.y,g=Math.sqrt(e*e+f*f);Math.abs(e)>Math.abs(e*100/g)&&(e=e*100/g),Math.abs(f)>Math.abs(f*100/g)&&(f=f*100/g),this.vx=e,this.vy=f},e.touchStart=function(a,b){this.addTouch(b),this.pressed=!0,this.updateTouch(b,a.clientX,a.clientY)},e.touchEnd=function(a,b){this.hasTouch(b)&&(this.removeTouch(b),this.pressed=!1)},e.draw=function(a,b,c){this.type==="circle"&&(a.beginPath(),a.fillStyle="#000000",a.globalAlpha=.05,a.arc(this.x*d.viewWidth/b,this.y*d.viewHeight/c,this.radius*d.viewWidth/b,0,2*Math.PI,!1),a.fill(),this.pressed&&(a.beginPath(),a.fillStyle="#000000",a.globalAlpha=.1,a.arc((this.x+this.vx)*d.viewWidth/b,(this.y+this.vy)*d.viewHeight/c,80*d.viewWidth/b,0,2*Math.PI,!1),a.fill()))}}(window),function(a){"use strict";var b=a.ec.TextField=function(b,c,d,e){this.ctx=b,this.text="",this.x=c||0,this.y=d||0,this.width=e||100,this.height=16;var f=this.ratio=a.ec.pixelRatio||1,g=this.canvas=document.createElement("canvas");g.width=this.width*f,g.height=this.height*f,this.context=g.getContext("2d"),this.context.textAlign="start",this.context.textBaseline="top",this.context.fillStyle="black",this.context.font="12px sans-serif",this.context.scale(f,f)};b.prototype.setText=function(a){this.text!==a&&(this.text=a,this.redraw()),this.draw()},b.prototype.setPos=function(a,b){this.x=a,this.y=b},b.prototype.redraw=function(){this.context.clearRect(0,0,this.width,this.height),this.context.fillText(this.text,0,0,this.width)},b.prototype.draw=function(){this.ctx.drawImage(this.canvas,this.x,this.y,this.width,this.height)}}(window),function(a){"use strict";var b=a.ec,c=b.Sound=function(){this.volume=0;if(b.webaudio)try{this.context=new(a.webkitAudioContext||a.AudioContext),this.volume=1,this.buffers={},this.sources={}}catch(c){console.error("Web Audio API not supported")}},d=c.prototype;d.playGameMusic=function(){this.context&&(this.playSound("audio/game.ogg?v="+b.version,"game"),this.sources.ending&&this.sources.ending.disconnect(0))},d.playEndingMusic=function(){this.context&&(this.playSound("audio/ending.ogg?v="+b.version,"ending"),this.sources.game&&this.sources.game.disconnect(0))},d.playSound=function(a,b){var c=this.buffers[b];if(c){var d=this.sources[b]=this.context.createBufferSource();d.buffer=c,d.loop=b==="game",d.connect(this.context.destination),d.noteOn(0)}else this.loadSound(a,b)},d.stop=function(){this.sources.game&&this.sources.game.disconnect(0),this.sources.ending&&this.sources.ending.disconnect(0)},d.loadSound=function(a,c){var d=this.context,e=new XMLHttpRequest;e.open("GET",a,!0),e.responseType="arraybuffer";var f=b.delegate(this,function(b){this.buffers[c]=b,this.playSound(a,c)});e.onload=function(){d.decodeAudioData(e.response,f,this.onError)},e.send()},d.onError=function(){console.error("Audio Error",arguments)}}(window),function(a){"use strict";var b=a.document,c=a.ec,d=a.cp,e=d.v,f=1<<31,g=~f,h=function(a,b){return a-=b,function(){return a+=b,a}},i=function(){var a=e(0,0);return function(b,c){return a.x=b,a.y=c,a}}(),j=c.ChipmunkDebugView=function(a){this.space=a;var g=this.canvas=b.createElement("canvas");g.style.position="absolute",this.ctx=g.getContext("2d"),this.resize(),this.orthoPos=e.mult(this.orthoSize,.5).add(i(50/this.scale,0)),this.mouse=e(0,0);var j=this.width-10,k=h(5,15),l=this.infoFields=[];for(var m=6;m-->0;)l.push(new c.TextField(this.ctx,5,k(),j));l[5].setPos(5,this.height-50);var n=this,o=this.canvas2point=function(a,b){return e(a/n.scale-n.orthoPos.x,n.orthoPos.y-b/n.scale)};this.point2canvas=function(a){return e((a.x+n.orthoPos.x)*n.scale,(n.orthoPos.y-a.y)*n.scale)},this.canvas.onmousemove=function(a){n.mouse=o(a.offsetX,a.offsetY);if(n.mouseDown&&!n.mouseJoint){var b=i(a.offsetX-n.mouseDown.x,a.offsetY-n.mouseDown.y).mult(1/n.scale);n.mouseDown.x=a.offsetX,n.mouseDown.y=a.offsetY,n.orthoPos.add(b)}};var p=this.mouseBody=new d.Body(Infinity,Infinity);this.canvas.onmousedown=function(b){var c=b.which===3;if(!c&&!n.mouseJoint){var g=o(b.offsetX,b.offsetY);n.mouseDown=e(b.offsetX,b.offsetY);var h=a.pointQueryFirst(g,f,d.NO_GROUP);if(h){var i=h.body;if(!i.isStatic()){var j=n.mouseJoint=new d.PivotJoint(p,i,e(0,0),i.world2Local(g));j.maxForce=5e4,j.errorBias=Math.pow(.85,60),a.addConstraint(j)}}}},this.canvas.onmouseup=function(b){var c=b.which===3;c||(n.mouseJoint&&(a.removeConstraint(n.mouseJoint),n.mouseJoint=null),n.mouseDown=null)},this.canvas.onmousewheel=function(a){var b=a.detail?a.detail*-1:(a.wheelDeltaY?a.wheelDeltaY:a.wheelDelta)/40;n.scale=Math.min(Math.max(.005,n.scale+b/(-999*n.scale+1e3)),1);var c=e.sub(n.orthoSize,i(n.width,n.height).mult(1/n.scale));n.orthoSize.sub(c),n.orthoPos.sub(c.mult(.5))}};j.prototype.show=function(){this.canvas.style.display="block",b.body.appendChild(this.canvas)},j.prototype.hide=function(){this.canvas.style.display="none",this.canvas.parentNode&&b.body.removeChild(this.canvas)},j.prototype.resize=function(a){a=a||.36;var b=this.ratio=c.pixelRatio||1;this.width=Math.max(160/b,Math.round(c.width*a)),this.height=Math.max(90/b,Math.round(c.height*a)),this.scale=this.width*a/c.width,this.orthoSize=e(this.width,this.height).mult(1/this.scale);var d=this.canvas;d.width=this.width*b,d.height=this.height*b,d.style.width=this.width+"px",d.style.height=this.height+"px",d.style.left=(c.width-this.width)/2+"px",d.style.top=c.height-this.height+"px",this.ctx.scale(b,b)},j.prototype.drawInfo=function(){var a=this.space,c=this.infoFields,d=0;this.ctx.textAlign="start",this.ctx.textBaseline="alphabetic",this.ctx.fillStyle="black",c[d++].setText(b.body.clientWidth+", "+b.body.clientHeight+" x "+this.ratio);var e=a.arbiters.length;this.maxArbiters=this.maxArbiters?Math.max(this.maxArbiters,e):e,c[d++].setText("Arbiters: "+e+" (Max: "+this.maxArbiters+")");var f=0;for(var g=0;g<e;g++)f+=a.arbiters[g].contacts.length;this.maxContacts=this.maxContacts?Math.max(this.maxContacts,f):f,c[d++].setText("Contact points: "+f+" (Max: "+this.maxContacts+")"),c[d++].setText("Mouse: "+this.mouse.x.toFixed(0)+", "+this.mouse.y.toFixed(0)),this.message&&c[5].setText(this.message)},j.prototype.draw=function(){var a=this.ctx,b=this;a.fillStyle="#ACF",a.fillRect(0,0,this.width,this.height),a.strokeStyle="black",this.ctx.lineCap="round",this.space.eachShape(function(c){a.fillStyle=c.style(),c.draw(a,b.scale,b.point2canvas)}),a.strokeStyle="red",a.lineWidth=2;var c=this.space.arbiters;for(var d=0;d<c.length;d++){var e=c[d].contacts;for(var f=0;f<e.length;f++){var g=this.point2canvas(e[f].p);a.beginPath(),a.moveTo(g.x-2,g.y-2),a.lineTo(g.x+2,g.y+2),a.stroke(),a.beginPath(),a.moveTo(g.x+2,g.y-2),a.lineTo(g.x-2,g.y+2),a.stroke()}}if(this.mouseJoint){a.beginPath();var h=this.point2canvas(this.mouseBody.p);a.arc(h.x,h.y,this.scale*5,0,2*Math.PI,!1),a.fill(),a.stroke()}this.space.eachConstraint(function(c){c.draw&&c.draw(a,b.scale,b.point2canvas)}),this.drawInfo()},j.prototype.step=function(){var a=e.lerp(this.mouseBody.p,this.mouse,.25);this.mouseBody.v=e.mult(e.sub(a,this.mouseBody.p),60),this.mouseBody.p=a,this.draw()};var k=function(a,b,c,d,e){d=c(d),a.beginPath(),a.arc(d.x,d.y,b*e,0,2*Math.PI,!1),a.fill(),a.stroke()},l=function(a,b,c,d){c=b(c),d=b(d),a.beginPath(),a.moveTo(c.x,c.y),a.lineTo(d.x,d.y),a.stroke()},m=[e(0,0),e(.2,0),e(.25,3),e(.3,-6),e(.35,6),e(.4,-6),e(.45,6),e(.5,-6),e(.55,6),e(.6,-6),e(.65,6),e(.7,-3),e(.75,6),e(.8,0),e(1,0)],n=function(a,b,c,d,f){d=c(d),f=c(f),a.beginPath(),a.moveTo(d.x,d.y);var g=e.sub(f,d),h=e.len(g),j=e.mult(g,1/h);for(var k=1;k<m.length;k++){var l=e.add(d,e.rotate(i(m[k].x*h,m[k].y*b),j));a.lineTo(l.x,l.y)}a.stroke()};d.PolyShape.prototype.draw=function(a,b,c){a.beginPath();var d=this.tVerts,e=d.length,f=c(i(d[e-2],d[e-1]));a.moveTo(f.x,f.y);for(var g=0;g<e;g+=2){var h=c(i(d[g],d[g+1]));a.lineTo(h.x,h.y)}a.fill(),a.stroke()},d.SegmentShape.prototype.draw=function(a,b,c){var d=a.lineWidth;a.lineWidth=Math.max(1,this.r*b*2),l(a,c,this.ta,this.tb),a.lineWidth=d},d.CircleShape.prototype.draw=function(a,b,c){k(a,b,c,this.tc,this.r),l(a,c,this.tc,e.mult(this.body.rot,this.r).add(this.tc))},d.PinJoint.prototype.draw=function(a,b,c){var d=this.a.local2World(this.anchr1),e=this.b.local2World(this.anchr2);a.lineWidth=2,a.strokeStyle="grey",l(a,c,d,e)},d.SlideJoint.prototype.draw=function(a,b,c){var d=this.a.local2World(this.anchr1),f=this.b.local2World(this.anchr2),g=e.add(d,e.clamp(e.sub(f,d),this.min));a.lineWidth=2,a.strokeStyle="grey",l(a,c,d,f),a.strokeStyle="red",l(a,c,d,g)},d.PivotJoint.prototype.draw=function(a,b,c){var d=this.a.local2World(this.anchr1),e=this.b.local2World(this.anchr2);a.strokeStyle="grey",a.fillStyle="grey",k(a,b,c,d,2),k(a,b,c,e,2)},d.GrooveJoint.prototype.draw=function(a,b,c){var d=this.a.local2World(this.grv_a),e=this.a.local2World(this.grv_b),f=this.b.local2World(this.anchr2);a.strokeStyle="grey",l(a,c,d,e),k(a,b,c,f,3)},d.DampedSpring.prototype.draw=function(a,b,c){var d=this.a.local2World(this.anchr1),e=this.b.local2World(this.anchr2);a.strokeStyle="grey",n(a,b,c,d,e)};var o=function(){return Math.floor(Math.random()*256)},p=[];for(var q=0;q<100;q++)p.push("rgb("+o()+", "+o()+", "+o()+")");d.Shape.prototype.style=function(){var a;return this.sensor?"rgba(255,255,255,0)":(a=this.body,a.isSleeping()?"rgb(50,50,50)":a.nodeIdleTime>this.space.sleepTimeThreshold?"rgb(170,170,170)":p[this.hashid%p.length])}}(window),function(a){"use strict";var b=a.ec,c=a.Stats,d=a.dat,e=b.DebugView=function(){var a=this.stats=new c;a.domElement.style.position="absolute",a.domElement.style.left="0px",a.domElement.style.top="0px"};e.prototype.show=function(){this.stats.domElement.style.display="block",a.document.body.appendChild(this.stats.domElement)},e.prototype.hide=function(){this.stats.domElement.style.display="none",this.stats.domElement.parentNode&&a.document.body.appendChild(this.stats.domElement)},e.prototype.addGui=function(a){var b=new d.GUI,c=b;for(var e=0;e<a.length;e++){var f=a[e];f.remember&&b.remember(f.target),f.name&&(c=b.addFolder(f.name),c.open());for(var g=0;g<f.props.length;g++){var h=f.props[g],i=h,j=null,k;h.name&&(j=h.params,i=h.name),j?j.min!==undefined&&j.max!==undefined?k=c.add(f.target,i,j.min,j.max,j.step):j.step&&(k=c.add(f.target,i).step(j.step)):k=c.add(f.target,i,j),h.listen&&k.listen(),h.onChange&&k.onChange(h.onChange)}}return b},e.prototype.worldGui=function(a){this.addGui([{name:"space",remember:!0,target:a.space,props:[{name:"iterations",params:{min:1,max:40}},{name:"sleepTimeThreshold",params:{step:b.TIME_STEP,min:b.TIME_STEP,max:1}},{name:"collisionSlop",params:{step:.1,min:.1,max:1}},"damping",{name:"idleSpeedThreshold",listen:!0,params:{min:0,max:50}},{name:"collisionBias"},"enableContactGraph"]}]),this.addGui([{name:"gravity",target:a.space.gravity,props:[{name:"x",params:{step:10,min:-1e3,max:1e3}},{name:"y",params:{step:10,min:-1e3,max:1e3}}]}])}}(window),function(a){"use strict";var b=a.ec,c=[undefined,undefined,undefined,undefined];b.keyPressed={};var d,e=b.UserInput=function(c){d=this,this.index=c||0,this.gamepadTime=1;var e=this.buttons=[];for(var f=0;f<17;f++)e[f]=0;var g=this.axes=[];for(f=0;f<4;f++)g[f]=0;b.gamepads&&(b.bind(a,"MozGamepadConnected",this.onGamepadConnect,!1),b.bind(a,"MozGamepadDisconnected",this.onGamepadDisconnect,!1)),this.pollGamePad=navigator.webkitGetGamepads!==undefined?this.pollGamePadList:this.pollDummyGamePadList,this.keyboardAxes1=!1,this.keyboardAxes2=!1,this.overlays=[]},f=e.prototype;f.addButtonOverlay=function(a){var b=this.overlays.indexOf(a);return b<0?(this.overlays.push(a),a):(console.error("overlay already a child of input",a),null)},f.removeButtonOverlay=function(a){var c=this.overlays.indexOf(a);return c>-1?(this.overlays.splice(c,1),b.unbind(a,"touchstart",a.touchStart,!1),b.unbind(a,"touchend",a.touchEnd,!1),a):(console.error("overlay not a child of input",a),null)},f.draw=function(a,c){a.save();var d;for(var e=0,f=this.overlays.length;e<f;e++)d=this.overlays[e],d.draw(this.width,this.height);b.core.paused()?(a.fillStyle="#000000",a.globalAlpha=.33,a.fillRect(0,0,this.width,this.height),a.fillStyle="#ffffff",a.globalAlpha=.8,a.beginPath(),a.moveTo(this.width-15,35),a.lineTo(this.width-50,15),a.lineTo(this.width-50,55),a.fill()):b.touch&&(a.fillStyle="#ffffff",a.globalAlpha=.8,a.fillRect(this.width-43,15,10,40),a.fillRect(this.width-25,15,10,40)),d=b.core.getOverlay();if(d){var g=this.height/d.height,h=this.width-d.width*g,i=this.height-d.height*g;a.globalAlpha=1,a.drawImage(d,h/2,i/2,d.width*g,d.height*g)}a.restore()},f.resize=function(a,b){this.width=a,this.height=b},f.testOverlays=function(a,b,c){var d=this.width,e=this.height;for(var f=0,g=this.overlays.length;f<g;f++){var h=this.overlays[f];a==="touchend"&&(h===this.leftStickOverlay||h===this.rightStickOverlay)&&h["on"+a]!==undefined&&h["on"+a].apply(h,[b,c]);if(h.hitTest(b.clientX,b.clientY,d,e))return h["on"+a]!==undefined&&h["on"+a].apply(h,[b,c]),h}return null},f.setLeftStickOverlay=function(a){this.leftStickOverlay=a,b.bind(a,"touchstart",a.touchStart,!1),b.bind(a,"touchend",a.touchEnd,!1)},f.setRightStickOverlay=function(a){this.rightStickOverlay=a,b.bind(a,"touchstart",a.touchStart,!1),b.bind(a,"touchend",a.touchEnd,!1)},f.setAxes1=function(a,b){this.axes[0]=a,this.axes[1]=b},f.setAxes2=function(a,b){this.axes[2]=a,this.axes[3]=b},f.setButton=function(a,b){this.buttons[a]=b},f.mapButton=function(a,b){h[a]=b},f.poll=function(){this.leftStickOverlay&&!this.keyboardAxes1&&this.setAxes1(this.leftStickOverlay.vx/100,this.leftStickOverlay.vy/100),this.rightStickOverlay&&!this.keyboardAxes2&&this.setAxes2(this.rightStickOverlay.vx/100,this.rightStickOverlay.vy/100);var a=this.pollGamePad()[this.index];a&&this.gamepadTime!==a.timestamp&&(this.gamepadTime=a.timestamp||1,a.buttons[9]===1&&this.buttons[9]!==1&&b.core.togglePause(),a.buttons.join("")!==this.buttons.join("")&&console.log("gamepad button change",a.buttons.indexOf(1),this.buttons.indexOf(1),a.axes),this.buttons=a.buttons.slice(0),this.keyboardAxes1||this.setAxes1(a.axes[0],a.axes[1]),this.keyboardAxes2||this.setAxes2(a.axes[3],a.axes[4]))},f.touchstart=function(a){if(b.core.paused())return;for(var c=0,e=a.changedTouches.length;c<e;c++)d.testOverlays(a.type,a.changedTouches[c],a.changedTouches[c].identifier)},f.touchmove=function(a){for(var b=0,c=d.overlays.length;b<c;b++){var e=d.overlays[b];for(var f=0,g=a.changedTouches.length;f<g;f++)if(e.hasTouch(a.changedTouches[f].identifier)){e.updateTouch(a.changedTouches[f].identifier,a.changedTouches[f].clientX,a.changedTouches[f].clientY);break}}a.preventDefault()},f.touchend=function(a){if(b.core.paused()){b.core.resume();return}for(var c=0,e=a.changedTouches.length;c<e;c++)d.testOverlays(a.type,a.changedTouches[c],a.changedTouches[c].identifier)},f.mousedown=function(c){if(b.core.paused())return;d.testOverlays(c.type,c,-1)||(b.bind(b.core.getViewDom(),"mousemove",d.mouseRightStick,!1),b.bind(a,"mouseup",d.mouseRightStickEnd,!1),d.mouseRightStick(c))},f.mouseRightStick=function(a){var b=a.target.width/2,c=a.target.height/2+100,e=a.clientX-b,f=a.clientY-c,g=Math.sqrt(e*e+f*f);e/=g,f/=g,d.setAxes2(e,f)},f.mouseRightStickEnd=function(a){b.unbind(b.core.getViewDom(),"mousemove",d.mouseRightStick,!1),d.setAxes2(0,0)},f.mouseup=function(a){if(b.core.paused()){b.core.resume();return}d.testOverlays(a.type,a,-1)},f.keydown=function(a){var c=a.keyCode||a.which;b.keyPressed[c]=!0;switch(c){case g.RIGHT:case g.D:case g.LEFT:case g.A:case g.UP:case g.W:case g.DOWN:case g.S:d.updateAxes1FromKeys();break;case g.SPACE:case g.ENTER:d.setButton(h.SELECT,1);break;case g.BACKSLASH:d.setButton(h.CANCEL,1)}},f.keyup=function(a){var c=a.keyCode||a.which;b.keyPressed[c]=!1;switch(c){case g.RIGHT:case g.D:case g.LEFT:case g.A:case g.UP:case g.W:case g.DOWN:case g.S:d.updateAxes1FromKeys();break;case g.SPACE:case g.ENTER:d.setButton(h.SELECT,0);break;case g.BACKSLASH:d.setButton(h.CANCEL,0);break;case g.P:b.core.paused()?b.core.resume():b.core.pause();break;case g.O:b.core.cycleDebug();break;case g.F:case g.SLASH:b.core.fullscreen();break;default:console.log(String.fromCharCode(c),c)}},f.updateAxes1FromKeys=function(){var a=(b.keyPressed[g.LEFT]||b.keyPressed[g.A]?-1:0)+(b.keyPressed[g.RIGHT]||b.keyPressed[g.D]?1:0),c=(b.keyPressed[g.UP]||b.keyPressed[g.W]?-1:0)+(b.keyPressed[g.DOWN]||b.keyPressed[g.S]?1:0);this.keyboardAxes1=a||c,this.setAxes1(a,c)},f.pollDummyGamePadList=function(){return c},f.pollGamePadList=function(){return navigator.webkitGetGamepads()},f.onGamepadConnect=function(a){console.log("onGamepadConnect",a);if(a.gamepad.index===0){var b=a.gamepad;this.pollGamePad=function(){return b}}},f.onGamepadDisconnect=function(a){console.log("onGamepadDisconnect",a),a.gamepad.index===0&&(this.pollGamePad=this.pollDummyGamePadList)};var g={LEFT:37,UP:38,RIGHT:39,DOWN:40,ENTER:13,SHIFT:16,CTRL:17,ALT:18,SPACE:32,NUM0:48,NUM1:49,NUM2:50,NUM3:51,NUM4:52,NUM5:53,NUM6:54,NUM7:55,NUM8:56,NUM9:57,A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90,SLASH:191,BACKSLASH:220},h={SELECT:0,CANCEL:1}}(window),function(a){"use strict";var b=a.ec,c=a.cp,d=c.v,e=b.EnemyInput=function(){this.axes=[];for(var a=0;a<4;a++)this.axes[a]=0;this.goal=null},f=e.prototype;f.poll=function(a){if(this.state==="dead")return;var b=this.goal;if(!b||b.met)b=this.selectGoal(b,a);this.goal=b;var c=b.task;if(!c||c.complete)c=this.selectTask(b,a);c&&c.apply(this,arguments)},f.setAxes1=function(a,b){this.axes[0]=a,this.axes[1]=b},f.selectGoal=function(a,c){var d;return a===m.surround?c.isShadowClone?Math.random()>.5?d=m.throwStars:d=m.surround:d=m.shadowClone:a===m.shadowClone?d=m.throwStars:a===m.throwStars?Math.random()>.8?d=m.avoid:d=m.rush:d=m.surround,d.met=!1,d.task=null,b.debug&&!c.isShadowClone&&console.log("Enemy goal: ",d.name),d},f.selectTask=function(a,c){var d,e;return e=a.tasks.indexOf(a.task)+1,e>=a.tasks.length?(a.met=!0,null):(d=a.tasks[e],d.complete=!1,a.task=d,b.debug&&!c.isShadowClone&&console.log("Enemy task: ",e),d)};var g=7,h=36,i=250,j=4096,k=262144,l=function(a){return a.x*a.x+a.y*a.y};f.targetNearestEnemy=function(c){this.targetEntity=b.player,this.targetPos=this.targetEntity.body.p,this.goal.task.complete=!0},f.targetNearestEnemyBorder=function(b){this.targetNearestEnemy(b);var e=d.sub(b.body.p,this.targetPos),f;b.isShadowClone&&(f=d.rotate(e,d.forangle(Math.random()*Math.PI*2))),f=d.mult(e,i/d.len(e));var g=d.sub(c.vzero,e.sub(f));this.targetPos=d.add(b.body.p,g),b.speed=4,this.goal.task.complete=!0},f.scramble=function(b){this.targetPos=d(Math.random()*1e3-500,Math.random()*1e3-500),b.speed=6,this.goal.task.complete=!0},f.moveTo=function(b){if(!this.targetPos){this.goal.task.complete=!0;return}var c=d.sub(this.targetPos,b.body.p);if(l(c)<j){this.goal.task.complete=!0,this.targetPos=null,this.setAxes1(0,0),b.isShadowClone||(this.idleTick=220);return}c=d.mult(c,1/d.len(c)),this.setAxes1(c.x,-c.y)},f.moveAway=function(b){if(!this.targetPos){this.goal.task.complete=!0;return}var c=d.sub(b.body.p,this.targetPos);if(l(c)>k){this.goal.task.complete=!0,this.targetPos=null,this.setAxes1(0,0);return}c=d.mult(c,1/d.len(c)),this.setAxes1(c.x,-c.y)},f.shuv=function(b){b.speed=6,this.targetNearestEnemy(b),this.moveTo(b)},f.kageNoBunshin=function(c){if(c.isShadowClone){this.goal.task.complete=!0;return}if(b.world.entities.length>h){this.goal.task.complete=!0,this.goal.met=!0;return}this.turns=this.turns||0,this.turns+=.5,c.body.a+=.5,this.turns>11&&(this.turns=0,this.goal.task.complete=!0)},f.makeClones=function(c){this.clones=this.clones||0,++this.clones>g||b.world.entities.length>h?(this.clones=0,this.goal.task.complete=!0):c.shadowClone()},f.throwStar=function(b){this.throwTick=this.throwTick||0,this.throwTick++,this.throwTick>Math.random()*300&&(this.throwTick=0,this.goal.task.complete=!0)},f.idle=function(b){this.idleTick=this.idleTick||0,this.idleTick++,this.idleTick>40+200*Math.random()&&(this.idleTick=0,this.goal.task.complete=!0)};var m={surround:{name:"surround",tasks:[f.targetNearestEnemyBorder,f.moveTo,f.idle]},shadowClone:{name:"shadow clone",tasks:[f.kageNoBunshin,f.makeClones,f.scramble,f.moveTo]},throwStars:{name:"throw stars",tasks:[f.targetNearestEnemy,f.throwStar,f.scramble]},avoid:{name:"avoid",tasks:[f.targetNearestEnemy,f.moveAway,f.idle]},rush:{name:"rush",tasks:[f.targetNearestEnemy,f.moveTo,f.shuv]}}}(window);