(function(){Object.create=Object.create||function(t){function e(){}return e.prototype=t,new e};var t;"undefined"==typeof exports?(t={},"object"==typeof window&&(window.cp=t)):t=exports;var e,i,s=function(t,e){if(!t)throw Error("Assertion failed: "+e)},n=function(t,e){!t&&console&&console.warn&&(console.warn("ASSERTION FAILED: "+e),console.trace&&console.trace())},a=function(t,e){return e>t?t:e},o=function(t,e){return t>e?t:e};"object"==typeof window&&window.navigator.userAgent.indexOf("Firefox")>-1?(e=Math.min,i=Math.max):(e=a,i=o);var r=function(t,e){return e>t?t+" "+e:e+" "+t},h=function(t,e){for(var i=0;t.length>i;i++)if(t[i]===e)return t[i]=t[t.length-1],t.length--,void 0},l=function(t,e,i){var s=T(e,i),n=v(S(s,T(t,i))/F(s));return k(i,M(s,n))},c=function(t,e,i,s,n,a){var o=i-n,r=s-a,h=v(_(o,r,t-n,e-a)/O(o,r));return new x(n+o*h,a+r*h)};t.momentForCircle=function(t,e,i,s){return t*(.5*(e*e+i*i)+F(s))},t.areaForCircle=function(t,e){return Math.PI*Math.abs(t*t-e*e)},t.momentForSegment=function(t,e,i){var s=M(k(e,i),.5);return t*(V(i,e)/12+F(s))},t.areaForSegment=function(t,e,i){return i*(Math.PI*i+2*W(t,e))},t.momentForPoly=function(t,e,i){for(var s=0,n=0,a=e.length,o=0;a>o;o+=2){var r=e[o]+i.x,h=e[o+1]+i.y,l=e[(o+2)%a]+i.x,c=e[(o+3)%a]+i.y,u=I(l,c,r,h),d=_(r,h,r,h)+_(r,h,l,c)+_(l,c,l,c);s+=u*d,n+=u}return t*s/(6*n)},t.areaForPoly=function(t){for(var e=0,i=0,s=t.length;s>i;i+=2)e+=B(new x(t[i],t[i+1]),new x(t[(i+2)%s],t[(i+3)%s]));return-e/2};var u=t.centroidForPoly=function(t){for(var e=0,i=new x(0,0),s=0,n=t.length;n>s;s+=2){var a=new x(t[s],t[s+1]),o=new x(t[(s+2)%n],t[(s+3)%n]),r=B(a,o);e+=r,i=k(i,M(k(a,o),r))}return M(i,1/(3*e))};t.recenterPoly=function(t){for(var e=u(t),i=0;t.length>i;i+=2)t[i]-=e.x,t[i+1]-=e.y};var d=t.momentForBox=function(t,e,i){return t*(e*e+i*i)/12};t.momentForBox2=function(t,e){var i=e.r-e.l,s=e.t-e.b,n=M([e.l+e.r,e.b+e.t],.5);return d(t,i,s)+t*F(n)};var p=t.loopIndexes=function(t){var e,i,s,n,a=0,o=0;e=s=t[0],i=n=t[1];for(var r=t.length>>1,h=1;r>h;h++){var l=t[2*h],c=t[2*h+1];e>l||l==e&&i>c?(e=l,i=c,a=h):(l>s||l==s&&c>n)&&(s=l,n=c,o=h)}return[a,o]},m=function(t,e,i){var s=t[2*e];t[2*e]=t[2*i],t[2*i]=s,s=t[2*e+1],t[2*e+1]=t[2*i+1],t[2*i+1]=s},y=function(t,e,i,s,n,a){if(0===i)return 0;for(var o=0,r=e,h=T(n,s),l=a*C(h),c=e,u=e+i-1;u>=c;){var d=new x(t[2*c],t[2*c+1]),p=B(h,T(d,s));p>l?(p>o&&(o=p,r=c),c++):(m(t,c,u),u--)}return r!=e&&m(t,e,r),c-e},f=function(t,e,i,s,n,a,o,r){if(0>s)return 0;if(0==s)return e[2*r]=a.x,e[2*r+1]=a.y,1;var h=y(e,i,s,n,a,t),l=new x(e[2*i],e[2*i+1]),c=f(t,e,i+1,h-1,n,l,a,r),u=r+c++;e[2*u]=a.x,e[2*u+1]=a.y;var d=y(e,i+h,s-h,a,o,t),p=new x(e[2*(i+h)],e[2*(i+h)+1]);return c+f(t,e,i+h+1,d-1,a,p,o,r+c)};t.convexHull=function(t,e,i){if(e)for(var s=0;t.length>s;s++)e[s]=t[s];else e=t;var a=p(t),o=a[0],r=a[1];if(o==r)return e.length=2,e;m(e,0,o),m(e,1,0==r?o:r);var h=new x(e[0],e[1]),l=new x(e[2],e[3]),c=t.length>>1,u=f(i,e,2,c-2,h,l,h,1)+1;return e.length=2*u,n(se(e),"Internal error: cpConvexHull() and cpPolyValidate() did not agree.Please report this error with as much info as you can."),e};var g=function(t,s,n){return e(i(t,s),n)},v=function(t){return i(0,e(t,1))},b=0,x=t.Vect=function(t,e){this.x=t,this.y=e,b++};t.v=function(t,e){return new x(t,e)};var w=t.vzero=new x(0,0),S=t.v.dot=function(t,e){return t.x*e.x+t.y*e.y},_=function(t,e,i,s){return t*i+e*s},C=t.v.len=function(t){return Math.sqrt(S(t,t))},A=t.v.len2=function(t,e){return Math.sqrt(t*t+e*e)};t.v.eql=function(t,e){return t.x===e.x&&t.y===e.y};var k=t.v.add=function(t,e){return new x(t.x+e.x,t.y+e.y)};x.prototype.add=function(t){return this.x+=t.x,this.y+=t.y,this};var T=t.v.sub=function(t,e){return new x(t.x-e.x,t.y-e.y)};x.prototype.sub=function(t){return this.x-=t.x,this.y-=t.y,this};var P=t.v.neg=function(t){return new x(-t.x,-t.y)};x.prototype.neg=function(){return this.x=-this.x,this.y=-this.y,this};var M=t.v.mult=function(t,e){return new x(t.x*e,t.y*e)};x.prototype.mult=function(t){return this.x*=t,this.y*=t,this};var B=t.v.cross=function(t,e){return t.x*e.y-t.y*e.x},I=function(t,e,i,s){return t*s-e*i},E=t.v.perp=function(t){return new x(-t.y,t.x)};t.v.pvrperp=function(t){return new x(t.y,-t.x)};var j=t.v.project=function(t,e){return M(e,S(t,e)/F(e))};x.prototype.project=function(t){return this.mult(S(this,t)/F(t)),this};var D=t.v.rotate=function(t,e){return new x(t.x*e.x-t.y*e.y,t.x*e.y+t.y*e.x)};x.prototype.rotate=function(t){return this.x=this.x*t.x-this.y*t.y,this.y=this.x*t.y+this.y*t.x,this};var L=t.v.unrotate=function(t,e){return new x(t.x*e.x+t.y*e.y,t.y*e.x-t.x*e.y)},F=t.v.lengthsq=function(t){return S(t,t)},O=t.v.lengthsq2=function(t,e){return t*t+e*e},H=t.v.lerp=function(t,e,i){return k(M(t,1-i),M(e,i))},z=t.v.normalize=function(t){return M(t,1/C(t))},R=t.v.normalize_safe=function(t){return 0===t.x&&0===t.y?w:z(t)},N=t.v.clamp=function(t,e){return S(t,t)>e*e?M(z(t),e):t};t.v.lerpconst=function(t,e,i){return k(t,N(T(e,t),i))};var W=t.v.dist=function(t,e){return C(T(t,e))},V=t.v.distsq=function(t,e){return F(T(t,e))};t.v.near=function(t,e,i){return i*i>V(t,e)};var Y=t.v.slerp=function(t,e,i){var s=Math.acos(S(t,e));if(s){var n=1/Math.sin(s);return k(M(t,Math.sin((1-i)*s)*n),M(e,Math.sin(i*s)*n))}return t};t.v.slerpconst=function(t,i,s){var n=Math.acos(S(t,i));return Y(t,i,e(s,n)/n)},t.v.forangle=function(t){return new x(Math.cos(t),Math.sin(t))},t.v.toangle=function(t){return Math.atan2(t.y,t.x)},t.v.str=function(t){return"("+t.x.toFixed(3)+", "+t.y.toFixed(3)+")"};var q=0,Z=t.BB=function(t,e,i,s){this.l=t,this.b=e,this.r=i,this.t=s,q++};t.bb=function(t,e,i,s){return new Z(t,e,i,s)};var G=function(t,e){return new Z(t.x-e,t.y-e,t.x+e,t.y+e)},X=function(t,e,i,s,n){return s>=t.l&&t.r>=e&&n>=t.b&&t.t>=i},U=0;t.NO_GROUP=0;var Q=t.ALL_LAYERS=-1;t.resetShapeIdCounter=function(){U=0};var J=t.Shape=function(t){this.body=t,this.bb_l=this.bb_b=this.bb_r=this.bb_t=0,this.hashid=U++,this.sensor=!1,this.e=0,this.u=0,this.surface_v=w,this.collision_type=0,this.group=0,this.layers=Q,this.space=null,this.collisionCode=this.collisionCode};J.prototype.setElasticity=function(t){this.e=t},J.prototype.setFriction=function(t){this.body.activate(),this.u=t},J.prototype.setLayers=function(t){this.body.activate(),this.layers=t},J.prototype.setSensor=function(t){this.body.activate(),this.sensor=t},J.prototype.setCollisionType=function(t){this.body.activate(),this.collision_type=t},J.prototype.getBody=function(){return this.body},J.prototype.active=function(){return this.body&&-1!==this.body.shapeList.indexOf(this)},J.prototype.setBody=function(t){s(!this.active(),"You cannot change the body on an active shape. You must remove the shape from the space before changing the body."),this.body=t},J.prototype.cacheBB=function(){return this.update(this.body.p,this.body.rot)},J.prototype.update=function(t,e){s(!isNaN(e.x),"Rotation is NaN"),s(!isNaN(t.x),"Position is NaN"),this.cacheData(t,e)},J.prototype.pointQuery=function(t){var e=this.nearestPointQuery(t);return 0>e.d?e:void 0},J.prototype.getBB=function(){return new Z(this.bb_l,this.bb_b,this.bb_r,this.bb_t)};var K=function(t,e,i){this.shape=t,this.p=e,this.d=i},$=function(t,e,i){this.shape=t,this.t=e,this.n=i};$.prototype.hitPoint=function(t,e){return H(t,e,this.t)},$.prototype.hitDist=function(t,e){return W(t,e)*this.t};var te=t.CircleShape=function(t,e,i){this.c=this.tc=i,this.r=e,this.type="circle",J.call(this,t)};te.prototype=Object.create(J.prototype),te.prototype.cacheData=function(t,e){var i=this.tc=D(this.c,e).add(t),s=this.r;this.bb_l=i.x-s,this.bb_b=i.y-s,this.bb_r=i.x+s,this.bb_t=i.y+s},te.prototype.nearestPointQuery=function(t){var e=t.x-this.tc.x,i=t.y-this.tc.y,s=A(e,i),n=this.r,a=new x(this.tc.x+e*n/s,this.tc.y+i*n/s);return new K(this,a,s-n)};var ee=function(t,e,i,s,n){s=T(s,e),n=T(n,e);var a=S(s,s)-2*S(s,n)+S(n,n),o=-2*S(s,s)+2*S(s,n),r=S(s,s)-i*i,h=o*o-4*a*r;if(h>=0){var l=(-o-Math.sqrt(h))/(2*a);if(l>=0&&1>=l)return new $(t,l,z(H(s,n,l)))}};te.prototype.segmentQuery=function(t,e){return ee(this,this.tc,this.r,t,e)};var ie=t.SegmentShape=function(t,e,i,s){this.a=e,this.b=i,this.n=E(z(T(i,e))),this.ta=this.tb=this.tn=null,this.r=s,this.a_tangent=w,this.b_tangent=w,this.type="segment",J.call(this,t)};ie.prototype=Object.create(J.prototype),ie.prototype.cacheData=function(t,e){this.ta=k(t,D(this.a,e)),this.tb=k(t,D(this.b,e)),this.tn=D(this.n,e);var i,s,n,a;this.ta.x<this.tb.x?(i=this.ta.x,s=this.tb.x):(i=this.tb.x,s=this.ta.x),this.ta.y<this.tb.y?(n=this.ta.y,a=this.tb.y):(n=this.tb.y,a=this.ta.y);var o=this.r;this.bb_l=i-o,this.bb_b=n-o,this.bb_r=s+o,this.bb_t=a+o},ie.prototype.nearestPointQuery=function(t){var e=l(t,this.ta,this.tb),i=t.x-e.x,s=t.y-e.y,n=A(i,s),a=this.r,o=n?k(e,M(new x(i,s),a/n)):e;return new K(this,o,n-a)},ie.prototype.segmentQuery=function(t,e){var i=this.tn,s=S(T(this.ta,t),i),n=this.r,a=s>0?P(i):i,o=T(M(a,n),t),r=k(this.ta,o),h=k(this.tb,o),l=T(e,t);if(0>=B(l,r)*B(l,h)){var c=s+(s>0?-n:n),u=-c,d=S(l,i)-c;if(0>u*d)return new $(this,u/(u-d),a)}else if(0!==n){var p=ee(this,this.ta,this.r,t,e),m=ee(this,this.tb,this.r,t,e);return p?m&&m.t<p.t?m:p:m}},ie.prototype.setNeighbors=function(t,e){this.a_tangent=T(t,this.a),this.b_tangent=T(e,this.b)},ie.prototype.setEndpoints=function(t,e){this.a=t,this.b=e,this.n=E(z(T(e,t)))};var se=function(t){for(var e=t.length,i=0;e>i;i+=2){var s=t[i],n=t[i+1],a=t[(i+2)%e],o=t[(i+3)%e],r=t[(i+4)%e],h=t[(i+5)%e];if(I(a-s,o-n,r-a,h-o)>0)return!1}return!0},ne=t.PolyShape=function(t,e,i){this.setVerts(e,i),this.type="poly",J.call(this,t)};ne.prototype=Object.create(J.prototype);var ae=function(t,e){this.n=t,this.d=e};ae.prototype.compare=function(t){return S(this.n,t)-this.d},ne.prototype.setVerts=function(t,e){s(t.length>=4,"Polygons require some verts"),s("number"==typeof t[0],"Polygon verticies should be specified in a flattened list (eg [x1,y1,x2,y2,x3,y3,...])"),s(se(t),"Polygon is concave or has a reversed winding. Consider using cpConvexHull()");var i=t.length,n=i>>1;this.verts=Array(i),this.tVerts=Array(i),this.planes=Array(n),this.tPlanes=Array(n);for(var a=0;i>a;a+=2){var o=t[a]+e.x,r=t[a+1]+e.y,h=t[(a+2)%i]+e.x,l=t[(a+3)%i]+e.y,c=z(E(new x(h-o,l-r)));this.verts[a]=o,this.verts[a+1]=r,this.planes[a>>1]=new ae(c,_(c.x,c.y,o,r)),this.tPlanes[a>>1]=new ae(new x(0,0),0)}},t.BoxShape=function(t,e,i){var s=e/2,n=i/2;return oe(t,new Z(-s,-n,s,n))};var oe=t.BoxShape2=function(t,e){var i=[e.l,e.b,e.l,e.t,e.r,e.t,e.r,e.b];return new ne(t,i,w)};ne.prototype.transformVerts=function(t,s){for(var n=this.verts,a=this.tVerts,o=1/0,r=-1/0,h=1/0,l=-1/0,c=0;n.length>c;c+=2){var u=n[c],d=n[c+1],p=t.x+u*s.x-d*s.y,m=t.y+u*s.y+d*s.x;a[c]=p,a[c+1]=m,o=e(o,p),r=i(r,p),h=e(h,m),l=i(l,m)}this.bb_l=o,this.bb_b=h,this.bb_r=r,this.bb_t=l},ne.prototype.transformAxes=function(t,e){for(var i=this.planes,s=this.tPlanes,n=0;i.length>n;n++){var a=D(i[n].n,e);s[n].n=a,s[n].d=S(t,a)+i[n].d}},ne.prototype.cacheData=function(t,e){this.transformAxes(t,e),this.transformVerts(t,e)},ne.prototype.nearestPointQuery=function(t){for(var e=this.tPlanes,i=this.tVerts,s=i[i.length-2],n=i[i.length-1],a=1/0,o=w,r=!1,h=0;e.length>h;h++){e[h].compare(t)>0&&(r=!0);var l=i[2*h],u=i[2*h+1],d=c(t.x,t.y,s,n,l,u),p=W(t,d);a>p&&(a=p,o=d),s=l,n=u}return new K(this,o,r?a:-a)},ne.prototype.segmentQuery=function(t,e){for(var i=this.tPlanes,s=this.tVerts,n=i.length,a=2*n,o=0;n>o;o++){var r=i[o].n,h=S(t,r);if(!(i[o].d>h)){var l=S(e,r),c=(i[o].d-h)/(l-h);if(!(0>c||c>1)){var u=H(t,e,c),d=-B(r,u),p=-I(r.x,r.y,s[2*o],s[2*o+1]),m=-I(r.x,r.y,s[(2*o+2)%a],s[(2*o+3)%a]);if(d>=p&&m>=d)return new $(this,c,r)}}}},ne.prototype.valueOnAxis=function(t,i){for(var s=this.tVerts,n=_(t.x,t.y,s[0],s[1]),a=2;s.length>a;a+=2)n=e(n,_(t.x,t.y,s[a],s[a+1]));return n-i},ne.prototype.containsVert=function(t,e){for(var i=this.tPlanes,s=0;i.length>s;s++){var n=i[s].n,a=_(n.x,n.y,t,e)-i[s].d;if(a>0)return!1}return!0},ne.prototype.containsVertPartial=function(t,e,i){for(var s=this.tPlanes,n=0;s.length>n;n++){var a=s[n].n;if(!(0>S(a,i))){var o=_(a.x,a.y,t,e)-s[n].d;if(o>0)return!1}}return!0},ne.prototype.getNumVerts=function(){return this.verts.length/2},ne.prototype.getVert=function(t){return new x(this.verts[2*t],this.verts[2*t+1])};var re=t.Body=function(t,e){this.p=new x(0,0),this.vx=this.vy=0,this.f=new x(0,0),this.w=0,this.t=0,this.v_limit=1/0,this.w_limit=1/0,this.v_biasx=this.v_biasy=0,this.w_bias=0,this.space=null,this.shapeList=[],this.arbiterList=null,this.constraintList=null,this.nodeRoot=null,this.nodeNext=null,this.nodeIdleTime=0,this.setMass(t),this.setMoment(e),this.rot=new x(0,0),this.setAngle(0)};if("undefined"!=typeof DEBUG&&DEBUG){var he=function(t,e){s(t.x==t.x&&t.y==t.y,e)},le=function(t,e){s(1/0!==Math.abs(t.x)&&1/0!==Math.abs(t.y),e)},ce=function(t,e){he(t,e),le(t,e)};re.prototype.sanityCheck=function(){s(this.m===this.m&&this.m_inv===this.m_inv,"Body's mass is invalid."),s(this.i===this.i&&this.i_inv===this.i_inv,"Body's moment is invalid."),ce(this.p,"Body's position is invalid."),ce(this.f,"Body's force is invalid."),s(this.vx===this.vx&&1/0!==Math.abs(this.vx),"Body's velocity is invalid."),s(this.vy===this.vy&&1/0!==Math.abs(this.vy),"Body's velocity is invalid."),s(this.a===this.a&&1/0!==Math.abs(this.a),"Body's angle is invalid."),s(this.w===this.w&&1/0!==Math.abs(this.w),"Body's angular velocity is invalid."),s(this.t===this.t&&1/0!==Math.abs(this.t),"Body's torque is invalid."),ce(this.rot,"Body's rotation vector is invalid."),s(this.v_limit===this.v_limit,"Body's velocity limit is invalid."),s(this.w_limit===this.w_limit,"Body's angular velocity limit is invalid.")}}else re.prototype.sanityCheck=function(){};re.prototype.getPos=function(){return this.p},re.prototype.getVel=function(){return new x(this.vx,this.vy)},re.prototype.getAngVel=function(){return this.w},re.prototype.isSleeping=function(){return null!==this.nodeRoot},re.prototype.isStatic=function(){return 1/0===this.nodeIdleTime},re.prototype.isRogue=function(){return null===this.space},re.prototype.setMass=function(t){s(t>0,"Mass must be positive and non-zero."),this.activate(),this.m=t,this.m_inv=1/t},re.prototype.setMoment=function(t){s(t>0,"Moment of Inertia must be positive and non-zero."),this.activate(),this.i=t,this.i_inv=1/t},re.prototype.addShape=function(t){this.shapeList.push(t)},re.prototype.removeShape=function(t){h(this.shapeList,t)};var ue=function(t,e,i){return t===i?t.next(e):(t.a===e?t.next_a=ue(t.next_a,e,i):t.next_b=ue(t.next_b,e,i),t)};re.prototype.removeConstraint=function(t){this.constraintList=ue(this.constraintList,this,t)},re.prototype.setPos=function(e){this.activate(),this.sanityCheck(),e===w&&(e=t.v(0,0)),this.p=e},re.prototype.setVel=function(t){this.activate(),this.vx=t.x,this.vy=t.y},re.prototype.setAngVel=function(t){this.activate(),this.w=t},re.prototype.setAngleInternal=function(t){s(!isNaN(t),"Internal Error: Attempting to set body's angle to NaN"),this.a=t,this.rot.x=Math.cos(t),this.rot.y=Math.sin(t)},re.prototype.setAngle=function(t){this.activate(),this.sanityCheck(),this.setAngleInternal(t)},re.prototype.velocity_func=function(t,e,i){var s=this.vx*e+(t.x+this.f.x*this.m_inv)*i,n=this.vy*e+(t.y+this.f.y*this.m_inv)*i,a=this.v_limit,o=s*s+n*n,r=o>a*a?a/Math.sqrt(o):1;this.vx=s*r,this.vy=n*r;var h=this.w_limit;this.w=g(this.w*e+this.t*this.i_inv*i,-h,h),this.sanityCheck()},re.prototype.position_func=function(t){this.p.x+=(this.vx+this.v_biasx)*t,this.p.y+=(this.vy+this.v_biasy)*t,this.setAngleInternal(this.a+(this.w+this.w_bias)*t),this.v_biasx=this.v_biasy=0,this.w_bias=0,this.sanityCheck()},re.prototype.resetForces=function(){this.activate(),this.f=new x(0,0),this.t=0},re.prototype.applyForce=function(t,e){this.activate(),this.f=k(this.f,t),this.t+=B(e,t)},re.prototype.applyImpulse=function(t,e){this.activate(),pi(this,t.x,t.y,e)},re.prototype.getVelAtPoint=function(t){return k(new x(this.vx,this.vy),M(E(t),this.w))},re.prototype.getVelAtWorldPoint=function(t){return this.getVelAtPoint(T(t,this.p))},re.prototype.getVelAtLocalPoint=function(t){return this.getVelAtPoint(D(t,this.rot))},re.prototype.eachShape=function(t){for(var e=0,i=this.shapeList.length;i>e;e++)t(this.shapeList[e])},re.prototype.eachConstraint=function(t){for(var e=this.constraintList;e;){var i=e.next(this);t(e),e=i}},re.prototype.eachArbiter=function(t){for(var e=this.arbiterList;e;){var i=e.next(this);e.swappedColl=this===e.body_b,t(e),e=i}},re.prototype.local2World=function(t){return k(this.p,D(t,this.rot))},re.prototype.world2Local=function(t){return L(T(t,this.p),this.rot)},re.prototype.kineticEnergy=function(){var t=this.vx*this.vx+this.vy*this.vy,e=this.w*this.w;return(t?t*this.m:0)+(e?e*this.i:0)};var de=t.SpatialIndex=function(t){if(this.staticIndex=t,t){if(t.dynamicIndex)throw Error("This static index is already associated with a dynamic index.");t.dynamicIndex=this}};de.prototype.collideStatic=function(t,e){if(t.count>0){var i=t.query;this.each(function(t){i(t,new Z(t.bb_l,t.bb_b,t.bb_r,t.bb_t),e)})}};var pe=t.BBTree=function(t){de.call(this,t),this.velocityFunc=null,this.leaves={},this.count=0,this.root=null,this.pooledNodes=null,this.pooledPairs=null,this.stamp=0};pe.prototype=Object.create(de.prototype);var me=0,ye=function(t,s,n){this.obj=null,this.bb_l=e(s.bb_l,n.bb_l),this.bb_b=e(s.bb_b,n.bb_b),this.bb_r=i(s.bb_r,n.bb_r),this.bb_t=i(s.bb_t,n.bb_t),this.parent=null,this.setA(s),this.setB(n)};pe.prototype.makeNode=function(t,e){var i=this.pooledNodes;return i?(this.pooledNodes=i.parent,i.constructor(this,t,e),i):(me++,new ye(this,t,e))};var fe=0,ge=function(t,e){this.obj=e,t.getBB(e,this),this.parent=null,this.stamp=1,this.pairs=null,fe++};pe.prototype.getBB=function(t,s){var n=this.velocityFunc;if(n){var a=.1,o=(t.bb_r-t.bb_l)*a,r=(t.bb_t-t.bb_b)*a,h=M(n(t),.1);s.bb_l=t.bb_l+e(-o,h.x),s.bb_b=t.bb_b+e(-r,h.y),s.bb_r=t.bb_r+i(o,h.x),s.bb_t=t.bb_t+i(r,h.y)}else s.bb_l=t.bb_l,s.bb_b=t.bb_b,s.bb_r=t.bb_r,s.bb_t=t.bb_t},pe.prototype.getStamp=function(){var t=this.dynamicIndex;return t&&t.stamp?t.stamp:this.stamp},pe.prototype.incrementStamp=function(){this.dynamicIndex&&this.dynamicIndex.stamp?this.dynamicIndex.stamp++:this.stamp++};var ve=0,be=function(t,e,i,s){this.prevA=null,this.leafA=t,this.nextA=e,this.prevB=null,this.leafB=i,this.nextB=s};pe.prototype.makePair=function(t,e,i,s){var n=this.pooledPairs;return n?(this.pooledPairs=n.prevA,n.prevA=null,n.leafA=t,n.nextA=e,n.prevB=null,n.leafB=i,n.nextB=s,n):(ve++,new be(t,e,i,s))},be.prototype.recycle=function(t){this.prevA=t.pooledPairs,t.pooledPairs=this};var xe=function(t,e,i){i&&(i.leafA===e?i.prevA=t:i.prevB=t),t?t.leafA===e?t.nextA=i:t.nextB=i:e.pairs=i};ge.prototype.clearPairs=function(t){var e,i=this.pairs;for(this.pairs=null;i;)i.leafA===this?(e=i.nextA,xe(i.prevB,i.leafB,i.nextB)):(e=i.nextB,xe(i.prevA,i.leafA,i.nextA)),i.recycle(t),i=e};var we=function(t,e,i){var s=t.pairs,n=e.pairs,a=i.makePair(t,s,e,n);t.pairs=e.pairs=a,s&&(s.leafA===t?s.prevA=a:s.prevB=a),n&&(n.leafA===e?n.prevA=a:n.prevB=a)};ye.prototype.recycle=function(t){this.parent=t.pooledNodes,t.pooledNodes=this},ge.prototype.recycle=function(){},ye.prototype.setA=function(t){this.A=t,t.parent=this},ye.prototype.setB=function(t){this.B=t,t.parent=this},ge.prototype.isLeaf=!0,ye.prototype.isLeaf=!1,ye.prototype.otherChild=function(t){return this.A==t?this.B:this.A},ye.prototype.replaceChild=function(t,s,a){n(t==this.A||t==this.B,"Node is not a child of parent."),this.A==t?(this.A.recycle(a),this.setA(s)):(this.B.recycle(a),this.setB(s));for(var o=this;o;o=o.parent){var r=o.A,h=o.B;o.bb_l=e(r.bb_l,h.bb_l),o.bb_b=e(r.bb_b,h.bb_b),o.bb_r=i(r.bb_r,h.bb_r),o.bb_t=i(r.bb_t,h.bb_t)}},ye.prototype.bbArea=ge.prototype.bbArea=function(){return(this.bb_r-this.bb_l)*(this.bb_t-this.bb_b)};var Se=function(t,s){return(i(t.bb_r,s.bb_r)-e(t.bb_l,s.bb_l))*(i(t.bb_t,s.bb_t)-e(t.bb_b,s.bb_b))},_e=function(t,e){return Math.abs(t.bb_l+t.bb_r-e.bb_l-e.bb_r)+Math.abs(t.bb_b+t.bb_t-e.bb_b-e.bb_t)},Ce=function(t,s,n){if(null==t)return s;if(t.isLeaf)return n.makeNode(s,t);var a=t.B.bbArea()+Se(t.A,s),o=t.A.bbArea()+Se(t.B,s);return a===o&&(a=_e(t.A,s),o=_e(t.B,s)),a>o?t.setB(Ce(t.B,s,n)):t.setA(Ce(t.A,s,n)),t.bb_l=e(t.bb_l,s.bb_l),t.bb_b=e(t.bb_b,s.bb_b),t.bb_r=i(t.bb_r,s.bb_r),t.bb_t=i(t.bb_t,s.bb_t),t};ye.prototype.intersectsBB=ge.prototype.intersectsBB=function(t){return this.bb_l<=t.r&&t.l<=this.bb_r&&this.bb_b<=t.t&&t.b<=this.bb_t};var Ae=function(t,e,i){t.intersectsBB(e)&&(t.isLeaf?i(t.obj):(Ae(t.A,e,i),Ae(t.B,e,i)))},ke=function(t,s,n){var a=1/(n.x-s.x),o=t.bb_l==s.x?-1/0:(t.bb_l-s.x)*a,r=t.bb_r==s.x?1/0:(t.bb_r-s.x)*a,h=e(o,r),l=i(o,r),c=1/(n.y-s.y),u=t.bb_b==s.y?-1/0:(t.bb_b-s.y)*c,d=t.bb_t==s.y?1/0:(t.bb_t-s.y)*c,p=e(u,d),m=i(u,d);if(l>=p&&m>=h){var y=i(h,p),f=e(l,m);if(f>=0&&1>=y)return i(y,0)}return 1/0},Te=function(t,i,s,n,a){if(t.isLeaf)return a(t.obj);var o=ke(t.A,i,s),r=ke(t.B,i,s);return r>o?(n>o&&(n=e(n,Te(t.A,i,s,n,a))),n>r&&(n=e(n,Te(t.B,i,s,n,a)))):(n>r&&(n=e(n,Te(t.B,i,s,n,a))),n>o&&(n=e(n,Te(t.A,i,s,n,a)))),n};pe.prototype.subtreeRecycle=function(t){t.isLeaf&&(this.subtreeRecycle(t.A),this.subtreeRecycle(t.B),t.recycle(this))};var Pe=function(t,e,i){if(e==t)return null;var s=e.parent;if(s==t){var n=t.otherChild(e);return n.parent=t.parent,t.recycle(i),n}return s.parent.replaceChild(s,s.otherChild(e),i),t},Me=function(t,e){return t.bb_l<=e.bb_r&&e.bb_l<=t.bb_r&&t.bb_b<=e.bb_t&&e.bb_b<=t.bb_t};ge.prototype.markLeafQuery=function(t,e,i,s){Me(t,this)&&(e?we(t,this,i):(this.stamp<t.stamp&&we(this,t,i),s&&s(t.obj,this.obj)))},ye.prototype.markLeafQuery=function(t,e,i,s){Me(t,this)&&(this.A.markLeafQuery(t,e,i,s),this.B.markLeafQuery(t,e,i,s))},ge.prototype.markSubtree=function(t,e,i){if(this.stamp==t.getStamp()){e&&e.markLeafQuery(this,!1,t,i);for(var s=this;s.parent;s=s.parent)s==s.parent.A?s.parent.B.markLeafQuery(this,!0,t,i):s.parent.A.markLeafQuery(this,!1,t,i)}else for(var n=this.pairs;n;)this===n.leafB?(i&&i(n.leafA.obj,this.obj),n=n.nextB):n=n.nextA},ye.prototype.markSubtree=function(t,e,i){this.A.markSubtree(t,e,i),this.B.markSubtree(t,e,i)},ge.prototype.containsObj=function(t){return this.bb_l<=t.bb_l&&this.bb_r>=t.bb_r&&this.bb_b<=t.bb_b&&this.bb_t>=t.bb_t},ge.prototype.update=function(t){var e=t.root,i=this.obj;return this.containsObj(i)?!1:(t.getBB(this.obj,this),e=Pe(e,this,t),t.root=Ce(e,this,t),this.clearPairs(t),this.stamp=t.getStamp(),!0)},ge.prototype.addPairs=function(t){var e=t.dynamicIndex;if(e){var i=e.root;i&&i.markLeafQuery(this,!0,e,null)}else{var s=t.staticIndex.root;this.markSubtree(t,s,null)}},pe.prototype.insert=function(t,e){var i=new ge(this,t);this.leaves[e]=i,this.root=Ce(this.root,i,this),this.count++,i.stamp=this.getStamp(),i.addPairs(this),this.incrementStamp()},pe.prototype.remove=function(t,e){var i=this.leaves[e];delete this.leaves[e],this.root=Pe(this.root,i,this),this.count--,i.clearPairs(this),i.recycle(this)},pe.prototype.contains=function(t,e){return null!=this.leaves[e]};var Be=function(){};pe.prototype.reindexQuery=function(t){if(this.root){var e,i=this.leaves;for(e in i)i[e].update(this);var s=this.staticIndex,n=s&&s.root;this.root.markSubtree(this,n,t),s&&!n&&this.collideStatic(this,s,t),this.incrementStamp()}},pe.prototype.reindex=function(){this.reindexQuery(Be)},pe.prototype.reindexObject=function(t,e){var i=this.leaves[e];i&&(i.update(this)&&i.addPairs(this),this.incrementStamp())},pe.prototype.pointQuery=function(t,e){this.query(new Z(t.x,t.y,t.x,t.y),e)},pe.prototype.segmentQuery=function(t,e,i,s){this.root&&Te(this.root,t,e,i,s)},pe.prototype.query=function(t,e){this.root&&Ae(this.root,t,e)},pe.prototype.count=function(){return this.count},pe.prototype.each=function(t){var e;for(e in this.leaves)t(this.leaves[e].obj)};var Ie=function(t,s,n,a,o){return(i(t.bb_r,a)-e(t.bb_l,s))*(i(t.bb_t,o)-e(t.bb_b,n))},Ee=function(t,s,n,a){if(1==a)return s[n];if(2==a)return t.makeNode(s[n],s[n+1]);for(var o=s[n],r=o.bb_l,h=o.bb_b,l=o.bb_r,c=o.bb_t,u=n+a,d=n+1;u>d;d++)o=s[d],r=e(r,o.bb_l),h=e(h,o.bb_b),l=i(l,o.bb_r),c=i(c,o.bb_t);var p=l-r>c-h,m=Array(2*a);if(p)for(var d=n;u>d;d++)m[2*d+0]=s[d].bb_l,m[2*d+1]=s[d].bb_r;else for(var d=n;u>d;d++)m[2*d+0]=s[d].bb_b,m[2*d+1]=s[d].bb_t;m.sort(function(t,e){return t-e});var y=.5*(m[a-1]+m[a]),f=r,g=h,v=l,b=c,x=r,w=h,S=l,_=c;p?v=x=y:b=w=y;for(var C=u,A=n;C>A;){var o=s[A];Ie(o,x,w,S,_)<Ie(o,f,g,v,b)?(C--,s[A]=s[C],s[C]=o):A++}if(C==a){for(var o=null,d=n;u>d;d++)o=Ce(o,s[d],t);return o}return NodeNew(t,Ee(t,s,n,C-n),Ee(t,s,C,u-C))};pe.prototype.optimize=function(){var t=Array(this.count),e=0;for(var i in this.leaves)t[e++]=this.nodes[i];tree.subtreeRecycle(root),this.root=Ee(tree,t,t.length)};var je=function(t,e){!t.isLeaf&&10>=e&&(je(t.A,e+1),je(t.B,e+1));for(var i="",s=0;e>s;s++)i+=" ";console.log(i+t.bb_b+" "+t.bb_t)};pe.prototype.log=function(){this.root&&je(this.root,0)};var De=t.CollisionHandler=function(){this.a=this.b=0};De.prototype.begin=function(){return!0},De.prototype.preSolve=function(){return!0},De.prototype.postSolve=function(){},De.prototype.separate=function(){};var Le=function(t,e){this.e=0,this.u=0,this.surface_vr=w,this.a=t,this.body_a=t.body,this.b=e,this.body_b=e.body,this.thread_a_next=this.thread_a_prev=null,this.thread_b_next=this.thread_b_prev=null,this.contacts=null,this.stamp=0,this.handler=null,this.swappedColl=!1,this.state="first coll"};Le.prototype.getShapes=function(){return this.swappedColl?[this.b,this.a]:[this.a,this.b]},Le.prototype.totalImpulse=function(){for(var t=this.contacts,e=new x(0,0),i=0,s=t.length;s>i;i++){var n=t[i];e.add(M(n.n,n.jnAcc))}return this.swappedColl?e:e.neg()},Le.prototype.totalImpulseWithFriction=function(){for(var t=this.contacts,e=new x(0,0),i=0,s=t.length;s>i;i++){var n=t[i];e.add(new x(n.jnAcc,n.jtAcc).rotate(n.n))}return this.swappedColl?e:e.neg()},Le.prototype.totalKE=function(){for(var t=(1-this.e)/(1+this.e),e=0,i=this.contacts,s=0,n=i.length;n>s;s++){var a=i[s],o=a.jnAcc,r=a.jtAcc;e+=t*o*o/a.nMass+r*r/a.tMass}return e},Le.prototype.ignore=function(){this.state="ignore"},Le.prototype.getA=function(){return this.swappedColl?this.b:this.a},Le.prototype.getB=function(){return this.swappedColl?this.a:this.b},Le.prototype.isFirstContact=function(){return"first coll"===this.state};var Fe=function(t,e,i){this.point=t,this.normal=e,this.dist=i};Le.prototype.getContactPointSet=function(){var t,e=Array(this.contacts.length);for(t=0;e.length>t;t++)e[t]=new Fe(this.contacts[t].p,this.contacts[t].n,this.contacts[t].dist);return e},Le.prototype.getNormal=function(t){var e=this.contacts[t].n;return this.swappedColl?P(e):e},Le.prototype.getPoint=function(t){return this.contacts[t].p},Le.prototype.getDepth=function(t){return this.contacts[t].dist};var Oe=function(t,e,i,s){i?i.body_a===e?i.thread_a_next=s:i.thread_b_next=s:e.arbiterList=s,s&&(s.body_a===e?s.thread_a_prev=i:s.thread_b_prev=i)};Le.prototype.unthread=function(){Oe(this,this.body_a,this.thread_a_prev,this.thread_a_next),Oe(this,this.body_b,this.thread_b_prev,this.thread_b_next),this.thread_a_prev=this.thread_a_next=null,this.thread_b_prev=this.thread_b_next=null},Le.prototype.update=function(t,e,i,s){if(this.contacts)for(var n=0;this.contacts.length>n;n++)for(var a=this.contacts[n],o=0;t.length>o;o++){var r=t[o];r.hash===a.hash&&(r.jnAcc=a.jnAcc,r.jtAcc=a.jtAcc)}this.contacts=t,this.handler=e,this.swappedColl=i.collision_type!==e.a,this.e=i.e*s.e,this.u=i.u*s.u,this.surface_vr=T(i.surface_v,s.surface_v),this.a=i,this.body_a=i.body,this.b=s,this.body_b=s.body,"cached"==this.state&&(this.state="first coll")},Le.prototype.preStep=function(t,i,s){for(var n=this.body_a,a=this.body_b,o=0;this.contacts.length>o;o++){var r=this.contacts[o];r.r1=T(r.p,n.p),r.r2=T(r.p,a.p),r.nMass=1/gi(n,a,r.r1,r.r2,r.n),r.tMass=1/gi(n,a,r.r1,r.r2,E(r.n)),r.bias=-s*e(0,r.dist+i)/t,r.jBias=0,r.bounce=di(n,a,r.r1,r.r2,r.n)*this.e}},Le.prototype.applyCachedImpulse=function(t){if(!this.isFirstContact())for(var e=this.body_a,i=this.body_b,s=0;this.contacts.length>s;s++){var n=this.contacts[s],a=n.n.x,o=n.n.y,r=a*n.jnAcc-o*n.jtAcc,h=a*n.jtAcc+o*n.jnAcc;mi(e,i,n.r1,n.r2,r*t,h*t)}};var He=0,ze=0;Le.prototype.applyImpulse=function(){He++;for(var t=this.body_a,e=this.body_b,s=this.surface_vr,n=this.u,a=0;this.contacts.length>a;a++){ze++;var o=this.contacts[a],r=o.nMass,h=o.n,l=o.r1,c=o.r2,u=e.vx-c.y*e.w-(t.vx-l.y*t.w),d=e.vy+c.x*e.w-(t.vy+l.x*t.w),p=h.x*(e.v_biasx-c.y*e.w_bias-t.v_biasx+l.y*t.w_bias)+h.y*(c.x*e.w_bias+e.v_biasy-l.x*t.w_bias-t.v_biasy),m=_(u,d,h.x,h.y),y=_(u+s.x,d+s.y,-h.y,h.x),f=(o.bias-p)*r,v=o.jBias;o.jBias=i(v+f,0);var b=-(o.bounce+m)*r,x=o.jnAcc;o.jnAcc=i(x+b,0);var w=n*o.jnAcc,S=-y*o.tMass,C=o.jtAcc;o.jtAcc=g(C+S,-w,w);var A=h.x*(o.jBias-v),k=h.y*(o.jBias-v);yi(t,-A,-k,l),yi(e,A,k,c);var T=o.jnAcc-x,P=o.jtAcc-C;mi(t,e,l,c,h.x*T-h.y*P,h.x*P+h.y*T)}},Le.prototype.callSeparate=function(t){var e=t.lookupHandler(this.a.collision_type,this.b.collision_type);e.separate(this,t)},Le.prototype.next=function(t){return this.body_a==t?this.thread_a_next:this.thread_b_next};var Re=0,Ne=function(t,e,i,s){this.p=t,this.n=e,this.dist=i,this.r1=this.r2=w,this.nMass=this.tMass=this.bounce=this.bias=0,this.jnAcc=this.jtAcc=this.jBias=0,this.hash=s,Re++},We=[],Ve=function(t,e,i,s){var n=i+s,a=T(e,t),o=F(a);if(!(o>=n*n)){var r=Math.sqrt(o);return new Ne(k(t,M(a,.5+(i-.5*n)/(r?r:1/0))),r?M(a,1/r):new x(1,0),r-n,0)}},Ye=function(t,e){var i=Ve(t.tc,e.tc,t.r,e.r);return i?[i]:We},qe=function(t,e){var i=e.ta,s=e.tb,n=t.tc,a=T(s,i),o=v(S(a,T(n,i))/F(a)),r=k(i,M(a,o)),h=Ve(n,r,t.r,e.r);if(h){var l=h.n;return 0===o&&0>S(l,e.a_tangent)||1===o&&0>S(l,e.b_tangent)?We:[h]}return We},Ze=0,Ge=function(t,e){var i=0,s=t.valueOnAxis(e[0].n,e[0].d);if(s>0)return-1;for(var n=1;e.length>n;n++){var a=t.valueOnAxis(e[n].n,e[n].d);if(a>0)return-1;a>s&&(s=a,i=n)}return Ze=s,i},Xe=function(t,e,i,s){for(var n=[],a=t.tVerts,o=0;a.length>o;o+=2){var h=a[o],l=a[o+1];e.containsVertPartial(h,l,P(i))&&n.push(new Ne(new x(h,l),i,s,r(t.hashid,o)))}for(var c=e.tVerts,o=0;c.length>o;o+=2){var h=c[o],l=c[o+1];t.containsVertPartial(h,l,i)&&n.push(new Ne(new x(h,l),i,s,r(e.hashid,o)))}return n},Ue=function(t,e,i,s){for(var n=[],a=t.tVerts,o=0;a.length>o;o+=2){var h=a[o],l=a[o+1];e.containsVert(h,l)&&n.push(new Ne(new x(h,l),i,s,r(t.hashid,o>>1)))}for(var c=e.tVerts,o=0;c.length>o;o+=2){var h=c[o],l=c[o+1];t.containsVert(h,l)&&n.push(new Ne(new x(h,l),i,s,r(e.hashid,o>>1)))}return n.length?n:Xe(t,e,i,s)},Qe=function(t,e){var i=Ge(e,t.tPlanes);if(-1==i)return We;var s=Ze,n=Ge(t,e.tPlanes);if(-1==n)return We;var a=Ze;return s>a?Ue(t,e,t.tPlanes[i].n,s):Ue(t,e,P(e.tPlanes[n].n),a)},Je=function(t,i,s){var n=S(i,t.ta)-t.r,a=S(i,t.tb)-t.r;return e(n,a)-s},Ke=function(t,e,i,s,n){for(var a=B(e.tn,e.ta),o=B(e.tn,e.tb),h=M(e.tn,n),l=i.tVerts,c=0;l.length>c;c+=2){var u=l[c],d=l[c+1];if(_(u,d,h.x,h.y)<S(e.tn,e.ta)*n+e.r){var p=I(e.tn.x,e.tn.y,u,d);a>=p&&p>=o&&t.push(new Ne(new x(u,d),h,s,r(i.hashid,c)))}}},$e=function(t,e){var i=[],s=e.tPlanes,n=s.length,a=S(t.tn,t.ta),o=e.valueOnAxis(t.tn,a)-t.r,h=e.valueOnAxis(P(t.tn),-a)-t.r;if(h>0||o>0)return We;var l=0,c=Je(t,s[0].n,s[0].d);if(c>0)return We;for(var u=0;n>u;u++){var d=Je(t,s[u].n,s[u].d);if(d>0)return We;d>c&&(c=d,l=u)}var p=P(s[l].n),m=k(t.ta,M(p,t.r)),y=k(t.tb,M(p,t.r));if(e.containsVert(m.x,m.y)&&i.push(new Ne(m,p,c,r(t.hashid,0))),e.containsVert(y.x,y.y)&&i.push(new Ne(y,p,c,r(t.hashid,1))),(o>=c||h>=c)&&(o>h?Ke(i,t,e,o,1):Ke(i,t,e,h,-1)),0===i.length){var f,g=2*l,v=e.tVerts,b=new x(v[g],v[g+1]);if(f=Ve(t.ta,b,t.r,0,i))return[f];if(f=Ve(t.tb,b,t.r,0,i))return[f];var w=2*n,_=new x(v[(g+2)%w],v[(g+3)%w]);if(f=Ve(t.ta,_,t.r,0,i))return[f];if(f=Ve(t.tb,_,t.r,0,i))return[f]}return i},ti=function(t,e){for(var i=e.tPlanes,s=0,n=S(i[0].n,t.tc)-i[0].d-t.r,a=0;i.length>a;a++){var o=S(i[a].n,t.tc)-i[a].d-t.r;if(o>0)return We;o>n&&(n=o,s=a)}var r=i[s].n,h=e.tVerts,l=h.length,c=s<<1,u=h[c],d=h[c+1],p=h[(c+2)%l],m=h[(c+3)%l],y=I(r.x,r.y,u,d),f=I(r.x,r.y,p,m),g=B(r,t.tc);if(f>g){var v=Ve(t.tc,new x(p,m),t.r,0,v);return v?[v]:We}if(y>g)return[new Ne(T(t.tc,M(r,t.r+n/2)),P(r),n,0)];var v=Ve(t.tc,new x(u,d),t.r,0,v);
return v?[v]:We};te.prototype.collisionCode=0,ie.prototype.collisionCode=1,ne.prototype.collisionCode=2,te.prototype.collisionTable=[Ye,qe,ti],ie.prototype.collisionTable=[null,function(){return We},$e],ne.prototype.collisionTable=[null,null,Qe];var ei=t.collideShapes=function(t,e){return s(t.collisionCode<=e.collisionCode,"Collided shapes must be sorted by type"),t.collisionTable[e.collisionCode](t,e)},ii=new De,si=t.Space=function(){this.stamp=0,this.curr_dt=0,this.bodies=[],this.rousedBodies=[],this.sleepingComponents=[],this.staticShapes=new pe(null),this.activeShapes=new pe(this.staticShapes),this.arbiters=[],this.contactBuffersHead=null,this.cachedArbiters={},this.constraints=[],this.locked=0,this.collisionHandlers={},this.defaultHandler=ii,this.postStepCallbacks=[],this.iterations=10,this.gravity=w,this.damping=1,this.idleSpeedThreshold=0,this.sleepTimeThreshold=1/0,this.collisionSlop=.1,this.collisionBias=Math.pow(.9,60),this.collisionPersistence=3,this.enableContactGraph=!1,this.staticBody=new re(1/0,1/0),this.staticBody.nodeIdleTime=1/0,this.collideShapes=this.makeCollideShapes()};si.prototype.getCurrentTimeStep=function(){return this.curr_dt},si.prototype.setIterations=function(t){this.iterations=t},si.prototype.isLocked=function(){return this.locked};var ni=function(t){s(!t.locked,"This addition/removal cannot be done safely during a call to cpSpaceStep()  or during a query. Put these calls into a post-step callback.")};si.prototype.addCollisionHandler=function(t,e,i,s,n,a){ni(this),this.removeCollisionHandler(t,e);var o=new De;o.a=t,o.b=e,i&&(o.begin=i),s&&(o.preSolve=s),n&&(o.postSolve=n),a&&(o.separate=a),this.collisionHandlers[r(t,e)]=o},si.prototype.removeCollisionHandler=function(t,e){ni(this),delete this.collisionHandlers[r(t,e)]},si.prototype.setDefaultCollisionHandler=function(t,e,i,s){ni(this);var n=new De;t&&(n.begin=t),e&&(n.preSolve=e),i&&(n.postSolve=i),s&&(n.separate=s),this.defaultHandler=n},si.prototype.lookupHandler=function(t,e){return this.collisionHandlers[r(t,e)]||this.defaultHandler},si.prototype.addShape=function(t){var e=t.body;return e.isStatic()?this.addStaticShape(t):(s(!t.space,"This shape is already added to a space and cannot be added to another."),ni(this),e.activate(),e.addShape(t),t.update(e.p,e.rot),this.activeShapes.insert(t,t.hashid),t.space=this,t)},si.prototype.addStaticShape=function(t){s(!t.space,"This shape is already added to a space and cannot be added to another."),ni(this);var e=t.body;return e.addShape(t),t.update(e.p,e.rot),this.staticShapes.insert(t,t.hashid),t.space=this,t},si.prototype.addBody=function(t){return s(!t.isStatic(),"Static bodies cannot be added to a space as they are not meant to be simulated."),s(!t.space,"This body is already added to a space and cannot be added to another."),ni(this),this.bodies.push(t),t.space=this,t},si.prototype.addConstraint=function(t){s(!t.space,"This shape is already added to a space and cannot be added to another."),ni(this);var e=t.a,i=t.b;return e.activate(),i.activate(),this.constraints.push(t),t.next_a=e.constraintList,e.constraintList=t,t.next_b=i.constraintList,i.constraintList=t,t.space=this,t},si.prototype.filterArbiters=function(t,e){for(var i in this.cachedArbiters){var s=this.cachedArbiters[i];(t===s.body_a&&(e===s.a||null===e)||t===s.body_b&&(e===s.b||null===e))&&(e&&"cached"!==s.state&&s.callSeparate(this),s.unthread(),h(this.arbiters,s),delete this.cachedArbiters[i])}},si.prototype.removeShape=function(t){var e=t.body;e.isStatic()?this.removeStaticShape(t):(s(this.containsShape(t),"Cannot remove a shape that was not added to the space. (Removed twice maybe?)"),ni(this),e.activate(),e.removeShape(t),this.filterArbiters(e,t),this.activeShapes.remove(t,t.hashid),t.space=null)},si.prototype.removeStaticShape=function(t){s(this.containsShape(t),"Cannot remove a static or sleeping shape that was not added to the space. (Removed twice maybe?)"),ni(this);var e=t.body;e.isStatic()&&e.activateStatic(t),e.removeShape(t),this.filterArbiters(e,t),this.staticShapes.remove(t,t.hashid),t.space=null},si.prototype.removeBody=function(t){s(this.containsBody(t),"Cannot remove a body that was not added to the space. (Removed twice maybe?)"),ni(this),t.activate(),h(this.bodies,t),t.space=null},si.prototype.removeConstraint=function(t){s(this.containsConstraint(t),"Cannot remove a constraint that was not added to the space. (Removed twice maybe?)"),ni(this),t.a.activate(),t.b.activate(),h(this.constraints,t),t.a.removeConstraint(t),t.b.removeConstraint(t),t.space=null},si.prototype.containsShape=function(t){return t.space===this},si.prototype.containsBody=function(t){return t.space==this},si.prototype.containsConstraint=function(t){return t.space==this},si.prototype.uncacheArbiter=function(t){delete this.cachedArbiters[r(t.a.hashid,t.b.hashid)],h(this.arbiters,t)},si.prototype.eachBody=function(t){this.lock();for(var e=this.bodies,i=0;e.length>i;i++)t(e[i]);for(var s=this.sleepingComponents,i=0;s.length>i;i++)for(var n=s[i],a=n;a;){var o=a.nodeNext;t(a),a=o}this.unlock(!0)},si.prototype.eachShape=function(t){this.lock(),this.activeShapes.each(t),this.staticShapes.each(t),this.unlock(!0)},si.prototype.eachConstraint=function(t){this.lock();for(var e=this.constraints,i=0;e.length>i;i++)t(e[i]);this.unlock(!0)},si.prototype.reindexStatic=function(){s(!this.locked,"You cannot manually reindex objects while the space is locked. Wait until the current query or step is complete."),this.staticShapes.each(function(t){var e=t.body;t.update(e.p,e.rot)}),this.staticShapes.reindex()},si.prototype.reindexShape=function(t){s(!this.locked,"You cannot manually reindex objects while the space is locked. Wait until the current query or step is complete.");var e=t.body;t.update(e.p,e.rot),this.activeShapes.reindexObject(t,t.hashid),this.staticShapes.reindexObject(t,t.hashid)},si.prototype.reindexShapesForBody=function(t){for(var e=t.shapeList;e;e=e.next)this.reindexShape(e)},si.prototype.useSpatialHash=function(t,e){throw Error("Spatial Hash not yet implemented!")},si.prototype.activateBody=function(t){if(s(!t.isRogue(),"Internal error: Attempting to activate a rogue body."),this.locked)-1===this.rousedBodies.indexOf(t)&&this.rousedBodies.push(t);else{this.bodies.push(t);for(var e=0;t.shapeList.length>e;e++){var i=t.shapeList[e];this.staticShapes.remove(i,i.hashid),this.activeShapes.insert(i,i.hashid)}for(var n=t.arbiterList;n;n=n.next(t)){var a=n.body_a;if(t===a||a.isStatic()){var o=n.a,h=n.b;this.cachedArbiters[r(o.hashid,h.hashid)]=n,n.stamp=this.stamp,n.handler=this.lookupHandler(o.collision_type,h.collision_type),this.arbiters.push(n)}}for(var l=t.constraintList;l;l=l.nodeNext){var a=l.a;(t===a||a.isStatic())&&this.constraints.push(l)}}},si.prototype.deactivateBody=function(t){s(!t.isRogue(),"Internal error: Attempting to deactivate a rogue body."),h(this.bodies,t);for(var e=0;t.shapeList.length>e;e++){var i=t.shapeList[e];this.activeShapes.remove(i,i.hashid),this.staticShapes.insert(i,i.hashid)}for(var n=t.arbiterList;n;n=n.next(t)){var a=n.body_a;(t===a||a.isStatic())&&this.uncacheArbiter(n)}for(var o=t.constraintList;o;o=o.nodeNext){var a=o.a;(t===a||a.isStatic())&&h(this.constraints,o)}};var ai=function(t){return t?t.nodeRoot:null},oi=function(t){if(t&&t.isSleeping(t)){s(!t.isRogue(),"Internal Error: componentActivate() called on a rogue body.");for(var e=t.space,i=t;i;){var n=i.nodeNext;i.nodeIdleTime=0,i.nodeRoot=null,i.nodeNext=null,e.activateBody(i),i=n}h(e.sleepingComponents,t)}};re.prototype.activate=function(){this.isRogue()||(this.nodeIdleTime=0,oi(ai(this)))},re.prototype.activateStatic=function(t){s(this.isStatic(),"Body.activateStatic() called on a non-static body.");for(var e=this.arbiterList;e;e=e.next(this))t&&t!=e.a&&t!=e.b||(e.body_a==this?e.body_b:e.body_a).activate()},re.prototype.pushArbiter=function(t){n(null===(t.body_a===this?t.thread_a_next:t.thread_b_next),"Internal Error: Dangling contact graph pointers detected. (A)"),n(null===(t.body_a===this?t.thread_a_prev:t.thread_b_prev),"Internal Error: Dangling contact graph pointers detected. (B)");var e=this.arbiterList;n(null===e||null===(e.body_a===this?e.thread_a_prev:e.thread_b_prev),"Internal Error: Dangling contact graph pointers detected. (C)"),t.body_a===this?t.thread_a_next=e:t.thread_b_next=e,e&&(e.body_a===this?e.thread_a_prev=t:e.thread_b_prev=t),this.arbiterList=t};var ri=function(t,e){e.nodeRoot=t,e!==t&&(e.nodeNext=t.nodeNext,t.nodeNext=e)},hi=function(t,e){if(!e.isRogue()){var i=ai(e);if(null==i){ri(t,e);for(var s=e.arbiterList;s;s=s.next(e))hi(t,e==s.body_a?s.body_b:s.body_a);for(var a=e.constraintList;a;a=a.next(e))hi(t,e==a.a?a.b:a.a)}else n(i===t,"Internal Error: Inconsistency detected in the contact graph.")}},li=function(t,e){for(var i=t;i;i=i.nodeNext)if(e>i.nodeIdleTime)return!0;return!1};si.prototype.processComponents=function(t){for(var e=1/0!==this.sleepTimeThreshold,i=this.bodies,s=0;i.length>s;s++){var a=i[s];n(null===a.nodeNext,"Internal Error: Dangling next pointer detected in contact graph."),n(null===a.nodeRoot,"Internal Error: Dangling root pointer detected in contact graph.")}if(e)for(var o=this.idleSpeedThreshold,r=o?o*o:F(this.gravity)*t*t,s=0;i.length>s;s++){var a=i[s],h=r?a.m*r:0;a.nodeIdleTime=a.kineticEnergy()>h?0:a.nodeIdleTime+t}for(var l=this.arbiters,s=0,c=l.length;c>s;s++){var u=l[s],d=u.body_a,p=u.body_b;e&&((p.isRogue()&&!p.isStatic()||d.isSleeping())&&d.activate(),(d.isRogue()&&!d.isStatic()||p.isSleeping())&&p.activate()),d.pushArbiter(u),p.pushArbiter(u)}if(e){for(var m=this.constraints,s=0;m.length>s;s++){var y=m[s],d=y.a,p=y.b;p.isRogue()&&!p.isStatic()&&d.activate(),d.isRogue()&&!d.isStatic()&&p.activate()}for(var s=0;i.length>s;){var a=i[s];if(null!==ai(a)||(hi(a,a),li(a,this.sleepTimeThreshold)))s++,a.nodeRoot=null,a.nodeNext=null;else{this.sleepingComponents.push(a);for(var f=a;f;f=f.nodeNext)this.deactivateBody(f)}}}},re.prototype.sleep=function(){this.sleepWithGroup(null)},re.prototype.sleepWithGroup=function(t){s(!this.isStatic()&&!this.isRogue(),"Rogue and static bodies cannot be put to sleep.");var e=this.space;if(s(e,"Cannot put a rogue body to sleep."),s(!e.locked,"Bodies cannot be put to sleep during a query or a call to cpSpaceStep(). Put these calls into a post-step callback."),s(null===t||t.isSleeping(),"Cannot use a non-sleeping body as a group identifier."),this.isSleeping())return s(ai(this)===ai(t),"The body is already sleeping and it's group cannot be reassigned."),void 0;for(var i=0;this.shapeList.length>i;i++)this.shapeList[i].update(this.p,this.rot);if(e.deactivateBody(this),t){var n=ai(t);this.nodeRoot=n,this.nodeNext=n.nodeNext,this.nodeIdleTime=0,n.nodeNext=this}else this.nodeRoot=this,this.nodeNext=null,this.nodeIdleTime=0,e.sleepingComponents.push(this);h(e.bodies,this)},si.prototype.activateShapesTouchingShape=function(t){1/0!==this.sleepTimeThreshold&&this.shapeQuery(t,function(t){t.body.activate()})},si.prototype.pointQuery=function(t,e,i,s){var n=function(n){(!n.group||i!==n.group)&&e&n.layers&&n.pointQuery(t)&&s(n)},a=new Z(t.x,t.y,t.x,t.y);this.lock(),this.activeShapes.query(a,n),this.staticShapes.query(a,n),this.unlock(!0)},si.prototype.pointQueryFirst=function(t,e,i){var s=null;return this.pointQuery(t,e,i,function(t){t.sensor||(s=t)}),s},si.prototype.nearestPointQuery=function(t,e,i,s,n){var a=function(a){if((!a.group||s!==a.group)&&i&a.layers){var o=a.nearestPointQuery(t);e>o.d&&n(a,o.d,o.p)}},o=G(t,e);this.lock(),this.activeShapes.query(o,a),this.staticShapes.query(o,a),this.unlock(!0)},si.prototype.nearestPointQueryNearest=function(t,e,i,s){var n,a=function(a){if((!a.group||s!==a.group)&&i&a.layers&&!a.sensor){var o=a.nearestPointQuery(t);e>o.d&&(!n||o.d<n.d)&&(n=o)}},o=G(t,e);return this.activeShapes.query(o,a),this.staticShapes.query(o,a),n},si.prototype.segmentQuery=function(t,e,i,s,n){var a=function(a){var o;return(!a.group||s!==a.group)&&i&a.layers&&(o=a.segmentQuery(t,e))&&n(a,o.t,o.n),1};this.lock(),this.staticShapes.segmentQuery(t,e,1,a),this.activeShapes.segmentQuery(t,e,1,a),this.unlock(!0)},si.prototype.segmentQueryFirst=function(t,e,i,s){var n=null,a=function(a){var o;return(!a.group||s!==a.group)&&i&a.layers&&!a.sensor&&(o=a.segmentQuery(t,e))&&(null===n||o.t<n.t)&&(n=o),n?n.t:1};return this.staticShapes.segmentQuery(t,e,1,a),this.activeShapes.segmentQuery(t,e,n?n.t:1,a),n},si.prototype.bbQuery=function(t,e,i,s){var n=function(n){(!n.group||i!==n.group)&&e&n.layers&&X(t,n.bb_l,n.bb_b,n.bb_r,n.bb_t)&&s(n)};this.lock(),this.activeShapes.query(t,n),this.staticShapes.query(t,n),this.unlock(!0)},si.prototype.shapeQuery=function(t,e){var i=t.body;i&&t.update(i.p,i.rot);var s=new Z(t.bb_l,t.bb_b,t.bb_r,t.bb_t),n=!1,a=function(i){var s=t;if((!s.group||s.group!==i.group)&&s.layers&i.layers&&s!==i){var a;if(s.collisionCode<=i.collisionCode)a=ei(s,i);else{a=ei(i,s);for(var o=0;a.length>o;o++)a[o].n=P(a[o].n)}if(a.length&&(n=!(s.sensor||i.sensor),e)){for(var r=Array(a.length),o=0;a.length>o;o++)r[o]=new Fe(a[o].p,a[o].n,a[o].dist);e(i,r)}}};return this.lock(),this.activeShapes.query(s,a),this.staticShapes.query(s,a),this.unlock(!0),n},si.prototype.addPostStepCallback=function(t){n(this.locked,"Adding a post-step callback when the space is not locked is unnecessary. Post-step callbacks will not called until the end of the next call to cpSpaceStep() or the next query."),this.postStepCallbacks.push(t)},si.prototype.runPostStepCallbacks=function(){for(var t=0;this.postStepCallbacks.length>t;t++)this.postStepCallbacks[t]();this.postStepCallbacks=[]},si.prototype.lock=function(){this.locked++},si.prototype.unlock=function(t){if(this.locked--,s(this.locked>=0,"Internal Error: Space lock underflow."),0===this.locked&&t){for(var e=this.rousedBodies,i=0;e.length>i;i++)this.activateBody(e[i]);e.length=0,this.runPostStepCallbacks()}},si.prototype.makeCollideShapes=function(){var t=this;return function(e,i){var s=t;if(e.bb_l<=i.bb_r&&i.bb_l<=e.bb_r&&e.bb_b<=i.bb_t&&i.bb_b<=e.bb_t&&e.body!==i.body&&(!e.group||e.group!==i.group)&&e.layers&i.layers){var n=s.lookupHandler(e.collision_type,i.collision_type),a=e.sensor||i.sensor;if(!a||n!==ii){if(e.collisionCode>i.collisionCode){var o=e;e=i,i=o}var h=ei(e,i);if(0!==h.length){var l=r(e.hashid,i.hashid),c=s.cachedArbiters[l];c||(c=s.cachedArbiters[l]=new Le(e,i)),c.update(h,n,e,i),"first coll"!=c.state||n.begin(c,s)||c.ignore(),"ignore"!==c.state&&n.preSolve(c,s)&&!a?s.arbiters.push(c):(c.contacts=null,"ignore"!==c.state&&(c.state="normal")),c.stamp=s.stamp}}}}},si.prototype.arbiterSetFilter=function(t){var e=this.stamp-t.stamp,i=t.body_a,s=t.body_b;return(i.isStatic()||i.isSleeping())&&(s.isStatic()||s.isSleeping())?!0:(e>=1&&"cached"!=t.state&&(t.callSeparate(this),t.state="cached"),e>=this.collisionPersistence?(t.contacts=null,!1):!0)};var ci=function(t){var e=t.body;t.update(e.p,e.rot)};si.prototype.step=function(t){if(0!==t){s(0===w.x&&0===w.y,"vzero is invalid"),this.stamp++;var e=this.curr_dt;this.curr_dt=t;var i,n,a,o=this.bodies,r=this.constraints,h=this.arbiters;for(i=0;h.length>i;i++){var l=h[i];l.state="normal",l.body_a.isSleeping()||l.body_b.isSleeping()||l.unthread()}for(h.length=0,this.lock(),i=0;o.length>i;i++)o[i].position_func(t);this.activeShapes.each(ci),this.activeShapes.reindexQuery(this.collideShapes),this.unlock(!1),this.processComponents(t),this.lock();for(a in this.cachedArbiters)this.arbiterSetFilter(this.cachedArbiters[a])||delete this.cachedArbiters[a];var c=this.collisionSlop,u=1-Math.pow(this.collisionBias,t);for(i=0;h.length>i;i++)h[i].preStep(t,c,u);for(i=0;r.length>i;i++){var d=r[i];d.preSolve(this),d.preStep(t)}var p=Math.pow(this.damping,t),m=this.gravity;for(i=0;o.length>i;i++)o[i].velocity_func(m,p,t);var y=0===e?0:t/e;for(i=0;h.length>i;i++)h[i].applyCachedImpulse(y);for(i=0;r.length>i;i++)r[i].applyCachedImpulse(y);for(i=0;this.iterations>i;i++){for(n=0;h.length>n;n++)h[n].applyImpulse();for(n=0;r.length>n;n++)r[n].applyImpulse()}for(i=0;r.length>i;i++)r[i].postSolve(this);for(i=0;h.length>i;i++)h[i].handler.postSolve(h[i],this);this.unlock(!0)}};var ui=function(t,e,i,s){var n=t.vx+-i.y*t.w,a=t.vy+i.x*t.w,o=e.vx+-s.y*e.w,r=e.vy+s.x*e.w;return new x(o-n,r-a)},di=function(t,e,i,s,n){var a=t.vx+-i.y*t.w,o=t.vy+i.x*t.w,r=e.vx+-s.y*e.w,h=e.vy+s.x*e.w;return _(r-a,h-o,n.x,n.y)},pi=function(t,e,i,s){t.vx+=e*t.m_inv,t.vy+=i*t.m_inv,t.w+=t.i_inv*(s.x*i-s.y*e)},mi=function(t,e,i,s,n,a){pi(t,-n,-a,i),pi(e,n,a,s)},yi=function(t,e,i,s){t.v_biasx+=e*t.m_inv,t.v_biasy+=i*t.m_inv,t.w_bias+=t.i_inv*I(s.x,s.y,e,i)},fi=function(t,e,i){var s=B(e,i);return t.m_inv+t.i_inv*s*s},gi=function(t,e,i,s,a){var o=fi(t,i,a)+fi(e,s,a);return n(0!==o,"Unsolvable collision or constraint."),o},vi=function(t,e,i,s,a,o){var r,h,l,c,u=t.m_inv+e.m_inv;r=u,h=0,l=0,c=u;var d=t.i_inv,p=i.x*i.x*d,m=i.y*i.y*d,y=-i.x*i.y*d;r+=m,h+=y,l+=y,c+=p;var f=e.i_inv,g=s.x*s.x*f,v=s.y*s.y*f,b=-s.x*s.y*f;r+=v,h+=b,l+=b,c+=g;var x=r*c-h*l;n(0!==x,"Unsolvable constraint.");var w=1/x;a.x=c*w,a.y=-h*w,o.x=-l*w,o.y=r*w},bi=function(t,e,i){return new x(S(t,e),S(t,i))},xi=function(t,e){return 1-Math.pow(t,e)},wi=t.Constraint=function(t,e){this.a=t,this.b=e,this.space=null,this.next_a=null,this.next_b=null,this.maxForce=1/0,this.errorBias=Math.pow(.9,60),this.maxBias=1/0};wi.prototype.activateBodies=function(){this.a&&this.a.activate(),this.b&&this.b.activate()},wi.prototype.preStep=function(){},wi.prototype.applyCachedImpulse=function(){},wi.prototype.applyImpulse=function(){},wi.prototype.getImpulse=function(){return 0},wi.prototype.preSolve=function(){},wi.prototype.postSolve=function(){},wi.prototype.next=function(t){return this.a===t?this.next_a:this.next_b};var Si=t.PinJoint=function(t,e,i,s){wi.call(this,t,e),this.anchr1=i,this.anchr2=s;var a=t?k(t.p,D(i,t.rot)):i,o=e?k(e.p,D(s,e.rot)):s;this.dist=C(T(o,a)),n(this.dist>0,"You created a 0 length pin joint. A pivot joint will be much more stable."),this.r1=this.r2=null,this.n=null,this.nMass=0,this.jnAcc=this.jnMax=0,this.bias=0};Si.prototype=Object.create(wi.prototype),Si.prototype.preStep=function(t){var e=this.a,i=this.b;this.r1=D(this.anchr1,e.rot),this.r2=D(this.anchr2,i.rot);var s=T(k(i.p,this.r2),k(e.p,this.r1)),n=C(s);this.n=M(s,1/(n?n:1/0)),this.nMass=1/gi(e,i,this.r1,this.r2,this.n);var a=this.maxBias;this.bias=g(-xi(this.errorBias,t)*(n-this.dist)/t,-a,a),this.jnMax=this.maxForce*t},Si.prototype.applyCachedImpulse=function(t){var e=M(this.n,this.jnAcc*t);mi(this.a,this.b,this.r1,this.r2,e.x,e.y)},Si.prototype.applyImpulse=function(){var t=this.a,e=this.b,i=this.n,s=di(t,e,this.r1,this.r2,i),n=(this.bias-s)*this.nMass,a=this.jnAcc;this.jnAcc=g(a+n,-this.jnMax,this.jnMax),n=this.jnAcc-a,mi(t,e,this.r1,this.r2,i.x*n,i.y*n)},Si.prototype.getImpulse=function(){return Math.abs(this.jnAcc)};var _i=t.SlideJoint=function(t,e,i,s,n,a){wi.call(this,t,e),this.anchr1=i,this.anchr2=s,this.min=n,this.max=a,this.r1=this.r2=this.n=null,this.nMass=0,this.jnAcc=this.jnMax=0,this.bias=0};_i.prototype=Object.create(wi.prototype),_i.prototype.preStep=function(t){var e=this.a,i=this.b;this.r1=D(this.anchr1,e.rot),this.r2=D(this.anchr2,i.rot);var s=T(k(i.p,this.r2),k(e.p,this.r1)),n=C(s),a=0;n>this.max?(a=n-this.max,this.n=R(s)):this.min>n?(a=this.min-n,this.n=P(R(s))):(this.n=w,this.jnAcc=0),this.nMass=1/gi(e,i,this.r1,this.r2,this.n);var o=this.maxBias;this.bias=g(-xi(this.errorBias,t)*a/t,-o,o),this.jnMax=this.maxForce*t},_i.prototype.applyCachedImpulse=function(t){var e=this.jnAcc*t;mi(this.a,this.b,this.r1,this.r2,this.n.x*e,this.n.y*e)},_i.prototype.applyImpulse=function(){if(0!==this.n.x||0!==this.n.y){var t=this.a,e=this.b,i=this.n,s=this.r1,n=this.r2,a=ui(t,e,s,n),o=S(a,i),r=(this.bias-o)*this.nMass,h=this.jnAcc;this.jnAcc=g(h+r,-this.jnMax,0),r=this.jnAcc-h,mi(t,e,this.r1,this.r2,i.x*r,i.y*r)}},_i.prototype.getImpulse=function(){return Math.abs(this.jnAcc)};var Ci=t.PivotJoint=function(t,e,i,s){if(wi.call(this,t,e),s===void 0){var n=i;i=t?t.world2Local(n):n,s=e?e.world2Local(n):n}this.anchr1=i,this.anchr2=s,this.r1=this.r2=w,this.k1=new x(0,0),this.k2=new x(0,0),this.jAcc=w,this.jMaxLen=0,this.bias=w};Ci.prototype=Object.create(wi.prototype),Ci.prototype.preStep=function(t){var e=this.a,i=this.b;this.r1=D(this.anchr1,e.rot),this.r2=D(this.anchr2,i.rot),vi(e,i,this.r1,this.r2,this.k1,this.k2),this.jMaxLen=this.maxForce*t;var s=T(k(i.p,this.r2),k(e.p,this.r1));this.bias=N(M(s,-xi(this.errorBias,t)/t),this.maxBias)},Ci.prototype.applyCachedImpulse=function(t){mi(this.a,this.b,this.r1,this.r2,this.jAcc.x*t,this.jAcc.y*t)},Ci.prototype.applyImpulse=function(){var t=this.a,e=this.b,i=this.r1,s=this.r2,n=ui(t,e,i,s),a=bi(T(this.bias,n),this.k1,this.k2),o=this.jAcc;this.jAcc=N(k(this.jAcc,a),this.jMaxLen),mi(t,e,this.r1,this.r2,this.jAcc.x-o.x,this.jAcc.y-o.y)},Ci.prototype.getImpulse=function(){return C(this.jAcc)};var Ai=t.GrooveJoint=function(t,e,i,s,n){wi.call(this,t,e),this.grv_a=i,this.grv_b=s,this.grv_n=E(z(T(s,i))),this.anchr2=n,this.grv_tn=null,this.clamp=0,this.r1=this.r2=null,this.k1=new x(0,0),this.k2=new x(0,0),this.jAcc=w,this.jMaxLen=0,this.bias=null};Ai.prototype=Object.create(wi.prototype),Ai.prototype.preStep=function(t){var e=this.a,i=this.b,s=e.local2World(this.grv_a),n=e.local2World(this.grv_b),a=D(this.grv_n,e.rot),o=S(s,a);this.grv_tn=a,this.r2=D(this.anchr2,i.rot);var r=B(k(i.p,this.r2),a);B(s,a)>=r?(this.clamp=1,this.r1=T(s,e.p)):r>=B(n,a)?(this.clamp=-1,this.r1=T(n,e.p)):(this.clamp=0,this.r1=T(k(M(E(a),-r),M(a,o)),e.p)),vi(e,i,this.r1,this.r2,this.k1,this.k2),this.jMaxLen=this.maxForce*t;var h=T(k(i.p,this.r2),k(e.p,this.r1));this.bias=N(M(h,-xi(this.errorBias,t)/t),this.maxBias)},Ai.prototype.applyCachedImpulse=function(t){mi(this.a,this.b,this.r1,this.r2,this.jAcc.x*t,this.jAcc.y*t)},Ai.prototype.grooveConstrain=function(t){var e=this.grv_tn,i=this.clamp*B(t,e)>0?t:j(t,e);return N(i,this.jMaxLen)},Ai.prototype.applyImpulse=function(){var t=this.a,e=this.b,i=this.r1,s=this.r2,n=ui(t,e,i,s),a=bi(T(this.bias,n),this.k1,this.k2),o=this.jAcc;this.jAcc=this.grooveConstrain(k(o,a)),mi(t,e,this.r1,this.r2,this.jAcc.x-o.x,this.jAcc.y-o.y)},Ai.prototype.getImpulse=function(){return C(this.jAcc)},Ai.prototype.setGrooveA=function(t){this.grv_a=t,this.grv_n=E(z(T(this.grv_b,t))),this.activateBodies()},Ai.prototype.setGrooveB=function(t){this.grv_b=t,this.grv_n=E(z(T(t,this.grv_a))),this.activateBodies()};var ki=function(t,e){return(t.restLength-e)*t.stiffness},Ti=t.DampedSpring=function(t,e,i,s,n,a,o){wi.call(this,t,e),this.anchr1=i,this.anchr2=s,this.restLength=n,this.stiffness=a,this.damping=o,this.springForceFunc=ki,this.target_vrn=this.v_coef=0,this.r1=this.r2=null,this.nMass=0,this.n=null};Ti.prototype=Object.create(wi.prototype),Ti.prototype.preStep=function(t){var e=this.a,i=this.b;this.r1=D(this.anchr1,e.rot),this.r2=D(this.anchr2,i.rot);var s=T(k(i.p,this.r2),k(e.p,this.r1)),a=C(s);this.n=M(s,1/(a?a:1/0));var o=gi(e,i,this.r1,this.r2,this.n);n(0!==o,"Unsolvable this."),this.nMass=1/o,this.target_vrn=0,this.v_coef=1-Math.exp(-this.damping*t*o);var r=this.springForceFunc(this,a);mi(e,i,this.r1,this.r2,this.n.x*r*t,this.n.y*r*t)},Ti.prototype.applyCachedImpulse=function(){},Ti.prototype.applyImpulse=function(){var t=this.a,e=this.b,i=this.n,s=this.r1,n=this.r2,a=di(t,e,s,n,i),o=(this.target_vrn-a)*this.v_coef;this.target_vrn=a+o,o*=this.nMass,mi(t,e,this.r1,this.r2,this.n.x*o,this.n.y*o)},Ti.prototype.getImpulse=function(){return 0};var Pi=function(t,e){return(e-t.restAngle)*t.stiffness},Mi=t.DampedRotarySpring=function(t,e,i,s,n){wi.call(this,t,e),this.restAngle=i,this.stiffness=s,this.damping=n,this.springTorqueFunc=Pi,this.target_wrn=0,this.w_coef=0,this.iSum=0};Mi.prototype=Object.create(wi.prototype),Mi.prototype.preStep=function(t){var e=this.a,i=this.b,s=e.i_inv+i.i_inv;n(0!==s,"Unsolvable spring."),this.iSum=1/s,this.w_coef=1-Math.exp(-this.damping*t*s),this.target_wrn=0;var a=this.springTorqueFunc(this,e.a-i.a)*t;e.w-=a*e.i_inv,i.w+=a*i.i_inv},Mi.prototype.applyImpulse=function(){var t=this.a,e=this.b,i=t.w-e.w,s=(this.target_wrn-i)*this.w_coef;this.target_wrn=i+s;var n=s*this.iSum;t.w+=n*t.i_inv,e.w-=n*e.i_inv};var Bi=t.RotaryLimitJoint=function(t,e,i,s){wi.call(this,t,e),this.min=i,this.max=s,this.jAcc=0,this.iSum=this.bias=this.jMax=0};Bi.prototype=Object.create(wi.prototype),Bi.prototype.preStep=function(t){var e=this.a,i=this.b,s=i.a-e.a,n=0;s>this.max?n=this.max-s:this.min>s&&(n=this.min-s),this.iSum=1/(1/e.i+1/i.i);var a=this.maxBias;this.bias=g(-xi(this.errorBias,t)*n/t,-a,a),this.jMax=this.maxForce*t,this.bias||(this.jAcc=0)},Bi.prototype.applyCachedImpulse=function(t){var e=this.a,i=this.b,s=this.jAcc*t;e.w-=s*e.i_inv,i.w+=s*i.i_inv},Bi.prototype.applyImpulse=function(){if(this.bias){var t=this.a,e=this.b,i=e.w-t.w,s=-(this.bias+i)*this.iSum,n=this.jAcc;this.jAcc=0>this.bias?g(n+s,0,this.jMax):g(n+s,-this.jMax,0),s=this.jAcc-n,t.w-=s*t.i_inv,e.w+=s*e.i_inv}},Bi.prototype.getImpulse=function(){return Math.abs(joint.jAcc)};var Ii=t.RatchetJoint=function(t,e,i,s){wi.call(this,t,e),this.angle=0,this.phase=i,this.ratchet=s,this.angle=(e?e.a:0)-(t?t.a:0),this.iSum=this.bias=this.jAcc=this.jMax=0};Ii.prototype=Object.create(wi.prototype),Ii.prototype.preStep=function(t){var e=this.a,i=this.b,s=this.angle,n=this.phase,a=this.ratchet,o=i.a-e.a,r=s-o,h=0;r*a>0?h=r:this.angle=Math.floor((o-n)/a)*a+n,this.iSum=1/(e.i_inv+i.i_inv);var l=this.maxBias;this.bias=g(-xi(this.errorBias,t)*h/t,-l,l),this.jMax=this.maxForce*t,this.bias||(this.jAcc=0)},Ii.prototype.applyCachedImpulse=function(t){var e=this.a,i=this.b,s=this.jAcc*t;e.w-=s*e.i_inv,i.w+=s*i.i_inv},Ii.prototype.applyImpulse=function(){if(this.bias){var t=this.a,e=this.b,i=e.w-t.w,s=this.ratchet,n=-(this.bias+i)*this.iSum,a=this.jAcc;this.jAcc=g((a+n)*s,0,this.jMax*Math.abs(s))/s,n=this.jAcc-a,t.w-=n*t.i_inv,e.w+=n*e.i_inv}},Ii.prototype.getImpulse=function(t){return Math.abs(t.jAcc)};var Ei=t.GearJoint=function(t,e,i,s){wi.call(this,t,e),this.phase=i,this.ratio=s,this.ratio_inv=1/s,this.jAcc=0,this.iSum=this.bias=this.jMax=0};Ei.prototype=Object.create(wi.prototype),Ei.prototype.preStep=function(t){var e=this.a,i=this.b;this.iSum=1/(e.i_inv*this.ratio_inv+this.ratio*i.i_inv);var s=this.maxBias;this.bias=g(-xi(this.errorBias,t)*(i.a*this.ratio-e.a-this.phase)/t,-s,s),this.jMax=this.maxForce*t},Ei.prototype.applyCachedImpulse=function(t){var e=this.a,i=this.b,s=this.jAcc*t;e.w-=s*e.i_inv*this.ratio_inv,i.w+=s*i.i_inv},Ei.prototype.applyImpulse=function(){var t=this.a,e=this.b,i=e.w*this.ratio-t.w,s=(this.bias-i)*this.iSum,n=this.jAcc;this.jAcc=g(n+s,-this.jMax,this.jMax),s=this.jAcc-n,t.w-=s*t.i_inv*this.ratio_inv,e.w+=s*e.i_inv},Ei.prototype.getImpulse=function(){return Math.abs(this.jAcc)},Ei.prototype.setRatio=function(t){this.ratio=t,this.ratio_inv=1/t,this.activateBodies()};var ji=t.SimpleMotor=function(t,e,i){wi.call(this,t,e),this.rate=i,this.jAcc=0,this.iSum=this.jMax=0};ji.prototype=Object.create(wi.prototype),ji.prototype.preStep=function(t){this.iSum=1/(this.a.i_inv+this.b.i_inv),this.jMax=this.maxForce*t},ji.prototype.applyCachedImpulse=function(t){var e=this.a,i=this.b,s=this.jAcc*t;e.w-=s*e.i_inv,i.w+=s*i.i_inv},ji.prototype.applyImpulse=function(){var t=this.a,e=this.b,i=e.w-t.w+this.rate,s=-i*this.iSum,n=this.jAcc;this.jAcc=g(n+s,-this.jMax,this.jMax),s=this.jAcc-n,t.w-=s*t.i_inv,e.w+=s*e.i_inv},ji.prototype.getImpulse=function(){return Math.abs(this.jAcc)}})(),this.createjs=this.createjs||{},function(){var t=function(t){this.initialize(t)},e=t.prototype;e.complete=!0,e.onComplete=null,e._animations=null,e._frames=null,e._images=null,e._data=null,e._loadCount=0,e._frameHeight=0,e._frameWidth=0,e._numFrames=0,e._regX=0,e._regY=0,e.initialize=function(t){var e,i,s,n;if(null!=t){if(t.images&&(i=t.images.length)>0)for(n=this._images=[],e=0;i>e;e++){var a=t.images[e];if("string"==typeof a){var o=a;a=new Image,a.src=o}n.push(a),a.getContext||a.complete||(this._loadCount++,this.complete=!1,function(t){a.onload=function(){t._handleImageLoad()}}(this))}if(null==t.frames);else if(t.frames instanceof Array)for(this._frames=[],n=t.frames,e=0,i=n.length;i>e;e++){var r=n[e];this._frames.push({image:this._images[r[4]?r[4]:0],rect:new createjs.Rectangle(r[0],r[1],r[2],r[3]),regX:r[5]||0,regY:r[6]||0})}else s=t.frames,this._frameWidth=s.width,this._frameHeight=s.height,this._regX=s.regX||0,this._regY=s.regY||0,this._numFrames=s.count,0==this._loadCount&&this._calculateFrames();if(null!=(s=t.animations)){this._animations=[],this._data={};var h;for(h in s){var l={name:h},c=s[h];if(isNaN(c))if(c instanceof Array)for(l.frequency=c[3],l.next=c[2],n=l.frames=[],e=c[0];c[1]>=e;e++)n.push(e);else{l.frequency=c.frequency,l.next=c.next;var u=c.frames;n=l.frames=isNaN(u)?u.slice(0):[u]}else n=l.frames=[c];l.next=2>n.length||0==l.next?null:null==l.next||1==l.next?h:l.next,l.frequency||(l.frequency=1),this._animations.push(h),this._data[h]=l}}}},e.getNumFrames=function(t){if(null==t)return this._frames?this._frames.length:this._numFrames;var e=this._data[t];return null==e?0:e.frames.length},e.getAnimations=function(){return this._animations.slice(0)},e.getAnimation=function(t){return this._data[t]},e.getFrame=function(t){var e;return this.complete&&this._frames&&(e=this._frames[t])?e:null},e.toString=function(){return"[SpriteSheet]"},e.clone=function(){var e=new t;return e.complete=this.complete,e._animations=this._animations,e._frames=this._frames,e._images=this._images,e._data=this._data,e._frameHeight=this._frameHeight,e._frameWidth=this._frameWidth,e._numFrames=this._numFrames,e._loadCount=this._loadCount,e},e._handleImageLoad=function(){0==--this._loadCount&&(this._calculateFrames(),this.complete=!0,this.onComplete&&this.onComplete())},e._calculateFrames=function(){if(!this._frames&&0!=this._frameWidth){this._frames=[];for(var t=0,e=this._frameWidth,i=this._frameHeight,s=0,n=this._images;n.length>s;s++){for(var a=n[s],o=0|(a.width+1)/e,r=0|(a.height+1)/i,h=this._numFrames>0?Math.min(this._numFrames-t,o*r):o*r,l=0;h>l;l++)this._frames.push({image:a,rect:new createjs.Rectangle(l%o*e,(0|l/o)*i,e,i),regX:this._regX,regY:this._regY});t+=h}this._numFrames=t}},createjs.SpriteSheet=t}(),this.createjs=this.createjs||{},function(){var t=function(t,e,i,s){this.initialize(t,e,i,s)},e=t.prototype;e.x=0,e.y=0,e.width=0,e.height=0,e.initialize=function(t,e,i,s){this.x=null==t?0:t,this.y=null==e?0:e,this.width=null==i?0:i,this.height=null==s?0:s},e.clone=function(){return new t(this.x,this.y,this.width,this.height)},e.toString=function(){return"[Rectangle (x="+this.x+" y="+this.y+" width="+this.width+" height="+this.height+")]"},createjs.Rectangle=t}();var Stats=function(){var t=Date.now(),e=t,i=0,s=1/0,n=0,a=0,o=1/0,r=0,h=0,l=0,c=document.createElement("div");c.id="stats",c.addEventListener("mousedown",function(t){t.preventDefault(),v(++l%2)},!1),c.style.cssText="width:80px;opacity:0.9;cursor:pointer";var u=document.createElement("div");u.id="fps",u.style.cssText="padding:0 0 3px 3px;text-align:left;background-color:#002",c.appendChild(u);var d=document.createElement("div");d.id="fpsText",d.style.cssText="color:#0ff;font-family:Helvetica,Arial,sans-serif;font-size:9px;font-weight:bold;line-height:15px",d.innerHTML="FPS",u.appendChild(d);var p=document.createElement("div");for(p.id="fpsGraph",p.style.cssText="position:relative;width:74px;height:30px;background-color:#0ff",u.appendChild(p);74>p.children.length;){var m=document.createElement("span");m.style.cssText="width:1px;height:30px;float:left;background-color:#113",p.appendChild(m)}var y=document.createElement("div");y.id="ms",y.style.cssText="padding:0 0 3px 3px;text-align:left;background-color:#020;display:none",c.appendChild(y);var f=document.createElement("div");f.id="msText",f.style.cssText="color:#0f0;font-family:Helvetica,Arial,sans-serif;font-size:9px;font-weight:bold;line-height:15px",f.innerHTML="MS",y.appendChild(f);var g=document.createElement("div");for(g.id="msGraph",g.style.cssText="position:relative;width:74px;height:30px;background-color:#0f0",y.appendChild(g);74>g.children.length;)m=document.createElement("span"),m.style.cssText="width:1px;height:30px;float:left;background-color:#131",g.appendChild(m);
var v=function(t){switch(l=t){case 0:u.style.display="block",y.style.display="none";break;case 1:u.style.display="none",y.style.display="block"}};return{REVISION:11,domElement:c,setMode:v,begin:function(){t=Date.now()},end:function(){var l=Date.now();i=l-t,s=Math.min(s,i),n=Math.max(n,i),f.textContent=i+" MS ("+s+"-"+n+")";var c=Math.min(30,30-30*(i/200));return g.appendChild(g.firstChild).style.height=c+"px",h++,l>e+1e3&&(a=Math.round(1e3*h/(l-e)),o=Math.min(o,a),r=Math.max(r,a),d.textContent=a+" FPS ("+o+"-"+r+")",c=Math.min(30,30-30*(a/100)),p.appendChild(p.firstChild).style.height=c+"px",e=l,h=0),l},update:function(){t=this.end()}}};!function(t){Date.now||(Date.now=function(){return+new Date});var e=function(t,e){return e[t]||e["webkit"+t]||e["moz"+t]||e["o"+t]||e["ms"+t]};if(!t.requestAnimationFrame){var i=0;t.requestAnimationFrame=e("RequestAnimationFrame",t)||function(e){var s=Date.now(),n=Math.max(0,16-(s-i)),a=t.setTimeout(function(){e(s+n)},n);return i=s+n,a}}t.cancelAnimationFrame||(t.cancelAnimationFrame=e("CancelAnimationFrame",t)||e("CancelRequestAnimationFrame",t)||function(e){t.clearTimeout(e)}),t.localStorage||(t.localStorage={_data:{},setItem:function(t,e){return this._data[t]=e+""},getItem:function(t){return this._data.hasOwnProperty(t)?this._data[t]:void 0},removeItem:function(t){return delete this._data[t]},clear:function(){return this._data={}}});var s=t.document,n=t.navigator,a=s.body;a.requestFullscreen||(a.requestFullscreen=a.requestFullscreen||e("RequestFullScreen",a)||e("RequestFullscreen",a),s.cancelFullScreen=e("CancelFullScreen",s)),t.AudioContext||(t.AudioContext=e("AudioContext",t)),n.getGamepads||(n.getGamepads=e("GetGamepads",n))}(window),function(t){"use strict";function e(){i.unbind(t.document,"DOMContentLoaded",e,!1),i.unbind(t,"load",e,!1),i.ready=!0}var i=t.ec={};i.version="0.1.304",i.debug=0;var s,n,a,o,r,h,l,c,u,d,p,m,y,f,g,v,b,x,w,S,_=i.TIME_STEP=1e3/60,C=!1,A=null,k=2e3,T=function(t,e){if(!t)return!1;for(var i=0,s=e.length;s>i;i++)if(void 0===t[e[i]])return!1;return!0},P=i.core={begin:function(){console.log("begin"),cancelAnimationFrame(x),x=requestAnimationFrame(P.load),i.core.loadSettings(),i.core.trackEvent("core","preload",i.version,void 0,!0)},loadSettings:function(){var t=i.core.getLocal("version");t||i.core.clearLocal(),t!==i.version&&i.core.setLocal("version",i.version),i.debug=i.core.getLocal("debug",0,parseInt,[10])},load:function(e){var s=t.document,n=i.appCache||{};return(n.complete||n.timedout)&&i.ready===!0&&T(a,"courtyard".split(","))&&T(o,["enter_the_ninja"])?(S&&s.body.removeChild(S),i.EnemyInput.ready(),i.ShadowCloneInput.ready(),i.Player.ready(),i.Ninja.ready(),i.EmptyHand.ready(),i.Projectile.ready(),i.Puff.ready(),i.Box.ready(),i.Circle.ready(),P.init(e),void 0):(x=requestAnimationFrame(P.load),S||(S=s.createElement("p"),s.body.appendChild(S)),S.innerHTML=n.loaded?"Downloading Updates "+n.loaded+"/"+n.total:"Loading...",console.log("loading"),void 0)},init:function(e){if(console.log("init"),m=e,y=0,v=null,b=null,f=new i.UserInput,g=new i.EnemyInput,s&&s.term(),i.world=s=s||new i.World,n=n||new i.Collisions,w||(w=new i.Sound,w.setVolume(i.core.getLocal("soundVolume",.5,parseFloat)),w.loadSound(w.sounds.game),w.loadSound(w.sounds.stars),w.loadSound(w.sounds.strikes),w.loadSound(w.sounds.hits)),i.sound=w,i.resizeDisplay(),i.SpriteSheets.init(),h=h||new i.Canvas2dView,h.removeAll(),l=l||new i.Canvas2dWorldView(s),c=new i.HUDView,h.add(l),h.add(f),h.add(c),i.view=h,i.addBrowserListeners(f),i.touch){var u=h.width*i.pixelRatio,d=h.height*i.pixelRatio;i.ButtonOverlay.viewWidth=u,i.ButtonOverlay.viewHeight=d,f.setLeftStickOverlay(f.addButtonOverlay(new i.ButtonOverlay({x:160,y:d-160,radius:150}))),f.setRightStickOverlay(f.addButtonOverlay(new i.ButtonOverlay({x:u-160,y:d-160,radius:150})));var p=f.addButtonOverlay(new i.ButtonOverlay({x:u,y:50,radius:150})),x=f.addButtonOverlay(new i.ButtonOverlay({x:0,y:50,radius:150}));i.bind(p,"touchend",i.core.togglePause,!1),i.bind(x,"touchend",i.core.cycleDebug,!1)}i.mobile&&t.scrollTo(0,1),w.stop(),C=!0,A=i.getImage("img/ui/startscreen.png"),c.alpha=0,i.bind(i.core.getViewDom(),i.touch?"touchend":"mouseup",i.core.start,!1);var S=o.enter_the_ninja;r=new i.Scene(S);var _=a[r.mapName];i.core.setupMap(_,r),i.debug&&i.core.setDebugLevel(i.debug),!i.touch,i.core.trackEvent("core","inited",i.version,void 0,!0)},setupMap:function(t,e){console.log("setupMap",t),s.space&&(s.contains(v.attack)&&s.remove(v.attack),s.remove(v),s.remove(b)),s.setMap(t),n.init(s.space),l.loadMap(),p&&p.setSpace(s.space),y=0,v||(i.player=v=(new i.Player).setInput(f)),s.add(v),b||(b=(new i.Ninja).setInput(g)),s.add(b),cancelAnimationFrame(x),x=requestAnimationFrame(e?P.animateScene:P.animate),v.setPos(t.width/2,t.height/2+450,0),b.setPos(t.width/2+200,t.height/2,0),e?(e.init({viewport:l.camera,monk:v,ninja:b}),e.step(0),s.stepScene(_)):(g.completeTask(),l.lookAt(v.body.p.x,-v.body.p.y-64))},cycleMap:function(){var t;s.map===a.courtyard?t=a.testmap2:s.map===a.testmap2?t=a.testmap:s.map===a.testmap&&(t=a.courtyard),i.core.setupMap(t,null)},start:function(t){i.unbind(i.core.getViewDom(),t.type,i.core.start,!1),A=null,i.bind(i.core.getViewDom(),i.touch?"touchend":"mouseup",i.core.skipScene,!1),w.playGameMusic()},skipScene:function(t){C||!r||r.complete||(i.unbind(i.core.getViewDom(),t.type,i.core.skipScene,!1),r.skip())},userStarted:function(){i.touch?(A=i.getImage("img/ui/guide-touch.png"),i.core.trackEvent("game","guide","guide-touch")):(A=i.getImage("img/ui/guide-move-desktop.png"),i.core.trackEvent("game","guide","guide-move-desktop")),c.alpha=1},userReady:function(){i.touch||(A=i.getImage("img/ui/guide-fight-desktop.png"),i.core.trackEvent("game","guide","guide-fight-desktop"))},userPlaying:function(){A=null},rollCredits:function(){i.playerInteractions=36,i.core.trackEvent("game","credits",i.version),cancelAnimationFrame(x),x=requestAnimationFrame(P.animateCredits),i.clearCache(),u=u||new i.Canvas2dCreditsView,u.init(h.context),h.removeAll(),h.add(u),i.touch?i.bind(i.core.getViewDom(),"touchend",i.core.restart,!1):i.bind(i.core.getViewDom(),"mouseup",i.core.restart,!1),w.playEndingMusic()},restart:function(t){u.creditsTime<u.skipAfter||(i.unbind(i.core.getViewDom(),t.type,i.core.restart,!1),h.remove(u),A=null,s&&s.space&&(s.contains(v.attack)&&s.remove(v.attack),s.remove(v),s.remove(b),s.term()),cancelAnimationFrame(x),x=requestAnimationFrame(P.init))},animateCredits:function(t){i.debug>0&&(d.begin(),1===i.debug&&i.core.traceTime("animateCredits")),x=requestAnimationFrame(P.animateCredits);var e=t-m;m=t,e=Math.max(_,Math.min(e,10*_)),4!==i.debug&&h.draw(e),i.debug>0&&(1===i.debug&&i.core.traceTimeEnd("animateCredits"),d.end())},animateScene:function(t){if(i.debug>0&&(d.begin(),1===i.debug&&i.core.traceTime("animateScene")),r.complete)return x=requestAnimationFrame(P.animate),r=null,void 0;x=requestAnimationFrame(P.animateScene);var e=t-m;if(m=t,C)e=0;else for(e=Math.max(_,Math.min(e,10*_)),r.step(e),y+=e;y>=_;)y-=_,s.stepScene(_);4!==i.debug&&h.draw(e),i.debug>0&&(i.debug>2&&p.step(h),1===i.debug&&i.core.traceTimeEnd("animateScene"),d.end())},animate:function(t){i.debug>0&&(d.begin(),1===i.debug&&i.core.traceTime("animate")),x=requestAnimationFrame(P.animate);var e=t-m;if(m=t,C)e=0;else{for(e=Math.max(_,Math.min(e,10*_)),y+=e;y>=_;)y-=_,s.step(_);if(l.lookAt(v.body.p.x,-v.body.p.y-v.z-64),c.health=v.hitPoints/100,c.rate=v.getHeartRate(),"dead"===b.state&&(b.decomposed+=e,b.decomposed>k))return b.decomposed=0,i.core.rollCredits(),void 0}4!==i.debug&&h.draw(e),i.debug>0&&(i.debug>2&&p.step(h),1===i.debug&&i.core.traceTimeEnd("animate"),d.end())},getOverlay:function(){return A},pause:function(){console.log("pause"),C=!0,h.pause(),w.pause(),i.allowPinchZoom(),f.clearKeys()},resume:function(){console.log("resume"),C=!1,h.resume(),w.resume(),i.preventPinchZoom()},togglePause:function(){C?i.core.resume():i.core.pause()},paused:function(){return C},fullscreen:function(){i.fullscreen&&t.document.body.requestFullscreen()},resize:function(){i.resizeDisplay()&&(h.resize(i.width,i.height,i.pixelRatio),p&&p.resize())},zoom:function(t){return l.zoom(t)},getViewDom:function(){return h.getDom()},getCamera:function(){return l.camera},setLocal:function(t,e){try{localStorage.setItem(t,e)}catch(s){console.error("localStorage.setItem",s),i.core.trackEvent("error","localStorage.setItem",s.message,void 0,!0)}},getLocal:function(t,e,i,s){var n=localStorage.getItem(t);return null===n&&void 0!==e?e:i?(s=s||[],s.unshift(n),i.apply(null,s)):n},removeLocal:function(t){return localStorage.removeItem(t)},clearLocal:function(){localStorage.clear()},trackPage:function(e){t._gaq&&t._gaq.push(["_trackPageview",e])},trackEvent:function(e,i,s,n,a){t._gaq&&t._gaq.push(["_trackEvent",e,i,s,n,a])},trackCustom:function(e,i,s,n){t._gaq&&t._gaq.push(["_setCustomVar",e,i,s,n])},setDebugLevel:function(t){switch(t=isNaN(t)?0:t,0>t&&(t=4),p=p||new i.ChipmunkDebugView(s.space),d=d||new i.DebugView,d.hide(),p.hide(),t){case 4:case 3:p.show();case 2:case 1:d.show()}i.debug=t,i.core.setLocal("debug",t),console.log("debug level",t)},cycleDebug:function(){i.core.setDebugLevel(i.debug-1)},traceTime:function(t){t=t||"default",console.time=console.time||function(){},console.time(t)},traceTimeEnd:function(t){t=t||"default",console.timeEnd=console.timeEnd||function(){},console.timeEnd(t)}};i.loadMap=function(t){console.log("loadMap",t.name),a=a||{},a[t.name]=t},i.loadScene=function(t){console.log("loadScene",t.name),o=o||{},o[t.name]=t},i.extend=function(t,e){for(var i in e)if(e.hasOwnProperty(i)&&!t.hasOwnProperty(i)){var s=e[i];void 0!==s&&(t[i]=s)}return t},i.copy=function(t,e){t=t||{};for(var i in e)t[i]=e[i];return t},i.delegate=function(t,e){return function(){return e.apply(t,arguments)}},i.objectToProps=function(t,e){for(var i=[],s=0,n=t.length;n>s;s++)i.push(t[s][e]);return i},i.bind=function(t,e,i,s){s=s||!1,t.addEventListener?t.addEventListener(e,i,s):t.attachEvent?t.attachEvent("on"+e,i):t["on"+e]=i},i.unbind=function(t,e,i,s){s=s||!1,t.removeEventListener?t.removeEventListener(e,i,s):t.detachEvent?t.detachEvent("on"+e,i):delete t["on"+e]},i.bind(t.document,"DOMContentLoaded",e,!1),i.bind(t,"load",e,!1),function(){var e=t.document,s=t.navigator;i.touch="ontouchstart"in t||t.DocumentTouch&&e instanceof t.DocumentTouch,i.msTouch=s.msPointerEnabled,i.mobile=/iPhone|iPad|iPod|Android/.test(s.userAgent),i.ios=/iPhone|iPad|iPod/.test(s.userAgent),i.ipad=/iPad/.test(s.userAgent),i.android=/Android/.test(s.userAgent),i.standalone=!!s.standalone,i.webgl=!!t.WebGLRenderingContext,i.fullscreen=!!e.cancelFullScreen,i.webaudio=!!t.AudioContext,i.gamepads=!!s.getGamepads}(),i.core.begin()}(window),function(t){"use strict";t.ec=t.ec||{};var e=t.applicationCache,i=5e3;if(ec.appCache={loaded:0,total:0,complete:!1,timedout:!1},e&&e.status!==e.UNCACHED){var s=t.setTimeout(function(){ec.appCache.timedout=!0},i);e.addEventListener("noupdate",function(){t.clearTimeout(s),ec.appCache.progress=100,ec.appCache.complete=!0},!1),e.addEventListener("downloading",function(){t.clearTimeout(s)},!1),e.addEventListener("progress",function(t){ec.appCache.loaded=t.loaded,ec.appCache.total=t.total},!1),e.addEventListener("updateready",function(){e.status===e.UPDATEREADY&&(ec.appCache.progress=100,t.clearTimeout(s),e.swapCache(),t.location.reload())},!1),e.addEventListener("cached",function(){ec.appCache.progress=100,ec.appCache.complete=!0,t.clearTimeout(s)},!1)}else ec.appCache.complete=!0}(window),function(t){"use strict";var e=t.ec,i=t.document,s=e.android&&i.querySelector&&i.querySelector('meta[name="viewport"]');e.addBrowserListeners=function(s){this.bind(t,"blur",this.core.pause,!1),e.touch?(this.bind(e.core.getViewDom(),"touchstart",s.touchstart,!1),this.bind(e.core.getViewDom(),"touchmove",s.touchmove,!1),this.bind(e.core.getViewDom(),"touchend",s.touchend,!1)):(this.bind(e.core.getViewDom(),"mousedown",s.mousedown,!1),this.bind(e.core.getViewDom(),"mouseup",s.mouseup,!1)),e.mobile||this.bind(t,"resize",this.core.resize,!1),this.bind(i,"keydown",s.keydown,!1),this.bind(i,"keyup",s.keyup,!1)},e.preventPinchZoom=function(){e.android&&s&&(s.content="width=device-width, user-scalable=0")},e.allowPinchZoom=function(){e.android&&s&&(s.content="width=device-width, user-scalable=1")}}(window),function(t){"use strict";var e=t.ec,i=t.document;e.resizeDisplay=function(){var s,n,a;if(s=e.forcePixelRatio||t.devicePixelRatio||1,e.mobile){var o=Math.max(t.screen.width,t.screen.height),r=Math.min(t.screen.width,t.screen.height);n=o,a=r,e.ipad&&(s=Math.min(1,s),e.standalone||(a-=96))}else{var h,l,c=16,u=9;for(n=c,a=u,h=t.innerWidth,l=t.innerHeight;h>=n+c&&l>=a+u;)n+=c,a+=u;i.body.style.left=Math.floor((h-n)/2)+"px",i.body.style.top=Math.floor((l-a)/2)+"px"}return e.width!==n||e.height!==a||e.pixelRatio!==s?(e.pixelRatio=s,e.width=n,e.height=a,i.body.style.width=n+"px",i.body.style.height=a+"px",!0):!1}}(window),function(t){"use strict";var e=t.ec,i={},s={};e.clearImages=function(){i={}},e.clearCache=function(){s={}},e.getImage=function(t){var e=i[t];return e||(e=i[t]=new Image,e.src=t),e},e.getCached=function(t,i){i=i||t.src;var n=s[i];return n?n:t.width&&t.height?e.appendCache(i,t):t},e.appendCache=function(i,n){1===e.debug&&e.core.traceTime("appendCache "+i);var a=t.document.createElement("canvas");a.width=n.width,a.height=n.height;var o=a.getContext("2d");return o.drawImage(n,0,0),s[i]=a,1===e.debug&&e.core.traceTimeEnd("appendCache "+i),a}}(window),function(t){"use strict";var e=t.ec,i=t.cp,s=i.v,n=e.Entity=function n(){this.setBaseProperties(),e.debug>1&&Object.seal(this)};n.groupId=1,n.labelPool=[],n.getLabel=function(t,i){var s=this.labelPool.pop();return s?s.setContext(t):s=new e.TextField(t,0,0),s.setSize(160,i).setStyle("#0ff")},n.prototype={getBaseProperties:function(){return{type:"Entity",isEntity:!0,pos:{x:0,y:0,z:0},groundZ:0,z:0,velZ:0,depth:32,shape:null,body:null,groupId:i.NO_GROUP,sortBounds:{top:0,front:0},mapCollision:[],maxCollisionTopZ:0,layerNum:0,layerName:"",label:null,input:null,climbHeight:128,attack:null,fx:null,hitTime:0,hitPoints:0,hitDuration:0,decomposed:0}},setBaseProperties:function(){e.extend(this,this.getBaseProperties())},term:function(){this.shape=null,this.body&&(this.body.userData&&(this.body.userData.parent=null,this.body.userData=null),this.body=null),this.pos=null,this.sortBounds=null,this.input=null,this.mapCollision=null,this.label&&(n.labelPool.push(this.label),this.label=null)},setView:function(t){return this.view=t,this},setInput:function(t){return this.input=t,this},step:function(){return this},postStep:function(t){this.groundZ=this.z;var e,i=-10,s=1,n=0,a=5,o=this.getTargetZ(this.climbHeight);return e=o-this.z,e>0?this.climbHeight>=e&&(this.groundZ=this.z,this.velZ=this.velZ*s+(a+n*this.body.m_inv)*t/100,0>this.velZ&&(this.velZ=0),this.z=Math.min(o,this.z+this.velZ)):0>e?(this.velZ=this.velZ*s+(i+n*this.body.m_inv)*t/100,this.z=Math.max(o,this.z+this.velZ),this.groundZ=o):this.velZ=0,this.mapCollision.length>0&&this.maxCollisionTopZ>o&&this.hitMapWall(),this},hitMapWall:function(){this.input&&this.input.mapCollision(this)},postStepScene:function(){this.groundZ=this.z;var t,e=32,i=this.getTargetZ(e);return t=i-this.z,t>=e?0>=t&&(this.groundZ=i):0>t&&(this.groundZ=i),this},getTargetZ:function(t){t=t||this.climbHeight;var e=0;this.maxCollisionTopZ=0;for(var i=0,s=this.mapCollision.length;s>i;i++){var n=this.mapCollision[i],a=n.getTop(this.body.p.x,-this.body.p.y);a>e&&t>=a-this.z&&(e=a),this.maxCollisionTopZ=Math.max(this.maxCollisionTopZ,a)}return e},addMapCollision:function(t){0>this.mapCollision.indexOf(t)&&this.mapCollision.push(t)},removeMapCollision:function(t){var e=this.mapCollision.indexOf(t);e>-1&&this.mapCollision.splice(e,1)},hit:function(){return console.log("HIT",this),this},getSortBounds:function(){return this.sortBounds.top=this.z+this.depth,this.sortBounds.front=-this.body.p.y,this.sortBounds},getPos:function(){return this.pos.x=this.body.p.x,this.pos.y=-this.body.p.y,this.pos.z=this.z,this.pos},setPos:function(t,e,i){var s=this.body;if(void 0!==i&&(this.z=s.z=i),s.activate(),s.p.x=t,s.p.y=-e,s.isStatic())for(var n=0;s.shapeList.length>n;n++){var a=s.shapeList[n];a.update(s.p,s.rot),a.space&&a.space.staticShapes.reindexObject(a,a.hashid)}return this},setAngle:function(t,e){var i=this.body;return void 0!==e&&(i.w=e),t&&(t.x||t.y)?(i.a=Math.atan2(-t.y,t.x),i.rot.x=t.x,i.rot.y=-t.y):isNaN(t)||(i.a=t,i.rot.x=Math.cos(t),i.rot.y=-Math.sin(t)),this},setVelocity:function(t,e,i){var s=this.body;return s.vx=t,s.vy=e,void 0!==i&&(this.velZ=i),this},resetForces:function(){var t=this.body;t.f.x=0,t.f.y=0,t.t=0},getBody:function(t,e){var s=this.body;return s||(0===t?(s=new i.Body(1/0,1/0),s.nodeIdleTime=1/0):s=new i.Body(t,e)),s},assignCircleShape:function(t,e,n){n=n||i.momentForCircle(e,0,t,s(0,0)),this.radius=t;var a=this.getBody(e,n);return this.setBody(a),this.shape=new i.CircleShape(a,t,s(0,0)),this},assignBoxShape:function(t,e,s,n){n=n||i.momentForBox(s,t,e),this.width=t,this.height=e;var a=this.getBody(s,n);return this.setBody(a),this.shape=new i.BoxShape(a,t,e),this},setBody:function(t){this.body=t,t.userData={parent:this}}}}(window),function(t){"use strict";var e=t.ec,i=64,s=64,n=e.Box=function(t,n,a){this.setBaseProperties(),n=n||i,a=a||s,void 0===t&&(t=1),this.assignBoxShape(n,a,t),this.shape.setElasticity(0),this.shape.setFriction(.6),this.shape.collision_type=e.Collisions.PROP,e.debug>1&&Object.seal(this)},a=n.prototype;n.ready=function(){e.extend(a,e.Entity.prototype)}}(window),function(t){"use strict";var e=t.ec,i=32,s=e.Circle=function(t,s,n){this.setBaseProperties(),n&&(s/=2),s=s||i,void 0===t&&(t=1),this.assignCircleShape(s,t),this.shape.setElasticity(0),this.shape.setFriction(.6),this.shape.collision_type=e.Collisions.PROP,e.debug>1&&Object.seal(this)},n=s.prototype;s.ready=function(){e.extend(n,e.Entity.prototype)}}(window),function(t){"use strict";var e=t.ec,i=t.cp,s=i.v,n=Math.abs,a=s(0,0),o=s(0,0);e.playerInteractions=-1;var r=e.Player=function(){this.setBaseProperties(),this.groupId=e.Entity.groupId++;var t=32,i=5;this.assignCircleShape(t,i),this.shape.setElasticity(0),this.shape.setFriction(0),this.shape.collision_type=e.Collisions.PLAYER,this.shape.group=this.groupId,this.state="standing",this.walkCount=0,this.nextStep=1.95,this.speed=8,this.attack=new e.EmptyHand(t-4,1),this.depth=118,this.type="Player",this.hitPoints=100,e.debug>1&&Object.seal(this),e.core.trackCustom(1,"Player Interacted","No",2)};r.ready=function(){e.extend(r.prototype,e.Entity.prototype)},r.prototype={term:function(){e.Entity.prototype.term.apply(this),this.attack=null},punch:function(t,i,n){if(!this.passive()){var r=this.attack;if(0===r.shape.group&&(r.shape.group=this.groupId,this.attack=r),!(r.phase>e.EmptyHand.PASSIVE)){i.contains(r)&&i.remove(r),r.time=0,r.startTime=t,r.phase=e.EmptyHand.PUSHING;var h=this.getPos();r.setPos(h.x,h.y,h.z),this.setAngle(o,0),r.setAngle(o,0);var l=.75;this.body.vx*=l,this.body.vy*=l,r.resetForces(),r.body.activate();var c=s.mult(o,1e3*this.speed/n);r.body.vx=c.x+a.x*l,r.body.vy=-c.y-a.y*l,i.add(r)}}},attackEnd:function(t,i){var s=this.attack;s.time=0,s.startTime=-1,s.phase=e.EmptyHand.PASSIVE,i.contains(s)&&i.remove(s),2===e.playerInteractions&&(e.playerInteractions=3,e.core.userPlaying())},passive:function(){return 0===o.x&&0===o.y},hit:function(t,e){var i=t&&t.totalKE()||1e3;return i>0&&"hit"!==this.state&&"dead"!==this.state&&(this.state="hit",e=e||10,this.hitPoints-=e,this.hitTime=600,this.hitDuration=this.hitTime,this.body.w=i/1e4,this.body.vx*=2,this.body.vy*=2),console.log("PLAYER HIT. Energy:",i,"HP:",this.hitPoints,this),this},getHeartRate:function(){var t=1;return"hit"===this.state?t=Math.min(3,1.2*t):"standing"===this.state?t=Math.max(.8,t-.01):"punching"===this.state?t=Math.min(2,t+.05):"dead"===this.state&&(t=0),t},step:function(t){if(this.hitTime>0)return this.hitTime-=t,0>=this.hitTime&&(this.hitTime=0,this.state=0>=this.hitPoints?"dead":"standing"),this;if("dead"===this.state,this.input.poll(this,t),this.resetForces(),this.attack.entityStep(e.world.time,e.world,this),-1===e.playerInteractions&&(e.playerInteractions=0,e.core.userStarted()),this.attack.phase===e.EmptyHand.PASSIVE||this.attack.phase===e.EmptyHand.PULLING)if(a.x=this.input.axes[0],a.y=this.input.axes[1],n(a.x)>.1||n(a.y)>.1){if((n(a.x)>.7||n(a.y)>.7)&&a.mult(1/s.len(a)),this.state="walking",a.mult(1e3*this.speed/t),this.body.activate(),this.body.vx+=a.x,this.body.vy-=a.y,this.body.vx*=.5,this.body.vy*=.5,t){var i=Math.sqrt(this.body.vx*this.body.vx+this.body.vy*this.body.vy)*t/4e4;this.walkCount+=Math.max(.15,i)}this.setAngle(a,0),0===e.playerInteractions&&(e.playerInteractions=1,e.core.trackCustom(1,"Player Interacted","Yes",2))}else this.state="standing",this.walkCount=0,this.body.vx=0,this.body.vy=0,this.body.w*=.99,1===e.playerInteractions&&(e.playerInteractions=2,e.core.userReady());return o.x=this.input.axes[2],o.y=this.input.axes[3],this.input.buttons[0]>0&&(o.x=Math.cos(this.body.a),o.y=-Math.sin(this.body.a)),n(o.x)>.1||n(o.y)>.1?(o.mult(1/s.len(o)),this.punch(e.world.time,e.world,t),this.state="punching"):(o.x=0,o.y=0),this}}}(window),function(t){"use strict";var e=t.ec,i=e.EmptyHand=function(t,s){this.setBaseProperties(),t=t||24,s=s||1,this.assignCircleShape(t,s),this.shape.setElasticity(.5),this.shape.setFriction(1),this.shape.collision_type=e.Collisions.PLAYER_HAND,this.depth=64,this.time=0,this.startTime=-1,this.phase=i.PASSIVE,this.pushDuration=5e3/60,this.grabDuration=1e4/60,this.punchDuration=this.pushDuration+this.grabDuration/2,e.debug>1&&Object.seal(this)};i.PASSIVE=0,i.PUSHING=1,i.GRABBING=2,i.PULLING=3;var s=i.prototype;i.ready=function(){e.extend(s,e.Entity.prototype)},s.entityStep=function(t,i,s){if(this.phase)if(this.time=t-this.startTime,this.phase===e.EmptyHand.PUSHING)this.time<this.punchDuration||(s.passive()?s.attackEnd(t,i):this.time>this.pushDuration&&(this.phase=e.EmptyHand.GRABBING));else if(this.phase===e.EmptyHand.GRABBING){if(this.body.vx*=.9,this.body.vy*=.9,s.passive())s.attackEnd(t,i);else if(this.time>this.pushDuration+this.grabDuration){var n=!1;n||s.attackEnd(t,i)}}else this.phase===e.EmptyHand.PULLING&&s.passive()&&(s.attackEnd(t,i),console.log("pull ended passively"))}}(window),function(t){"use strict";var e=t.ec,i=t.cp,s=i.v,n=Math.abs,a=s(0,0),o=s(0,0),r=e.Ninja=function(){this.setBaseProperties(),this.groupId=e.Entity.groupId++;var t=32,i=5;this.assignCircleShape(t,i),this.shape.setElasticity(0),this.shape.setFriction(0),this.shape.collision_type=e.Collisions.MONSTER,this.shape.group=this.groupId,this.state="standing",this.walkCount=0,this.speed=8,this.attack=new e.EmptyHand(t-4,1),this.depth=118,this.type="Ninja",this.isShadowClone=!1,this.shadowClones=null,this.master=null,this.fx=null,this.hitPoints=100,e.debug>1&&Object.seal(this)};r.ready=function(){e.extend(r.prototype,e.Entity.prototype)},r.prototype={term:function(){e.Entity.prototype.term.apply(this),this.attack=null,this.shadowClones=null,this.master=null,this.fx=null},shadowClone:function(){if(this.isShadowClone)return console.error("shadow clone tried to clone itself!"),void 0;var t=this.getPos(),i=(new e.Ninja).setPos(t.x,t.y,t.z).setInput(new e.ShadowCloneInput);i.isShadowClone=!0,i.master=this,this.shadowClones||(this.shadowClones=[]),this.shadowClones.push(i),e.world.add(i),this.puffSmoke(),i.puffSmoke()},getClones:function(){var t=this.shadowClones;t||(t=this.shadowClones=[]);for(var e=t.length;e-->0;)"dead"===t[e].state&&t.splice(e,1);return t},puffSmoke:function(){var t=new e.Puff(this.groupId);e.world.add(t),this.fx=t,this.fx.track(this)},throwStar:function(){if("hit"!==this.state&&"dead"!==this.state){var t=this.getPos(),i=this.body.a,s=800,n=20,a=(new e.Projectile).setPos(t.x,t.y,t.z+64).setAngle(i,n).setVelocity(Math.cos(i)*s,Math.sin(i)*s,0);a.shape.group=this.groupId,e.world.add(a)}},hit:function(t,e){var i=t&&t.totalKE()||1e3;return i>0&&"hit"!==this.state&&"dead"!==this.state&&(this.state="hit",this.isShadowClone?(this.hitTime=400,this.hitPoints=e?0:this.hitPoints):(this.hitPoints-=e,this.hitTime=600),this.input.completeTask(),this.hitDuration=this.hitTime,this.body.w=i/1e4,this.body.vx*=2,this.body.vy*=2),this},updateFx:function(){this.fx&&(this.fx.time>0?this.fx.update(this):this.fx=null)},step:function(t){if(this.hitTime>0)return this.isShadowClone&&this.hitTime===this.hitDuration&&0===this.hitPoints&&this.puffSmoke(),this.hitTime-=t,0>=this.hitTime&&(this.hitTime=0,0>=this.hitPoints?(this.state="dead",this.isShadowClone&&(e.world.remove(this),this.term())):this.state="standing"),this.updateFx(),this;if(this.isShadowClone&&0>=this.master.hitPoints)this.puffSmoke(),this.hit(null,e.world,1);else if("dead"===this.state)return this.body.vx=0,this.body.vy=0,this.body.w*=.5,this.updateFx(),this;if(this.input.poll(this,t),this.resetForces(),this.attack.phase===e.EmptyHand.PASSIVE||this.attack.phase===e.EmptyHand.PULLING)if(a.x=this.input.axes[0],a.y=this.input.axes[1],n(a.x)>.1||n(a.y)>.1){if((n(a.x)>.7||n(a.y)>.7)&&a.mult(1/s.len(a)),this.state="walking",a.mult(1e3*this.speed/t),this.body.activate(),this.body.vx+=a.x,this.body.vy-=a.y,this.body.vx*=.5,this.body.vy*=.5,t){var i=Math.sqrt(this.body.vx*this.body.vx+this.body.vy*this.body.vy)*t/4e4;this.walkCount+=Math.max(.15,i)}this.setAngle(a,0)}else this.state="standing",this.body.vx=0,this.body.vy=0,this.body.w*=.99;return o.x=this.input.axes[2],o.y=-this.input.axes[3],n(o.x)>.1||n(o.y)>.1?o.mult(1/s.len(o)):(o.x=0,o.y=0),this.updateFx(),this}}}(window),function(t){"use strict";var e=t.ec,i=50,s=e.Puff=function(t){this.setBaseProperties(),this.groupId=t||e.Entity.groupId++,this.assignCircleShape(i,1),this.shape.setElasticity(0),this.shape.setFriction(0),this.shape.sensor=!0,this.time=this.duration=500,e.debug>1&&Object.seal(this)};s.ready=function(){e.extend(s.prototype,e.Entity.prototype)},s.prototype={track:function(t){var e=t.getPos();this.setPos(e.x,e.y+1,e.z+1),this.setVelocity(t.body.vx,t.body.vy,0)},step:function(t){this.time-=t,0>=this.time&&(this.time=0,e.world.remove(this),this.term())},update:function(t){this.time>0&&this.track(t)}}}(window),function(t){"use strict";var e=t.ec,i=e.Projectile=function(t,i){this.setBaseProperties(),t=t||12,i=i||1,this.depth=1,this.assignCircleShape(t,i),this.shape.setElasticity(1),this.shape.setFriction(1),this.shape.collision_type=e.Collisions.PROJECTILE,this.vx=0,this.vy=0,this.distanceSq=0,this.maxDistanceSq=64e6,this.inactive=0,this.lifetime=0,e.debug>1&&Object.seal(this)},s=i.prototype;s.climbHeight=0,i.ready=function(){e.extend(s,e.Entity.prototype)},s.setVelocity=function(t,e,i){var s=this.body;return s.vx=t,s.vy=e,this.vx=t,this.vy=e,void 0!==i&&(this.velZ=i),this},s.step=function(){return this.vx=this.body.vx,this.vy=this.body.vy,this},s.postStep=function(t){if(this.groundZ=this.getTargetZ(this.climbHeight),this.inactive>0)return this.inactive+=t,this.inactive>3e3&&(e.world.remove(this),this.term()),void 0;var i=this.z+this.velZ*t/100;if(this.groundZ>i)return this.z=this.groundZ,this.resetForces(),this.deactivate(t),void 0;if(this.z=i,this.maxDistanceSq&&this.mapCollision.length>0&&this.maxCollisionTopZ>this.groundZ&&this.hitObstacle(t),this.distanceSq+=this.vx*this.vx+this.vy*this.vy,this.distanceSq<this.maxDistanceSq)this.body.vx=this.vx,this.body.vy=this.vy;else{var s=-10,n=50/(Math.abs(this.body.w)+50),a=n;this.velZ=this.velZ*n+(s+a*this.body.m_inv)*t/100}},s.hit=function(t,e){console.log("Projectile HIT. Force:",e,"arbiter:",t),this.startFall(e)},s.hitObstacle=function(t){9e6>this.distanceSq||Math.random()>.8?this.deactivate(t):this.startFall(t),this.maxDistanceSq=0},s.startFall=function(){this.resetForces(),this.velZ+=32*Math.random()-16,this.body.w=4*Math.random()-2},s.deactivate=function(t){this.setVelocity(0,0,0),this.body.w=0,this.inactive=t,this.shape.sensor=!0},s.postStepScene=function(){this.groundZ=this.getTargetZ(this.climbHeight)}}(window),function(t){"use strict";var e=t.ec,i=e.MapElement=function(t){e.extend(this,{x:0,y:0,z:0,width:0,height:0,depth:0,regX:null,regY:null,matrix:null,mapType:"notset",mass:0,shape:null,type:null,image:null,layerNum:0,visible:!0,body:null,imageData:null,sortBounds:{top:0,front:0,back:0,inited:!1},label:null}),e.copy(this,t),this.init(),e.debug>1&&Object.seal(this)},s=i.prototype;s.init=function(){if(this.regX?(this.drawX=this.x-this.regX,this.drawY=this.y-this.regY):(this.drawX=this.x||0,this.drawY=this.y||0,this.regX=0,this.regY=0),this.z=this.mZ||this.z,this.y=this.y+this.z,this.depth=this.mDepth||this.depth,this.children)for(var t=this.children.length;t-->0;){var e=this.children[t];e.drawX=e.x,e.drawY=e.y}},s.loadImages=function(t){if((this.image||this.fillImage)&&(this.imageData=e.getImage(t+"/"+(this.image||this.fillImage))),this.fillColor&&9===this.fillColor.length&&(this.fillAlpha=255/parseInt(this.fillColor.substr(7),16),this.fillColor=this.fillColor.substr(0,7)),this.children)for(var i=this.children.length;i-->0;)this.loadImages.apply(this.children[i],[t])},s.setBody=function(t){this.body=t,t.userData={parent:this}},s.isBehindEntity=function(t){switch(this.mapType){case"container":case"parallax":return!1}var e=this.getSortBounds();if("floor"===this.mapType){if(t.mapCollision.length){if(t.mapCollision.indexOf(this)>-1&&t.z>=e.top)return!0}else if(t.z>=e.top)return!0}else{var i=t.getSortBounds();if("wall"===this.mapType){if(i.front>e.front)return!0}else{if("steps"!==this.mapType)throw this+" isBehindEntity(): Invalid Map Type: "+this.mapType;if(t.z>=this.z&&i.front>e.back)return!0}}return!1},s.toString=function(){return'[MapElement "'+this.name+'"]'},s.getTop=function(t,e){if("steps"===this.mapType){var i=this.z+this.depth*(this.y-e)/this.mHeight;return Math.min(this.z+this.depth,Math.max(0,i))}return this.z+this.depth},s.getSortBounds=function(){var t=this.sortBounds;if(!t.inited){if(t.inited=!0,t.top=this.z+this.depth,t.back=this.y-this.mHeight,"entity"===this.mapType)throw"entity sorting should not be handled by element instances";if("polygons"===this.shape&&this.shapes){var e=this.shapes;t.front=-1/0,t.back=1/0;var i;for(var s in e){i=this.y-(this.regY-e[s].y),"floor"===this.mapType&&(i+=this.depth);for(var n in e[s].polygons)for(var a=e[s].polygons[n],o=0;a.length>o;o++){var r=a[o];t.front=Math.max(t.front,i+r[1]),t.back=Math.min(t.back,i+r[1])}}console.log(this.mapType,this.name,"yd",this.y+this.depth,"r",this.regY,"offsetY",i)}else"wall"===this.mapType?t.front=this.y:"steps"===this.mapType?(t.front=this.y,t.top=this.z):"floor"===this.mapType?(t.back=this.y+this.depth-this.mHeight/2,t.front=t.back+this.mHeight):"parallax"===this.mapType?(t.front=-1,t.back=-1):t.front=this.y+this.mHeight}return t}}(window),function(t){"use strict";var e=t.ec,i=t.cp,s=i.v,n=e.World=function(){this.time=0,this.entities=[],this.elements=[],this.space=null,this.map=null,e.debug>1&&Object.seal(this)},a=1<<31,o=~a,r=n.prototype;r.init=function(){var t=this.space=new i.Space;t.gravity=s(0,0),t.iterations=10,t.sleepTimeThreshold=9*e.TIME_STEP,t.idleSpeedThreshold=.1,t.collisionSlop=.025,t.collisionBias=Math.pow(.25,60),t.damping=.5},r.term=function(){this.entities.length=0,this.elements.length=0;var t=this.space;t&&(t.locked=0,t.collisionHandlers.length=0,t.bodies.length=0,t.sleepingComponents.length=0,t.constraints.length=0,t.arbiters.length=0),this.space=null,this.map=null},r.setMap=function(t){this.term(),this.init(),this.addWalls(0,0,t.width,t.height);for(var e=t.layers,i=0;e.length>i;i++){var s=e[i];s.layerNum=i;var n,a,o=s.elements||[],r=s.shapes||[];for(n=o.length;n-->0;)"entity"===o[n].mapType?a=this.add(this.initMapEntity(o[n])):(a=this.initMapElement(o[n]),this.addMapElementBody(a)),a.layerNum=i,a.isEntity?o.splice(n,1):(a.visible=!!a.image||!!a.children,o[n]=a);s.elements=o,s.shapes=r}this.map=t},r.initMapEntity=function(t){var i=t.x,s=t.y,n=t.mZ,a=e[t.type];console.log("map entity",t.type,i,s,n);var o=new a(t.mass,t.mWidth,t.mHeight).setPos(i,s,n);return o.depth=t.mDepth,o},r.initMapElement=function(t){return t instanceof e.MapElement?t:new e.MapElement(t)
},r.addMapElementBody=function(t){var n,a,o,r,h,l,c=t.x,u=t.y;if("wall"===t.mapType){var d;if(n=t.shapes,"polygons"===t.shape&&n){t.setBody(new i.Body(1/0,1/0));for(r in n){o=[],a=n[r];for(h in a.polygons){for(o=o.concat.apply(o,a.polygons[h]),l=1;o.length>l;l+=2)o[l]=-o[l];try{d=this.addPolygons(s(c,u),o,t.body,s(a.x-t.regX,t.regY-a.y)),d.depth=t.depth,d.collision_type=e.Collisions.MAP,console.log('Wall Polygon verts "'+t.name+'" ['+t.x+","+t.y+"]["+t.regY+","+t.regY+"] ["+a.x+","+a.y+"]"+o)}catch(p){console.error('Bad Wall Polygon in "'+t.name+'". '+p+" "+o)}}}}else d=this.addBox(s(c,u-t.mHeight/2),t.mWidth,t.mHeight),d.depth=t.depth,d.collision_type=e.Collisions.MAP,t.setBody(d.body);this.elements.push(t)}else if("floor"===t.mapType){var m;if(n=t.shapes,"polygons"===t.shape&&n){t.setBody(new i.Body(1/0,1/0));for(r in n){o=[],a=n[r];for(h in a.polygons){for(o=o.concat.apply(o,a.polygons[h]),l=1;o.length>l;l+=2)o[l]=-o[l];try{m=this.addPolygons(s(c,u+t.depth),o,t.body,s(a.x-t.regX,t.regY-a.y)),m.depth=t.depth,m.collision_type=e.Collisions.MAP,console.log('Floor Polygon verts "'+t.name+'" ['+t.x+","+t.y+"] "+o)}catch(p){console.error('Bad Floor Polygon in "'+t.name+":"+h+'". '+p+" "+o)}}}}else m=this.addBox(s(c,u+t.depth),t.mWidth,t.mHeight),m.depth=t.depth,m.collision_type=e.Collisions.MAP,t.setBody(m.body);this.elements.push(t)}else if("steps"===t.mapType){var y=this.addBox(s(c,u-t.mHeight/2),t.mWidth,t.mHeight);y.depth=t.depth,y.collision_type=e.Collisions.MAP,t.setBody(y.body),this.elements.push(t)}else if("container"!==t.mapType&&"parallax"!==t.mapType)throw t+" World.addMapElementBody(): Invalid Map Type: "+this.mapType},r.addWalls=function(t,e,i,n){this.addBox(s((i-t)/2,e-64),256+i-t,128),this.addBox(s((i-t)/2,n+64),256+i-t,128),this.addBox(s(i+64,(n-e)/2),128,n-e),this.addBox(s(t-64,(n-e)/2),128,n-e)},r.addBox=function(t,e,s){var n=new i.Body(1/0,1/0);n.nodeIdleTime=1/0,t.y=-t.y,n.p=t;var a=this.space.addShape(new i.BoxShape(n,e,s));return a.setElasticity(0),a.setFriction(1),a.setLayers(o),a},r.addPolygons=function(t,e,n,a){n=n||new i.Body(1/0,1/0),a=a||s(0,0),n.nodeIdleTime=1/0,t.y=-t.y,n.p=t;var r=this.space.addShape(new i.PolyShape(n,e,a));return r.setElasticity(0),r.setFriction(1),r.setLayers(o),r},r.addLineSegment=function(t,e){var s=this.space.addShape(new i.SegmentShape(this.space.staticBody,t,e,0));return s.setElasticity(0),s.setFriction(1),s.setLayers(o),s},r.add=function(t){return 0>this.entities.indexOf(t)?(t.body.isStatic()||this.space.addBody(t.body),this.space.addShape(t.shape),this.entities.push(t),t):(console.error("entity already a child of world",t),null)},r.remove=function(t){var e=this.entities.indexOf(t);return e>-1?(t.body.isStatic()||this.space.removeBody(t.body),this.space.removeShape(t.shape),this.entities.splice(e,1),t.mapCollision.length=0,t):(console.error("entity not a child of world",t),null)},r.contains=function(t){return this.entities.indexOf(t)>-1},r.entityForBody=function(t){for(var e=this.entities.length;e-->0;)if(this.entities[e].body===t)return this.entities[e];return console.error("no entity for body",t),null},r.elementForBody=function(t){for(var e=this.elements.length;e-->0;)if(this.elements[e].body===t)return this.elements[e];return console.error("no elements for body",t),null},r.createStaticBody=function(){var t=new i.Body(1/0,1/0);return t.nodeIdleTime=1/0,t},r.step=function(t){var e;for(e=this.entities.length;e-->0;)this.entities[e].step(t);for(this.space.step(t/1e3),e=this.entities.length;e-->0;)this.entities[e].postStep(t);this.time+=t},r.stepScene=function(t){var e;for(this.space.step(t/1e3),e=this.entities.length;e-->0;)this.entities[e].postStepScene(t);this.time+=t}}(window),function(t){"use strict";var e=t.ec,i=e.Scene=function(t){this.data=t,this.mapName=t.map,this.fps=this.data.useFrames?this.data.fps:1,this.duration=this.calculateTime(t.duration),this.time=0,this.complete=!1,this.animations=null,e.debug>1&&Object.seal(this)},s=i.prototype;s.init=function(t){this.time=0,this.complete=!1,this.animations=[];for(var i=this.data.tracks,s=0;i.length>s;s++){var n=new e.Animation(i[s],t,this.fps);this.animations.push(n),n.actor.shape&&(n.sensor=n.actor.shape.sensor,n.actor.shape.sensor=!0)}},s.step=function(t){var e,i;if(t/=1e3,this.time+=t,this.time>this.duration)for(this.time=this.duration,this.complete=!0,e=0;this.animations.length>e;e++)i=this.animations[e],i.actor.shape&&(i.actor.shape.sensor=i.sensor);for(e=0;this.animations.length>e;e++)i=this.animations[e],i.update(this.time)},s.skip=function(){this.time=this.duration,this.step(0)},s.calculateTime=function(t){return this.data.useFrames?t/this.fps:t}}(window),function(t){"use strict";var e=t.ec,i={x:0,y:0},s=e.Animation=function(t,i,s){e.extend(this,t),this.actor=i[this.element.name],this.sensor=!1,this.fps=s,this.complete=!1,this.index=-1,this.tween=null,this.update=this.nextTween,e.debug>1&&Object.seal(this)},n=s.prototype;n.idle=function(){},n.nextTween=function(t){var e=this.keyframes,i=++this.index;if(i>=e.length)return this.tween&&!this.tween.complete&&this.updateTween(this.tween.endTime),this.update=this.idle,this.complete=!0,void 0;var s=this.tween={},n=e[i];if(s.index=i,s.from=n,s.startTime=this.calculateTime(n.start),s.duration=this.calculateTime(n.duration),s.endTime=this.calculateTime(n.start+n.duration),n.empty)return console.log("empty keyframe",this),s.complete=!0,this.actor.z=1e4,this.checkNext(t),void 0;if(s.complete=!1,n.tween){var a=e[i+1];s.to=a,s.fn="inout"===n.ease?this.easeInOutQuad:"in"===n.ease?this.easeInQuad:"out"===n.ease?this.easeOutQuad:this.linearTween}this.updateTween(t)},n.updateTween=function(t){if(!this.checkNext(t)){var e=this.tween,s=e.from,n=s.x,a=s.y,o=s.z;if(s.tween){var r=e.to,h=t-e.startTime;if(n=e.fn(h,n,r.x-n,e.duration),a=e.fn(h,a,r.y-a,e.duration),0>h||h>e.duration)throw"Tween time is out of range of current keyframe";if("Viewport"===this.element.type)this.actor.lookAt(n,a);else{void 0!==o&&(void 0!==r.z&&(o=e.fn(h,s.z,r.z-s.z,e.duration)),a+=o);var l=this.actor.getPos();if(this.actor.setPos(n,a,o),i.x=n-l.x,i.y=a-l.y,this.actor.setAngle(i,0),this.actor.state="walking",i.x||i.y){var c=Math.sqrt(i.x*i.x+i.y*i.y)/4e4;this.actor.walkCount+=Math.max(.15,c)}}this.update=this.updateTween}else"Viewport"===this.element.type?this.actor.lookAt(n,a):(void 0!==o&&(a+=o),this.actor.setPos(n,a,o),this.actor.body.vy=.001,this.actor.state="standing"),e.complete=!0,this.update=this.checkNext}},n.checkNext=function(t){return t>this.tween.endTime?(this.nextTween(t),!0):(this.update=this.checkNext,!1)},n.linearTween=function(t,e,i,s){return i*t/s+e},n.easeInQuad=function(t,e,i,s){return t/=s,i*t*t+e},n.easeOutQuad=function(t,e,i,s){return t/=s,-i*t*(t-2)+e},n.easeInOutQuad=function(t,e,i,s){return t/=s/2,1>t?i/2*t*t+e:(t--,-i/2*(t*(t-2)-1)+e)},n.calculateTime=function(t){return 1!==this.fps?t/this.fps:t}}(window),function(t){"use strict";var e=t.ec,i=t.createjs;e.SpriteSheets={init:function(){e.SpriteSheets.monk=new i.SpriteSheet({images:["img/sprite/sprites_64.png"],frames:[[188,0,76,137,0,36,126],[265,0,68,142,0,36,125],[334,0,64,138,0,35,124],[399,0,72,136,0,35,126],[472,0,64,138,0,27,124],[537,0,64,142,0,26,125],[602,0,70,141,0,32,129],[673,0,61,139,0,28,126],[735,0,67,140,0,33,128],[803,0,65,139,0,31,126],[869,0,77,142,0,43,126],[947,0,49,143,0,26,125],[0,144,53,143,0,29,125],[54,144,64,135,0,32,126],[119,144,66,134,0,33,125],[186,144,51,136,0,26,123],[238,144,67,134,0,36,125],[306,144,66,136,0,39,123],[373,144,67,138,0,31,128],[441,144,64,140,0,32,126],[506,144,67,138,0,31,128],[574,144,64,140,0,29,126],[639,144,66,134,0,32,125],[706,144,51,136,0,24,123],[758,144,68,134,0,31,125],[827,144,66,136,0,26,123],[894,144,77,142,0,32,126],[972,144,48,143,0,20,125],[0,288,52,143,0,22,125],[53,288,64,135,0,30,126],[188,0,76,137,0,36,126],[118,288,74,138,0,32,116],[193,288,69,134,0,34,113],[263,288,74,144,0,33,100],[338,288,68,142,0,36,125],[407,288,50,142,0,43,124],[458,288,79,144,0,80,126],[538,288,91,135,0,108,116],[630,288,64,137,0,35,123],[695,288,67,139,0,38,126],[763,288,52,142,0,41,131],[816,288,47,140,0,54,131],[864,288,72,136,0,35,126],[937,288,66,137,0,32,136],[0,433,69,138,0,33,142],[70,433,61,138,0,34,144],[132,433,64,137,0,27,123],[197,433,68,139,0,28,126],[266,433,52,142,0,9,131],[319,433,47,140,0,-9,131],[367,433,64,142,0,26,125],[432,433,47,142,0,33,124],[480,433,77,144,0,-5,126],[558,433,91,135,0,-19,116]],animations:{standing:0,walk_0:6,walk_1:10,walk_2:14,walk_3:18,walk_4:22,walk_5:26,punch_0:30,punch_1:34,punch_2:38,punch_3:42,punch_4:46,punch_5:50}}),e.SpriteSheets.ninja=new i.SpriteSheet({images:["img/sprite/sprites_64.png"],frames:[[650,433,74,135,0,37,125],[725,433,60,143,0,31,125],[786,433,65,137,0,36,123],[852,433,74,132,0,37,126],[927,433,65,137,0,27,123],[0,578,60,143,0,27,125],[61,578,72,143,0,36,126],[134,578,72,143,0,36,125],[207,578,72,144,0,36,126],[280,578,72,143,0,36,125],[353,578,74,133,0,37,125],[428,578,74,135,0,37,124],[503,578,74,133,0,37,125],[578,578,74,134,0,37,123],[653,578,58,130,0,27,124],[712,578,59,130,0,28,123],[653,578,58,130,0,27,124],[712,578,59,130,0,28,123],[772,578,60,136,0,33,127],[833,578,60,136,0,33,126],[772,578,60,136,0,33,127],[894,578,60,136,0,33,126],[955,578,58,130,0,34,124],[0,723,59,130,0,34,123],[955,578,58,130,0,34,124],[0,723,59,130,0,34,123],[60,723,74,133,0,35,125],[135,723,74,135,0,35,124],[210,723,74,133,0,35,125],[285,723,74,134,0,35,123],[360,723,119,108,0,44,125],[480,723,127,78,0,47,93],[608,723,145,55,0,46,62],[754,723,140,44,0,41,32],[895,723,96,85,0,42,93],[0,859,101,113,0,51,99],[102,859,89,105,0,42,91],[192,859,81,85,0,41,83],[274,859,78,32,0,41,57]],animations:{standing:0,walk_0:6,walk_1:10,walk_2:14,walk_3:18,walk_4:22,walk_5:26,fall:30,puff:34}}),e.SpriteSheets.throwingStar=new i.SpriteSheet({images:["img/sprite/sprites_64.png"],frames:[[485,859,34,26,0,17,13],[520,859,34,26,0,17,13],[555,859,32,26,0,16,13],[588,859,30,22,0,15,11],[619,859,26,20,0,13,10],[646,859,30,22,0,15,11],[677,859,32,26,0,16,13],[710,859,34,26,0,17,13],[745,859,34,26,0,17,13],[780,859,34,26,0,17,13],[815,859,32,26,0,16,13],[848,859,30,22,0,15,11],[879,859,26,20,0,13,10],[906,859,30,22,0,15,11],[937,859,32,26,0,16,13],[970,859,34,26,0,17,13]]}),e.SpriteSheets.shadow=new i.SpriteSheet({images:["img/sprite/sprites_64.png"],frames:[[404,859,80,54,0,40,26]]}),e.SpriteSheets.shadowSmall=new i.SpriteSheet({images:["img/sprite/sprites_64.png"],frames:[[353,859,50,32,0,23,14]]}),e.SpriteSheets.heart=new i.SpriteSheet({images:["img/sprite/sprites_64.png"],frames:[[0,0,93,82,0,45,36],[94,0,93,82,0,45,36]]}),e.SpriteSheets.lion=new i.SpriteSheet({images:["img/sprite/lion_64.png"],frames:[[0,0,80,212,0,40,180]]}),e.SpriteSheets.cauldron=new i.SpriteSheet({images:["img/sprite/cauldron_64.png"],frames:[[0,0,256,255,0,128,148]]})}}}(window),function(t){"use strict";function e(t,e){var i,s,r,h=t.body.a,l=6,c=h+n/6;0===h&&(c-=.1);for(var u=(5-a(3*c/n))%6;0>u;)u+=l;"walking"===t.state?(i=e.getAnimation("walk_"+u),i?(s=o(t.walkCount)%4,u=i.frames[0]+s):console.error("no walk_"+u)):"punching"===t.state?(i=e.getAnimation("punch_"+u),i?(r=t.attack.time/t.attack.pushDuration,s=Math.min(3,o(3*r)),u=i.frames[0]+s):console.error("no punch_"+u)):("hit"===t.state||"dead"===t.state)&&(i=e.getAnimation("fall"),i?("dead"===t.state?s=3:t.isShadowClone?(r=(t.hitDuration-t.hitTime)/t.hitDuration,s=Math.min(3,o(2*r))):(r=(t.hitDuration-t.hitTime)/t.hitDuration,.33>r?s=-1:(r=3*(r-.33)/2,s=Math.min(3,o(3*r)))),u=-1===s?u:i.frames[0]+s):console.error("no fall"));var d=e.getFrame(u);return null===d?(e.complete&&console.error("SpriteSheet null frame. Complete:",e.complete,u,"/",e.getNumFrames(),e.getAnimations()),null):d}function i(t,e,i,s){return e.r>=i&&e.l<=i+t.width&&e.b>=s&&e.t<=s+t.height}var s=t.ec,n=Math.PI,a=Math.round,o=Math.floor,r=s.Canvas2dEntityView=function(){s.debug>1&&Object.seal(this)},h=r.prototype;h.draw=function(t,e,i,s){this.drawShadow(t,e,i),this.drawEntity(t,e,i,s)},h.drawShadow=function(t,e,n){var a;if(e instanceof s.Ninja||e instanceof s.Player)a=s.SpriteSheets.shadow.getFrame(0);else{if(!(e instanceof s.Projectile))return;a=s.SpriteSheets.shadowSmall.getFrame(0)}if(a){var o=e.getPos(),r=o.x,h=o.y-e.groundZ,l=a.rect;if(i(l,n,r-a.regX,h-a.regY)){1===s.debug&&s.core.traceTime("drawImage shadow "+a.image.src);var c=s.getCached(a.image);t.drawImage(c,l.x,l.y,l.width,l.height,r-a.regX,h-a.regY,l.width,l.height),1===s.debug&&s.core.traceTimeEnd("drawImage shadow "+a.image.src)}}},h.drawEntity=function(t,a,r,h){var l,c,u,d,p=a.getPos(),m=p.x,y=p.y-p.z;if(a instanceof s.Ninja)l=e(a,s.SpriteSheets.ninja,h),"hit"===a.state&&a.hitTime===a.hitDuration&&s.sound.playSound(s.sound.sounds.hits,"*");else if(a instanceof s.Puff){var f=s.SpriteSheets.ninja,g=f.getAnimation("puff");g&&(d=g.frames[0]+o(4.9*(a.duration-a.time)/a.duration),l=f.getFrame(d))}else if(a instanceof s.Projectile){var v=s.SpriteSheets.throwingStar,b=v.getNumFrames();d=o(a.body.a*b/n)%b,l=v.getFrame(d),0===a.lifetime&&s.sound.playSound(s.sound.sounds.stars,"*"),a.lifetime+=h}else a instanceof s.Player?(l=e(a,s.SpriteSheets.monk,h),"walking"===a.state?a.walkCount>=a.nextStep&&(a.nextStep+=2,s.sound.playSound(s.sound.sounds.steps,"*")):"standing"===a.state?0!==a.nextStep&&(a.nextStep=0,s.sound.playSound(s.sound.sounds.steps,"*")):"punching"===a.state&&0===a.attack.time&&(s.sound.playSound(s.sound.sounds.strikes,"*"),a.nextStep=1)):a instanceof s.Box?l=s.SpriteSheets.lion.getFrame(0):a instanceof s.Circle?l=s.SpriteSheets.cauldron.getFrame(0):a instanceof s.EmptyHand||(1===s.debug&&s.core.traceTime("draw entity"),t.save(),a.radius?(t.fillStyle="#ff8000",t.beginPath(),t.arc(m,y,a.radius,0,2*n,!1),t.fill()):a.width&&a.height?(t.fillStyle="#0008ff",t.beginPath(),t.fillRect(m-a.width/2,y-a.height/2,a.width,a.height)):(t.fillStyle="#000088",t.beginPath(),t.fillRect(m-32,y-32,64,64)),t.restore(),1===s.debug&&s.core.traceTimeEnd("draw entity"));if(l&&i(l.rect,r,m-l.regX,y-l.regY)&&(u=s.getCached(l.image),c=l.rect,1===s.debug&&s.core.traceTime("drawImage "+l.image.src),t.drawImage(u,c.x,c.y,c.width,c.height,m-l.regX,y-l.regY,c.width,c.height),1===s.debug&&s.core.traceTimeEnd("drawImage "+l.image.src)),s.debug>1){var x=48;a.label=a.label||s.Entity.getLabel(t,x),a.label.setPos(m-16,y-(l&&l.regY+x||0));var w=""+a.layerNum+": "+a.layerName;if(a.mapCollision.length&&(w+="\r"+s.objectToProps(a.mapCollision,"name").join(",")),a.input){var S=a.input.goal;S&&(w+="\r"+S.name+" "+(S.taskIndex+1)+"/"+S.tasks.length+" "+(S.taskTime/1e3).toFixed(1))}a.label.setText(w)}}}(window),function(t){"use strict";var e=t.ec,i=e.Canvas2dMapView=function(){this.layers=[],e.debug>1&&Object.seal(this)},s=i.prototype;s.loadLayers=function(t){for(var e=this.layers=t.layers,i=e.length;i-->0;)this.loadLayer(e[i],t.path)},s.loadLayer=function(t,e){t.visible!==!1&&(t.visible=!0);for(var i=t.elements.length;i-->0;)t.elements[i].loadImages(e)},s.getLayers=function(){return this.layers||[]},s.getItemsInLayer=function(t,e,i){i=i||[];for(var s=t.elements,n=e.length;n-->0;){var a=e[n];a.layerNum=-1;for(var o=s.length;o-->0;)if(s[o].isBehindEntity(a)){a.layerNum=t.layerNum,a.layerName=t.name,e.splice(n,1),i.push(a);break}}return i},s.draw=function(t,e){for(var i=this.layers,s=i.length;s-->0;)this.drawLayer(i[s],t,e)},s.drawLayer=function(t,e,i,s){if(!t.visible)return!1;for(var n=t.elements,a=n.length;a-->0;)this.drawElement(n[a],e,i,s);return!0},s.drawElement=function(t,i,s){if(!t.visible)return!1;if(0===t.width||this.intersects(t,s)){i.save(),i.globalAlpha=t.alpha;var n=t.matrix;if(n?i.transform(n.a,n.b,n.c,n.d,n.tx-t.regX*n.a,n.ty-t.regY*n.d):i.transform(1,0,0,1,t.drawX,t.drawY),t.children)for(var a=t.children,o=0;a.length>o;o++){var r=a[o];(t.width||this.intersects(r,s))&&(r.image&&r.imageData?this.drawImage(r,i):this.drawShape(r,i))}t.imageData&&this.drawImageInplace(t,i),i.restore()}if(e.debug>1){var h=t.getSortBounds(),l="floor"===t.mapType?"#f00":"#f0f";t.label=t.label||new e.TextField(i,0,0,512,null,l),t.label.setPos(16+t.x-t.width/2,h.back+2),t.label.setText(t.name+": "+t.mapType+" ("+t.y+", "+t.z+", "+t.depth+", "+t.height+", "+t.mHeight+")"+h.back+","+h.front),i.strokeStyle=l,i.lineWidth=1,i.beginPath(),i.rect(t.x-t.width/2,h.back,t.width,h.front-h.back),i.stroke()}return!0},s.drawShape=function(t,i){if(1===e.debug&&e.core.traceTime("drawShape "+t.fillImage),t.fillImage){var s=e.getCached(t.imageData,t.fillImage);i.fillStyle=i.createPattern(s,"repeat")}else i.fillStyle=t.fillColor||"#00f";if(t.polygons){i.save(),i.translate(t.x,t.y);for(var n=0;t.polygons.length>n;n++)this.drawPolygon(t.polygons[n],i);i.restore()}else if(t.oval)i.beginPath(),i.arc(t.x,t.y,t.width/2,0,2*Math.PI,!1),i.fill();else{if(!t.rectangle)throw 1===e.debug&&e.core.traceTimeEnd("drawShape "+t.fillImage),"what kind of shape is this? "+t;i.fillRect(t.x,t.y,t.width,t.height)}return 1===e.debug&&e.core.traceTimeEnd("drawShape "+t.fillImage),!0},s.drawPolygon=function(t,e){e.beginPath();var i=0;for(e.moveTo(t[i][0],t[i][1]),i=1;t.length>i;i++)e.lineTo(t[i][0],t[i][1]);return e.fill(),!0},s.drawImage=function(t,i){1===e.debug&&e.core.traceTime("drawImage map child "+t.image);var s=e.getCached(t.imageData,t.image);return i.drawImage(s,t.x,t.y,t.width,t.height),1===e.debug&&e.core.traceTimeEnd("drawImage map child "+t.image),!0},s.drawImageInplace=function(t,i){1===e.debug&&e.core.traceTime("drawImage map "+t.image);var s=e.getCached(t.imageData,t.image);i.drawImage(s,0,0),1===e.debug&&e.core.traceTimeEnd("drawImage map "+t.image)},s.intersects=function(t,e){return t.drawX<=e.r&&e.l<=t.drawX+t.width&&t.drawY<=e.b&&e.t<=t.drawY+t.height},s.containsViewPort=function(t,e){return t.drawX<=e.l&&e.r>=t.drawX+t.width&&t.drawY<=e.t&&e.b>=t.drawY+t.height},s.insideViewPort=function(t,e){return e.l<=t.drawX&&t.drawX+t.width>=e.r&&e.t<=t.drawY&&t.drawY+t.height>=e.b}}(window),function(t){"use strict";var e=t.ec,i=e.Canvas2dWorldView=function(t){this.world=t,this.mapRenderer=new e.Canvas2dMapView,this.entityRenderer=new e.Canvas2dEntityView,this.camera={lookAt:function(t,e){this.x=-this.width/this.scaleX/2+t,this.y=-this.height/this.scaleY/2+e}},this.camera.x=this.camera.y=16,this.camera.zoom=1,this.viewport={l:0,t:0,r:0,b:0},e.debug>1&&Object.seal(this)},s=i.prototype;s.loadMap=function(){this.mapRenderer.loadLayers(this.world.map)},s.updateViewport=function(t){var e=this.viewport;return e.l=t.x,e.t=t.y,e.r=e.l+t.width/t.scaleX,e.b=e.t+t.height/t.scaleY,e},s.draw=function(t,e){t.setTransform(1,0,0,1,0,0),t.fillStyle="#888888",t.globalAlpha=1,t.fillRect(0,0,this.camera.width,this.camera.height),t.save(),t.setTransform(this.camera.scaleX,0,0,this.camera.scaleY,-this.camera.x*this.camera.scaleX,-this.camera.y*this.camera.scaleY);var i,s,a,o=this.world.entities.slice(),r=this.mapRenderer.getLayers(),h=[];for(i=r.length;i-->0;){var l=this.mapRenderer.getItemsInLayer(r[i],o,h[i]);l.sort(n),h[i]=l}o.length&&console.error(o.length+" elements did not get placed in a layer");var c=this.updateViewport(this.camera);for(i=0,a=r.length;a>i;i++){this.mapRenderer.drawLayer(r[i],t,c,e);var u=h[i];for(s=0;u.length>s;s++)this.entityRenderer.drawShadow(t,u[s],c,e);for(s=0;u.length>s;s++)this.entityRenderer.drawEntity(t,u[s],c,e)}t.restore()},s.lookAt=function(t,e){this.camera.lookAt(t,e)},s.resize=function(t,e,i){this.camera.width=t*i,this.camera.height=e*i,this.camera.pixelRatio=i,this.zoom(this.camera.zoom)},s.zoom=function(t){var i=640>=e.height?640:720;this.camera.zoom=t,t=t*e.height/i,this.camera.scaleX=this.camera.pixelRatio*t,this.camera.scaleY=this.camera.pixelRatio*t,console.log("zoom",this.camera.zoom,"factor",t,"x,y:",this.camera.scaleX,this.camera.scaleY,"w,h:",this.camera.width,this.camera.height,"px:",this.camera.pixelRatio)};var n=function(t,e){return t.body.p.y>e.body.p.y?-1:e.body.p.y>t.body.p.y?1:0}}(window),function(t){"use strict";function e(t,e,i,s,n){var a=1.70158,o=0,r=s;if(0==e)return i;if(1==(e/=n))return i+s;if(o||(o=.3*n),Math.abs(s)>r){r=s;var a=o/4}else var a=o/(2*Math.PI)*Math.asin(s/r);return-(r*Math.pow(2,10*(e-=1))*Math.sin((e*n-a)*2*Math.PI/o))+i}var i=t.ec,s=i.HUDView=function(){this.width=0,this.height=0,this.pixelRatio=1,this.alpha=1,this.scale=1,this.health=1,this.rate=1,this.lifetime=0,i.debug>1&&Object.seal(this)};s.prototype={draw:function(t,s){this.lifetime+=s;var n=i.SpriteSheets.heart.getFrame(1),a=i.SpriteSheets.heart.getFrame(0);if(n){var o=25+n.regX,r=20+n.regY,h=n.rect;t.save();var l=1e3/this.rate,c=(this.scale+e(0,this.lifetime%l,1,.2,l))/2;t.setTransform(c,0,0,c,o,r),this.scale=c,1>this.health&&(t.globalAlpha=this.alpha,t.drawImage(i.getCached(n.image),h.x,h.y,h.width,h.height,-n.regX,-n.regY,h.width,h.height)),t.globalAlpha=this.health*this.alpha,h=a.rect,t.drawImage(i.getCached(a.image),h.x,h.y,h.width,h.height,-a.regX,-a.regY,h.width,h.height),t.restore()}},resize:function(t,e,i){this.width=t*i,this.height=e*i,this.pixelRatio=i}}}(window),function(t){"use strict";var e=t.ec,i=e.Canvas2dCreditsView=function(){e.extend(this,{width:0,height:0,creditsTime:-1,skipAfter:3500,overlay:e.getImage("img/ui/credits.png")}),e.debug>1&&Object.seal(this)};i.prototype={init:function(t){this.creditsTime=0,t.setTransform(1,0,0,1,0,0),t.fillStyle="#000",t.globalAlpha=.1},draw:function(t,e){t.fillRect(0,0,this.width,this.height),t.globalAlpha=Math.min(1,t.globalAlpha+.1),this.creditsTime+=e;var i=4*Math.floor(24*this.creditsTime/1e3),s=this.overlay;if(s.height){var n=this.height/s.height,a=this.width-s.width*n,o=Math.max(-258*n,this.height-i);t.drawImage(s,a/2,o,s.width*n,s.height*n)}},resize:function(t,e,i){this.width=t*i,this.height=e*i}}}(window),function(t){"use strict";var e=t.ec,i=e.Canvas2dView=function(){this.children=[];var i=this.canvas=t.document.createElement("canvas");i.style.position="absolute",this.context=i.getContext("2d"),this.resize(e.width,e.height,e.pixelRatio),t.document.body.appendChild(this.canvas),e.debug>1&&Object.seal(this)},s=i.prototype;s.draw=function(t){for(var e=this.context,i=this.children,s=0,n=i.length;n>s;s++)i[s].draw(e,t)},s.pause=function(){},s.resume=function(){},s.getDom=function(){return this.canvas},s.add=function(t){return 0>this.children.indexOf(t)?(t.resize(this.width,this.height,this.pixelRatio),this.children.push(t),t):(console.error("object already a child of world",t),null)},s.remove=function(t){var e=this.children.indexOf(t);return e>-1?(this.children.splice(e,1),t):(console.error("object not a child of world",t),null)},s.removeAll=function(){this.children.length=0},s.resize=function(t,e,i){var s=this.canvas;this.width=t,this.height=e,this.pixelRatio=i,s.width=t*i,s.height=e*i,s.style.width=this.width+"px",s.style.height=this.height+"px";for(var n=this.children,a=0,o=n.length;o>a;a++)n[a].resize(t,e,i)},s.debugGui=function(t){var i=this,s=function(){var t=e.pixelRatio;e.resizeDisplay(),e.pixelRatio=t,i.resize(e.width,e.height,t)};t.addGui([{name:"view",remember:!0,target:i[0],props:[{name:"x",params:{min:-480,max:1600}},{name:"y",params:{min:-320,max:1600}},{name:"zoom",onChange:function(t){i.zoom(t)},params:{step:.01,min:.25,max:4}}]},{name:"pixelRatio",target:e,props:[{name:"pixelRatio",params:{min:1,max:2,step:.5},onChange:s}]}])}}(window),function(t){"use strict";var e=t.ec,i={type:"circle",x:0,y:0,radius:50},s=e.ButtonOverlay=function(t){t=e.extend(t||{},i),e.extend(this,t),this.radiusSq=this.radius?this.radius*this.radius:0,this.touches=[],this.pressed=!1,this.vx=this.vy=0,e.debug>1&&Object.seal(this)};s.viewWidth=1280,s.viewHeight=720;var n=s.prototype;n.containerWidth=s.viewWidth,n.containerHeight=s.viewHeight,n.hitTest=function(t,e,i,n){if(this.containerWidth=i,this.containerHeight=n,"circle"===this.type){var a=t*s.viewWidth/i-this.x,o=e*s.viewHeight/n-this.y;if(this.radiusSq>=a*a+o*o)return!0}else if("rectangle"===this.type){if(t>this.left&&this.right>t&&e>this.top&&this.buttom>e)return!0}else console.error(this,"invalid type:",this.type);return!1},n.addTouch=function(t){0>this.touches.indexOf(t)&&this.touches.push(t)},n.removeTouch=function(t){var e=this.touches.indexOf(t);e>-1&&(this.touches.splice(e,1),this.vx=this.vy=0)},n.hasTouch=function(t){return this.touches.indexOf(t)>-1},n.updateTouch=function(t,e,i){var n=e*s.viewWidth/this.containerWidth-this.x,a=i*s.viewHeight/this.containerHeight-this.y,o=Math.sqrt(n*n+a*a);Math.abs(n)>Math.abs(100*n/o)&&(n=100*n/o),Math.abs(a)>Math.abs(100*a/o)&&(a=100*a/o),this.vx=n,this.vy=a},n.touchStart=function(t,e){this.addTouch(e),this.pressed=!0,this.updateTouch(e,t.clientX,t.clientY)},n.touchEnd=function(t,e){this.hasTouch(e)&&(this.removeTouch(e),this.pressed=!1)},n.draw=function(t,e,i){"circle"===this.type&&(t.beginPath(),t.fillStyle="#000000",t.globalAlpha=.05,t.arc(this.x*s.viewWidth/e,this.y*s.viewHeight/i,this.radius*s.viewWidth/e,0,2*Math.PI,!1),t.fill(),this.pressed&&(t.beginPath(),t.fillStyle="#000000",t.globalAlpha=.1,t.arc((this.x+this.vx)*s.viewWidth/e,(this.y+this.vy)*s.viewHeight/i,80*s.viewWidth/e,0,2*Math.PI,!1),t.fill()))}}(window),function(t){"use strict";var e=t.ec,i=e.TextField=function(t,i,s,n,a,o){this.setContext(t),this.text="",this.multiline=!0,this.x=i||0,this.y=s||0,this.width=0,this.height=0,this.ratio=1,this.canvas=document.createElement("canvas"),this.context=this.canvas.getContext("2d"),this.context.textAlign="start",this.context.textBaseline="top",this.context.font="12px sans-serif",this.lineHeight=14,(n||a)&&this.setSize(n,a),o&&this.setStyle(o),e.debug>1&&Object.seal(this)};i.prototype.setText=function(t){return this.text!==t&&(this.text=t,this.redraw()),this.draw(),this},i.prototype.setContext=function(t){return this.ctx=t,this},i.prototype.setSize=function(t,i){this.width=t||100,this.height=i||this.lineHeight+2;var s=this.ratio=e.pixelRatio||1;return this.canvas.width=this.width*s,this.canvas.height=this.height*s,this.context.scale(s,s),this},i.prototype.setStyle=function(t){return this.context.fillStyle=t||"black",this.text&&this.redraw(),this},i.prototype.setMultiline=function(t){return this.multiline=t,this.text&&this.redraw(),this},i.prototype.setPos=function(t,e){return this.x=t,this.y=e,this},i.prototype.redraw=function(){if(this.context.clearRect(0,0,this.width,this.height),1===e.debug&&e.core.traceTime("fillText TextField "+this.text.length),this.multiline)for(var t=this.text.split(/[\r\n]/),i=this.lineHeight,s=0;t.length>s;s++)this.context.fillText(t[s],0,i,this.width),i+=this.lineHeight;else this.context.fillText(this.text,0,0,this.width);1===e.debug&&e.core.traceTimeEnd("fillText TextField "+this.text.length)},i.prototype.draw=function(){1===e.debug&&e.core.traceTime("draw TextField canvas"),this.ctx.drawImage(this.canvas,this.x,this.y,this.width,this.height),1===e.debug&&e.core.traceTimeEnd("draw TextField canvas")}}(window),function(t){"use strict";function e(){var t=new Audio;return{m4a:!!(t.canPlayType("audio/x-m4a;")||t.canPlayType("audio/aac;")).replace(/^no$/,""),ogg:!!t.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,"")}}function i(t){var e,i=0;for(var s in t)Math.random()<1/++i&&(e=s);return e}var s=t.ec,n=s.Sound=function(){this.codecs=e(),this.volume=1,this.paused=!1,this.sounds={game:{name:"game",urls:["audio/crickets.m4a","audio/crickets.ogg"],loop:!0,maxInstances:1,state:0},ending:{name:"ending",urls:["audio/ending.m4a","audio/ending.ogg"],maxInstances:1,state:0},steps:{name:"steps",urls:["audio/steps.m4a","audio/steps.ogg"],sprites:{step1:[403/48e3,2807/48e3],step2:[.1334375,2798/48e3],step3:[12403/48e3,2806/48e3],step4:[18397/48e3,2806/48e3]},maxInstances:2,volume:.1,state:0},strikes:{name:"strikes",urls:["audio/strikes.m4a","audio/strikes.ogg"],sprites:{strike1:[0,18400/48e3],strike2:[18208/48e3,13210/48e3],strike3:[31418/48e3,19279/48e3],strike4:[57124/48e3,21064/48e3],strike5:[81401/48e3,27134/48e3],strike6:[117817/48e3,21422/48e3],strike7:[2.9008125,.3365625],strike8:[3.237375,.458125],strike9:[3.7609375,20315/48e3],strike10:[200840/48e3,17173/48e3]},maxInstances:3,volume:.6,state:0},hits:{name:"hits",urls:["audio/hits.m4a","audio/hits.ogg"],sprites:{hit1:[0,27722/48e3],hit2:[27722/48e3,20278/48e3],hit3:[1,23654/48e3],hit4:[71654/48e3,.4405],hit5:[92798/48e3,23494/48e3],hit6:[2.42275,21496/48e3]},maxInstances:5,volume:.5,state:0},stars:{name:"stars",urls:["audio/stars.m4a","audio/stars.ogg"],sprites:{star1:[0,18094/48e3],star2:[18094/48e3,.4685]},maxInstances:6,volume:.2,state:0}},this.buffers={},this.sources={};var i;if(s.webaudio)try{t.AudioContext?i=new t.AudioContext:t.webkitAudioContext&&(i=new t.webkitAudioContext)}catch(n){console.error("Web Audio API not supported")}if(!i){s.webaudio=!1;var a=function(){s.extend(this,{audio:new Audio,buffer:null,loop:!1,gain:{value:1},playbackState:0,timeoutId:-1})};a.prototype={connect:function(t){this.gain=t.gain||this.gain},disconnect:function(){this.playbackState=3,this.timeoutId>-1&&clearTimeout(this.timeoutId)},noteGrainOn:function(t,e,i){t=0;var n=this.audio;n.id=Date.now()+"",n.src=this.buffer.url,n.preload="auto",n.volume=this.gain.value*s.sound.volume,n.loop=this.loop,this.playbackState=1;var a=this,o=function(){n.removeEventListener("ended",o,!1),n.removeEventListener("paused",o,!1),a.disconnect()},r=function(){n.currentTime=e,n.play(),a.playbackState=a.PLAYING_STATE,a.loop||(n.addEventListener("ended",o,!1),n.addEventListener("paused",o,!1)),i>0&&(a.timeoutId=setTimeout(function(){a.noteOff(0)},1e3*i-16.7)),n.removeEventListener("canplay",r,!1)};n.addEventListener("canplay",r,!1),n.load()},noteOn:function(t){this.noteGrainOn(t,0,0)},noteOff:function(t){t=0,this.audio.pause(),this.disconnect()},PLAYING_STATE:2},i={pool:[],destination:null,createBufferSource:function(){var t;if(this.pool.length>8)for(var e=this.pool.length;e-->0;){var i=this.pool[e];if(3===i.playbackState){t=i;break}}return t||(t=new a,this.pool.push(t)),t},createGainNode:function(){return{gain:{value:1},connect:function(){},disconnect:function(){}}}}}this.gainNode=i.createGainNode(),this.gainNode.gain.value=this.volume,this.gainNode.connect(i.destination),this.context=i,s.debug>1&&Object.seal(this)};n.prototype={playGameMusic:function(){this.context&&(this.playSound(this.sounds.game),this.stopSound(this.sounds.ending))},playEndingMusic:function(){this.context&&(this.playSound(this.sounds.ending),this.stopSound(this.sounds.game))},pause:function(){this.paused=!0;for(var t in this.sources)this.pauseSound(this.sounds[t])},resume:function(){this.paused=!1;for(var t in this.sources)this.resumeSound(this.sounds[t])},stop:function(){for(var t in this.sources)this.stopSound(this.sounds[t])},setVolume:function(t){this.volume=t,this.gainNode&&(this.gainNode.gain.value=t)},playSound:function(t,e){if(!(this.paused||0>this.volume)){var s=this.buffers[t.name];if(s){var n=this.sources[t.name];if(n&&1===t.maxInstances&&n.playbackState>0)return;n=this.sources[t.name]=this.context.createBufferSource(),n.buffer=s,n.loop=t.loop;var a=this.gainNode;if(void 0!==t.volume&&(a=this.context.createGainNode(),a.gain.value=t.volume,a.connect(this.context.destination)),n.connect(a),e){"*"===e&&(e=i(t.sprites));var o=t.sprites[e],r=o[0],h=o[1];n.noteGrainOn(0,r,h)}else n.noteOn(0)}else this.loadSound(t,!e)}},pauseSound:function(t){var e=this.sources[t.name];e&&e.playbackState===e.PLAYING_STATE&&e.noteOff(0)},resumeSound:function(t){if(!t.sprites){var e=this.sources[t.name];if(e&&e.playbackState!==e.PLAYING_STATE){var i=this.sources[t.name]=this.context.createBufferSource();i.buffer=e.buffer,i.loop=e.loop,i.connect(this.gainNode),i.noteOn(0)}}},stopSound:function(t){var e=this.sources[t.name];e&&(this.pauseSound(t),delete this.sources[t.name],e.disconnect(0),e=null)},loadSound:function(t,e){if(!t.state){for(var i=null,n=0;t.urls.length>n;n++){var a=t.urls[n].toLowerCase().match(/.+\.([^?]+)(\?|$)/)[1];if(this.codecs[a]){i=t.urls[n];break}}t.state=1;var o=s.delegate(this,function(i){this.buffers[t.name]=i,t.state=3,e&&this.playSound(t)});if(s.webaudio===!1){var r={url:i};return o(r),void 0}var h=this.context,l=new XMLHttpRequest;l.open("GET",i,!0),l.responseType="arraybuffer",l.onload=function(){t.state=2,h.decodeAudioData(l.response,o,this.onError)
};try{l.send()}catch(c){console.log(c),t.state=0}}},onError:function(){console.error("Audio Error",arguments)}}}(window),function(t){"use strict";var e=t.document,i=t.ec,s=t.cp,n=s.v,a=1<<31,o=2*Math.PI,r=function(t,e){return t-=e,function(){return t+=e}},h=function(){var t=n(0,0);return function(e,i){return t.x=e,t.y=i,t}}(),l=i.ChipmunkDebugView=function(t){this.setSpace(t);var o=this.canvas=e.createElement("canvas");o.style.position="absolute",this.ctx=o.getContext("2d"),this.resize(),this.scale=.1,this.orthoPos=n.mult(this.orthoSize,.5).add(h(0,-this.orthoSize.y)),this.maxArbiters=null,this.maxContacts=null,this.mouseDown=null,this.mouseJoint=null,this.mouse=n(0,0);for(var l=this.width-10,c=r(5,15),u=this.infoFields=[],d=6;d-->0;)u.push(new i.TextField(this.ctx,5,c(),l));u[5].setPos(5,this.height-50);var p=this,m=this.canvas2point=function(t,e){return n(t/p.scale-p.orthoPos.x,p.orthoPos.y-e/p.scale)};this.point2canvas=function(t){return n((t.x+p.orthoPos.x)*p.scale,(p.orthoPos.y-t.y)*p.scale)},this.canvas.onmousemove=function(t){if(p.mouse=m(t.offsetX,t.offsetY),p.mouseDown&&!p.mouseJoint){var e=h(t.offsetX-p.mouseDown.x,t.offsetY-p.mouseDown.y).mult(1/p.scale);p.mouseDown.x=t.offsetX,p.mouseDown.y=t.offsetY,p.orthoPos.add(e)}};var y=this.mouseBody=new s.Body(1/0,1/0);this.canvas.onmousedown=function(e){var i=3===e.which;if(!i&&!p.mouseJoint){var o=m(e.offsetX,e.offsetY);p.mouseDown=n(e.offsetX,e.offsetY);var r=t.pointQueryFirst(o,a,s.NO_GROUP);if(r){var h=r.body;if(!h.isStatic()){var l=p.mouseJoint=new s.PivotJoint(y,h,n(0,0),h.world2Local(o));l.maxForce=5e4,l.errorBias=Math.pow(.85,60),t.addConstraint(l)}}}},this.canvas.onmouseup=function(e){var i=3===e.which;i||(p.mouseJoint&&(t.removeConstraint(p.mouseJoint),p.mouseJoint=null),p.mouseDown=null)},this.canvas.onmousewheel=function(t){var e=t.detail?-1*t.detail:(t.wheelDeltaY?t.wheelDeltaY:t.wheelDelta)/40;p.scale=Math.min(Math.max(.005,p.scale+e/(-999*p.scale+1e3)),1);var i=n.sub(p.orthoSize,h(p.width,p.height).mult(1/p.scale));p.orthoSize.sub(i),p.orthoPos.sub(i.mult(.5))},i.debug>1&&Object.seal(this)};l.prototype.setSpace=function(t){this.space=t},l.prototype.show=function(){this.canvas.style.display="block",e.body.appendChild(this.canvas)},l.prototype.hide=function(){this.canvas.style.display="none",this.canvas.parentNode&&e.body.removeChild(this.canvas)},l.prototype.resize=function(t){t=t||.36;var e=this.ratio=i.pixelRatio||1;this.width=Math.max(160/e,Math.round(i.width*t)),this.height=Math.max(90/e,Math.round(i.height*t)),this.scale=this.width*t/i.width,this.orthoSize=n(this.width,this.height).mult(1/this.scale);var s=this.canvas;s.width=this.width*e,s.height=this.height*e,s.style.width=this.width+"px",s.style.height=this.height+"px",s.style.left=0,s.style.top=i.height-this.height+"px",this.ctx.scale(e,e)},l.prototype.step=function(t){var e=n.lerp(this.mouseBody.p,this.mouse,.25);this.mouseBody.v=n.mult(n.sub(e,this.mouseBody.p),60),this.mouseBody.p=e,this.draw(t)},l.prototype.draw=function(t){var e=this.ctx,i=this;e.clearRect(0,0,this.width,this.height),e.fillStyle="#ACF",e.globalAlpha=.5,e.fillRect(0,0,this.width,this.height),e.globalAlpha=1,e.strokeStyle="black",this.space.eachShape(function(t){e.fillStyle=t.style(),t.draw(e,i.scale,i.point2canvas)}),e.strokeStyle="red",e.lineWidth=2;for(var s=this.space.arbiters,n=0;s.length>n;n++)for(var a=s[n].contacts,r=0;a.length>r;r++){var h=this.point2canvas(a[r].p);e.beginPath(),e.moveTo(h.x-2,h.y-2),e.lineTo(h.x+2,h.y+2),e.stroke(),e.beginPath(),e.moveTo(h.x+2,h.y-2),e.lineTo(h.x-2,h.y+2),e.stroke()}if(this.mouseJoint){e.beginPath();var l=this.point2canvas(this.mouseBody.p);e.arc(l.x,l.y,5*this.scale,0,o,!1),e.fill(),e.stroke()}this.space.eachConstraint(function(t){t.draw&&t.draw(e,i.scale,i.point2canvas)}),this.drawInfo(t)},l.prototype.drawInfo=function(t){var s=this.space,n=this.infoFields,a=0;this.ctx.textAlign="start",this.ctx.textBaseline="alphabetic",this.ctx.fillStyle="black",n[a++].setText(e.body.clientWidth+","+e.body.clientHeight+" x "+i.pixelRatio);var o=t.children[0];n[a++].setText(t.canvas.width+","+t.canvas.height+" x "+o.camera.zoom+" : "+o.camera.width+","+o.camera.height+" : "+o.camera.scaleX+","+o.camera.scaleY);var r=s.arbiters.length;this.maxArbiters=this.maxArbiters?Math.max(this.maxArbiters,r):r,n[a++].setText("Arbiters: "+r+" (Max: "+this.maxArbiters+")");for(var h=0,l=0;r>l;l++)h+=s.arbiters[l].contacts.length;this.maxContacts=this.maxContacts?Math.max(this.maxContacts,h):h,n[a++].setText("Contact points: "+h+" (Max: "+this.maxContacts+")"),n[a++].setText("Mouse: "+this.mouse.x.toFixed(0)+", "+this.mouse.y.toFixed(0)),this.message&&n[a++].setText(this.message)};var c=function c(t,e,i,s,n){s=i(s),t.beginPath(),t.arc(s.x,s.y,e*n,0,o,!1),t.fill(),t.stroke()},u=function u(t,e,i,s){i=e(i),s=e(s),t.beginPath(),t.moveTo(i.x,i.y),t.lineTo(s.x,s.y),t.stroke()},d=[n(0,0),n(.2,0),n(.25,3),n(.3,-6),n(.35,6),n(.4,-6),n(.45,6),n(.5,-6),n(.55,6),n(.6,-6),n(.65,6),n(.7,-3),n(.75,6),n(.8,0),n(1,0)],p=function p(t,e,i,s,a){s=i(s),a=i(a),t.beginPath(),t.moveTo(s.x,s.y);for(var o=n.sub(a,s),r=n.len(o),l=n.mult(o,1/r),c=1;d.length>c;c++){var u=n.add(s,n.rotate(h(d[c].x*r,d[c].y*e),l));t.lineTo(u.x,u.y)}t.stroke()};s.PolyShape.prototype.draw=function(t,e,i){t.beginPath();var s=this.tVerts,n=s.length,a=i(h(s[n-2],s[n-1]));t.moveTo(a.x,a.y);for(var o=0;n>o;o+=2){var r=i(h(s[o],s[o+1]));t.lineTo(r.x,r.y)}t.fill(),t.stroke()},s.SegmentShape.prototype.draw=function(t,e,i){var s=t.lineWidth;t.lineWidth=Math.max(1,2*this.r*e),u(t,i,this.ta,this.tb),t.lineWidth=s},s.CircleShape.prototype.draw=function(t,e,i){c(t,e,i,this.tc,this.r),u(t,i,this.tc,n.mult(this.body.rot,this.r).add(this.tc))},s.PinJoint.prototype.draw=function(t,e,i){var s=this.a.local2World(this.anchr1),n=this.b.local2World(this.anchr2);t.lineWidth=2,t.strokeStyle="grey",u(t,i,s,n)},s.SlideJoint.prototype.draw=function(t,e,i){var s=this.a.local2World(this.anchr1),a=this.b.local2World(this.anchr2),o=n.add(s,n.clamp(n.sub(a,s),this.min));t.lineWidth=2,t.strokeStyle="grey",u(t,i,s,a),t.strokeStyle="red",u(t,i,s,o)},s.PivotJoint.prototype.draw=function(t,e,i){var s=this.a.local2World(this.anchr1),n=this.b.local2World(this.anchr2);t.strokeStyle="grey",t.fillStyle="grey",c(t,e,i,s,2),c(t,e,i,n,2)},s.GrooveJoint.prototype.draw=function(t,e,i){var s=this.a.local2World(this.grv_a),n=this.a.local2World(this.grv_b),a=this.b.local2World(this.anchr2);t.strokeStyle="grey",u(t,i,s,n),c(t,e,i,a,3)},s.DampedSpring.prototype.draw=function(t,e,i){var s=this.a.local2World(this.anchr1),n=this.b.local2World(this.anchr2);t.strokeStyle="grey",p(t,e,i,s,n)};for(var m=function(){return Math.floor(256*Math.random())},y=[],f=0;100>f;f++)y.push("rgb("+m()+", "+m()+", "+m()+")");s.Shape.prototype.style=function(){var t;return this.sensor?"rgba(255,255,255,0.1)":(t=this.body,t.isSleeping()?"rgba(50,50,50,0.5)":t.nodeIdleTime>this.space.sleepTimeThreshold?"rgba(170,170,170,0.5)":y[this.hashid%y.length])}}(window),function(t){"use strict";var e=t.ec,i=t.Stats,s=t.dat,n=e.DebugView=function(){var t=this.stats=new i;t.domElement.style.position="absolute",t.domElement.style.left="0px",t.domElement.style.top="0px",e.debug>1&&Object.seal(this)};n.prototype.begin=function(){this.stats.begin()},n.prototype.end=function(){this.stats.end()},n.prototype.show=function(){this.stats.domElement.style.display="block",t.document.body.appendChild(this.stats.domElement)},n.prototype.hide=function(){this.stats.domElement.style.display="none",this.stats.domElement.parentNode&&t.document.body.appendChild(this.stats.domElement)},n.prototype.addGui=function(t){for(var e=new s.GUI,i=e,n=0;t.length>n;n++){var a=t[n];a.remember&&e.remember(a.target),a.name&&(i=e.addFolder(a.name),i.open());for(var o=0;a.props.length>o;o++){var r,h=a.props[o],l=h,c=null;h.name&&(c=h.params,l=h.name),c?void 0!==c.min&&void 0!==c.max?r=i.add(a.target,l,c.min,c.max,c.step):c.step&&(r=i.add(a.target,l).step(c.step)):r=i.add(a.target,l,c),h.listen&&r.listen(),h.onChange&&r.onChange(h.onChange)}}return e},n.prototype.worldGui=function(t){this.addGui([{name:"space",remember:!0,target:t.space,props:[{name:"iterations",params:{min:1,max:40}},{name:"sleepTimeThreshold",params:{step:e.TIME_STEP,min:e.TIME_STEP,max:1}},{name:"collisionSlop",params:{step:.1,min:.1,max:1}},"damping",{name:"idleSpeedThreshold",listen:!0,params:{min:0,max:50}},{name:"collisionBias"},"enableContactGraph"]}]),this.addGui([{name:"gravity",target:t.space.gravity,props:[{name:"x",params:{step:10,min:-1e3,max:1e3}},{name:"y",params:{step:10,min:-1e3,max:1e3}}]}])}}(window),function(t){"use strict";function e(){this.row=-1,this.col=-1}var i=t.Hungarian={skillMatrix:null,matrix:null,stars:null,rCov:[],cCov:[],rows:0,cols:0,dim:0,solutions:0,FORBIDDEN_VALUE:-999999,hungarianAlgortithm:function(t,e){i.init(t,e),i.matrix=i.subtractRowMins(i.matrix),i.findZeros(i.matrix);for(var s=!1;!s;){var n=i.coverColumns(i.matrix);if(n>i.solutions-1&&(s=!0),!s)for(s=i.coverZeros(i.matrix);s;){var a=i.findSmallestUncoveredVal(i.matrix);i.matrix=i.uncoverSmallest(a,i.matrix),s=i.coverZeros(i.matrix)}}return i.getSolution(t,e)},init:function(t,e){i.cols=e.length,i.rows=t.length,i.dim=Math.max(i.rows,i.cols),i.solutions=i.dim,i.matrix=i.initMatrix(i.dim,i.dim),i.stars=i.initMatrix(i.dim,i.dim),i.matrix=i.loadMatrix(e,t,i.matrix,!1),i.rCov=Array(i.dim),i.cCov=Array(i.dim),i.initArray(i.cCov,0),i.initArray(i.rCov,0)},initMatrix:function(t,e){for(var s=Array(t),n=0;t>n;n++)s[n]=Array(e),i.initArray(s[n],0);return s},loadMatrix:function(t,e,s,n){return s=i.loadYourMatrix(t,e,s),n&&(s=i.reverseMatrix(i.findMaxValue(s),s)),s},loadYourMatrix:function(t,e,i){for(var s=0;i.length>s;s++)for(var n=e[s],a=0;i[s].length>a;a++){var o=t[a];if(o){var r=t[a].getPos(),h=r.x-n.x,l=r.y-n.y;i[s][a]=h*h+l*l}else i[s][a]=0,console.error("entity missing from squad: "+a+" "+t)}return i},findMaxValue:function(t){for(var e=0,i=0;t.length>i;i++)for(var s=0;t[i].length>s;s++)t[i][s]>e&&(e=t[i][s]);return Number(e)},reverseMatrix:function(t,e){for(var i=0;e.length>i;i++)for(var s=0;e[i].length>s;s++)e[i][s]=(Number(t)-Number(e[i][s])).toFixed(0);return e},subtractRowMins:function(t){for(var e=0;t.length>e;e++){for(var i=Number.MAX_VALUE,s=0;t[e].length>s;s++)i>t[e][s]&&(i=Number(t[e][s]));for(var n=0;t[e].length>n;n++)t[e][n]=t[e][n]-i}return t},subtractColMins:function(t){for(var e=0;t[0].length>e;e++){for(var i=Number.MAX_VALUE,s=0;t.length>s;s++)i>t[s][e]&&(i=Number(t[s][e]));for(var n=0;t[0].length>n;n++)t[n][e]=t[n][e]-i}return t},findZeros:function(t){for(var e=0;t.length>e;e++)for(var s=0;t[e].length>s;s++)0===t[e][s]&&0===i.rCov[e]&&0===i.cCov[s]&&(i.stars[e][s]=1,i.cCov[s]=1,i.rCov[e]=1);i.initArray(i.cCov,0),i.initArray(i.rCov,0)},initArray:function(t,e){for(var i=0;t.length>i;i++)t[i]=Number(e)},coverColumns:function(t){for(var e=0,s=0;t.length>s;s++)for(var n=0;t[s].length>n;n++)1===i.stars[s][n]&&(i.cCov[n]=1);for(var a=0;i.cCov.length>a;a++)e=Number(i.cCov[a])+Number(e);return e},coverZeros:function(t){for(var e=!0,s=i.findUncoveredZero(t);s.row>-1&&e===!0;){i.stars[s.row][s.col]=2;var n=i.foundStarInRow(s.row,t);n>-1?(i.rCov[s.row]=1,i.cCov[n]=0):(i.starZeroInRow(s),e=!1),e===!0&&(s=i.findUncoveredZero(t))}return e},findUncoveredZero:function(t){for(var s=new e,n=0;t.length>n;n++)for(var a=0;t[n].length>a;a++)0===t[n][a]&&0===i.rCov[n]&&0===i.cCov[a]&&(s.row=n,s.col=a,a=t[n].length,n=t.length-1);return s},foundStarInRow:function(t,e){for(var s=-1,n=0;e[t].length>n;n++)1===i.stars[t][n]&&(s=n,n=e[t].length);return s},starZeroInRow:function(t){var e=!1,s=0,n=i.initMatrix(2*i.dim,2);for(n[s][0]=t.row,n[s][1]=t.col;!e;){var a=i.findStarInCol(n[s][1]);if(a>-1?(s++,n[s][0]=a,n[s][1]=n[s-1][1]):e=!0,!e){var o=i.findPrimeInRow(n[s][0]);s++,n[s][0]=n[s-1][0],n[s][1]=o}}i.convertPath(n,s),i.initArray(i.cCov,0),i.initArray(i.rCov,0),i.erasePrimes()},findStarInCol:function(t){for(var e=-1,s=0;i.stars.length>s;s++)1===i.stars[s][t]&&(e=s,s=i.stars.length);return e},findPrimeInRow:function(t){for(var e=-1,s=0;i.stars[t].length>s;s++)2===i.stars[t][s]&&(e=s,s=i.stars[t].length);return e},convertPath:function(t,e){for(var s=0;e+1>s;s++){var n=t[s][0],a=t[s][1];1===i.stars[n][a]?i.stars[n][a]=0:2===i.stars[n][a]&&(i.stars[n][a]=1)}},erasePrimes:function(){for(var t=0;i.stars.length>t;t++)for(var e=0;i.stars[t].length>e;e++)2===i.stars[t][e]&&(i.stars[t][e]=0)},findSmallestUncoveredVal:function(t){for(var e=Number.MAX_VALUE,s=0;t.length>s;s++)for(var n=0;t[s].length>n;n++)0===i.rCov[s]&&0===i.cCov[n]&&e>t[s][n]&&(e=t[s][n]);return e},uncoverSmallest:function(t,e){for(var s=0;e.length>s;s++)for(var n=0;e[s].length>n;n++)1===i.rCov[s]&&(e[s][n]+=t),0===i.cCov[n]&&(e[s][n]-=t);return e},getSolution:function(){for(var t=[],e=0;i.rows>e;e++)for(var s=0;i.cols>s;s++)1===i.stars[e][s]&&t.push([e,s]);return t}}}(window),function(t){"use strict";var e=t.ec,i=t.cp,s=t.Hungarian,n=i.v,a=e.Formations=function(){this.positions=[],e.debug>1&&Object.seal(this)},o=a.prototype;o.lineupPositions=function(t,e,i,s,a){s=s||96,a=a||128;var o=n.sub(t,e),r=n.len(o);0===r?(o.x=0,o.y=a):a>r&&(o=n.normalize(o).mult(a));var h=n.mult(o,.5),l=n.normalize(n.perp(o)).mult(s);h.sub(n.mult(l,(i-1)/2));for(var c=Math.atan2(-o.y,o.x)+Math.PI,u=this.getFormationVectors(i),d=[],p=0;i>p;p++)u[p].x=h.x,u[p].y=h.y,d[p]=c,h.add(l);return{positions:u,angles:d}},o.circlePositions=function(t,e,i,s){for(var a=Math.PI,o=2*a,r=this.getFormationVectors(i),h=[],l=0;i>l;l++){var c=o*l/i,u=n.forangle(c).mult(s);r[l].x=u.x,r[l].y=u.y,h[l]=Math.atan2(-u.y,u.x)+a}return{positions:r,angles:h}},o.updateUnitsHungarian=function(t,e,i){return i=i||e.length,e=e.slice(0,i),t=t.slice(0,i),s.hungarianAlgortithm(e,t)},o.getFormationVectors=function(t){for(var e=0;t>e;e++)this.positions[e]=this.positions[e]||n(0,0);return this.positions},o.newFormationVectors=function(){this.positions=[]}}(window),function(t){"use strict";function e(t){r.debug>0;var e=t.swappedColl?t.body_a:t.body_b,i=e.userData.parent;return i?(i.hit(t,l),t.ignore(),!1):t.contacts&&t.contacts.length}function i(t){var e=t.body_a.userData.parent,i=t.body_b.userData.parent;return e&&i&&(e.hitTime&&!i.hitTime?i.hit(t,0):i.hitTime&&!e.hitTime&&e.hit(t,0)),!0}function s(t){var e=t.swappedColl?t.body_b:t.body_a,i=t.swappedColl?t.body_a:t.body_b,s=e.userData.parent,n=i.userData.parent;return r.debug>0,s.addMapCollision(n),!0}function n(t){var e=t.swappedColl?t.body_b:t.body_a,i=t.swappedColl?t.body_a:t.body_b,s=e.userData.parent,n=i.userData.parent;r.debug>0,s.removeMapCollision(n)}function a(t){var e=t.swappedColl?t.body_b:t.body_a,i=t.swappedColl?t.body_a:t.body_b;return o(e.userData.parent,i.userData.parent)}function o(t,e){var i=t.getSortBounds();if(i.top<e.z)return!1;var s=e.getSortBounds();return t.z>s.top?!1:t.z===s.top?!1:(r.debug>0,!0)}var r=t.ec,h=r.Collisions=function(){r.debug>1&&Object.seal(this)};h.PLAYER=1,h.PLAYER_HAND=2,h.MONSTER=10,h.PROJECTILE=12,h.MAP=50,h.PROP=100;var l=10;h.prototype={init:function(t){var o=null;t.addCollisionHandler(h.PLAYER_HAND,h.MONSTER,o,a,e,o),t.addCollisionHandler(h.PLAYER_HAND,h.PROJECTILE,o,a,e,o),t.addCollisionHandler(h.MONSTER,h.MONSTER,o,a,i,o),t.addCollisionHandler(h.PROJECTILE,h.PROP,o,a,i,o),t.addCollisionHandler(h.PROJECTILE,h.PLAYER,o,a,e,o),t.addCollisionHandler(h.PLAYER,h.MAP,s,a,o,n),t.addCollisionHandler(h.MONSTER,h.MAP,s,a,o,n),t.addCollisionHandler(h.PROJECTILE,h.MAP,s,a,o,n),t.addCollisionHandler(h.PLAYER_HAND,h.MAP,o,a,o,o)},term:function(){}}}(window),function(t){"use strict";var e=t.ec,i=[void 0,void 0,void 0,void 0];e.keyPressed={};var s,n=e.UserInput=function(i){s=this,this.index=i||0,this.gamepadTime=1;for(var n=this.buttons=[],a=0;17>a;a++)n[a]=0;this.axes=[0,0,0,0],e.gamepads&&(e.bind(t,"MozGamepadConnected",this.onGamepadConnect,!1),e.bind(t,"MozGamepadDisconnected",this.onGamepadDisconnect,!1)),this.pollGamePad=void 0!==navigator.webkitGetGamepads?this.pollGamePadList:this.pollDummyGamePadList,this.keyboardAxes1=!1,this.keyboardAxes2=!1,this.overlays=[],this.width=0,this.height=0,this.pixelRatio=1,e.debug>1&&Object.seal(this)},a=n.prototype;a.addButtonOverlay=function(t){var e=this.overlays.indexOf(t);return 0>e?(this.overlays.push(t),t):(console.error("overlay already a child of input",t),null)},a.removeButtonOverlay=function(t){var i=this.overlays.indexOf(t);return i>-1?(this.overlays.splice(i,1),e.unbind(t,"touchstart",t.touchStart,!1),e.unbind(t,"touchend",t.touchEnd,!1),t):(console.error("overlay not a child of input",t),null)},a.draw=function(t){t.save();for(var i,s=0,n=this.overlays.length;n>s;s++)i=this.overlays[s],i.draw(t,this.width,this.height);if(e.core.paused()?(t.fillStyle="#000000",t.globalAlpha=.33,t.fillRect(0,0,this.width,this.height),t.fillStyle="#ffffff",t.globalAlpha=.8,t.beginPath(),t.moveTo(this.width-15,35),t.lineTo(this.width-50,15),t.lineTo(this.width-50,55),t.fill()):e.touch&&(t.fillStyle="#ffffff",t.globalAlpha=.8,t.fillRect(this.width-43,15,10,40),t.fillRect(this.width-25,15,10,40)),i=e.core.getOverlay()){var a=Math.min(this.height/i.height,this.width/i.width),o=this.width-i.width*a,r=this.height-i.height*a;t.globalAlpha=1,1===e.debug&&e.core.traceTime("drawImage overlay "+i.src),t.drawImage(i,o/2,r/2,i.width*a,i.height*a),1===e.debug&&e.core.traceTimeEnd("drawImage overlay "+i.src)}t.restore()},a.resize=function(t,e,i){this.width=t*i,this.height=e*i,this.pixelRatio=i},a.testOverlays=function(t,e,i){for(var s=this.width/this.pixelRatio,n=this.height/this.pixelRatio,a=0,o=this.overlays.length;o>a;a++){var r=this.overlays[a];if("touchend"===t&&(r===this.leftStickOverlay||r===this.rightStickOverlay)&&void 0!==r["on"+t]&&r["on"+t].apply(r,[e,i]),r.hitTest(e.clientX,e.clientY,s,n))return void 0!==r["on"+t]&&r["on"+t].apply(r,[e,i]),r}return null},a.setLeftStickOverlay=function(t){this.leftStickOverlay=t,e.bind(t,"touchstart",t.touchStart,!1),e.bind(t,"touchend",t.touchEnd,!1)},a.setRightStickOverlay=function(t){this.rightStickOverlay=t,e.bind(t,"touchstart",t.touchStart,!1),e.bind(t,"touchend",t.touchEnd,!1)},a.setAxes1=function(t,e){this.axes[0]=t,this.axes[1]=e},a.setAxes2=function(t,e){this.axes[2]=t,this.axes[3]=e},a.setButton=function(t,e){this.buttons[t]=e},a.mapButton=function(t,e){r[t]=e},a.poll=function(){this.leftStickOverlay&&!this.keyboardAxes1&&this.setAxes1(this.leftStickOverlay.vx/100,this.leftStickOverlay.vy/100),this.rightStickOverlay&&!this.keyboardAxes2&&this.setAxes2(this.rightStickOverlay.vx/100,this.rightStickOverlay.vy/100);var t=this.pollGamePad()[this.index];t&&this.gamepadTime!==t.timestamp&&(this.gamepadTime=t.timestamp||1,1===t.buttons[9]&&1!==this.buttons[9]&&e.core.togglePause(),t.buttons.join("")!==this.buttons.join("")&&console.log("gamepad button change",t.buttons.indexOf(1),this.buttons.indexOf(1),t.axes),this.buttons=t.buttons.slice(0),this.keyboardAxes1||this.setAxes1(t.axes[0],t.axes[1]),this.keyboardAxes2||this.setAxes2(t.axes[3],t.axes[4]))},a.mapCollision=function(){},a.touchstart=function(t){if(!e.core.paused())for(var i=0,n=t.changedTouches.length;n>i;i++)s.testOverlays(t.type,t.changedTouches[i],t.changedTouches[i].identifier)},a.touchmove=function(t){for(var e=0,i=s.overlays.length;i>e;e++)for(var n=s.overlays[e],a=0,o=t.changedTouches.length;o>a;a++)if(n.hasTouch(t.changedTouches[a].identifier)){n.updateTouch(t.changedTouches[a].identifier,t.changedTouches[a].clientX,t.changedTouches[a].clientY);break}t.preventDefault()},a.touchend=function(t){if(e.core.paused())return e.core.resume(),void 0;for(var i=0,n=t.changedTouches.length;n>i;i++)s.testOverlays(t.type,t.changedTouches[i],t.changedTouches[i].identifier)},a.mousedown=function(i){e.core.paused()||s.testOverlays(i.type,i,-1)||(e.bind(e.core.getViewDom(),"mousemove",s.mouseRightStick,!1),e.bind(t,"mouseup",s.mouseRightStickEnd,!1),s.mouseRightStick(i))},a.mouseRightStick=function(t){var i=t.target.width/2,n=t.target.height/2,a=t.offsetX-i,o=t.offsetY-n,r=e.core.getCamera();o-=64*r.scaleY;var h=Math.sqrt(a*a+o*o);a/=h,o/=h,s.setAxes2(a,o)},a.mouseRightStickEnd=function(){e.unbind(e.core.getViewDom(),"mousemove",s.mouseRightStick,!1),s.setAxes2(0,0)},a.mouseup=function(t){return e.core.paused()?(e.core.resume(),void 0):(s.testOverlays(t.type,t,-1),void 0)},a.keydown=function(t){var i=t.keyCode||t.which;switch(e.keyPressed[i]=!0,i){case o.RIGHT:case o.D:case o.LEFT:case o.A:case o.UP:case o.W:case o.DOWN:case o.S:s.updateAxes1FromKeys();break;case o.SPACE:case o.ENTER:s.setButton(r.SELECT,1);break;case o.BACKSLASH:s.setButton(r.CANCEL,1)}},a.keyup=function(t){var i=t.keyCode||t.which;switch(e.keyPressed[i]=!1,i){case o.RIGHT:case o.D:case o.LEFT:case o.A:case o.UP:case o.W:case o.DOWN:case o.S:s.updateAxes1FromKeys();break;case o.SPACE:case o.ENTER:s.setButton(r.SELECT,0);break;case o.BACKSLASH:s.setButton(r.CANCEL,0);break;case o.P:e.core.paused()?e.core.resume():e.core.pause();break;case o.O:e.core.cycleDebug();break;case o.M:e.core.cycleMap();break;case o.F:case o.SLASH:e.core.fullscreen();break;default:console.log(String.fromCharCode(i),i)}},a.clearKeys=function(){e.keyPressed={},this.keyboardAxes1=!1,this.keyboardAxes2=!1,this.setAxes1(0,0),this.setAxes2(0,0),this.setButton(r.SELECT,0),this.setButton(r.CANCEL,0)},a.updateAxes1FromKeys=function(){var t=(e.keyPressed[o.LEFT]||e.keyPressed[o.A]?-1:0)+(e.keyPressed[o.RIGHT]||e.keyPressed[o.D]?1:0),i=(e.keyPressed[o.UP]||e.keyPressed[o.W]?-1:0)+(e.keyPressed[o.DOWN]||e.keyPressed[o.S]?1:0);this.keyboardAxes1=t||i,this.setAxes1(t,i)},a.pollDummyGamePadList=function(){return i},a.pollGamePadList=function(){return navigator.webkitGetGamepads()},a.onGamepadConnect=function(t){if(console.log("onGamepadConnect",t),0===t.gamepad.index){var e=t.gamepad;this.pollGamePad=function(){return e}}},a.onGamepadDisconnect=function(t){console.log("onGamepadDisconnect",t),0===t.gamepad.index&&(this.pollGamePad=this.pollDummyGamePadList)};var o={LEFT:37,UP:38,RIGHT:39,DOWN:40,ENTER:13,SHIFT:16,CTRL:17,ALT:18,SPACE:32,NUM0:48,NUM1:49,NUM2:50,NUM3:51,NUM4:52,NUM5:53,NUM6:54,NUM7:55,NUM8:56,NUM9:57,A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90,SLASH:191,BACKSLASH:220},r={SELECT:0,CANCEL:1}}(window),function(t){"use strict";var e=t.ec,i=t.cp,s=e.GoalBasedInput=function(){this.setBaseProperties(),e.debug>1&&Object.seal(this)},n=s.prototype;n.getBaseProperties=function(){return{axes:[0,0,0,0],goal:null,goalIndex:-1,targetPos:null,targetAngle:null,targetEntity:null}},n.setBaseProperties=function(){e.extend(this,this.getBaseProperties())},n.poll=function(t,e){if("dead"!==this.state){var i=this.goal;if(!i||i.met){if(i=this.selectGoal(),null===i)return;this.setGoal(i)}var s=i.task;(!s||s.complete)&&(s=this.selectTask(i,t)),s&&(i.taskTime+=e,s.apply(this,arguments))}},n.mapCollision=function(){this.completeTask(),this.goal&&(this.goal.mapCollisions++,this.goal.task&&this.goal.task.mapCollisions++)},n.setAxes1=function(t,e){this.axes[0]=t,this.axes[1]=e},n.setAxes2=function(t,e){this.axes[2]=t,this.axes[3]=e},n.selectGoal=function(){return null},n.setGoal=function(t){t.met=!1,t.task=null,t.taskIndex=-1,t.taskTime=0,t.mapCollisions=0,this.goal=t},n.selectTask=function(t){var e,i;return i=t.taskIndex+1,i>=t.tasks.length?(t.met=!0,null):(e=t.tasks[i],e.complete=!1,e.mapCollisions=0,t.task=e,t.taskIndex=i,t.taskTime=0,e)},n.completeTask=function(){this.goal&&this.goal.task&&(this.goal.task.complete=!0)},n.updateTargetPos=function(){var t=this.targetPos||i.v(0,0);if(!this.targetEntity)return console.error("update target: targetEntity not set"),this.completeTask(),t;var e=this.targetEntity.getPos();return t.x=e.x,t.y=e.y,this.targetPos=t,t}}(window),function(t){"use strict";function e(){return function(t){this.targetPos=x(1e3*Math.random(),1e3*Math.random()+1e3),t.speed=6,this.completeTask()}}function i(t,e){return t=t||A,e=e||6,function(e){if(!this.targetPos)return this.setAxes1(0,0),this.completeTask(),void 0;var i=x.sub(this.targetPos,e.getPos());if(t*t>f(i)){this.completeTask();var s=this.targetAngle;return s?e.body.a=s:e.setAngle(i,0),this.targetPos=null,this.setAxes1(0,0),void 0}g(i,!0),this.setAxes1(i.x,i.y)}}function s(t,e){return t=t||k,e=e||6,function(e){if(!this.targetPos)return this.completeTask(),void 0;var i=x.sub(e.getPos(),this.targetPos);return f(i)>t*t?(this.completeTask(),this.targetPos=null,this.setAxes1(0,0),e.setAngle(i,0),void 0):(g(i,!0),this.setAxes1(i.x,i.y),void 0)}}function n(t,e){return t=t||k,e=e||6,function(e){if(!this.targetPos)return this.completeTask(),void 0;var i=x.sub(this.targetPos,e.getPos());return f(i)>t*t+A*A?(g(i,!0),this.setAxes1(i.x,i.y),void 0):t*t>f(i)?(g(i,!0),this.setAxes1(-i.x,-i.y),void 0):(this.completeTask(),this.targetPos=null,this.setAxes1(0,0),e.setAngle(i,0),void 0)}}function a(t,e){t=t||A,e=e||6;var i=n(t);return function(t){t.speed=e,this.updateTargetPos(),i.apply(this,arguments)}}function o(){var t=i(0,8);return function(){_.apply(this,arguments),t.apply(this,arguments)}}function r(t,e){t=t||7,e=e||t;var i=h(t,e);return function(e){return e.getClones().length>=t?(this.completeTask(),void 0):(this.turns+=.5,e.body.a+=.5,this.turns>11&&(this.turns=0,this.goal.task=i,this.goal.taskTime=0),void 0)}}function h(t,e){return t=t||7,e=e||e,function(i){++this.clones>e||i.getClones().length>=t?(this.clones=0,this.completeTask()):i.shadowClone()}}function l(t,e,i){return t=t||128,e=e||128,i=i||100,function(s){var n=s.getClones(),a=Math.min(i,n.length),o=this.updateTargetPos(),r=this.formations.lineupPositions(s.getPos(),o,a,t,e),h=this.formations.updateUnitsHungarian(n,r.positions,a);d(n,r,h,a,o),this.completeTask()}}function c(t,e){return t=t||256,e=e||100,function(i){var s=i.getClones().slice(0);s.unshift(i);var n=Math.min(e,s.length),a=this.updateTargetPos(),o=this.formations.circlePositions(i.getPos(),a,n,t),r=this.formations.updateUnitsHungarian(s,o.positions,n);d(s,o,r,n,a),this.completeTask()}}function u(t,e){return t=t||256,e=e||100,function(i){var s=i.getClones(),n=Math.min(e,s.length),a=this.updateTargetPos(),o=this.formations.circlePositions(i.getPos(),a,n,t),r=this.formations.updateUnitsHungarian(s,o.positions,n);d(s,o,r,n,a),this.completeTask()}}function d(t,e,s,n,a){n=n||s.length;for(var o=a?a.x:0,r=a?a.y:0,h=e.positions,l=e.angles,c=0;n>c;c++){var u=h[s[c][0]],d=l[s[c][0]],p=t[s[c][1]],m=p.input,y=m.targetPos||x(0,0);y.x=u.x+o,y.y=u.y+r,null===m.targetPos&&(m.targetPos=y),m.targetAngle=d,p.isShadowClone&&m.setGoal({name:"move to",tasks:[i(A/2)]})}}function p(t){return t=t||1e3,function(e){if(t>this.goal.taskTime)for(var i=e.getClones(),s=0;i.length>s;s++){var n=i[s].input;if(n.goal&&!n.goal.met)return}this.completeTask()}}function m(){return function(t){for(var e=t.getClones(),i=0;e.length>i;i++){var s=e[i].input;s.goal&&s.goal.met&&0===s.goal.mapCollisions&&e[i].throwStar()}this.completeTask()}}function y(t){return t=t||120,function(){this.goal.taskTime>=t&&this.completeTask()}}function f(t){return t.x*t.x+t.y*t.y}function g(t,e){e||(t=v.copy({},t));var i=Math.sqrt(f(t));return t.x=t.x/i,t.y=t.y/i,t}var v=t.ec,b=t.cp,x=b.v,w=v.EnemyInput=function(){this.setBaseProperties(),this.turns=0,this.clones=0,this.formations=new v.Formations,v.debug>1&&Object.seal(this)},S=w.prototype;w.ready=function(){v.extend(S,v.GoalBasedInput.prototype)},S.selectGoal=function(){var t,e;return e=this.goalIndex+1,e>=M.length&&(e=0),t=M[e],this.goalIndex=e,t};var _=function(){this.targetEntity=v.player,this.completeTask()},C=function(){this.targetEntity=v.player,this.updateTargetPos(),this.completeTask()},A=64,k=512,T=12,P={faceOff:{name:"face off",tasks:[_,a(200,T),y(250)]},formLine:{name:"formation line",tasks:[_,a(350,T),y(33),r(8),h(8),l(80,200),y(166)]},waitForClones:{name:"wait for clones",tasks:[p(800)]},throwStars:{name:"throw stars",tasks:[_,m(),y(600)]},formCircleWithLeader:{name:"formation circle with leader",tasks:[_,r(8),h(8),c(360),i(A/2),y(1500)]},formCircle:{name:"formation circle",tasks:[_,a(360),r(8),u(200),y(1500)]},circleTarget:{name:"circle target",tasks:[y(1)]},rush:{name:"rush",tasks:[C,i(100),o(),r(18)]},scatter:{name:"scatter",tasks:[e(),i()]},avoid:{name:"avoid",tasks:[C,s(600),y(300)]},moveToPosition:{name:"move to",tasks:[i(A/2)]}},M=[P.formLine,P.waitForClones,P.throwStars,P.formCircleWithLeader,P.circleTarget,P.formCircle,P.rush]}(window),function(t){"use strict";var e=t.ec,i=e.ShadowCloneInput=function(){this.setBaseProperties(),e.debug>1&&Object.seal(this)},s=i.prototype;i.ready=function(){e.extend(s,e.GoalBasedInput.prototype)}}(window);