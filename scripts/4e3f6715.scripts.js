var ec=ec||{version:"0.1.164"};(function(a){"use strict",a.ec=ec;var b=a.document,c=a.Modernizr;c.addTest({mobile:function(){return/iPhone|iPad|iPod|Android/.test(navigator.userAgent)},ios:function(){return/iPhone|iPad|iPod/.test(navigator.userAgent)},ipad:function(){return/iPad/.test(navigator.userAgent)},android:function(){return/Android/.test(navigator.userAgent)},standalone:function(){return!!navigator.standalone}}),ec.webgl=c.webgl,ec.touch=c.touch,ec.mobile=c.mobile,ec.ios=c.ios,ec.ipad=c.ipad,ec.android=c.android,ec.fullscreen=c.fullscreen,ec.gamepads=c.gamepads,ec.debug=0;var d,e,f,g,h=ec.TIME_STEP=1e3/60,i=!1,j,k,l,m,n,o,p=null,q,r=2e3,s="extend,resizeDisplay,addBrowserListeners,Entity,Box,Circle,EmptyHand,Player,Ninja,Puff,World,Canvas2dView,TextField,ChipmunkDebugView,DebugView,UserInput,EnemyInput,SpriteSheets,ButtonOverlay".split(","),t="cp,THREE,createjs,Stats,dat".split(","),u=function(a,b){for(var c=0,d=b.length;c<d;c++)if(a[b[c]]===undefined)return!1;return!0},v=ec.core={load:function(b){if(!u(a,t)||!u(ec,s)){console.log("loading"),w(v.load);return}console.log("init"),v.init(b)},init:function(b){k=b,l=0,q=w(v.animate),m=new ec.UserInput,ec.world=d=new ec.World,d.addWalls(),ec.player=n=d.add((new ec.Player).setPos(-2,-155,0).setInput(m)),d.add((new ec.Circle(0,96)).setPos(-384,-208,0)),d.add((new ec.Circle(0,96)).setPos(384,-208,0)),d.add((new ec.Box(0)).setPos(-250,0,0)),d.add((new ec.Box(0)).setPos(250,0,0)),d.add((new ec.Box(0)).setPos(-250,250,0)),d.add((new ec.Box(0)).setPos(250,250,0)),d.add((new ec.Box(0)).setPos(-250,500,0)),d.add((new ec.Box(0)).setPos(250,500,0)),d.add((new ec.Box(0)).setPos(-500,-500,0)),d.add((new ec.Box(0)).setPos(500,-500,0));var c=new ec.EnemyInput;o=d.add((new ec.Ninja).setPos(250,64,0).setInput(c)),ec.resizeDisplay(),ec.SpriteSheets.init(),e=new ec.Canvas2dView,g=new ec.ChipmunkDebugView(d.space),f=new ec.DebugView,ec.debug&&ec.core.setDebugLevel(ec.debug),e.setInput(m),ec.addBrowserListeners(m);if(ec.touch){var h=e.width*ec.pixelRatio,j=e.height*ec.pixelRatioY||ec.pixelRatio;ec.ButtonOverlay.viewWidth=h,ec.ButtonOverlay.viewHeight=j,m.setLeftStickOverlay(m.addButtonOverlay(new ec.ButtonOverlay({x:160,y:j-160,radius:150}))),m.setRightStickOverlay(m.addButtonOverlay(new ec.ButtonOverlay({x:h-160,y:j-160,radius:150})));var r=m.addButtonOverlay(new ec.ButtonOverlay({x:h,y:50,radius:150})),s=m.addButtonOverlay(new ec.ButtonOverlay({x:0,y:50,radius:150}));ec.bind(r,"touchend",ec.core.togglePause,!1),ec.bind(s,"touchend",ec.core.cycleDebug,!1)}ec.mobile&&a.scrollTo(0,1),i=!0,p=new Image,p.src="img/ui/startscreen.png?v="+ec.version,e.lookAt(n.body.p.x,-n.body.p.y),ec.touch?ec.bind(ec.core.getViewDom(),"touchend",ec.core.start,!1):ec.bind(ec.core.getViewDom(),"mouseup",ec.core.start,!1),!!ec.touch,ec.core.trackEvent("core","inited",ec.version,undefined,!0)},start:function(a){p=null,ec.playerInteractions<1&&(p=new Image,ec.touch?(p.src="img/ui/guide-touch.png?v="+ec.version,ec.core.trackEvent("game","guide","guide-touch")):(p.src="img/ui/guide-move-desktop.png?v="+ec.version,ec.core.trackEvent("game","guide","guide-move-desktop"))),ec.unbind(ec.core.getViewDom(),a.type,ec.core.start,!1)},userReady:function(){p&&(ec.touch||(p=null,p=new Image,p.src="img/ui/guide-fight-desktop.png?v="+ec.version,ec.core.trackEvent("game","guide","guide-fight-desktop")))},userPlaying:function(){p=null},rollCredits:function(){ec.playerInteractions=36,p=new Image,p.src="img/ui/credits.png?v="+ec.version,ec.core.trackEvent("game","credits",ec.version),ec.touch?ec.bind(ec.core.getViewDom(),"touchend",ec.core.restart,!1):ec.bind(ec.core.getViewDom(),"mouseup",ec.core.restart,!1),x(q),q=w(v.animateCredits),e.initCredits(),d.term()},restart:function(a){p=null,x(q),q=w(v.init),ec.unbind(ec.core.getViewDom(),a.type,ec.core.start,!1)},animateCredits:function(a){q=w(v.animateCredits),ec.debug>0&&f.stats.begin(),j=a-k,k=a,j=Math.max(h,Math.min(j,h*10)),e.drawCredits(j),ec.debug>0&&f.stats.end()},animate:function(a){q=w(v.animate),ec.debug>0&&f.stats.begin(),j=a-k,k=a,j=Math.max(h,Math.min(j,h*10));if(!i){l+=j;while(l>=h)l-=h,d.step(h);e.lookAt(n.body.p.x,-n.body.p.y)}if(o.state==="dead"){o.decomposed=o.decomposed||0,o.decomposed+=j;if(o.decomposed>r){delete o.decomposed,ec.core.rollCredits();return}}ec.debug<3&&e.draw(d),ec.debug>0&&(ec.debug>1&&g.step(),f.stats.end())},getOverlay:function(){return p},pause:function(){console.log("pause"),i=!0,e.pause(),ec.allowPinchZoom()},resume:function(){console.log("resume"),i=!1,e.resume(),ec.preventPinchZoom()},togglePause:function(){ec.core.paused()?ec.core.resume():ec.core.pause()},paused:function(){return i},fullscreen:function(){if(ec.fullscreen){var a=b.body;a.requestFullscreen=a.requestFullscreen||a.mozRequestFullscreen||a.mozRequestFullScreen||a.webkitRequestFullscreen,a.requestFullscreen()}},resize:function(){ec.resizeDisplay()&&(e.resize(),g.resize())},getViewDom:function(){return e.getDom()},trackPage:function(b){a._gaq&&a._gaq.push(["_trackPageview",b])},trackEvent:function(b,c,d,e,f){a._gaq&&a._gaq.push(["_trackEvent",b,c,d,e,f])},trackCustom:function(b,c,d,e){a._gaq&&a._gaq.push(["_setCustomVar",b,c,d,e])},setDebugLevel:function(a){a<0&&(a=3),f.hide(),g.hide();switch(a){case 3:case 2:g.show();case 1:f.show()}ec.debug=a,console.log("debug level",a)},cycleDebug:function(){ec.core.setDebugLevel(ec.debug-1)}};ec.extend=function(a,b){for(var c in b)if(b.hasOwnProperty(c)&&!a.hasOwnProperty(c)){var d=b[c];d!==undefined&&(a[c]=b[c])}return a},ec.create=function(a){function b(){}return b.prototype=a,new b},ec.delegate=function(a,b){return function(){return b.apply(a,arguments)}},Date.now||(Date.now=function(){return+(new Date)});var w=a.requestAnimationFrame||c.prefixed("RequestAnimationFrame",a),x=a.cancelAnimationFrame||c.prefixed("CancelAnimationFrame",a)||c.prefixed("CancelRequestAnimationFrame",a)||function(b){a.clearTimeout(b)};if(!w){var y=0;w=function(b,c){var d=Date.now(),e=Math.max(0,16-(d-y)),f=a.setTimeout(function(){b(d+e)},e);return y=d+e,f}}w(v.load),ec.core.trackEvent("core","preload",ec.version,undefined,!0)})(window),window.Modernizr=function(a,b,c){function d(a){q.cssText=a}function e(a,b){return d(t.join(a+";")+(b||""))}function f(a,b){return typeof a===b}function g(a,b){return!!~(""+a).indexOf(b)}function h(a,b){for(var d in a){var e=a[d];if(!g(e,"-")&&q[e]!==c)return b=="pfx"?e:!0}return!1}function i(a,b,d){for(var e in a){var g=b[a[e]];if(g!==c)return d===!1?a[e]:f(g,"function")?g.bind(d||b):g}return!1}function j(a,b,c){var d=a.charAt(0).toUpperCase()+a.slice(1),e=(a+" "+v.join(d+" ")+d).split(" ");return f(b,"string")||f(b,"undefined")?h(e,b):(e=(a+" "+w.join(d+" ")+d).split(" "),i(e,b,c))}var k="2.6.2",l={},m=!0,n=b.documentElement,o="modernizr",p=b.createElement(o),q=p.style,r,s={}.toString,t=" -webkit- -moz- -o- -ms- ".split(" "),u="Webkit Moz O ms",v=u.split(" "),w=u.toLowerCase().split(" "),x={},y={},z={},A=[],B=A.slice,C,D=function(a,c,d,e){var f,g,h,i,j=b.createElement("div"),k=b.body,l=k||b.createElement("body");if(parseInt(d,10))while(d--)h=b.createElement("div"),h.id=e?e[d]:o+(d+1),j.appendChild(h);return f=["&#173;",'<style id="s',o,'">',a,"</style>"].join(""),j.id=o,(k?j:l).innerHTML+=f,l.appendChild(j),k||(l.style.background="",l.style.overflow="hidden",i=n.style.overflow,n.style.overflow="hidden",n.appendChild(l)),g=c(j,a),k?j.parentNode.removeChild(j):(l.parentNode.removeChild(l),n.style.overflow=i),!!g},E=function(){function a(a,e){e=e||b.createElement(d[a]||"div"),a="on"+a;var g=a in e;return g||(e.setAttribute||(e=b.createElement("div")),e.setAttribute&&e.removeAttribute&&(e.setAttribute(a,""),g=f(e[a],"function"),f(e[a],"undefined")||(e[a]=c),e.removeAttribute(a))),e=null,g}var d={select:"input",change:"input",submit:"form",reset:"form",error:"img",load:"img",abort:"img"};return a}(),F={}.hasOwnProperty,G;!f(F,"undefined")&&!f(F.call,"undefined")?G=function(a,b){return F.call(a,b)}:G=function(a,b){return b in a&&f(a.constructor.prototype[b],"undefined")},Function.prototype.bind||(Function.prototype.bind=function(a){var b=this;if(typeof b!="function")throw new TypeError;var c=B.call(arguments,1),d=function(){if(this instanceof d){var e=function(){};e.prototype=b.prototype;var f=new e,g=b.apply(f,c.concat(B.call(arguments)));return Object(g)===g?g:f}return b.apply(a,c.concat(B.call(arguments)))};return d}),x.canvas=function(){var a=b.createElement("canvas");return!!a.getContext&&!!a.getContext("2d")},x.canvastext=function(){return!!l.canvas&&!!f(b.createElement("canvas").getContext("2d").fillText,"function")},x.webgl=function(){return!!a.WebGLRenderingContext},x.touch=function(){var c;return"ontouchstart"in a||a.DocumentTouch&&b instanceof DocumentTouch?c=!0:D(["@media (",t.join("touch-enabled),("),o,")","{#modernizr{top:9px;position:absolute}}"].join(""),function(a){c=a.offsetTop===9}),c},x.hashchange=function(){return E("hashchange",a)&&(b.documentMode===c||b.documentMode>7)},x.history=function(){return!!a.history&&!!history.pushState},x.websockets=function(){return"WebSocket"in a||"MozWebSocket"in a},x.video=function(){var a=b.createElement("video"),c=!1;try{if(c=!!a.canPlayType)c=new Boolean(c),c.ogg=a.canPlayType('video/ogg; codecs="theora"').replace(/^no$/,""),c.h264=a.canPlayType('video/mp4; codecs="avc1.42E01E"').replace(/^no$/,""),c.webm=a.canPlayType('video/webm; codecs="vp8, vorbis"').replace(/^no$/,"")}catch(d){}return c},x.audio=function(){var a=b.createElement("audio"),c=!1;try{if(c=!!a.canPlayType)c=new Boolean(c),c.ogg=a.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),c.mp3=a.canPlayType("audio/mpeg;").replace(/^no$/,""),c.wav=a.canPlayType('audio/wav; codecs="1"').replace(/^no$/,""),c.m4a=(a.canPlayType("audio/x-m4a;")||a.canPlayType("audio/aac;")).replace(/^no$/,"")}catch(d){}return c},x.localstorage=function(){try{return localStorage.setItem(o,o),localStorage.removeItem(o),!0}catch(a){return!1}},x.applicationcache=function(){return!!a.applicationCache};for(var H in x)G(x,H)&&(C=H.toLowerCase(),l[C]=x[H](),A.push((l[C]?"":"no-")+C));return l.addTest=function(a,b){if(typeof a=="object")for(var d in a)G(a,d)&&l.addTest(d,a[d]);else{a=a.toLowerCase();if(l[a]!==c)return l;b=typeof b=="function"?b():b,typeof m!="undefined"&&m&&(n.className+=" "+(b?"":"no-")+a),l[a]=b}return l},d(""),p=r=null,l._version=k,l._prefixes=t,l._domPrefixes=w,l._cssomPrefixes=v,l.hasEvent=E,l.testProp=function(a){return h([a])},l.testAllProps=j,l.testStyles=D,l.prefixed=function(a,b,c){return b?j(a,b,c):j(a,"pfx")},n.className=n.className.replace(/(^|\s)no-js(\s|$)/,"$1$2")+(m?" js "+A.join(" "):""),l}(this,this.document),Modernizr.addTest("webaudio",!!window.webkitAudioContext||!!window.AudioContext),Modernizr.addTest("contextmenu","contextMenu"in document.documentElement&&"HTMLMenuItemElement"in window),Modernizr.addTest("fullscreen",function(){for(var a=0;a<Modernizr._domPrefixes.length;a++)if(document[Modernizr._domPrefixes[a].toLowerCase()+"CancelFullScreen"])return!0;return!!document.cancelFullScreen||!1}),Modernizr.addTest("gamepads",!!Modernizr.prefixed("getGamepads",navigator)),Modernizr.addTest("json",!!window.JSON&&!!JSON.parse),Modernizr.addTest("getusermedia",!!Modernizr.prefixed("getUserMedia",navigator)),Modernizr.addTest("raf",!!Modernizr.prefixed("requestAnimationFrame",window)),Modernizr.addTest("vibrate",!!Modernizr.prefixed("vibrate",navigator)),function(){if(!Modernizr.webgl)return;var a,b,c;try{a=document.createElement("canvas"),b=a.getContext("webgl")||a.getContext("experimental-webgl"),c=b.getSupportedExtensions()}catch(d){return}b===undefined?Modernizr.webgl=new Boolean(!1):Modernizr.webgl=new Boolean(!0);for(var e=-1,f=c.length;++e<f;)Modernizr.webgl[c[e]]=!0;window.TEST&&TEST.audvid&&TEST.audvid.push("webgl"),a=undefined}(),function(a){"use strict";var b=a.ec,c=a.document,d=b.android&&c.querySelector&&c.querySelector('meta[name="viewport"]');b.addBrowserListeners=function(d){this.bind(a,"blur",this.core.pause,!1),b.touch?(this.bind(b.core.getViewDom(),"touchstart",d.touchstart,!1),this.bind(b.core.getViewDom(),"touchmove",d.touchmove,!1),this.bind(b.core.getViewDom(),"touchend",d.touchend,!1)):(this.bind(b.core.getViewDom(),"mousedown",d.mousedown,!1),this.bind(b.core.getViewDom(),"mouseup",d.mouseup,!1)),b.mobile||this.bind(a,"resize",this.core.resize,!1),this.bind(c,"keydown",d.keydown,!1),this.bind(c,"keyup",d.keyup,!1)},b.preventPinchZoom=function(){b.android&&d&&(d.content="width=device-width, user-scalable=0")},b.allowPinchZoom=function(){b.android&&d&&(d.content="width=device-width, user-scalable=1")},b.bind=function(a,b,c,d){d=d||!1,a.addEventListener?a.addEventListener(b,c,d):a.attachEvent?a.attachEvent("on"+b,c):a["on"+b]=c},b.unbind=function(a,b,c,d){d=d||!1,a.removeEventListener?a.removeEventListener(b,c,d):a.detachEvent?a.detachEvent("on"+b,c):delete a["on"+b]}}(window),function(a){"use strict";var b=a.ec,c=a.document;b.resizeDisplay=function(){var d,e,f,g;d=e=b.forcePixelRatio||a.devicePixelRatio||1,b.ipad&&!b.webgl&&(e=Math.min(1.333333,d),d=Math.min(1,d));if(b.mobile){var h=Math.max(a.screen.width,a.screen.height),i=Math.min(a.screen.width,a.screen.height);f=h,g=i}else{var j=16,k=9,l,m;f=j,g=k,l=a.innerWidth,m=a.innerHeight;while(f+j<=l&&g+k<=m)f+=j,g+=k;c.body.style.left=Math.floor((l-f)/2)+"px",c.body.style.top=Math.floor((m-g)/2)+"px"}return b.width!==f||b.height!==g||b.pixelRatio!==d||b.pixelRatioY!==e?(b.pixelRatio=d,b.pixelRatioY=e,b.width=f,b.height=g,c.body.style.width=f+"px",c.body.style.height=g+"px",!0):!1}}(window),function(a){"use strict";var b=a.cp,c=b.v,d=a.ec.Entity=function(){console.log("new Entity",this)};d.groupId=1;var e=d.prototype;e.z=0,e.groupId=b.NO_GROUP,e.setView=function(a){return this.view=a,this},e.setInput=function(a){return this.input=a,this},e.step=function(a){return this},e.hit=function(a){return console.log("HIT",this),this},e.setPos=function(a,b,c){this.body.activate(),this.body.p.x=a,this.body.p.y=b,c!==undefined&&(this.z=this.body.z=c);if(this.body.isStatic())for(var d=0;d<this.body.shapeList.length;d++){var e=this.body.shapeList[d];e.update(this.body.p,this.body.rot),e.space&&e.space.staticShapes.reindexObject(e,e.hashid)}return this};var f=function(a,c){var d;return a===0?(d=new b.Body(Infinity,Infinity),d.nodeIdleTime=Infinity):d=new b.Body(a,c),d};e.assignCircleShape=function(a,d,e){return e=e||b.momentForCircle(d,0,a,c(0,0)),this.radius=a,this.body=f(d,e),this.shape=new b.CircleShape(this.body,a,c(0,0)),this},e.assignBoxShape=function(a,c,d,e){return e=e||b.momentForBox(d,a,c),this.width=a,this.height=c,this.body=f(d,e),this.shape=new b.BoxShape(this.body,a,c),this}}(window),function(a){"use strict";var b=a.ec,c=64,d=64,e=a.ec.Box=function(a,e,f){e=e||c,f=f||d,a===undefined&&(a=1),this.assignBoxShape(e,f,a),this.shape.setElasticity(0),this.shape.setFriction(.6),this.setPos(-64,0,0),this.shape.collision_type=b.World.PROP_TYPE},f=e.prototype;b.extend(f,b.Entity.prototype)}(window),function(a){"use strict";var b=a.ec,c=32,d=a.ec.Circle=function(a,d){d=d||c,a===undefined&&(a=1),this.assignCircleShape(d,a),this.shape.setElasticity(0),this.shape.setFriction(.6),this.setPos(64,64,0),this.shape.collision_type=b.World.PROP_TYPE},e=d.prototype;b.extend(e,b.Entity.prototype)}(window),function(a){"use strict";var b=a.ec,c=a.cp,d=c.v,e=Math.abs,f=32,g=d(0,0),h=d(0,0);b.playerInteractions=0;var i=a.ec.Player=function(){this.groupId=b.Entity.groupId++,this.assignCircleShape(f,1),this.shape.setElasticity(0),this.shape.setFriction(0),this.body.a=-1.57,this.shape.collision_type=b.World.PLAYER_TYPE,this.shape.group=this.groupId,this.state="standing",this.walkCount=0,this.speed=8,this.attack=new b.EmptyHand(f-4,1),b.core.trackCustom(1,"Player Interacted","No",2)},j=i.prototype;b.extend(j,b.Entity.prototype),j.punch=function(a,c,e){if(this.passive())return;var f=this.attack;f.shape.group===0&&(f.shape.group=this.groupId,this.attack=f);if(f.phase>b.EmptyHand.PASSIVE)return;c.contains(f)&&c.remove(f),f.time=0,f.startTime=a,f.phase=b.EmptyHand.PUSHING,f.setPos(this.body.p.x,this.body.p.y,this.z),this.body.w=0,this.body.a=f.body.a=Math.atan2(h.y,h.x);var i=.75;this.body.vx*=i,this.body.vy*=i,f.body.resetForces(),f.body.activate();var j=d.mult(h,this.speed*1e3/e);f.body.vx=j.x+g.x*i,f.body.vy=j.y+g.y*i,c.add(f)},j.attackEnd=function(a,c){var d=this.attack;d.time=0,d.startTime=-1,d.phase=b.EmptyHand.PASSIVE,c.contains(d)&&c.remove(d),b.playerInteractions===2&&(b.playerInteractions=3,b.core.userPlaying())},j.passive=function(){return h.x===0&&h.y===0},j.step=function(a){this.input.poll(),this.body.resetForces(),this.attack.entityStep(b.world.time,b.world,this);if(this.attack.phase===b.EmptyHand.PASSIVE||this.attack.phase===b.EmptyHand.PULLING)g.x=this.input.axes[0],g.y=-this.input.axes[1],e(g.x)>.1||e(g.y)>.1?((e(g.x)>.7||e(g.y)>.7)&&g.mult(1/d.len(g)),this.state="walking",g.mult(this.speed*1e3/a),this.body.activate(),this.body.vx+=g.x,this.body.vy+=g.y,this.body.vx*=.5,this.body.vy*=.5,this.body.w=0,this.body.a=Math.atan2(g.y,g.x),b.playerInteractions===0&&(b.playerInteractions=1,b.core.trackCustom(1,"Player Interacted","Yes",2))):(this.state="standing",this.walkCount=0,this.body.vx=0,this.body.vy=0,this.body.w*=.99,b.playerInteractions===1&&(b.playerInteractions=2,b.core.userReady()));return h.x=this.input.axes[2],h.y=-this.input.axes[3],this.input.buttons[0]>0&&(h.x=Math.cos(this.body.a),h.y=Math.sin(this.body.a)),e(h.x)>.1||e(h.y)>.1?(h.mult(1/d.len(h)),this.punch(b.world.time,b.world,a),this.state="punching"):(h.x=0,h.y=0),this}}(window),function(a){"use strict";var b=a.ec,c=a.cp,d=c.v,e=b.EmptyHand=function(a,c){a=a||24,c=c||1,this.assignCircleShape(a,c),this.shape.setElasticity(.5),this.shape.setFriction(1),this.shape.collision_type=b.World.PLAYER_HAND,this.setPos(64,64,64),this.time=0,this.startTime=-1,this.phase=e.PASSIVE,this.pushDuration=5e3/60,this.grabDuration=1e4/60,this.punchDuration=this.pushDuration+this.grabDuration/2};e.PASSIVE=0,e.PUSHING=1,e.GRABBING=2,e.PULLING=3;var f=e.prototype;b.extend(f,b.Entity.prototype),f.entityStep=function(a,c,d){if(this.phase){this.time=a-this.startTime;if(this.phase===b.EmptyHand.PUSHING)this.time<this.punchDuration||(d.passive()?d.attackEnd(a,c):this.time>this.pushDuration&&(this.phase=b.EmptyHand.GRABBING));else if(this.phase===b.EmptyHand.GRABBING){this.body.vx*=.9,this.body.vy*=.9;if(d.passive())d.attackEnd(a,c);else if(this.time>this.pushDuration+this.grabDuration){var e=!1;e||d.attackEnd(a,c)}}else this.phase===b.EmptyHand.PULLING&&d.passive()&&(d.attackEnd(a,c),console.log("pull ended passively"))}}}(window),function(a){"use strict";var b=a.ec,c=a.cp,d=c.v,e=Math.abs,f=32,g=d(0,0),h=d(0,0),i=b.Ninja=function(){this.groupId=b.Entity.groupId++,this.assignCircleShape(f,1),this.shape.setElasticity(0),this.shape.setFriction(0),this.body.a=3,this.shape.collision_type=b.World.MONSTER_TYPE,this.shape.group=this.groupId,this.state="standing",this.walkCount=0,this.speed=8,this.attack=new b.EmptyHand(f-4,1),this.isShadowClone=!1,this.hitPoints=100},j=i.prototype;b.extend(j,b.Entity.prototype),j.shadowClone=function(){if(this.isShadowClone){console.error("shadow clone tried to clone itself!");return}var a=(new b.Ninja).setPos(this.body.p.x,this.body.p.y,0).setInput(new b.EnemyInput);a.isShadowClone=!0,a.master=this,b.world.add(a),b.world.add(new b.Puff(this)),b.world.add(new b.Puff(a))},j.hit=function(a,b,c){var d=a&&a.totalKE()||1e3;return d>0&&this.state!=="hit"&&this.state!=="dead"&&(this.state="hit",this.isShadowClone?(this.hitTime=400,this.hitPoints=c?0:this.hitPoints):(this.hitPoints-=c,this.hitTime=600),this.hitDuration=this.hitTime,this.body.w=d/1e4,this.body.vx*=2,this.body.vy*=2),this},j.step=function(a){if(this.hitTime>0)return this.isShadowClone&&this.hitTime===this.hitDuration&&this.hitPoints===0&&b.world.add(new b.Puff(this)),this.hitTime-=a,this.hitTime<=0&&(this.hitTime=0,this.hitPoints<=0?(this.state="dead",this.isShadowClone&&b.world.remove(this)):this.state="standing"),this;if(this.isShadowClone&&this.master.hitPoints<=0)b.world.add(new b.Puff(this)),this.hit(null,b.world,1);else if(this.state==="dead")return this.body.vx=0,this.body.vy=0,this.body.w*=.5,this;this.input.poll(this),this.body.resetForces();if(this.attack.phase===b.EmptyHand.PASSIVE||this.attack.phase===b.EmptyHand.PULLING)g.x=this.input.axes[0],g.y=-this.input.axes[1],e(g.x)>.1||e(g.y)>.1?((e(g.x)>.7||e(g.y)>.7)&&g.mult(1/d.len(g)),g.mult(this.speed*1e3/a),this.body.activate(),this.body.vx+=g.x,this.body.vy+=g.y,this.body.vx*=.5,this.body.vy*=.5,this.body.w=0,this.body.a=Math.atan2(g.y,g.x)):(this.body.vx=0,this.body.vy=0,this.body.w*=.99);return h.x=this.input.axes[2],h.y=-this.input.axes[3],e(h.x)>.1||e(h.y)>.1?h.mult(1/d.len(h)):(h.x=0,h.y=0),this}}(window),function(a){"use strict";var b=a.ec,c=50,d=b.Puff=function(a){this.groupId=a.groupId,this.assignCircleShape(c,1),this.shape.setElasticity(0),this.shape.setFriction(0),this.shape.sensor=!0,this.time=this.duration=500,this.master=a,this.setPos(a.body.p.x,a.body.p.y-1,0)},e=d.prototype;b.extend(e,b.Entity.prototype),e.step=function(a){this.time-=a,this.time<=0?(this.time=0,b.world.remove(this),delete this.master):this.setPos(this.master.body.p.x,this.master.body.p.y-1,this.z+1)}}(window),function(a){"use strict";var b=a.ec,c=a.cp,d=c.v,e=1<<31,f=~e,g=640,h=b.World=function(){this.time=0;var a=this.space=new c.Space;a.gravity=d(0,0),a.iterations=10,a.sleepTimeThreshold=b.TIME_STEP*9,a.idleSpeedThreshold=.1,a.collisionSlop=.025,a.collisionBias=Math.pow(.25,60),a.damping=.5;var e=b.delegate(this,this.pushCollision),f=b.delegate(this,this.bumpCollision);a.addCollisionHandler(h.PLAYER_HAND,h.MONSTER_TYPE,null,null,e,null),a.addCollisionHandler(h.MONSTER_TYPE,h.MONSTER_TYPE,f,null,f,null),this.entities=[]};h.PLAYER_TYPE=1,h.PLAYER_HAND=2,h.MONSTER_TYPE=10,h.PROP_TYPE=100;var i=h.prototype;i.term=function(){this.entities.length=0;var a=this.space;a.locked=0,a.removeCollisionHandler(h.PLAYER_HAND,h.MONSTER_TYPE),a.removeCollisionHandler(h.MONSTER_TYPE,h.MONSTER_TYPE),a.bodies.length=0,a.sleepingComponents.length=0,a.constraints.length=0,a.arbiters.length=0,a.constraints.length=0,delete this.space};var j=10;i.pushCollision=function(a,b){var c=a.swappedColl?a.body_a:a.body_b,d=this.entityForBody(c);return d?(d.hit(a,this,j),a.ignore(),!1):a.contacts&&a.contacts.length},i.bumpCollision=function(a,b){var c=this.entityForBody(a.body_a),d=this.entityForBody(a.body_b);return c&&d?(c.hitTime&&!d.hitTime?d.hit(a,this,0):d.hitTime&&!c.hitTime&&c.hit(a,this,0),!(c.hitTime>0&&d.hitTime>0)):!0},i.addWalls=function(){this.addBox(d(0,-g-64),g*2+256,128),this.addBox(d(0,g+64),g*2+256,128),this.addBox(d(g+64,0),128,g*2+256),this.addBox(d(-g-64,0),128,g*2+256)},i.addBox=function(a,b,d){var e=new c.Body(Infinity,Infinity);e.nodeIdleTime=Infinity,e.p=a;var g=this.space.addShape(new c.BoxShape(e,b,d));return g.setElasticity(0),g.setFriction(1),g.setLayers(f),g},i.addLineSegment=function(a,b){var d=this.space.addShape(new c.SegmentShape(this.space.staticBody,a,b,0));return d.setElasticity(0),d.setFriction(1),d.setLayers(f),d},i.add=function(a){return this.entities.indexOf(a)<0?(a.body.isStatic()||this.space.addBody(a.body),this.space.addShape(a.shape),this.entities.push(a),a):(console.error("entity already a child of world",a),null)},i.remove=function(a){var b=this.entities.indexOf(a);return b>-1?(a.body.isStatic()||this.space.removeBody(a.body),this.space.removeShape(a.shape),this.entities.splice(b,1),a):(console.error("entity not a child of world",a),null)},i.contains=function(a){return this.entities.indexOf(a)>-1},i.entityForBody=function(a){for(var b=this.entities.length;b-->0;)if(this.entities[b].body===a)return this.entities[b];return console.error("no entity for body",a),null},i.createStaticBody=function(){var a=new c.Body(Infinity,Infinity);return a.nodeIdleTime=Infinity,a},i.step=function(a){for(var b=this.entities.length;b-->0;)this.entities[b].step(a);this.space.step(a/1e3),this.time+=a}}(window),function(a){"use strict";var b=a.ec;b.SpriteSheets={init:function(){b.SpriteSheets.monk=new a.createjs.SpriteSheet({images:["img/sprite/minimonk_64.png?v="+b.version],frames:[[0,0,74,137,0,37,126],[74,0,64,142,0,36,125],[138,0,64,137,0,35,123],[202,0,72,136,0,35,126],[274,0,64,137,0,27,123],[338,0,64,142,0,26,125],[402,0,74,141,0,40,129],[0,142,61,139,0,32,126],[61,142,67,141,0,33,129],[128,142,65,140,0,33,127],[193,142,77,142,0,43,126],[270,142,48,143,0,26,125],[318,142,53,143,0,29,125],[371,142,64,135,0,32,126],[435,142,66,134,0,33,125],[0,285,51,136,0,26,123],[51,285,68,134,0,36,125],[119,285,66,136,0,39,123],[185,285,67,138,0,34,128],[252,285,64,140,0,30,126],[316,285,67,138,0,34,128],[383,285,64,140,0,33,126],[0,425,66,134,0,32,125],[66,425,51,136,0,24,123],[117,425,68,134,0,31,125],[185,425,66,136,0,26,123],[251,425,77,142,0,32,126],[328,425,48,143,0,20,125],[376,425,53,143,0,22,125],[429,425,64,135,0,30,126],[0,568,74,137,0,37,126],[74,568,74,138,0,41,116],[148,568,69,134,0,34,113],[217,568,73,144,0,40,100],[74,0,64,142,0,36,125],[290,568,48,142,0,43,124],[338,568,77,144,0,80,126],[415,568,91,135,0,108,116],[0,712,64,137,0,35,123],[64,712,68,139,0,38,126],[132,712,52,142,0,41,131],[184,712,45,139,0,46,130],[229,712,72,136,0,35,126],[301,712,64,137,0,30,136],[365,712,67,138,0,34,142],[432,712,61,138,0,34,144],[0,854,64,137,0,27,123],[64,854,68,139,0,28,126],[132,854,52,142,0,9,131],[184,854,45,139,0,-2,130],[338,0,64,142,0,26,125],[229,854,47,142,0,33,124],[276,854,77,144,0,-4,126],[353,854,91,135,0,-18,116]],animations:{standing:0,walk_0:6,walk_1:10,walk_2:14,walk_3:18,walk_4:22,walk_5:26,punch_0:30,punch_1:34,punch_2:38,punch_3:42,punch_4:46,punch_5:50}}),b.SpriteSheets.ninja=new a.createjs.SpriteSheet({images:["img/sprite/ninja_64.png?v="+b.version],frames:[[0,0,74,137,0,37,126],[74,0,59,141,0,32,124],[133,0,69,138,0,35,124],[202,0,73,138,0,36,127],[275,0,69,138,0,32,124],[344,0,59,141,0,25,124],[403,0,96,85,0,42,93],[0,141,101,113,0,51,99],[101,141,89,105,0,42,91],[190,141,81,85,0,41,83],[271,141,78,32,0,41,57],[349,141,119,108,0,44,125],[0,254,127,78,0,47,93],[127,254,145,55,0,53,62],[272,254,140,43,0,58,31]],animations:{standing:0,puff:6,fall:11}}),b.SpriteSheets.lion=new a.createjs.SpriteSheet({images:["img/sprite/lion_64.png?v="+b.version],frames:[[0,0,80,212,0,40,180]]}),b.SpriteSheets.shadow=new a.createjs.SpriteSheet({images:["img/sprite/shadow_64.png?v="+b.version],frames:[[0,0,80,54,0,40,26]]}),b.SpriteSheets.cauldron=new a.createjs.SpriteSheet({images:["img/sprite/cauldron_64.png?v="+b.version],frames:[[0,0,256,255,0,128,148]]})}}}(window),function(a){"use strict";var b=a.ec,c=b.Canvas2dView=function(){this.x=this.y=-16,this.scale=1;var b=this.canvas=a.document.createElement("canvas");b.style.position="absolute",this.context=b.getContext("2d"),this.resize(),a.document.body.appendChild(b),this.map={draw:function(a){a.drawImage(this.canvas,-640,-640,this.canvas.width,this.canvas.height)},canvas:a.document.createElement("canvas"),tile:new Image},this.map.canvas.width=1280,this.map.canvas.height=1280;var c=this.map.context=this.map.canvas.getContext("2d");this.map.tile.onload=function(){console.log("loaded",this.width,this.height);for(var a=0;a<400;a++){var b=a%20*64,d=Math.floor(a/20)*64;c.drawImage(this,b,d,this.width,this.height)}},this.map.tile.src="img/tile/floor_8888_64.png",this.drawEntities=this.drawEntity()},d=c.prototype;d.drawEntity=function(){var a=this.context,c=b.SpriteSheets.monk,d=b.SpriteSheets.ninja,e=Math.PI,f=Math.round,g=function(a,b){var c=a.body.a,d=6,g=c+e/6,h,i,j;c===0&&(g-=.1);var k=(5-f(g*3/e))%6;while(k<0)k+=d;if(a.state==="walking"){var l=Math.sqrt(a.body.vx*a.body.vx+a.body.vy*a.body.vy);a.walkCount+=Math.max(.15,l/2500),h=b.getAnimation("walk_"+k),h?(i=Math.floor(a.walkCount)%4,k=h.frames[0]+i):console.error("no walk_"+k)}else if(a.state==="punching")h=b.getAnimation("punch_"+k),h?(j=a.attack.time/a.attack.pushDuration,i=Math.min(3,Math.floor(j*3)),k=h.frames[0]+i):console.error("no walk_"+k);else if(a.state==="hit"||a.state==="dead")h=b.getAnimation("fall"),h?(a.state==="dead"?i=3:(j=(a.hitDuration-a.hitTime)/a.hitDuration,i=Math.min(3,Math.floor(j*2))),k=h.frames[0]+i):console.error("no fall");var m=b.getFrame(k);return m===null?(b.complete&&console.error("SpriteSheet null frame. Complete:",b.complete,k,"/",b.getNumFrames(),b.getAnimations()),null):m},h=b.SpriteSheets.lion.getFrame(0),i=b.SpriteSheets.cauldron.getFrame(0);return function(f){var j=f.body.p.x,k=-f.body.p.y-f.z,l,m;a.save();if(f instanceof b.Ninja)l=g(f,d),l&&(m=l.rect,a.drawImage(l.image,m.x,m.y,m.width,m.height,j-l.regX,k-l.regY,m.width,m.height));else if(f instanceof b.Puff){var n=d.getAnimation("puff");if(n){var o=n.frames[0]+Math.floor(4.9*(f.duration-f.time)/f.duration);l=d.getFrame(o),l&&(m=l.rect,a.drawImage(l.image,m.x,m.y,m.width,m.height,j-l.regX,k-l.regY,m.width,m.height))}else console.error("no puff")}else f instanceof b.Player?(l=g(f,c),l&&(m=l.rect,a.drawImage(l.image,m.x,m.y,m.width,m.height,j-l.regX,k-l.regY,m.width,m.height))):f instanceof b.EmptyHand||(f instanceof b.Box?(a.fillStyle="#888888",l=h||b.SpriteSheets.lion.getFrame(0),l&&(m=l.rect,a.drawImage(l.image,m.x,m.y,m.width,m.height,j-l.regX,k-l.regY,m.width,m.height))):f instanceof b.Circle?(a.fillStyle="#888888",l=i||b.SpriteSheets.cauldron.getFrame(0),l&&(m=l.rect,a.drawImage(l.image,m.x,m.y,m.width,m.height,j-l.regX,k-l.regY,m.width,m.height))):f.radius?(a.fillStyle="#ff8000",a.beginPath(),a.arc(j,k,f.radius,0,2*e,!1),a.fill()):f.width&&f.height?(a.fillStyle="#0008ff",a.beginPath(),a.fillRect(j-f.width/2,k-f.height/2,f.width,f.height)):(a.fillStyle="#000088",a.beginPath(),a.fillRect(j-32,k-32,64,64)));a.restore()}},d.drawShadow=function(a){var c=b.SpriteSheets.shadow.getFrame(0);if(c){var d=a.body.p.x,e=-a.body.p.y-a.z,f=c.rect,g=this.context;g.save(),(a instanceof b.Ninja||a instanceof b.Player)&&g.drawImage(c.image,f.x,f.y,f.width,f.height,d-c.regX,e-c.regY,f.width,f.height),g.restore()}},d.lookAt=function(a,b){this.x=-this.canvas.width/this.scaleX/2+a,this.y=-this.canvas.height/this.scaleY/2+b-64},d.zoom=function(a){var c=b.pixelRatio,d=b.pixelRatioY||c;this.scale=a,a=a*b.height/640,this.scaleX=c*a,this.scaleY=d*a,this.context.scale(this.scaleX,this.scaleY)},d.setInput=function(a){return this.input=a,a.resize(this.width,this.height),this};var e=function(a,b){return a.body.p.y>b.body.p.y?-1:b.body.p.y>a.body.p.y?1:0};d.draw=function(a){var c=this.context;c.save(),c.setTransform(1,0,0,1,0,0),c.fillStyle="#888888",c.globalAlpha=1,c.fillRect(0,0,this.canvas.width,this.canvas.height),c.save(),c.scale(this.scaleX,this.scaleY),c.translate(-this.x,-this.y),this.map.draw(c);var d=a.entities;a.space.activeShapes.count>0&&d.sort(e);var f=0,g=d.length;while(f<g)this.drawShadow(d[f]),this.drawEntities(d[f]),f++;c.restore(),this.input&&this.input.draw(c,this.canvas.width,this.canvas.height),b.core.paused()?(c.fillStyle="#000000",c.globalAlpha=.33,c.fillRect(0,0,this.canvas.width,this.canvas.height),c.fillStyle="#ffffff",c.globalAlpha=.8,c.beginPath(),c.moveTo(this.canvas.width-15,35),c.lineTo(this.canvas.width-50,15),c.lineTo(this.canvas.width-50,55),c.fill()):b.touch&&(c.fillStyle="#ffffff",c.globalAlpha=.8,c.fillRect(this.canvas.width-43,15,10,40),c.fillRect(this.canvas.width-25,15,10,40));var h=b.core.getOverlay();if(h){var i=this.canvas.height/h.height,j=this.canvas.width-h.width*i,k=this.canvas.height-h.height*i;c.globalAlpha=1,c.drawImage(h,j/2,k/2,h.width*i,h.height*i)}c.restore()},d.initCredits=function(){var a=this.context;a.setTransform(1,0,0,1,0,0),a.fillStyle="#000",a.globalAlpha=.1,this.creditsTime=0},d.drawCredits=function(a){var c=this.context;c.fillRect(0,0,this.canvas.width,this.canvas.height),c.globalAlpha=Math.min(1,c.globalAlpha+.1),this.creditsTime+=a;var d=Math.floor(this.creditsTime*24/1e3)*4,e=b.core.getOverlay(),f=this.canvas.height/e.height,g=this.canvas.width-e.width*f,h=Math.max(-258*f,this.canvas.height-d);c.drawImage(e,g/2,h,e.width*f,e.height*f)},d.pause=function(){},d.resume=function(){},d.getDom=function(){return this.canvas},d.resize=function(){var a=b.pixelRatio,c=b.pixelRatioY||a,d=this.canvas;this.width=b.width,this.height=b.height,d.width=this.width*a,d.height=this.height*c,d.style.width=this.width+"px",d.style.height=this.height+"px",this.zoom(this.scale),this.input&&this.input.resize(this.width,this.height)},d.debugGui=function(a){var c=this,d=function(){var a=b.pixelRatio,d=b.pixelRatioY;b.resizeDisplay(),b.pixelRatio=a,b.pixelRatioY=d,c.resize()};a.addGui([{name:"view",remember:!0,target:c,props:[{name:"x",params:{min:-480,max:1600}},{name:"y",params:{min:-320,max:1600}},{name:"scale",onChange:function(a){c.zoom(a)},params:{step:.01,min:.25,max:4}}]},{name:"pixelRatio",target:b,props:[{name:"pixelRatio",params:{min:1,max:2,step:.5},onChange:d},{name:"pixelRatioY",params:{min:1,max:2,step:.5},onChange:d}]}])}}(window),function(a){"use strict";var b=a.ec,c={type:"circle",x:0,y:0,radius:50},d=b.ButtonOverlay=function(a){a=b.extend(a||{},c),b.extend(this,a),this.radiusSq=this.radius?this.radius*this.radius:0,this.touches=[],this.pressed=!1,this.vx=this.vy=0};d.viewWidth=1280,d.viewHeight=720;var e=d.prototype;e.containerWidth=d.viewWidth,e.containerHeight=d.viewHeight,e.hitTest=function(a,b,c,e){this.containerWidth=c,this.containerHeight=e;if(this.type==="circle"){var f=a*d.viewWidth/c-this.x,g=b*d.viewHeight/e-this.y;if(f*f+g*g<=this.radiusSq)return!0}else if(this.type==="rectangle"){if(a>this.left&&a<this.right&&b>this.top&&b<this.buttom)return!0}else console.error(this,"invalid type:",this.type);return!1},e.addTouch=function(a){this.touches.indexOf(a)<0&&this.touches.push(a)},e.removeTouch=function(a){var b=this.touches.indexOf(a);b>-1&&(this.touches.splice(b,1),this.vx=this.vy=0)},e.hasTouch=function(a){return this.touches.indexOf(a)>-1},e.updateTouch=function(a,b,c){var e=b*d.viewWidth/this.containerWidth-this.x,f=c*d.viewHeight/this.containerHeight-this.y,g=Math.sqrt(e*e+f*f);Math.abs(e)>Math.abs(e*100/g)&&(e=e*100/g),Math.abs(f)>Math.abs(f*100/g)&&(f=f*100/g),this.vx=e,this.vy=f},e.touchStart=function(a,b){this.addTouch(b),this.pressed=!0,this.updateTouch(b,a.clientX,a.clientY)},e.touchEnd=function(a,b){this.hasTouch(b)&&(this.removeTouch(b),this.pressed=!1)},e.draw=function(a,b,c){this.type==="circle"&&(a.beginPath(),a.fillStyle="#000000",a.globalAlpha=.05,a.arc(this.x*d.viewWidth/b,this.y*d.viewHeight/c,this.radius*d.viewWidth/b,0,2*Math.PI,!1),a.fill(),this.pressed&&(a.beginPath(),a.fillStyle="#000000",a.globalAlpha=.1,a.arc((this.x+this.vx)*d.viewWidth/b,(this.y+this.vy)*d.viewHeight/c,80*d.viewWidth/b,0,2*Math.PI,!1),a.fill()))}}(window),function(a){"use strict";var b=a.ec.TextField=function(b,c,d,e){this.ctx=b,this.text="",this.x=c||0,this.y=d||0,this.width=e||100,this.height=16;var f=this.ratio=a.ec.pixelRatio||1,g=this.canvas=document.createElement("canvas");g.width=this.width*f,g.height=this.height*f,this.context=g.getContext("2d"),this.context.textAlign="start",this.context.textBaseline="top",this.context.fillStyle="black",this.context.font="12px sans-serif",this.context.scale(f,f)};b.prototype.setText=function(a){this.text!==a&&(this.text=a,this.redraw()),this.draw()},b.prototype.setPos=function(a,b){this.x=a,this.y=b},b.prototype.redraw=function(){this.context.clearRect(0,0,this.width,this.height),this.context.fillText(this.text,0,0,this.width)},b.prototype.draw=function(){this.ctx.drawImage(this.canvas,this.x,this.y,this.width,this.height)}}(window),function(a){"use strict";var b=a.document,c=a.ec,d=a.cp,e=d.v,f=1<<31,g=~f,h=function(a,b){return a-=b,function(){return a+=b,a}},i=function(){var a=e(0,0);return function(b,c){return a.x=b,a.y=c,a}}(),j=c.ChipmunkDebugView=function(a){this.space=a;var g=this.canvas=b.createElement("canvas");g.style.position="absolute",this.ctx=g.getContext("2d"),this.resize(),this.orthoPos=e.mult(this.orthoSize,.5).add(i(50/this.scale,0)),this.mouse=e(0,0);var j=this.width-10,k=h(5,15),l=this.infoFields=[];for(var m=6;m-->0;)l.push(new c.TextField(this.ctx,5,k(),j));l[5].setPos(5,this.height-50);var n=this,o=this.canvas2point=function(a,b){return e(a/n.scale-n.orthoPos.x,n.orthoPos.y-b/n.scale)};this.point2canvas=function(a){return e((a.x+n.orthoPos.x)*n.scale,(n.orthoPos.y-a.y)*n.scale)},this.canvas.onmousemove=function(a){n.mouse=o(a.offsetX,a.offsetY);if(n.mouseDown&&!n.mouseJoint){var b=i(a.offsetX-n.mouseDown.x,a.offsetY-n.mouseDown.y).mult(1/n.scale);n.mouseDown.x=a.offsetX,n.mouseDown.y=a.offsetY,n.orthoPos.add(b)}};var p=this.mouseBody=new d.Body(Infinity,Infinity);this.canvas.onmousedown=function(b){var c=b.which===3;if(!c&&!n.mouseJoint){var g=o(b.offsetX,b.offsetY);n.mouseDown=e(b.offsetX,b.offsetY);var h=a.pointQueryFirst(g,f,d.NO_GROUP);if(h){var i=h.body;if(!i.isStatic()){var j=n.mouseJoint=new d.PivotJoint(p,i,e(0,0),i.world2Local(g));j.maxForce=5e4,j.errorBias=Math.pow(.85,60),a.addConstraint(j)}}}},this.canvas.onmouseup=function(b){var c=b.which===3;c||(n.mouseJoint&&(a.removeConstraint(n.mouseJoint),n.mouseJoint=null),n.mouseDown=null)},this.canvas.onmousewheel=function(a){var b=a.detail?a.detail*-1:(a.wheelDeltaY?a.wheelDeltaY:a.wheelDelta)/40;n.scale=Math.min(Math.max(.005,n.scale+b/(-999*n.scale+1e3)),1);var c=e.sub(n.orthoSize,i(n.width,n.height).mult(1/n.scale));n.orthoSize.sub(c),n.orthoPos.sub(c.mult(.5))}};j.prototype.show=function(){this.canvas.style.display="block",b.body.appendChild(this.canvas)},j.prototype.hide=function(){this.canvas.style.display="none",this.canvas.parentNode&&b.body.removeChild(this.canvas)},j.prototype.resize=function(a){a=a||.36;var b=this.ratio=c.pixelRatio||1;this.width=Math.max(160/b,Math.round(c.width*a)),this.height=Math.max(90/b,Math.round(c.height*a)),this.scale=this.width*a/c.width,this.orthoSize=e(this.width,this.height).mult(1/this.scale);var d=this.canvas;d.width=this.width*b,d.height=this.height*b,d.style.width=this.width+"px",d.style.height=this.height+"px",d.style.left=(c.width-this.width)/2+"px",d.style.top=c.height-this.height+"px",this.ctx.scale(b,b)},j.prototype.drawInfo=function(){var a=this.space,c=this.infoFields,d=0;this.ctx.textAlign="start",this.ctx.textBaseline="alphabetic",this.ctx.fillStyle="black",c[d++].setText(b.body.clientWidth+", "+b.body.clientHeight+" x "+this.ratio);var e=a.arbiters.length;this.maxArbiters=this.maxArbiters?Math.max(this.maxArbiters,e):e,c[d++].setText("Arbiters: "+e+" (Max: "+this.maxArbiters+")");var f=0;for(var g=0;g<e;g++)f+=a.arbiters[g].contacts.length;this.maxContacts=this.maxContacts?Math.max(this.maxContacts,f):f,c[d++].setText("Contact points: "+f+" (Max: "+this.maxContacts+")"),c[d++].setText("Mouse: "+this.mouse.x.toFixed(0)+", "+this.mouse.y.toFixed(0)),this.message&&c[5].setText(this.message)},j.prototype.draw=function(){var a=this.ctx,b=this;a.fillStyle="#ACF",a.fillRect(0,0,this.width,this.height),a.strokeStyle="black",this.ctx.lineCap="round",this.space.eachShape(function(c){a.fillStyle=c.style(),c.draw(a,b.scale,b.point2canvas)}),a.strokeStyle="red",a.lineWidth=2;var c=this.space.arbiters;for(var d=0;d<c.length;d++){var e=c[d].contacts;for(var f=0;f<e.length;f++){var g=this.point2canvas(e[f].p);a.beginPath(),a.moveTo(g.x-2,g.y-2),a.lineTo(g.x+2,g.y+2),a.stroke(),a.beginPath(),a.moveTo(g.x+2,g.y-2),a.lineTo(g.x-2,g.y+2),a.stroke()}}if(this.mouseJoint){a.beginPath();var h=this.point2canvas(this.mouseBody.p);a.arc(h.x,h.y,this.scale*5,0,2*Math.PI,!1),a.fill(),a.stroke()}this.space.eachConstraint(function(c){c.draw&&c.draw(a,b.scale,b.point2canvas)}),this.drawInfo()},j.prototype.step=function(){var a=e.lerp(this.mouseBody.p,this.mouse,.25);this.mouseBody.v=e.mult(e.sub(a,this.mouseBody.p),60),this.mouseBody.p=a,this.draw()};var k=function(a,b,c,d,e){d=c(d),a.beginPath(),a.arc(d.x,d.y,b*e,0,2*Math.PI,!1),a.fill(),a.stroke()},l=function(a,b,c,d){c=b(c),d=b(d),a.beginPath(),a.moveTo(c.x,c.y),a.lineTo(d.x,d.y),a.stroke()},m=[e(0,0),e(.2,0),e(.25,3),e(.3,-6),e(.35,6),e(.4,-6),e(.45,6),e(.5,-6),e(.55,6),e(.6,-6),e(.65,6),e(.7,-3),e(.75,6),e(.8,0),e(1,0)],n=function(a,b,c,d,f){d=c(d),f=c(f),a.beginPath(),a.moveTo(d.x,d.y);var g=e.sub(f,d),h=e.len(g),j=e.mult(g,1/h);for(var k=1;k<m.length;k++){var l=e.add(d,e.rotate(i(m[k].x*h,m[k].y*b),j));a.lineTo(l.x,l.y)}a.stroke()};d.PolyShape.prototype.draw=function(a,b,c){a.beginPath();var d=this.tVerts,e=d.length,f=c(i(d[e-2],d[e-1]));a.moveTo(f.x,f.y);for(var g=0;g<e;g+=2){var h=c(i(d[g],d[g+1]));a.lineTo(h.x,h.y)}a.fill(),a.stroke()},d.SegmentShape.prototype.draw=function(a,b,c){var d=a.lineWidth;a.lineWidth=Math.max(1,this.r*b*2),l(a,c,this.ta,this.tb),a.lineWidth=d},d.CircleShape.prototype.draw=function(a,b,c){k(a,b,c,this.tc,this.r),l(a,c,this.tc,e.mult(this.body.rot,this.r).add(this.tc))},d.PinJoint.prototype.draw=function(a,b,c){var d=this.a.local2World(this.anchr1),e=this.b.local2World(this.anchr2);a.lineWidth=2,a.strokeStyle="grey",l(a,c,d,e)},d.SlideJoint.prototype.draw=function(a,b,c){var d=this.a.local2World(this.anchr1),f=this.b.local2World(this.anchr2),g=e.add(d,e.clamp(e.sub(f,d),this.min));a.lineWidth=2,a.strokeStyle="grey",l(a,c,d,f),a.strokeStyle="red",l(a,c,d,g)},d.PivotJoint.prototype.draw=function(a,b,c){var d=this.a.local2World(this.anchr1),e=this.b.local2World(this.anchr2);a.strokeStyle="grey",a.fillStyle="grey",k(a,b,c,d,2),k(a,b,c,e,2)},d.GrooveJoint.prototype.draw=function(a,b,c){var d=this.a.local2World(this.grv_a),e=this.a.local2World(this.grv_b),f=this.b.local2World(this.anchr2);a.strokeStyle="grey",l(a,c,d,e),k(a,b,c,f,3)},d.DampedSpring.prototype.draw=function(a,b,c){var d=this.a.local2World(this.anchr1),e=this.b.local2World(this.anchr2);a.strokeStyle="grey",n(a,b,c,d,e)};var o=function(){return Math.floor(Math.random()*256)},p=[];for(var q=0;q<100;q++)p.push("rgb("+o()+", "+o()+", "+o()+")");d.Shape.prototype.style=function(){var a;return this.sensor?"rgba(255,255,255,0)":(a=this.body,a.isSleeping()?"rgb(50,50,50)":a.nodeIdleTime>this.space.sleepTimeThreshold?"rgb(170,170,170)":p[this.hashid%p.length])}}(window),function(a){"use strict";var b=a.ec,c=a.Stats,d=a.dat,e=b.DebugView=function(){var a=this.stats=new c;a.domElement.style.position="absolute",a.domElement.style.left="0px",a.domElement.style.top="0px"};e.prototype.show=function(){this.stats.domElement.style.display="block",a.document.body.appendChild(this.stats.domElement)},e.prototype.hide=function(){this.stats.domElement.style.display="none",this.stats.domElement.parentNode&&a.document.body.appendChild(this.stats.domElement)},e.prototype.addGui=function(a){var b=new d.GUI,c=b;for(var e=0;e<a.length;e++){var f=a[e];f.remember&&b.remember(f.target),f.name&&(c=b.addFolder(f.name),c.open());for(var g=0;g<f.props.length;g++){var h=f.props[g],i=h,j=null,k;h.name&&(j=h.params,i=h.name),j?j.min!==undefined&&j.max!==undefined?k=c.add(f.target,i,j.min,j.max,j.step):j.step&&(k=c.add(f.target,i).step(j.step)):k=c.add(f.target,i,j),h.listen&&k.listen(),h.onChange&&k.onChange(h.onChange)}}return b},e.prototype.worldGui=function(a){this.addGui([{name:"space",remember:!0,target:a.space,props:[{name:"iterations",params:{min:1,max:40}},{name:"sleepTimeThreshold",params:{step:b.TIME_STEP,min:b.TIME_STEP,max:1}},{name:"collisionSlop",params:{step:.1,min:.1,max:1}},"damping",{name:"idleSpeedThreshold",listen:!0,params:{min:0,max:50}},{name:"collisionBias"},"enableContactGraph"]}]),this.addGui([{name:"gravity",target:a.space.gravity,props:[{name:"x",params:{step:10,min:-1e3,max:1e3}},{name:"y",params:{step:10,min:-1e3,max:1e3}}]}])}}(window),function(a){"use strict";var b=a.ec,c=[undefined,undefined,undefined,undefined];b.keyPressed={};var d,e=b.UserInput=function(c){d=this,this.index=c||0,this.gamepadTime=1;var e=this.buttons=[];for(var f=0;f<17;f++)e[f]=0;var g=this.axes=[];for(f=0;f<4;f++)g[f]=0;b.gamepads&&(b.bind(a,"MozGamepadConnected",this.onGamepadConnect,!1),b.bind(a,"MozGamepadDisconnected",this.onGamepadDisconnect,!1)),this.pollGamePad=navigator.webkitGetGamepads!==undefined?this.pollGamePadList:this.pollDummyGamePadList,this.keyboardAxes1=!1,this.keyboardAxes2=!1,this.overlays=[]},f=e.prototype;f.addButtonOverlay=function(a){var b=this.overlays.indexOf(a);return b<0?(this.overlays.push(a),a):(console.error("overlay already a child of input",a),null)},f.removeButtonOverlay=function(a){var c=this.overlays.indexOf(a);return c>-1?(this.overlays.splice(c,1),b.unbind(a,"touchstart",a.touchStart,!1),b.unbind(a,"touchend",a.touchEnd,!1),a):(console.error("overlay not a child of input",a),null)},f.draw=function(a,b,c){for(var d=0,e=this.overlays.length;d<e;d++){var f=this.overlays[d];f.draw(a,b,c)}},f.resize=function(a,b){this.width=a,this.height=b},f.testOverlays=function(a,b,c){var d=this.width,e=this.height;for(var f=0,g=this.overlays.length;f<g;f++){var h=this.overlays[f];a==="touchend"&&(h===this.leftStickOverlay||h===this.rightStickOverlay)&&h["on"+a]!==undefined&&h["on"+a].apply(h,[b,c]);if(h.hitTest(b.clientX,b.clientY,d,e))return h["on"+a]!==undefined&&h["on"+a].apply(h,[b,c]),h}return null},f.setLeftStickOverlay=function(a){this.leftStickOverlay=a,b.bind(a,"touchstart",a.touchStart,!1),b.bind(a,"touchend",a.touchEnd,!1)},f.setRightStickOverlay=function(a){this.rightStickOverlay=a,b.bind(a,"touchstart",a.touchStart,!1),b.bind(a,"touchend",a.touchEnd,!1)},f.setAxes1=function(a,b){this.axes[0]=a,this.axes[1]=b},f.setAxes2=function(a,b){this.axes[2]=a,this.axes[3]=b},f.setButton=function(a,b){this.buttons[a]=b},f.mapButton=function(a,b){h[a]=b},f.poll=function(){this.leftStickOverlay&&!this.keyboardAxes1&&this.setAxes1(this.leftStickOverlay.vx/100,this.leftStickOverlay.vy/100),this.rightStickOverlay&&!this.keyboardAxes2&&this.setAxes2(this.rightStickOverlay.vx/100,this.rightStickOverlay.vy/100);var a=this.pollGamePad()[this.index];a&&this.gamepadTime!==a.timestamp&&(this.gamepadTime=a.timestamp||1,a.buttons[9]===1&&this.buttons[9]!==1&&b.core.togglePause(),a.buttons.join("")!==this.buttons.join("")&&console.log("gamepad button change",a.buttons.indexOf(1),this.buttons.indexOf(1),a.axes),this.buttons=a.buttons.slice(0),this.keyboardAxes1||this.setAxes1(a.axes[0],a.axes[1]),this.keyboardAxes2||this.setAxes2(a.axes[3],a.axes[4]))},f.touchstart=function(a){if(b.core.paused())return;for(var c=0,e=a.changedTouches.length;c<e;c++)d.testOverlays(a.type,a.changedTouches[c],a.changedTouches[c].identifier)},f.touchmove=function(a){for(var b=0,c=d.overlays.length;b<c;b++){var e=d.overlays[b];for(var f=0,g=a.changedTouches.length;f<g;f++)if(e.hasTouch(a.changedTouches[f].identifier)){e.updateTouch(a.changedTouches[f].identifier,a.changedTouches[f].clientX,a.changedTouches[f].clientY);break}}a.preventDefault()},f.touchend=function(a){if(b.core.paused()){b.core.resume();return}for(var c=0,e=a.changedTouches.length;c<e;c++)d.testOverlays(a.type,a.changedTouches[c],a.changedTouches[c].identifier)},f.mousedown=function(c){if(b.core.paused())return;d.testOverlays(c.type,c,-1)||(b.bind(b.core.getViewDom(),"mousemove",d.mouseRightStick,!1),b.bind(a,"mouseup",d.mouseRightStickEnd,!1),d.mouseRightStick(c))},f.mouseRightStick=function(a){var b=a.target.width/2,c=a.target.height/2+100,e=a.clientX-b,f=a.clientY-c,g=Math.sqrt(e*e+f*f);e/=g,f/=g,d.setAxes2(e,f)},f.mouseRightStickEnd=function(a){b.unbind(b.core.getViewDom(),"mousemove",d.mouseRightStick,!1),d.setAxes2(0,0)},f.mouseup=function(a){if(b.core.paused()){b.core.resume();return}d.testOverlays(a.type,a,-1)},f.keydown=function(a){var c=a.keyCode||a.which;b.keyPressed[c]=!0;switch(c){case g.RIGHT:case g.D:case g.LEFT:case g.A:case g.UP:case g.W:case g.DOWN:case g.S:d.updateAxes1FromKeys();break;case g.SPACE:case g.ENTER:d.setButton(h.SELECT,1);break;case g.BACKSLASH:d.setButton(h.CANCEL,1)}},f.keyup=function(a){var c=a.keyCode||a.which;b.keyPressed[c]=!1;switch(c){case g.RIGHT:case g.D:case g.LEFT:case g.A:case g.UP:case g.W:case g.DOWN:case g.S:d.updateAxes1FromKeys();break;case g.SPACE:case g.ENTER:d.setButton(h.SELECT,0);break;case g.BACKSLASH:d.setButton(h.CANCEL,0);break;case g.P:b.core.paused()?b.core.resume():b.core.pause();break;case g.O:b.core.cycleDebug();break;case g.F:case g.SLASH:b.core.fullscreen();break;default:console.log(String.fromCharCode(c),c)}},f.updateAxes1FromKeys=function(){var a=(b.keyPressed[g.LEFT]||b.keyPressed[g.A]?-1:0)+(b.keyPressed[g.RIGHT]||b.keyPressed[g.D]?1:0),c=(b.keyPressed[g.UP]||b.keyPressed[g.W]?-1:0)+(b.keyPressed[g.DOWN]||b.keyPressed[g.S]?1:0);this.keyboardAxes1=a||c,this.setAxes1(a,c)},f.pollDummyGamePadList=function(){return c},f.pollGamePadList=function(){return navigator.webkitGetGamepads()},f.onGamepadConnect=function(a){console.log("onGamepadConnect",a);if(a.gamepad.index===0){var b=a.gamepad;this.pollGamePad=function(){return b}}},f.onGamepadDisconnect=function(a){console.log("onGamepadDisconnect",a),a.gamepad.index===0&&(this.pollGamePad=this.pollDummyGamePadList)};var g={LEFT:37,UP:38,RIGHT:39,DOWN:40,ENTER:13,SHIFT:16,CTRL:17,ALT:18,SPACE:32,NUM0:48,NUM1:49,NUM2:50,NUM3:51,NUM4:52,NUM5:53,NUM6:54,NUM7:55,NUM8:56,NUM9:57,A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90,SLASH:191,BACKSLASH:220},h={SELECT:0,CANCEL:1}}(window),function(a){"use strict";var b=a.ec,c=a.cp,d=c.v,e=b.EnemyInput=function(){this.axes=[];for(var a=0;a<4;a++)this.axes[a]=0;this.goal=null},f=e.prototype;f.poll=function(a){if(this.state==="dead")return;var b=this.goal;if(!b||b.met)b=this.selectGoal(b,a);this.goal=b;var c=b.task;if(!c||c.complete)c=this.selectTask(b,a);c&&c.apply(this,arguments)},f.setAxes1=function(a,b){this.axes[0]=a,this.axes[1]=b},f.selectGoal=function(a,c){var d;return a===m.surround?c.isShadowClone?Math.random()>.5?d=m.throwStars:d=m.surround:d=m.shadowClone:a===m.shadowClone?d=m.throwStars:a===m.throwStars?Math.random()>.8?d=m.avoid:d=m.rush:d=m.surround,d.met=!1,d.task=null,b.debug&&!c.isShadowClone&&console.log("Enemy goal: ",d.name),d},f.selectTask=function(a,c){var d,e;return e=a.tasks.indexOf(a.task)+1,e>=a.tasks.length?(a.met=!0,null):(d=a.tasks[e],d.complete=!1,a.task=d,b.debug&&!c.isShadowClone&&console.log("Enemy task: ",e),d)};var g=7,h=36,i=250,j=4096,k=262144,l=function(a){return a.x*a.x+a.y*a.y};f.targetNearestEnemy=function(c){this.targetEntity=b.player,this.targetPos=this.targetEntity.body.p,this.goal.task.complete=!0},f.targetNearestEnemyBorder=function(b){this.targetNearestEnemy(b);var e=d.sub(b.body.p,this.targetPos),f;b.isShadowClone&&(f=d.rotate(e,d.forangle(Math.random()*Math.PI*2))),f=d.mult(e,i/d.len(e));var g=d.sub(c.vzero,e.sub(f));this.targetPos=d.add(b.body.p,g),b.speed=4,this.goal.task.complete=!0},f.scramble=function(b){this.targetPos=d(Math.random()*1e3-500,Math.random()*1e3-500),b.speed=6,this.goal.task.complete=!0},f.moveTo=function(b){if(!this.targetPos){this.goal.task.complete=!0;return}var c=d.sub(this.targetPos,b.body.p);if(l(c)<j){this.goal.task.complete=!0,this.targetPos=null,this.setAxes1(0,0),b.isShadowClone||(this.idleTick=220);return}c=d.mult(c,1/d.len(c)),this.setAxes1(c.x,-c.y)},f.moveAway=function(b){if(!this.targetPos){this.goal.task.complete=!0;return}var c=d.sub(b.body.p,this.targetPos);if(l(c)>k){this.goal.task.complete=!0,this.targetPos=null,this.setAxes1(0,0);return}c=d.mult(c,1/d.len(c)),this.setAxes1(c.x,-c.y)},f.shuv=function(b){b.speed=6,this.targetNearestEnemy(b),this.moveTo(b)},f.kageNoBunshin=function(c){if(c.isShadowClone){this.goal.task.complete=!0;return}if(b.world.entities.length>h){this.goal.task.complete=!0,this.goal.met=!0;return}this.turns=this.turns||0,this.turns+=.5,c.body.a+=.5,this.turns>11&&(this.turns=0,this.goal.task.complete=!0)},f.makeClones=function(c){this.clones=this.clones||0,++this.clones>g||b.world.entities.length>h?(this.clones=0,this.goal.task.complete=!0):c.shadowClone()},f.throwStar=function(b){this.throwTick=this.throwTick||0,this.throwTick++,this.throwTick>Math.random()*300&&(this.throwTick=0,this.goal.task.complete=!0)},f.idle=function(b){this.idleTick=this.idleTick||0,this.idleTick++,this.idleTick>40+200*Math.random()&&(this.idleTick=0,this.goal.task.complete=!0)};var m={surround:{name:"surround",tasks:[f.targetNearestEnemyBorder,f.moveTo,f.idle]},shadowClone:{name:"shadow clone",tasks:[f.kageNoBunshin,f.makeClones,f.scramble,f.moveTo]},throwStars:{name:"throw stars",tasks:[f.targetNearestEnemy,f.throwStar,f.scramble]},avoid:{name:"avoid",tasks:[f.targetNearestEnemy,f.moveAway,f.idle]},rush:{name:"rush",tasks:[f.targetNearestEnemy,f.moveTo,f.shuv]}}}(window);